<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Coeliacs Like Beer Too! {{ cache_buster }}</title>
        
        <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ cache_buster }}">
        
        <link rel="stylesheet" href="/static/css/breweries.css?v={{ cache_buster }}">
        <link rel="stylesheet" href="/static/css/community-hub.css?v={{ cache_buster }}">        
        <link rel="stylesheet" href="/static/css/map.css?v={{ cache_buster }}">
        <link rel="stylesheet" href="/static/css/onboarding.css?v={{ cache_buster }}">
        
        <!-- Leaflet CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <!-- Leaflet MarkerCluster CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">

        <!-- PWA Manifest -->
        <link rel="manifest" href="/static/manifest.json">
        
        <!-- Theme Colors -->
        <meta name="theme-color" content="#764BEA">
        <meta name="msapplication-TileColor" content="#764BEA">
        <meta name="msapplication-navbutton-color" content="#764BEA">
        <meta name="apple-mobile-web-app-status-bar-style" content="default">
        
        <!-- Favicons & PWA Icons -->
        <link rel="icon" type="image/png" href="/static/images/favicon-96x96.png" sizes="96x96" />
        <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg" />
        <link rel="shortcut icon" href="/static/images/favicon.ico" />
        <link rel="apple-touch-icon" sizes="180x180" href="/static/images/apple-touch-icon.png" />
        <meta name="apple-mobile-web-app-title" content="CLB" />
        <link rel="manifest" href="/static/manifest.json" />
        
        <!-- Enhanced Meta for PWA -->
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="application-name" content="GF Beer Finder">
        
        <!-- Google Analytics with GDPR compliance -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-WSHR39KSXS"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            
            // Set default consent to denied (GDPR compliant)
            gtag('consent', 'default', {
                'analytics_storage': 'denied'
            });
            
            gtag('js', new Date());
            gtag('config', 'G-WSHR39KSXS', {
                'anonymize_ip': true,
                'cookie_flags': 'SameSite=None;Secure'
            });
        </script>
    </head>
    <body>
         <!-- Top Navigation Bar -->
        <nav class="top-nav home-nav">
            <div class="nav-content">
                <!-- Left Section -->
                <div class="nav-left">
                    <!-- Logo (always visible) -->
                    <div class="logo-container">
                        <img src="/static/images/logo-white.svg" alt="Coeliacs Like Beer Too" class="nav-logo">
                    </div>
                </div> <!-- ‚Üê THIS WAS MISSING! -->
                
                <!-- Right Section -->
                <div class="nav-right">
                    <!-- GF/All Toggle (results & map only) -->
                    <div class="nav-toggle">
                        <div class="toggle-container" id="mainToggleContainer">
                            <div class="toggle-track">
                                <div class="toggle-thumb" id="mainToggleThumb"></div>
                                <div class="toggle-option active" data-value="gf">GF Only</div>
                                <div class="toggle-option" data-value="all">All Venues</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Future: Notifications, settings etc -->
                    <div class="nav-actions">
                        <button class="btn nav-notification-btn">üîî</button>
                    </div>
                    
                    <!-- Back Button (hidden on home) -->
                    <button class="btn nav-back-btn" data-action="nav-back">‚Üê Back</button>
                </div>
            </div>
        </nav>
        
        <!-- Community Homepage -->
        <div class="community-home">
            
            <!-- Quick Stats Bar -->
            <div class="stats-bar">
                <div class="stat-pill">
                    <span class="stat-number-small" id="totalVenues">&nbsp;</span>
                    <span class="stat-label-small">Venues currently<br>in database</br></span>
                </div>
                <div class="stat-pill highlighted">
                    <span class="stat-number-small" id="gfVenues">&nbsp;</span>
                    <span class="stat-label-small">Known to serve<br>gf beer</br></span>
                </div>
                <div class="stat-pill">
                    <span class="stat-number-small" id="monthlyFinds">&nbsp;</span>
                    <span class="stat-label-small">New findings<br>this month</br></span>
                </div>
            </div>
            
            <!-- Near Me Quick Access -->
            <div class="hero-section">
                <div class="near-me-section">
                    <button class="card near-me-button" data-action="quick-nearby">
                        <div class="near-me-icon">üìç</div>
                        <div class="near-me-content">
                            <h3>Find GF Beer</h3>
                            <p>Quick 5km search around<br>you</br></p>
                        </div>
                    </button>
                </div>
                <div class="buy-beer-section">
                    <button class="card buy-beer-button" data-action="buy-gf-beer">
                        <div class="buy-beer-icon">üõí</div>
                        <div class="buy-beer-content">
                            <h3>Buy GF Beer</h3>
                            <p>Shop premium selections<br>online</br></p>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Community Feed -->
            <div class="community-feed">
                <!-- Venue of the Month -->
                <div class="card featured-card">
                    <div class="featured-badge">üèÜ Venue of the Month</div>
                    <div class="featured-content">
                        <h2>The Botanist Sheffield</h2>
                        <p>6 dedicated GF taps including Bellfield, Jump Ship & Brass Castle!</p>
                        <div class="featured-stats">
                            <span>üìç Sheffield City Centre</span>
                            <span>üç∫ Always GF Available</span>
                        </div>
                        <button class="btn btn-featured" data-action="view-venue" data-venue-id="12345">
                            View Details
                        </button>
                    </div>
                </div>
                
                <!-- ====================================================================
                     RECENT FINDS - HTML STRUCTURE
                     Insert this into the community feed section of index.html
                     Replace the existing "Latest Finds" section
                     ==================================================================== -->
                
                <!-- Recent Finds Section -->
                <div class="recent-finds-section" id="recentFinds">
                  <h2 class="recent-finds-title">
                    <span class="recent-finds-icon">üÜï</span>
                    Latest Community Discoveries
                  </h2>
                  
                  <div class="recent-finds-container">
                    <!-- Loading State -->
                    <div class="recent-finds-loading" id="recentFindsLoading">
                      Loading latest discoveries...
                    </div>
                    
                    <!-- Error State -->
                    <div class="recent-finds-error" id="recentFindsError" style="display: none;">
                      Unable to load recent finds. Please try again later.
                    </div>
                    
                    <!-- Empty State -->
                    <div class="recent-finds-empty" id="recentFindsEmpty" style="display: none;">
                      No recent finds yet. Be the first to share a discovery!
                    </div>
                    
                    <!-- Dynamic Content List -->
                    <ul class="recent-finds-list" id="recentFindsList" style="display: none;">
                      <!-- Dynamic content will be inserted here by JavaScript -->
                    </ul>
                  </div>
                </div>
                
                <!-- Trending This Week -->
                <div class="section-header">
                    <h2>üìà Trending This Week</h2>
                </div>
                
                <div class="card trending-list">
                    <div class="trending-item">
                        <span class="trending-rank">1</span>
                        <div class="trending-content">
                            <strong>Brass Castle - Haze</strong>
                            <small>Reported 18 times</small>
                        </div>
                        <span class="trending-badge">üî•</span>
                    </div>
                    <div class="trending-item">
                        <span class="trending-rank">2</span>
                        <div class="trending-content">
                            <strong>Bellfield - Lawless</strong>
                            <small>Reported 15 times</small>
                        </div>
                    </div>
                    <div class="trending-item">
                        <span class="trending-rank">3</span>
                        <div class="trending-content">
                            <strong>Vagabond - American Pale Ale</strong>
                            <small>Reported 12 times</small>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-card" data-action="browse-breweries">
                        <span class="action-icon">üè≠</span>
                        <span class="action-label">Browse Breweries</span>
                    </button>
                    <button class="action-card" data-action="new-to-gf">
                        <span class="action-icon">üéì</span>
                        <span class="action-label">New to GF?</span>
                    </button>
                    <button class="action-card" data-action="add-find">
                        <span class="action-icon">‚ûï</span>
                        <span class="action-label">Add a Find</span>
                    </button>
                    <button class="action-card" data-action="saved-venues">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-label">Saved Venues</span>
                    </button>
                </div>
            </div>
        </div>

            <!-- Bottom navigation bar -->
        <nav class="bottom-nav">
            <a href="/" class="nav-item">
                <div class="nav-icon">üè†</div>
                <div class="nav-label">Home</div>
            </a>
            <div class="nav-item" data-action="open-search">
                <div class="nav-icon">üîç</div>
                <div class="nav-label">Search</div>
            </div>
            <a href="#" data-action="show-full-map" class="nav-item">
                <div class="nav-icon">üó∫Ô∏è</div>
                <div class="nav-label">Map</div>
            </a>
            <div class="nav-item" data-action="open-community-hub">
                <div class="nav-icon">üèÜ</div>
                <div class="nav-label">Community</div>
            </div>
            <div class="nav-item nav-more" data-action="toggle-more-menu">
                <div class="nav-icon">‚ãØ</div>
                <div class="nav-label">More</div>
                <div class="more-menu" id="moreMenu">
                    <a href="#" data-action="about-us" class="more-menu-item">
                        <span class="menu-icon">‚ÑπÔ∏è</span>
                        <span>About Us</span>
                    </a>
                    <a href="#" data-action="about-gf" class="more-menu-item">
                        <span class="menu-icon">üî¨</span>
                        <span>About Gluten Free</span>
                    </a>
                    <a href="/privacy" class="more-menu-item">
                        <span class="menu-icon">üîí</span>
                        <span>Privacy Policy</span>
                    </a>
                    <a href="/terms" class="more-menu-item">
                        <span class="menu-icon">üìã</span>
                        <span>Terms of Service</span>
                    </a>
                </div>
            </div>
        </nav>   

        <!-- Search Options Overlay -->
        <div id="searchOverlay" class="overlay search-overlay">
            <div class="search-container">
                <div class="search-card">
                    <div class="search-header">
                        <h2 class="search-header-title">üîç What are you searching for? üç∫</h2>
                    </div>
                    <div class="search-body">
                        <div class="search-options">
                            
                            <!-- Location Search -->
                            <div class="search-option location" data-action="location-search">
                                <span class="search-icon">üìç</span>
                                <h3 class="search-title">Venues Near Me</h3>
                                <p class="search-description">Find venues close to you, control the search distance.</p>
                            </div>
                            
                            <!-- Name Search -->
                            <div class="search-option name" data-action="search-name">
                                <span class="search-icon">üè†</span>
                                <h3 class="search-title">Venues by Name</h3>
                                <p class="search-description">Search for a specific venue name - "Milestone" etc</p>
                            </div>
                            
                            <!-- Area Search -->
                            <div class="search-option area" data-action="search-area">
                                <span class="search-icon">üó∫Ô∏è</span>
                                <h3 class="search-title">Venues by Area</h3>
                                <p class="search-description">Explore venues in regions, cities, or postcodes</p>
                            </div>
                            
                            <!-- Beer Search -->
                            <div class="search-option beer" data-action="search-beer">
                                <span class="search-icon">üç∫</span>
                                <h3 class="search-title">Venues by Beer</h3>
                                <p class="search-description">Find venues serving specific GF beers - "Zapato", "IPA" etc.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Search Modals -->
        <div id="nameModal" class="modal search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üè† Search by Venue Name</h3>
                    <p class="modal-subtitle">Enter the name of the venue you're looking for</p>
                </div>
                <input type="text" class="form-input" placeholder="e.g. The Red Lion, Wetherspoons" id="nameInput">
                <div class="modal-actions">
                    <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button class="btn btn-primary" data-action="perform-name-search">Search</button>
                </div>
            </div>
        </div>
        
        <div id="areaModal" class="modal search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üó∫Ô∏è Search by Area</h3>
                    <p class="modal-subtitle">Find venues in a specific location</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Search by:</label>
                    <select id="areaSearchType" class="form-select" data-action="update-area-placeholder">
                        <option value="city">üèôÔ∏è City/Region</option>
                        <option value="postcode">üìÆ Postcode</option>  
                    </select>
                </div>
                <input type="text" class="form-input" placeholder="Enter postcode..." id="areaInput">
                <div class="modal-actions">
                    <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button class="btn btn-primary" data-action="perform-area-search">Search</button>
                </div>
            </div>
        </div>
    
        <div id="beerModal" class="modal search-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üç∫ Search by Beer</h3>
                    <p class="modal-subtitle">Find venues serving specific gluten-free beers</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Search by:</label>
                    <select id="beerSearchType" class="form-select" data-action="update-beer-placeholder">
                        <option value="brewery">üè≠ Brewery Name</option>
                        <option value="beer">üç∫ Specific Beer</option>
                        <option value="style">üé® Beer Style</option>
                    </select>
                </div>
                <div class="beer-search-container">
                    <input type="text" class="form-input" placeholder="Start typing brewery name..." id="beerInput">
                    <div id="beerSuggestions" class="suggestions beer-search-suggestions"></div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button class="btn btn-primary" data-action="perform-beer-search">Search</button>
                </div>
            </div>
        </div>
    
        <!-- Distance Selection Modal -->
        <div id="distanceModal" class="modal search-modal">
            <div class="modal-content distance-content">
                <div class="modal-header">
                    <h3 class="modal-title">üìç How far will you travel?</h3>
                </div>
                <div class="modal-options distance-options">
                    <div class="distance-option" data-distance="1">
                        <div class="distance-number">1km</div>
                        <div class="distance-label">Walking distance</div>
                    </div>
                    <div class="distance-option" data-distance="3">
                        <div class="distance-number">3km</div>
                        <div class="distance-label">Short journey</div>
                    </div>
                    <div class="distance-option popular" data-distance="5">
                        <div class="distance-number">5km</div>
                        <div class="distance-label">Most popular</div>
                    </div>
                    <div class="distance-option" data-distance="10">
                        <div class="distance-number">10km</div>
                        <div class="distance-label">Longer trip</div>
                    </div>
                    <div class="distance-option" data-distance="20">
                        <div class="distance-number">20km</div>
                        <div class="distance-label">Day out</div>
                    </div>
                </div>
                <div class="modal-actions distance-actions">
                    <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Map Overlay -->
        <div id="fullMapOverlay" class="overlay map-overlay">
            <div class="map-container">
                <div id="fullMap" class="full-map"></div>
            </div>
        </div>

        <!-- Add this overlay div somewhere in your body -->
        <div id="communityHubOverlay" class="overlay">
            <div id="communityHubContent">
                <!-- Content will be injected here -->
            </div>
        </div>

        <!-- Breweries Overlay -->
        <div id="breweriesOverlay" class="overlay breweries-overlay">
            <div class="breweries-container">
                <div class="breweries-content" id="breweriesContent">
                    <div class="breweries-grid" id="breweriesGrid">
                    </div>
                </div>
            </div>
        </div>

        <!-- Brewery Beers Modal -->
        <div id="breweryBeersModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üç∫ <span id="breweryName"></span> Beers</h3>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="breweryBeersLoading" class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading beers...</div>
                    </div>
                    <div id="breweryBeersList" class="brewery-beers-list"></div>
                    <div id="breweryBeersEmpty" class="empty-state" style="display: none;">
                        <p>No beers found for this brewery</p>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" data-action="search-venues-with-brewery">
                        üîç Find Venues Serving These Beers
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Prompt After Beer Report Modal -->
        <div id="statusPromptAfterBeerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üéØ One More Thing!</h2>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                
                <div class="modal-body" style="text-align: center; padding: 2rem;">
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem;">
                        Thanks for adding that beer! üç∫
                    </p>
                    
                    <p style="margin-bottom: 2rem;">
                        <strong>How reliably does <span id="statusPromptVenueName" style="font-weight: bold;">this venue</span> have GF beer?</strong>
                    </p>
                    
                    <div class="status-quick-options" style="display: flex; flex-direction: column; gap: 0.75rem; max-width: 400px; margin: 0 auto;">
                        <button class="btn btn-success status-prompt-btn" data-action="quick-status-update" data-status="always_tap_cask" style="text-align: left; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.5rem;">‚≠ê</span>
                                <div>
                                    <strong>Always has GF on tap/cask</strong>
                                    <br><small style="opacity: 0.8;">The holy grail! Permanent GF tap/cask lines</small>
                                </div>
                            </div>
                        </button>
                        
                        <button class="btn btn-primary status-prompt-btn" data-action="quick-status-update" data-status="always_bottle_can" style="text-align: left; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.5rem;">‚úÖ</span>
                                <div>
                                    <strong>Always has GF bottles/cans</strong>
                                    <br><small style="opacity: 0.8;">Reliable bottled/canned options</small>
                                </div>
                            </div>
                        </button>
                        
                        <button class="btn btn-secondary status-prompt-btn" data-action="quick-status-update" data-status="currently" style="text-align: left; padding: 1rem;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.5rem;">üîµ</span>
                                <div>
                                    <strong>Sometimes has GF beer</strong>
                                    <br><small style="opacity: 0.8;">Not always available, but they have it today</small>
                                </div>
                            </div>
                        </button>
                        
                        <button class="btn btn-outline" data-action="skip-status-prompt" style="padding: 0.75rem; margin-top: 0.5rem;">
                            ü§∑ Not sure / Skip
                        </button>
                    </div>
                    
                    <p style="margin-top: 1.5rem; font-size: 0.9rem; opacity: 0.7;">
                        This helps others know what to expect when they visit!
                    </p>
                </div>
            </div>
        </div>
    
        <div id="resultsOverlay" class="overlay results-overlay">
            <div class="results-container">

                <div class="results-header">
                    <!-- Title and Map toggle button -->
                    <h2 class="results-title" id="resultsTitle">Search Results</h2>
                    <button class="btn results-map-toggle" data-action="toggle-results-map">
                        <span id="resultsMapBtnText">Map</span>
                    </button>
                </div>
                
                <div class="results-content">
                    <!-- This holds BOTH views -->
                    <div class="results-list-container" id="resultsListContainer">
                        <!-- LIST VIEW - shows when in list mode -->
                        <div class="results-loading" id="resultsLoading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Finding nearby GF beer...</div>
                        </div>
                        
                        <div class="results-list" id="resultsList"></div>
                        
                        <div class="no-results-found" id="noResultsFound">
                            <div class="no-results-icon">üîç</div>
                            <div class="no-results-title">No venues found</div>
                            <div class="no-results-text">Try expanding your search or check the spelling</div>
                        </div>
                    </div>
                    
                    <div class="results-map-container" id="resultsMapContainer">
                        <!-- MAP VIEW - shows when in map mode -->
                        <div id="resultsMap" class="results-map"></div>
                        <!-- ^^^ Leaflet map renders HERE -->
                    </div>
                </div>
                
                <!-- Move pagination HERE - outside results-content -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info">
                        <span id="paginationInfo">Showing 1-20 of 45 results</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-secondary" id="prevPageBtn" data-action="prev-page" disabled>
                            ‚Üê Previous
                        </button>
                        <div class="page-numbers" id="pageNumbers">
                            <!-- Page numbers will be inserted here -->
                        </div>
                        <button class="btn btn-secondary" id="nextPageBtn" data-action="next-page">
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Venue Details Overlay -->
        <div id="venueDetailsOverlay" class="overlay venue-details-overlay">
            <div class="venue-details-container">
                
                <!-- Main content card -->
                <div class="venue-details-card">
                    <div class="venue-details-content">
                        <div class="venue-header">
                            <h1 class="venue-title" id="venueDetailsTitle">Venue Name</h1>
                            <div class="venue-address" id="venueDetailsAddress">Address</div>
                            <div class="venue-location" id="venueDetailsLocation">Location</div>
                        </div>
        
                        <div class="gf-status-section">
                            <div class="status-card">
                                <h3 class="status-question">üç∫ What's the GF beer situation here?</h3>
                                <div class="current-status" id="currentGFStatus">
                                    <span class="status-icon">‚ùì</span>
                                    <span class="status-text">Not Sure</span>
                                    <span class="status-meta">Help us find out!</span>
                                </div>
                                <div class="status-actions">
                                    <button class="btn btn-sm btn-outline" data-action="change-gf-status">üìä Update Status</button>
                                    <button class="btn btn-sm btn-primary" data-action="report-beer">‚ûï Add New Beer</button>
                                </div>
                            </div>
                        </div>

                        <div class="beer-section" id="beerSection">
                            <div class="beer-section-title">üç∫ Available Gluten Free Beers</div>
                            <div class="beer-status" id="venueDetailsBeer"></div>
                        </div>
                    </div>
                    
                    <!-- Action buttons stick to bottom -->
                    <div class="venue-action-grid venue-action-grid-simple">
                        <button class="btn btn-external" data-action="find-venue-online">üîç Find Online</button>
                        <button class="btn btn-external" data-action="get-venue-directions">üß≠ Get Directions</button>
                    </div>
                </div>  
            </div>
        </div>

        <!-- Report Modal -->
        <div id="reportModal" class="modal report-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Report GF Beer Find</h2>
                    <p class="modal-subtitle" id="reportModalSubtitle"></p>
                    <button class="modal-close" data-action="close-modal" aria-label="Close report modal">&times;</button>
                </div>
                
                <div class="modal-body">
                    <form id="reportForm" class="modal-form" data-action="submit-report">
                        <div class="form-group" id="venueSearchGroup">
                            <label class="form-label">Find Your Venue *</label>
                            <input type="text" id="reportVenueSearch" class="form-input" placeholder="Start typing venue name..." autocomplete="off">
                            <div id="venueSuggestions" class="suggestions"></div>
                        </div>
                        
                        <div id="selectedVenueInfo" class="selected-venue-info">
                            <div class="selected-venue-card">
                                <strong id="selectedVenueName"></strong>
                                <div id="selectedVenueAddress"></div>
                                <button type="button" class="btn btn-secondary btn-sm" data-action="clear-selected-venue">Choose Different Venue</button>
                            </div>
                        </div>
                        
                        <div id="newVenueFields" class="new-venue-fields">
                            <h4>üìç Add New Venue</h4>
                            <div class="form-group">
                                <label class="form-label">Venue Name *</label>
                                <input type="text" id="reportVenueName" class="form-input" placeholder="The Red Lion">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address *</label>
                                <input type="text" id="reportAddress" class="form-input" placeholder="123 High Street">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Postcode *</label>
                                <input type="text" id="reportPostcode" class="form-input" placeholder="SW1A 1AA">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Beer Format *</label>
                            <select id="reportFormat" name="reportFormat" class="form-select" required>
                                <option value="">Select format...</option>
                                <option value="bottle">üç∫ Bottle</option>
                                <option value="tap">üö∞ Tap</option>
                                <option value="cask">üõ¢Ô∏è Cask</option>
                                <option value="can">ü•´ Can</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Brewery</label>
                            <div class="brewery-dropdown-container">
                                <input type="text" id="reportBrewery" name="reportBrewery" class="form-input" placeholder="Start typing brewery name..." autocomplete="off">
                                <div id="breweryDropdown" class="suggestions brewery-suggestions"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Beer Name</label>
                            <div class="beer-name-container">
                                <input type="text" id="reportBeerName" name="reportBeerName" class="form-input" placeholder="Start typing beer name..." autocomplete="off">
                                <div id="beerNameDropdown" class="suggestions beer-suggestions"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Beer Style</label>
                            <div class="beer-style-container">
                                <input type="text" id="reportBeerStyle" name="reportBeerStyle" class="form-input" placeholder="IPA, Lager, Stout..." autocomplete="off">
                                <div id="beerStyleDropdown" class="suggestions style-suggestions"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">ABV (Alcohol %)</label>
                            <input type="number" id="reportBeerABV" name="reportBeerABV" class="form-input" placeholder="4.5" step="0.1" min="0" max="20">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Photo (Optional)</label>
                            <label for="reportPhoto" class="photo-upload-compact">
                                <div class="photo-upload-icon">üì∑</div>
                                <div class="photo-upload-text">
                                    <strong>Add a photo</strong><br>
                                    <small>Beer menu, bottle, or tap</small>
                                </div>
                                <input type="file" id="reportPhoto" name="reportPhoto" accept="image/*">
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Submit Report</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Other Modals -->
        <div id="placesSearchModal" class="modal places-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">üîç Find Your Venue</h2>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p class="search-prompt">Search for bars, venues, or restaurants:</p>
                    <div class="places-search-container">
                        <input type="text" id="placesSearchInput" class="form-input" placeholder="e.g. Lawn Club Sheffield" autocomplete="off">
                        <div id="placesResults" class="places-results"></div>
                    </div>
                    <div class="search-powered-by"><small>Powered by Google Places</small></div>
                    <div id="selectedPlacePreview" class="selected-place-preview" style="display: none;">
                        <h4>Selected Venue:</h4>
                        <div class="place-details">
                            <strong id="selectedPlaceName"></strong>
                            <div id="selectedPlaceAddress"></div>
                            <div id="selectedPlaceType"></div>
                        </div>
                        <button class="btn btn-primary" data-action="use-selected-place">‚úÖ Use This Venue</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="venueAddedPromptModal" class="modal prompt-modal">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="success-icon"> </div>
                    <h3 Venue Added Successfully!> </h3>
                    <p <strong id="addedVenueName"> </strong> has been added to our database.</p>
                    <p>What would you like to do next?</p>
                    <div class="modal-actions status-modal-action">
                        <button class="btn btn-primary" data-action="update-gf-status-new-venue">üìä Update GF Beer Status</button>
                        <button class="btn btn-success" data-action="report-gf-beer-new-venue">üç∫ Report GF Beer Available</button>
                        <button class="btn btn-secondary" data-action="close-venue-added-modal">‚úÖ Done For Now</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Modals -->
        <div id="gfStatusModal" class="modal status-modal">
            <div class="modal-content status-modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Update GF Beer Status</h2>
                    <p class="modal-subtitle" id="statusModalSubtitle"></p>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="modal-options status-options">
                        <button class="status-option always-tap-cask" data-status="always_tap_cask">
                            <div class="option-icon">‚≠ê</div>
                            <div class="option-content">
                                <h4>Always Has Tap/Cask</h4>
                                <p>Dedicated GF tap or cask - the holy grail!</p>
                            </div>
                        </button>
                        <button class="status-option always-bottle-can" data-status="always_bottle_can">
                            <div class="option-icon">‚úÖ</div>
                            <div class="option-content">
                                <h4>Always Has Bottles/Cans</h4>
                                <p>Reliable GF bottles or cans in the fridge</p>
                            </div>
                        </button>
                        <button class="status-option currently" data-status="currently">
                            <div class="option-icon">üîµ</div>
                            <div class="option-content">
                                <h4>Currently Available</h4>
                                <p>GF beer in stock right now</p>
                            </div>
                        </button>
                        <button class="status-option not-currently" data-status="not_currently">
                            <div class="option-icon">‚ùå</div>
                            <div class="option-content">
                                <h4>Not Available</h4>
                                <p>No GF options at the moment</p>
                            </div>
                        </button>
                        <button class="status-option unknown" data-status="unknown">
                            <div class="option-icon">‚ùì</div>
                            <div class="option-content">
                                <h4>Not Sure</h4>
                                <p>Status unknown</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="gfStatusConfirmModal" class="modal confirm-modal">
            <div class="modal-content confirm-modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Confirm Status Change</h2>
                </div>
                <div class="modal-body">
                    <div class="confirm-message">
                        <p>You're about to update the GF beer status to:</p>
                        <div class="confirm-status" id="confirmStatus"></div>
                        <p class="confirm-warning">This will be visible to all users. Are you sure?</p>
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" data-action="cancel-status">Cancel</button>
                        <button class="btn btn-primary" data-action="confirm-status">Yes, Update</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="beerDetailsPromptModal" class="modal prompt-modal">
            <div class="modal-content prompt-modal-content">
                <div class="modal-body">
                    <div class="success-icon">üéâ</div>
                    <h3>Thanks for the update!</h3>
                    <p>Would you like to tell us which GF beers are available?</p>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" data-action="skip-details">Not Now</button>
                        <button class="btn btn-primary" data-action="add-beer-details">üìù Add Beer Details</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Beer List Modal -->
        <div id="beerListModal" class="modal beer-list-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üç∫ Current GF Beers</h3>
                    <p class="modal-subtitle" id="beerListVenueName"></p>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="beerListContent" class="beer-list-content">
                        <!-- Beer items will be populated here -->
                    </div>
                    <div class="beer-list-empty" id="beerListEmpty" style="display: none;">
                        <p>No GF beers reported yet</p>
                        <button class="btn btn-primary" data-action="report-beer">Add First Beer</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="nicknameModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">üëã Choose Your Nickname</h3>
                    <p class="modal-subtitle">How should we credit your contributions?</p>
                </div>
                <div class="modal-body">
                    <input type="text" 
                           id="nicknameInput" 
                           class="form-input" 
                           placeholder="e.g. BeerHunter, GFGuru..."
                           maxlength="30">
                    <p style="text-align: center; color: var(--text-muted); font-size: var(--text-sm); margin-top: var(--space-md);">
                        This will be shown on your beer reports
                    </p>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" data-action="skip-nickname">Skip for Now</button>
                    <button class="btn btn-primary" data-action="save-nickname">Save Nickname</button>
                </div>
            </div>
        </div>

        <!-- Add to index.html -->
        <div id="manualVenueEntryModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">‚úèÔ∏è Add Venue Manually</h3>
                    <button class="modal-close" data-action="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="manualVenueForm">
                        <div class="form-group">
                            <label class="form-label">Venue Name *</label>
                            <input type="text" id="manualVenueName" class="form-input" 
                                   placeholder="e.g. The Jolly Roger" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <input type="text" id="manualVenueAddress" class="form-input" 
                                   placeholder="e.g. 123 High Street" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">City/Town *</label>
                            <input type="text" id="manualVenueCity" class="form-input" 
                                   placeholder="e.g. Sheffield" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode *</label>
                            <input type="text" id="manualVenuePostcode" class="form-input" 
                                   placeholder="e.g. S1 2AB" required 
                                   pattern="[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? ?[0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}">
                        </div>
                        <p style="text-align: center; color: var(--text-muted); font-size: var(--text-sm);">
                            We'll try to find coordinates later
                        </p>
                    </form>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" data-action="close-modal">Cancel</button>
                    <button class="btn btn-primary" data-action="submit-manual-venue">Add Venue</button>
                </div>
            </div>
        </div>

        <!-- About Overlay -->
        <div id="aboutOverlay" class="overlay info-overlay">
            <div class="info-container">
                <div class="info-card">
                    <div class="info-header">
                        <h1 class="info-title">‚ÑπÔ∏è About Coeliacs Like Beer Too</h1>
                        <button class="info-close" data-action="close-about" aria-label="Close">√ó</button>
                    </div>
                    <div class="info-content">
                        <div class="info-section">
                            <h3>üç∫ Our Mission</h3>
                            <p>We believe that being coeliac shouldn't mean missing out on great beer experiences. Our mission is to create the UK's most comprehensive, community-driven guide to gluten free beer options across the country.</p>
                        </div>
                        <div class="info-section">
                            <h3>üë• Our Story</h3>
                            <p>Started by coeliacs, for coeliacs. We understand the frustration of walking into a venue and not knowing if they have any safe options. That's why we built this platform - to help our community find amazing gluten free beer wherever they are in the UK.</p>
                        </div>
                        <div class="info-section">
                            <h3>ü§ù Community Driven</h3>
                            <p>Every beer report, every venue update, every photo comes from real people in the coeliac community. Together, we're building something that helps everyone discover new places and feel confident about their choices.</p>
                        </div>
                        <div class="info-section">
                            <h3>üìà Growing Together</h3>
                            <p>With thousands of venues in our database and growing reports every day, we're becoming the go-to resource for gluten free beer discovery. Join us in making the UK more accessible for coeliacs!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GF Info Overlay -->
        <div id="gfInfoOverlay" class="overlay info-overlay">
            <div class="info-container">
                <div class="info-card">
                    <div class="info-header">
                        <h1 class="info-title">üî¨ What is Gluten Free Beer?</h1>
                        <button class="info-close" data-action="close-gf-info" aria-label="Close">√ó</button>
                    </div>
                    <div class="info-content">
                        <div class="info-section">
                            <h3>üß™ Official Standards</h3>
                            <div class="standards-grid">
                                <div class="standard-item">
                                    <strong>üá¨üáß UK & EU</strong>
                                    <p>Less than 20ppm gluten</p>
                                </div>
                                <div class="standard-item">
                                    <strong>üá∫üá∏ USA</strong>
                                    <p>Made only with gluten free ingredients</p>
                                </div>
                                <div class="standard-item">
                                    <strong>üá¶üá∫ Australia</strong>
                                    <p>Made only with gluten free ingredients</p>
                                </div>
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>üè∑Ô∏è Types of GF Beer</h3>
                            <div class="beer-type-item">
                                <strong>‚úÖ Certified Gluten Free</strong>
                                <p>Made from naturally gluten free grains (rice, sorghum, millet). Safest option.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>‚öóÔ∏è Gluten Removed/Reduced</strong>
                                <p>Made from barley/wheat but treated with enzymes to break down gluten. Some coeliacs react.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>üåæ "Made Without Gluten"</strong>
                                <p>No gluten ingredients added, but may have cross-contamination. Check carefully!</p>
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>‚ö†Ô∏è Important Notes</h3>
                            <ul class="safety-notes">
                                <li><strong>Cross-contamination</strong> can happen in breweries that also make regular beer</li>
                                <li><strong>Always check labels</strong> and ask staff about preparation methods</li>
                                <li><strong>Coeliacs vs Gluten Intolerant</strong> - Coeliac disease is an autoimmune condition requiring strict gluten avoidance</li>
                                <li><strong>When in doubt</strong>, choose certified gluten free options</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        

        <!-- Location Permission Modal -->
        <div id="locationPermissionModal" class="modal location-modal">
            <div class="modal-content location-permission-card">
                <div class="permission-icon">üìç</div>
                <h2 class="permission-title">Enable Location Services</h2>
                <p class="permission-text">
                    To find venues near you, we need access to your location. 
                    Your location data stays on your device and is never stored.
                </p>
                <div class="permission-benefits">
                    <div class="benefit-item">
                        <span class="benefit-icon">üéØ</span>
                        <span>Find the closest venues with GF beer</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon">üìè</span>
                        <span>See accurate distances</span>
                    </div>
                    <div class="benefit-item">
                        <span class="benefit-icon">üó∫Ô∏è</span>
                        <span>Get directions from your location</span>
                    </div>
                </div>
                <div class="permission-actions">
                    <button class="btn btn-secondary" data-action="deny-location">Not Now</button>
                    <button class="btn btn-primary" data-action="allow-location">Enable Location</button>
                </div>
                <p class="permission-note">
                    You can change this anytime in your browser settings
                </p>
            </div>
        </div>


        <!-- Location Blocked Modal -->
        <div id="locationBlockedModal" class="modal location-modal">
            <div class="modal-content location-permission-card">
                <div class="permission-icon blocked">üö´</div>
                <h2 class="permission-title">Location Access Blocked</h2>
                <p class="permission-text">
                    Your browser is currently blocking location access for this website. 
                    To find venues near you, you'll need to update your browser settings.
                    If you don't wish to share your location, please select "Search
                    by Area" below to continue.
                </p>
                
                <div class="permission-benefits blocked-instructions">
                    <h4>How to enable location:</h4>
                    
                    <div class="browser-instructions" id="browserInstructions">
                        <!-- Chrome -->
                        <div class="instruction-set" data-browser="chrome">
                            <strong>Chrome:</strong>
                            <ol>
                                <li>Click the lock icon üîí in the address bar</li>
                                <li>Find "Location" and change it to "Allow"</li>
                                <li>Refresh the page and try again</li>
                            </ol>
                        </div>
                        
                        <!-- Firefox -->
                        <div class="instruction-set" data-browser="firefox">
                            <strong>Firefox:</strong>
                            <ol>
                                <li>Click the lock icon üîí in the address bar</li>
                                <li>Click "Clear permissions and reload"</li>
                                <li>When prompted, click "Allow location access"</li>
                            </ol>
                        </div>
                        
                        <!-- Safari -->
                        <div class="instruction-set" data-browser="safari">
                            <strong>Safari:</strong>
                            <ol>
                                <li>Go to Safari ‚Üí Preferences ‚Üí Websites</li>
                                <li>Click "Location" in the sidebar</li>
                                <li>Find coeliacslikebeer.co.uk and change to "Allow"</li>
                            </ol>
                        </div>
                        
                        <!-- Edge -->
                        <div class="instruction-set" data-browser="edge">
                            <strong>Edge:</strong>
                            <ol>
                                <li>Click the lock icon üîí in the address bar</li>
                                <li>Click "Permissions for this site"</li>
                                <li>Find "Location" and change to "Allow"</li>
                            </ol>
                        </div>
                        
                        <!-- Generic -->
                        <div class="instruction-set" data-browser="generic">
                            <strong>Most browsers:</strong>
                            <ol>
                                <li>Look for a lock icon üîí in your address bar</li>
                                <li>Click it and find location settings</li>
                                <li>Change location access to "Allow"</li>
                                <li>Refresh the page and try again</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="permission-actions">
                    <button class="btn btn-secondary" data-action="close-location-blocked">Search by Area</button>
                    <button class="btn btn-primary" data-action="reload-page">Try Again</button>
                </div>
                
                <p class="permission-note">
                    Don't worry - your location data is never stored or shared
                </p>
            </div>
        </div>
        
        <!-- Toasts -->
        <div id="loadingToast" class="toast toast-loading">
            <div class="toast-content">
                <div class="spinner"></div>
                <span id="loadingMessage">Loading...</span>
            </div>
        </div>
        
        <div id="successToast" class="toast toast-success">
            <div class="toast-content">
                <span class="toast-icon">‚úÖ</span>
                <span id="successMessage">Success!</span>
            </div>
        </div>
        
        <!-- Cookie Consent -->
        <div id="cookieConsent" class="cookie-consent">
            <div class="cookie-content">
                <div class="cookie-text">
                    <h4>üç™ We use cookies</h4>
                    <p>We use essential cookies to make our site work. With your consent, we may also use analytics cookies to improve your experience.</p>
                </div>
                <div class="cookie-buttons">
                    <button data-action="accept-all-cookies" class="cookie-btn cookie-btn-accept">Accept All</button>
                    <button data-action="accept-essential-cookies" class="cookie-btn cookie-btn-essential">Essential Only</button>
                    <button data-modal="cookieSettings" class="cookie-btn cookie-btn-settings">Settings</button>
                </div>
            </div>
        </div>
        
        <div id="cookieSettings" class="modal cookie-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">üç™ Cookie Settings</h2>
                    <button class="modal-close" aria-label="Close cookie settings">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="cookie-settings-content">
                        <div class="cookie-category">
                            <div class="cookie-category-header">
                                <h3>Essential Cookies</h3>
                                <label class="cookie-toggle">
                                    <input type="checkbox" checked disabled>
                                    <span class="toggle-slider essential"></span>
                                </label>
                            </div>
                            <p>These cookies are necessary for the website to function and cannot be switched off. They are usually only set in response to actions made by you which amount to a request for services.</p>
                            <div class="cookie-details">
                                <strong>Examples:</strong> Session management, search preferences, location consent
                            </div>
                        </div>
                        <div class="cookie-category">
                            <div class="cookie-category-header">
                                <h3>Analytics Cookies</h3>
                                <label class="cookie-toggle">
                                    <input type="checkbox" id="analyticsConsent">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                            <p>These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our service.</p>
                            <div class="cookie-details">
                                <strong>Provider:</strong> Google Analytics<br>
                                <strong>Purpose:</strong> Usage statistics, popular features, performance monitoring
                            </div>
                        </div>
                        <div class="cookie-info">
                            <h4>üìã Your Rights</h4>
                            <ul>
                                <li>You can change your preferences at any time</li>
                                <li>Withdrawing consent may limit website functionality</li>
                                <li>Essential cookies cannot be disabled</li>
                                <li>See our <a href="/cookies" target="_blank">Cookie Policy</a> for full details</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button data-action="save-cookie-preferences" class="btn btn-primary">Save Preferences</button>
                        <button data-action="accept-all-from-settings" class="btn btn-success">Accept All</button>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Templates -->
        <template id="venue-result-template">
            <div class="result-item">
                <div class="result-header">
                    <div class="result-main-info">
                        <h3 class="result-title"></h3>
                        <div class="result-distance"></div>
                    </div>
                    <div class="gf-indicator"></div>
                </div>
                <div class="result-location">
                    <div class="result-address"></div>
                    <div class="result-postcode"></div>
                    <div class="result-authority"></div>
                </div>
                <div class="result-actions">
                    <button class="btn btn-primary" data-action="view-venue">üìç View Details</button>
                </div>
            </div>
        </template>

        <template id="map-legend-template">
            <div class="map-legend">
                <div class="legend-title">üç∫ GF Beer Status</div>
                <div class="legend-item">
                    <div class="legend-marker always-tap-cask"></div>
                    <span class="legend-text">Always Tap/Cask</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker always-bottle-can"></div>
                    <span class="legend-text">Always Bottles/Cans</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker currently"></div>
                    <span class="legend-text">Currently Available</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker unknown"></div>
                    <span class="legend-text">Unknown Status</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker not-currently"></div>
                    <span class="legend-text">Not Currently</span>
                </div>
                <div class="legend-item">
                    <div class="legend-marker user-location"></div>
                    <span class="legend-text">Your Location</span>
                </div>
            </div>
        </template>
        
        <template id="map-error-template">
            <div class="map-error-container">
                <div class="map-error-icon">üìç</div>
                <div class="map-error-title">Location coordinates not available</div>
                <div class="map-error-text">Help us by reporting the exact location!</div>
            </div>
        </template>
        
        <template id="popup-content-template">
            <div class="popup-content">
                <div class="popup-title" data-field="name"></div>
                <div class="popup-address" data-field="address"></div>
                <div class="popup-postcode" data-field="postcode"></div>
                <div class="popup-distance" data-field="distance"></div>
                <div class="popup-gf-status" data-field="gf-status"></div>
                <button class="popup-button" data-action="view-details">View Details</button>
            </div>
        </template>
        
        <!-- Scripts -->
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
        <script type="module" src="/static/js/main.js?v={{ cache_buster }}"></script>
        <script src="/static/js/recent-finds.js"></script>
        
        <script>
            // Essential initialization
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üîß Setting up legacy event handlers...');
                
                // Check app initialization
                setTimeout(() => {
                    if (!window.CoeliacsApp?.initialized) {
                        console.warn('‚ö†Ô∏è App initialization may have failed');
                    }
                }, 3000);
                
                // Photo upload handler
                const photoInput = document.getElementById('reportPhoto');
                const photoLabel = document.querySelector('.photo-upload-compact');
                
                if (photoInput && photoLabel) {
                    photoInput.addEventListener('change', function(e) {
                        const file = e.target.files[0];
                        if (file) {
                            const fileName = file.name.length > 20 ? 
                                file.name.substring(0, 17) + '...' : 
                                file.name;
                            
                            const textEl = photoLabel.querySelector('.photo-upload-text');
                            if (textEl) {
                                textEl.innerHTML = `<strong>üì∏ ${fileName}</strong><br><small>Click to change photo</small>`;
                            }
                            photoLabel.classList.add('active');
                        }
                    });
                }
            });
            
            // Performance monitoring
            window.addEventListener('load', function() {
                if (performance && performance.timing) {
                    setTimeout(() => {
                        const timing = performance.timing;
                        if (timing.loadEventEnd > 0 && timing.navigationStart > 0) {
                            const loadTime = timing.loadEventEnd - timing.navigationStart;
                            if (loadTime > 0 && loadTime < 60000) {
                                console.log(`‚ö° Page load time: ${loadTime}ms`);
                            }
                        }
                    }, 100);
                }
            });
            
            // Cache buster logging
            console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
            console.log('üì± User Agent:', navigator.userAgent.substring(0, 50) + '...');
            console.log('üì∫ Viewport:', window.innerWidth + 'x' + window.innerHeight);
            console.log('üåê Connection:', navigator.connection?.effectiveType || 'unknown');
        </script>

        <script>
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', async () => {
                    try {
                        const registration = await navigator.serviceWorker.register('/static/js/service-worker.js');
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            console.log('üîÑ New version available');
                            const newWorker = registration.installing;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Show update notification
                                    showUpdateNotification();
                                }
                            });
                        });
                        
                    } catch (error) {
                        console.log('‚ùå Service Worker registration failed:', error);
                    }
                });
            }
            
            // PWA Install Prompt
            let deferredPrompt;
            let installBtn;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('üì± PWA install prompt available');
                
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                
                // Save the event for later use
                deferredPrompt = e;
                
                // Show custom install button (only for non-iOS)
                if (!isIOS()) {
                    showInstallPrompt();
                }
            });
            
            // iOS Detection Functions
            function isIOS() {
                return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
            }
            
            function isStandalone() {
                return window.navigator.standalone || 
                       window.matchMedia('(display-mode: standalone)').matches;
            }
            
            // Show custom install prompt (Android/Desktop)
            function showInstallPrompt() {
                // Create install banner
                const installBanner = document.createElement('div');
                installBanner.id = 'pwa-install-banner';
                installBanner.innerHTML = `
                    <div class="install-banner-content">
                        <div class="install-icon">üì±</div>
                        <div class="install-text">
                            <strong>Install GF Beer Finder</strong>
                            <small>Get app-like experience & better location access</small>
                        </div>
                        <div class="install-actions">
                            <button class="btn btn-primary btn-sm" id="pwa-install-btn">Install</button>
                            <button class="btn btn-secondary btn-sm" id="pwa-dismiss-btn">√ó</button>
                        </div>
                    </div>
                `;
                
                // Style the banner
                installBanner.style.cssText = `
                    position: fixed;
                    top: var(--nav-height);
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 12px;
                    z-index: 1500;
                    animation: slideDown 0.3s ease;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                `;
                
                // Add CSS for the banner content
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideDown {
                        from { transform: translateY(-100%); }
                        to { transform: translateY(0); }
                    }
                    .install-banner-content {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        max-width: 100%;
                    }
                    .install-icon {
                        font-size: 1.5rem;
                    }
                    .install-text {
                        flex: 1;
                        min-width: 0;
                    }
                    .install-text strong {
                        display: block;
                        font-size: 0.9rem;
                        line-height: 1.2;
                    }
                    .install-text small {
                        opacity: 0.9;
                        font-size: 0.8rem;
                    }
                    .install-actions {
                        display: flex;
                        gap: 8px;
                    }
                    #pwa-install-btn, #pwa-dismiss-btn {
                        padding: 6px 12px;
                        border: none;
                        border-radius: 16px;
                        font-size: 0.8rem;
                        cursor: pointer;
                    }
                    #pwa-install-btn {
                        background: rgba(255,255,255,0.9);
                        color: #667eea;
                        font-weight: 600;
                    }
                    #pwa-dismiss-btn {
                        background: rgba(255,255,255,0.2);
                        color: white;
                        width: 28px;
                        padding: 6px;
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(installBanner);
                
                // Handle install button click
                document.getElementById('pwa-install-btn').addEventListener('click', async () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        const result = await deferredPrompt.userChoice;
                        
                        console.log('üì± Install prompt result:', result.outcome);
                        
                        if (result.outcome === 'accepted') {
                            console.log('‚úÖ User installed the PWA');
                        }
                        
                        deferredPrompt = null;
                    }
                    
                    installBanner.remove();
                });
                
                // Handle dismiss button
                document.getElementById('pwa-dismiss-btn').addEventListener('click', () => {
                    installBanner.style.animation = 'slideDown 0.3s ease reverse';
                    setTimeout(() => installBanner.remove(), 300);
                    
                    // Don't show again for this session
                    sessionStorage.setItem('pwa-dismissed', 'true');
                });
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    if (document.contains(installBanner)) {
                        installBanner.style.animation = 'slideDown 0.3s ease reverse';
                        setTimeout(() => installBanner.remove(), 300);
                    }
                }, 10000);
            }
            
            // iOS Install Guide
            function showIOSInstallGuide() {
                // Don't show if already installed or dismissed recently
                if (isStandalone() || sessionStorage.getItem('ios-guide-dismissed')) {
                    return;
                }
                
                const guide = document.createElement('div');
                guide.id = 'ios-install-guide';
                guide.innerHTML = `
                    <div class="ios-guide-content">
                        <div class="ios-guide-header">
                            <div class="ios-guide-icon">üì±</div>
                            <div class="ios-guide-text">
                                <strong>Install GF Beer Finder</strong>
                                <small>Get app-like experience & better location access</small>
                            </div>
                            <button class="ios-guide-close" onclick="dismissIOSGuide()">√ó</button>
                        </div>
                        
                        <div class="ios-guide-steps">
                            <div class="ios-step">
                                <span class="step-number">1</span>
                                <span class="step-icon">üì§</span>
                                <span class="step-text">Tap the Share button below</span>
                            </div>
                            <div class="ios-step">
                                <span class="step-number">2</span>
                                <span class="step-icon">‚ûï</span>
                                <span class="step-text">Select "Add to Home Screen"</span>
                            </div>
                            <div class="ios-step">
                                <span class="step-number">3</span>
                                <span class="step-icon">üç∫</span>
                                <span class="step-text">Enjoy app-like experience!</span>
                            </div>
                        </div>
                        
                        <div class="ios-guide-benefits">
                            <div class="benefit">‚ö° Faster loading</div>
                            <div class="benefit">üìç Better location access</div>
                            <div class="benefit">üîÑ Works offline</div>
                        </div>
                    </div>
                `;
                
                // Add styles for iOS guide
                const style = document.createElement('style');
                style.textContent = `
                    #ios-install-guide {
                        position: fixed;
                        top: var(--nav-height);
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        z-index: 1600;
                        animation: slideDown 0.4s ease;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    }
                    
                    .ios-guide-content {
                        padding: 12px 16px;
                    }
                    
                    .ios-guide-header {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        margin-bottom: 12px;
                    }
                    
                    .ios-guide-icon {
                        font-size: 1.5rem;
                    }
                    
                    .ios-guide-text {
                        flex: 1;
                        min-width: 0;
                    }
                    
                    .ios-guide-text strong {
                        display: block;
                        font-size: 0.95rem;
                        line-height: 1.2;
                        margin-bottom: 2px;
                    }
                    
                    .ios-guide-text small {
                        opacity: 0.9;
                        font-size: 0.8rem;
                        line-height: 1.2;
                    }
                    
                    .ios-guide-close {
                        background: rgba(255,255,255,0.2);
                        border: none;
                        color: white;
                        width: 28px;
                        height: 28px;
                        border-radius: 50%;
                        font-size: 1.1rem;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .ios-guide-steps {
                        display: flex;
                        gap: 8px;
                        margin-bottom: 12px;
                        overflow-x: auto;
                        padding: 4px 0;
                    }
                    
                    .ios-step {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                        min-width: 80px;
                        text-align: center;
                        position: relative;
                    }
                    
                    .step-number {
                        position: absolute;
                        top: -8px;
                        right: -8px;
                        background: #fbbf24;
                        color: #92400e;
                        width: 20px;
                        height: 20px;
                        border-radius: 50%;
                        font-size: 0.7rem;
                        font-weight: bold;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    
                    .step-icon {
                        font-size: 1.2rem;
                        margin-bottom: 2px;
                    }
                    
                    .step-text {
                        font-size: 0.75rem;
                        line-height: 1.2;
                        opacity: 0.95;
                    }
                    
                    .ios-guide-benefits {
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        flex-wrap: wrap;
                    }
                    
                    .benefit {
                        background: rgba(255,255,255,0.15);
                        padding: 4px 8px;
                        border-radius: 12px;
                        font-size: 0.75rem;
                        white-space: nowrap;
                    }
                    
                    /* Responsive adjustments */
                    @media (max-width: 380px) {
                        .ios-guide-content {
                            padding: 10px 12px;
                        }
                        
                        .ios-guide-steps {
                            gap: 4px;
                        }
                        
                        .ios-step {
                            min-width: 70px;
                        }
                        
                        .step-text {
                            font-size: 0.7rem;
                        }
                        
                        .ios-guide-benefits {
                            gap: 8px;
                        }
                        
                        .benefit {
                            font-size: 0.7rem;
                            padding: 3px 6px;
                        }
                    }
                `;
                document.head.appendChild(style);
                
                document.body.appendChild(guide);
                
                // Auto-dismiss after 15 seconds
                setTimeout(() => {
                    if (document.contains(guide)) {
                        dismissIOSGuide();
                    }
                }, 15000);
            }
            
            // Dismiss iOS guide
            function dismissIOSGuide() {
                const guide = document.getElementById('ios-install-guide');
                if (guide) {
                    guide.style.animation = 'slideDown 0.3s ease reverse';
                    setTimeout(() => guide.remove(), 300);
                }
                
                // Don't show again for this session
                sessionStorage.setItem('ios-guide-dismissed', 'true');
            }
            
            // Check if we should show iOS guide
            function checkIOSInstallGuide() {
                if (isIOS() && !isStandalone()) {
                    // Show after a short delay so user sees the main app first
                    setTimeout(() => {
                        showIOSInstallGuide();
                    }, 3000);
                }
            }
            
            // Show update notification
            function showUpdateNotification() {
                const updateBanner = document.createElement('div');
                updateBanner.innerHTML = `
                    <div style="
                        position: fixed;
                        bottom: var(--nav-height);
                        left: 16px;
                        right: 16px;
                        background: #667eea;
                        color: white;
                        padding: 12px;
                        border-radius: 12px;
                        z-index: 1500;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    ">
                        <strong>üöÄ New version available!</strong>
                        <button onclick="window.location.reload()" style="
                            margin-left: 12px;
                            background: white;
                            color: #667eea;
                            border: none;
                            padding: 4px 12px;
                            border-radius: 16px;
                            font-weight: 600;
                            cursor: pointer;
                        ">Update</button>
                    </div>
                `;
                
                document.body.appendChild(updateBanner);
                
                setTimeout(() => updateBanner.remove(), 5000);
            }
            
            // Handle app install success
            window.addEventListener('appinstalled', () => {
                console.log('üéâ PWA was installed successfully');
                
                // Hide install prompt if still showing
                const banner = document.getElementById('pwa-install-banner');
                if (banner) banner.remove();
                
                // Hide iOS guide if still showing
                const guide = document.getElementById('ios-install-guide');
                if (guide) guide.remove();
                
                // Show success message
                const successToast = document.createElement('div');
                successToast.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: #10b981;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        z-index: 2000;
                        text-align: center;
                        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
                    ">
                        üéâ App installed! Better location access enabled.
                    </div>
                `;
                
                document.body.appendChild(successToast);
                setTimeout(() => successToast.remove(), 3000);
            });
            
            // Detect if running as PWA
            function isPWA() {
                return window.matchMedia('(display-mode: standalone)').matches || 
                       window.navigator.standalone ||
                       document.referrer.includes('android-app://');
            }
            
            // Enhanced location permissions for PWA
            if (isPWA()) {
                console.log('üöÄ Running as PWA - enhanced features available');
                document.body.classList.add('pwa-mode');
                
                // Better location handling for PWA mode
                if ('permissions' in navigator) {
                    navigator.permissions.query({name: 'geolocation'}).then(result => {
                        console.log('üìç Location permission status:', result.state);
                    });
                }
            }
            
            // Make functions globally available
            window.dismissIOSGuide = dismissIOSGuide;
            window.isIOS = isIOS;
            window.isStandalone = isStandalone;
            
            // Initialize iOS guide check when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', checkIOSInstallGuide);
            } else {
                checkIOSInstallGuide();
            }
        </script>
    </body>
</html>
