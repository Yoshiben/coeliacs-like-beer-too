<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coeliacs Like Beer Too! - Find GF-Friendly Pubs - {{ cache_buster }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-XXXXXXXXXX'); // Replace with your actual GA4 ID
    </script>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Coeliacs Like Beer Too!</h1>
            <p class="hero-subtitle">The UK's largest community-driven guide to gluten free beer</p>
            
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalPubs">Loading...</span>
                    <span class="stat-label">UK Pubs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="gfPubs">Loading...</span>
                    <span class="stat-label">GF Options</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="monthlyReports">Loading...</span>
                    <span class="stat-label">This Month</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section" id="search">
        <h2 class="section-title">üîç Find Gluten Free Beer Near You</h2>
        <div class="search-grid">
            <div class="search-row">
                <select id="searchType" class="search-type-dropdown">
                    <option value="all">Search All</option>
                    <option value="name">Pub Name</option>
                    <option value="postcode">Postcode</option>
                    <option value="area">Local Authority</option>
                </select>
                <input type="text" id="searchInput" class="search-input" placeholder="Enter pub name, postcode, or local authority" onkeydown="if (event.key === 'Enter') searchPubs()">
                <label class="gf-checkbox"><input type="checkbox" id="gfOnly"> Gluten Free Only</label>
            </div>
            <div class="search-actions">
                <button onclick="searchPubs()" class="search-btn">Search Pubs</button>
                <button class="search-btn secondary" onclick="findNearbyPubs()">Pubs Near Me</button>
                <button class="map-control-btn" id="toggleMapBtn" onclick="toggleMap()">üó∫Ô∏è Show Map</button>
                <button class="map-control-btn" onclick="centerOnLocation()">üìç My Location</button>
            </div>
        </div>
        <div id="suggestions"></div>
    </div>

    <!-- Dynamic Results Section - Pushed down when visible -->
    <div id="results-section" style="display: none;">
        <div class="results-header">
            <h2 class="section-title">üìç Search Results</h2>
        </div>
        <ul id="results"></ul>
    </div>

    <!-- Map Section (Hidden by Default, Smart Show) -->
    <div class="map-container" id="mapContainer" style="display: none;">
        <div class="map-section-header">
            <h2 class="section-title">üó∫Ô∏è Interactive Map</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Location Status -->
    <div id="locationStatus" class="location-status location-loading" style="display: none;">
        Getting your location...
    </div>

    <!-- Features Grid -->
    <div class="features-section" id="featuresSection">
        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">‚ÑπÔ∏è</span>
                <h3 class="feature-title">About Us</h3>
                <p class="feature-description">Learn about our mission to help coeliacs find great beer across the UK.</p>
                <button class="feature-action" onclick="showAboutUs()">Learn More</button>
            </div>
            
            <!-- SWAPPED: What is GF Beer now comes before Report -->
            <div class="feature-card">
                <span class="feature-icon">üî¨</span>
                <h3 class="feature-title">What is GF Beer?</h3>
                <p class="feature-description">Everything you need to know about gluten free beer standards and safety.</p>
                <button class="feature-action" onclick="showGFInfo()">Learn More</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üì∏</span>
                <h3 class="feature-title">Report GF Beer</h3>
                <p class="feature-description">Found gluten free beer somewhere? Share it with the community and help others!</p>
                <button class="feature-action" onclick="openReportModal()">Add Report</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üè≠</span>
                <h3 class="feature-title">GF Breweries</h3>
                <p class="feature-description">Discover breweries making amazing gluten free beers and where to find them.</p>
                <button class="feature-action" onclick="showComingSoon('GF Breweries Database')">Coming Soon</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üìß</span>
                <h3 class="feature-title">Weekly Updates</h3>
                <p class="feature-description">Get notified about new GF beer finds, pub additions, and brewery news.</p>
                <button class="feature-action" onclick="showComingSoon('Newsletter')">Coming Soon</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">‚≠ê</span>
                <h3 class="feature-title">GF Beer Reviews</h3>
                <p class="feature-description">Real reviews from coeliacs - discover which beers are worth trying and which to avoid.</p>
                <button class="feature-action" onclick="showComingSoon('Beer Reviews')">Coming Soon</button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section" id="activitySection">
        <div class="activity-card">
            <div class="activity-header">
                <h2 class="activity-title">üî• Recent GF Beer Updates</h2>
                <a href="#" class="view-all" onclick="showAllActivity()">View All</a>
            </div>
            
            <div id="recentActivity">
                <div class="activity-item">
                    <div class="activity-avatar">üç∫</div>
                    <div class="activity-content">
                        <div class="activity-text">Welcome to the community! Start by searching for pubs near you.</div>
                        <div class="activity-time">Search above to see real pub data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Report GF Beer Modal -->
    <div id="reportModal" class="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Report GF Beer Find</h2>
                <button class="close-modal" onclick="closeReportModal()">&times;</button>
            </div>
            
            <form id="reportForm" class="report-form">
                <div class="form-group">
                    <label>Find Your Pub *</label>
                    <input type="text" id="reportPubSearch" required placeholder="Start typing pub name..." autocomplete="off">
                    <div id="pubSuggestions" class="pub-suggestions"></div>
                    <small>Search for an existing pub first - we'll check our database!</small>
                </div>
                
                <div id="selectedPubInfo" class="selected-pub-info" style="display: none;">
                    <div class="selected-pub-card">
                        <strong id="selectedPubName"></strong>
                        <div id="selectedPubAddress"></div>
                        <button type="button" onclick="clearSelectedPub()" class="btn-clear">Choose Different Pub</button>
                    </div>
                </div>
                
                <div id="newPubFields" class="new-pub-fields" style="display: none;">
                    <h4>üìç Add New Pub</h4>
                    <div class="form-group">
                        <label>Pub Name *</label>
                        <input type="text" id="reportPubName" placeholder="The Red Lion">
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <input type="text" id="reportAddress" placeholder="123 High Street">
                    </div>
                    <div class="form-group">
                        <label>Postcode *</label>
                        <input type="text" id="reportPostcode" placeholder="SW1A 1AA">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Beer Format *</label>
                    <select id="reportFormat" required>
                        <option value="">Select format...</option>
                        <option value="bottle">üç∫ Bottle</option>
                        <option value="tap">üö∞ Tap</option>
                        <option value="cask">üõ¢Ô∏è Cask</option>
                        <option value="can">ü•´ Can</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Brewery</label>
                    <input type="text" id="reportBrewery" placeholder="Brewdog">
                </div>
                
                <div class="form-group">
                    <label>Beer Name</label>
                    <input type="text" id="reportBeerName" placeholder="Punk AF">
                </div>
                
                <div class="form-group">
                    <label>Beer Style</label>
                    <input type="text" id="reportBeerStyle" placeholder="IPA">
                </div>
                
                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="reportPhoto" accept="image/*">
                    <small>Share a photo of the beer or menu</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeReportModal()" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn-submit">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- About Us Modal -->
    <div id="aboutModal" class="report-modal">
        <div class="modal-content about-modal-content">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è About Coeliacs Like Beer Too</h2>
                <button class="close-modal" onclick="closeAboutModal()">&times;</button>
            </div>
            
            <div class="about-content">
                <div class="about-section">
                    <h3>üç∫ Our Mission</h3>
                    <p>We believe that being coeliac shouldn't mean missing out on great beer experiences. Our mission is to create the UK's most comprehensive, community-driven guide to gluten free beer options across the country.</p>
                </div>
                
                <div class="about-section">
                    <h3>üë• Our Story</h3>
                    <p>Started by coeliacs, for coeliacs. We understand the frustration of walking into a pub and not knowing if they have any safe options. That's why we built this platform - to help our community find amazing gluten free beer wherever they are in the UK.</p>
                </div>
                
                <div class="about-section">
                    <h3>ü§ù Community Driven</h3>
                    <p>Every beer report, every pub update, every photo comes from real people in the coeliac community. Together, we're building something that helps everyone discover new places and feel confident about their choices.</p>
                </div>
                
                <div class="about-section">
                    <h3>üìà Growing Together</h3>
                    <p>With thousands of pubs in our database and growing reports every day, we're becoming the go-to resource for gluten free beer discovery. Join us in making the UK more accessible for coeliacs!</p>
                </div>
                
                <div class="contact-info">
                    <h3>üí¨ Get in Touch</h3>
                    <p>Questions, suggestions, or partnership opportunities? We'd love to hear from you!</p>
                    <button onclick="showComingSoon('Contact Form')" class="btn-contact">Contact Us</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GF Info Modal -->
    <div id="gfInfoModal" class="report-modal">
        <div class="modal-content gf-modal-content">
            <div class="modal-header">
                <h2>üî¨ What is Gluten Free Beer?</h2>
                <button class="close-modal" onclick="closeGFInfoModal()">&times;</button>
            </div>
            
            <div class="gf-content">
                <div class="gf-section">
                    <h3>üß™ Official Standards</h3>
                    <div class="standards-grid">
                        <div class="standard-item">
                            <strong>üá¨üáß UK & EU</strong>
                            <p>Less than 20ppm gluten</p>
                        </div>
                        <div class="standard-item">
                            <strong>üá∫üá∏ USA</strong>
                            <p>Less than 20ppm gluten</p>
                        </div>
                        <div class="standard-item">
                            <strong>üá¶üá∫ Australia</strong>
                            <p>Less than 5ppm gluten (stricter!)</p>
                        </div>
                    </div>
                </div>
                
                <div class="gf-section">
                    <h3>üè∑Ô∏è Types of GF Beer</h3>
                    <div class="beer-types">
                        <div class="beer-type-item">
                            <strong>‚úÖ Certified Gluten Free</strong>
                            <p>Made from naturally gluten free grains (rice, sorghum, millet). Safest option.</p>
                        </div>
                        <div class="beer-type-item">
                            <strong>‚öóÔ∏è Gluten Removed/Reduced</strong>
                            <p>Made from barley/wheat but treated with enzymes to break down gluten. Some coeliacs react.</p>
                        </div>
                        <div class="beer-type-item">
                            <strong>üåæ "Made Without Gluten"</strong>
                            <p>No gluten ingredients added, but may have cross-contamination. Check carefully!</p>
                        </div>
                    </div>
                </div>
                
                <div class="gf-section">
                    <h3>‚ö†Ô∏è Important Notes</h3>
                    <ul class="safety-notes">
                        <li><strong>Cross-contamination</strong> can happen in breweries that also make regular beer</li>
                        <li><strong>Always check labels</strong> and ask staff about preparation methods</li>
                        <li><strong>Coeliacs vs Gluten Intolerant</strong> - Coeliac disease is an autoimmune condition requiring strict gluten avoidance, while gluten intolerance is a separate digestive sensitivity</li>
                        <li><strong>When in doubt</strong>, choose certified gluten free options</li>
                    </ul>
                </div>
                
                <div class="gf-section">
                    <h3>üç∫ Popular GF Beer Brands in UK</h3>
                    <div class="brand-grid">
                        <span class="brand-tag">Brewdog (GF Range)</span>
                        <span class="brand-tag">Glutenberg</span>
                        <span class="brand-tag">Omission</span>
                        <span class="brand-tag">Stella Artois (GF)</span>
                        <span class="brand-tag">Ghostfish</span>
                        <span class="brand-tag">Ground Breaker</span>
                    </div>
                </div>
                
                <div class="disclaimer">
                    <p><strong>Disclaimer:</strong> This information is for guidance only. Always consult with healthcare professionals and verify product safety for your individual needs.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Coordinate Modal -->
    <div id="coordinateModal" class="coordinate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalPubName">Help us locate this pub!</h2>
                <p>We'll search near the postcode and you can click to pinpoint the exact location.</p>
            </div>
            
            <div class="modal-instructions">
                <span id="modalInstructions">üó∫Ô∏è Searching for the pub area...</span>
            </div>
            
            <div id="coordinateMap" class="modal-map"></div>
            
            <div id="selectedLocationInfo" class="selected-location" style="display: none;">
                <div>üìç Selected location:</div>
                <div class="coordinates" id="selectedCoordinates"></div>
            </div>
            
            <div class="modal-buttons">
                <button id="confirmLocation" class="modal-button confirm-button">
                    ‚úÖ Confirm Location
                </button>
                <button id="cancelModal" class="modal-button cancel-button">
                    ‚ùå Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Toast -->
    <div id="loadingToast" class="toast loading-toast" style="display: none;">
        <div class="toast-content">
            <div class="spinner"></div>
            <span id="loadingMessage">Loading...</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="toast success-toast" style="display: none;">
        <div class="toast-content">
            <span class="toast-icon">‚úÖ</span>
            <span id="successMessage">Success!</span>
        </div>
    </div>

    <script>
        // Cache-busting timestamp
        console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
        
        var map;
        var userLocation = null;
        var pubMarkers = [];
        var userMarker = null;

        // Smart coordinate modal variables
        var coordinateMap;
        var selectedMarker;
        var currentPub;
        var selectedCoordinates = null;

        // Global pagination variables
        let currentPage = 1;
        let currentQuery = '';
        let currentSearchType = 'all';
        let currentGfOnly = false;

        // ================================
        // TOAST NOTIFICATION SYSTEM
        // ================================
        
        function showLoadingToast(message = 'Loading...') {
            const toast = document.getElementById('loadingToast');
            document.getElementById('loadingMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
        }

        function hideLoadingToast() {
            const toast = document.getElementById('loadingToast');
            toast.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }

        function showSuccessToast(message = 'Success!') {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-in';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // ================================
        // GOOGLE ANALYTICS TRACKING
        // ================================
        
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }

        function trackSearch(query, searchType, results) {
            trackEvent('search', 'Search', `${searchType}: ${query} (${results} results)`);
        }

        function trackPubView(pubName) {
            trackEvent('pub_view', 'Pub Interaction', pubName);
        }

        // ================================
        // ENHANCED UI FUNCTIONS
        // ================================
        
        let selectedPubData = null;
        let pubSearchTimeout = null;
        let mapVisible = false;
        
        function scrollToSearch() {
            document.getElementById('search').scrollIntoView({ behavior: 'smooth' });
        }

        // SMART MAP TOGGLE - Auto-show when needed
        function toggleMap() {
            mapVisible = !mapVisible;
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');
            
            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                
                // Initialize map if not already done, or resize if it exists
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
                
                // Smooth scroll to show the map
                setTimeout(() => {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
            }
            
            AppState.save();
        }

        // SMART MAP SHOWING - Auto show map when needed
        function smartShowMap() {
            if (!mapVisible) {
                toggleMap();
            }
        }

        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            trackEvent('open_report_modal', 'Modal');
            // Focus on pub search field
            setTimeout(() => {
                document.getElementById('reportPubSearch').focus();
            }, 100);
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('reportForm').reset();
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('newPubFields').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
        }

        function showAboutUs() {
            document.getElementById('aboutModal').style.display = 'block';
            trackEvent('open_about_modal', 'Modal');
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        function showGFInfo() {
            document.getElementById('gfInfoModal').style.display = 'block';
            trackEvent('open_gf_info_modal', 'Modal');
        }

        function closeGFInfoModal() {
            document.getElementById('gfInfoModal').style.display = 'none';
        }

        function showComingSoon(feature) {
            trackEvent('coming_soon_click', 'Feature Interest', feature);
            showSuccessToast(`${feature} is coming soon! üöÄ We're working hard to bring you this feature.`);
        }

        function showAllActivity() {
            trackEvent('view_all_activity', 'Navigation');
            showSuccessToast('Full activity feed coming soon! üìä This will show all recent GF beer finds.');
        }

        // SMART RESULTS SECTION - Pushes content down
        function showResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'block';
            
            // Add margin to push content down
            featuresSection.style.marginTop = '40px';
            activitySection.style.marginTop = '40px';
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'none';
            
            // Remove margin
            featuresSection.style.marginTop = '0';
            activitySection.style.marginTop = '0';
        }

        // Enhanced pub search functionality
        function searchPubsForReport(query) {
            if (query.length < 2) {
                document.getElementById('pubSuggestions').style.display = 'none';
                return;
            }

            // Debounce the search
            clearTimeout(pubSearchTimeout);
            pubSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/autocomplete?q=${encodeURIComponent(query)}&search_type=name&limit=5`);
                    if (!response.ok) return;
                    
                    const pubs = await response.json();
                    const suggestions = document.getElementById('pubSuggestions');
                    
                    if (pubs.length === 0) {
                        suggestions.innerHTML = `
                            <div class="no-pub-found">
                                <strong>üè™ Pub not found in our database</strong>
                                <button type="button" onclick="showNewPubFields()" class="btn-add-new">Add New Pub</button>
                            </div>
                        `;
                        suggestions.style.display = 'block';
                        return;
                    }
                    
                    suggestions.innerHTML = '';
                    pubs.forEach(pub => {
                        const div = document.createElement('div');
                        div.className = 'pub-suggestion-item';
                        div.innerHTML = `
                            <strong>${pub.name}</strong>
                            <div>${pub.address}, ${pub.postcode}</div>
                        `;
                        div.onclick = () => selectExistingPub(pub);
                        suggestions.appendChild(div);
                    });
                    
                    // Add "Not here?" option
                    const notFoundDiv = document.createElement('div');
                    notFoundDiv.className = 'pub-suggestion-item add-new';
                    notFoundDiv.innerHTML = `
                        <strong>üè™ Don't see your pub?</strong>
                        <div>Add a new pub to our database</div>
                    `;
                    notFoundDiv.onclick = () => showNewPubFields();
                    suggestions.appendChild(notFoundDiv);
                    
                    suggestions.style.display = 'block';
                } catch (error) {
                    console.error('Error searching pubs:', error);
                }
            }, 300);
        }

        function selectExistingPub(pub) {
            selectedPubData = pub;
            document.getElementById('selectedPubName').textContent = pub.name;
            document.getElementById('selectedPubAddress').textContent = `${pub.address}, ${pub.postcode}`;
            document.getElementById('selectedPubInfo').style.display = 'block';
            document.getElementById('newPubFields').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
            document.getElementById('reportPubSearch').value = pub.name;
            trackEvent('select_existing_pub', 'Report Flow', pub.name);
        }

        function clearSelectedPub() {
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('reportPubSearch').value = '';
            document.getElementById('reportPubSearch').focus();
        }

        function showNewPubFields() {
            const query = document.getElementById('reportPubSearch').value;
            document.getElementById('newPubFields').style.display = 'block';
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
            trackEvent('add_new_pub', 'Report Flow');
            
            // Pre-fill with search query if available
            if (query) {
                document.getElementById('reportPubName').value = query;
            }
            
            // Focus on address field
            setTimeout(() => {
                document.getElementById('reportAddress').focus();
            }, 100);
        }

        function addToRecentActivity(report) {
            const activityContainer = document.getElementById('recentActivity');
            const newActivity = document.createElement('div');
            newActivity.className = 'activity-item';
            
            const pubName = selectedPubData ? selectedPubData.name : report.pubName;
            newActivity.innerHTML = `
                <div class="activity-avatar">üì∏</div>
                <div class="activity-content">
                    <div class="activity-text"><strong>You</strong> reported <strong>${report.brewery} ${report.beerName}</strong> at ${pubName}</div>
                    <div class="activity-time">Just now</div>
                </div>
            `;
            activityContainer.insertBefore(newActivity, activityContainer.firstChild);
        }

        // DYNAMIC STATS LOADING FROM DATABASE
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/stats');
                if (response.ok) {
                    const stats = await response.json();
                    
                    // Animate the numbers counting up
                    animateNumber('totalPubs', stats.total_pubs);
                    animateNumber('gfPubs', stats.gf_pubs);
                    animateNumber('monthlyReports', stats.monthly_reports);
                } else {
                    // Fallback to mock data if API not ready
                    animateNumber('totalPubs', 52847);
                    animateNumber('gfPubs', 1249);
                    animateNumber('monthlyReports', 847);
                }
            } catch (error) {
                console.log('Stats API not ready, using mock data');
                // Fallback numbers for beta
                animateNumber('totalPubs', 52847);
                animateNumber('gfPubs', 1249);
                animateNumber('monthlyReports', 847);
            }
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const startNumber = 0;
            const duration = 2000; // 2 seconds
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease out animation
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOut);
                
                element.textContent = currentNumber.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // ================================
        // CORE FUNCTIONALITY
        // ================================

        // State management for refresh persistence
        const AppState = {
            save: function(pubId = null) {
                const state = {
                    query: currentQuery,
                    searchType: currentSearchType,
                    gfOnly: currentGfOnly,
                    page: currentPage,
                    mapVisible: mapVisible,
                    specificPubId: pubId || null,
                    timestamp: Date.now()
                };
                window.location.hash = btoa(JSON.stringify(state));
            },
            
            load: function() {
                try {
                    if (window.location.hash) {
                        const state = JSON.parse(atob(window.location.hash.substring(1)));
                        if (Date.now() - state.timestamp < 3600000) {
                            return state;
                        }
                    }
                } catch (e) {
                    console.log('No valid state to restore');
                }
                return null;
            },
            
            restore: async function() {
                const state = this.load();
                if (state) {
                    console.log('Restoring state:', state);
                    
                    document.getElementById('searchInput').value = state.query || '';
                    document.getElementById('searchType').value = state.searchType || 'all';
                    document.getElementById('gfOnly').checked = state.gfOnly || false;
                    
                    currentQuery = state.query || '';
                    currentSearchType = state.searchType || 'all';
                    currentGfOnly = state.gfOnly || false;
                    currentPage = state.page || 1;
                    mapVisible = state.mapVisible || false;
                    
                    const mapContainer = document.getElementById('mapContainer');
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    if (mapVisible) {
                        mapContainer.style.display = 'block';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                    } else {
                        mapContainer.style.display = 'none';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                    }
                    
                    if (state.specificPubId) {
                        console.log('Restoring specific pub:', state.specificPubId);
                        await searchSpecificPub(state.specificPubId);
                    } else if (state.query) {
                        console.log('Restoring search query:', state.query);
                        await loadPage(state.page);
                    }
                }
            }
        };

        // Debounce function to limit rapid requests
        let debounceTimeout;
        function debounce(func, wait) {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get user's location
        function getUserLocation() {
            const statusEl = document.getElementById('locationStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'location-status location-loading';
            statusEl.textContent = 'Getting your location...';

            if (!navigator.geolocation) {
                statusEl.className = 'location-status location-error';
                statusEl.textContent = 'Geolocation not supported by this browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    statusEl.className = 'location-status location-success';
                    statusEl.textContent = 'Location found! Click "Pubs Near Me" to see what\'s around you.';
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('You are here!')
                        .openPopup();
                    
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                },
                (error) => {
                    let errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    statusEl.className = 'location-status location-error';
                    statusEl.textContent = errorMessage;
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            );
        }

        // ENHANCED Find nearby pubs with smart map showing
        async function findNearbyPubs() {
            if (!userLocation) {
                showSuccessToast('Getting your location first...');
                getUserLocation();
                return;
            }

            trackEvent('find_nearby_pubs', 'Location Search');
            smartShowMap(); // Auto-show map
            
            const gfOnly = document.getElementById('gfOnly').checked;
            const radius = 5;
            
            showResultsSection();
            showLoadingToast('Finding nearby pubs...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Finding nearby pubs...</li>';
            
            map.setView([userLocation.lat, userLocation.lng], 14);
            
            try {
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&gf_only=${gfOnly}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const nearbyPubs = await response.json();
                
                if (nearbyPubs.error) {
                    throw new Error(nearbyPubs.error);
                }
                
                hideLoadingToast();
                displaySearchResults(nearbyPubs);
                addPubMarkersToMap(nearbyPubs);
                
                showSuccessToast(`Found ${nearbyPubs.length} pubs near you!`);
                trackSearch('nearby', 'location', nearbyPubs.length);
                
                if (nearbyPubs.length > 0) {
                    const allPoints = [];
                    allPoints.push([userLocation.lat, userLocation.lng]);
                    
                    nearbyPubs.forEach(pub => {
                        if (pub.latitude && pub.longitude) {
                            allPoints.push([parseFloat(pub.latitude), parseFloat(pub.longitude)]);
                        }
                    });
                    
                    if (allPoints.length > 1) {
                        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
                
                currentQuery = '';
                currentSearchType = 'all';
                currentGfOnly = gfOnly;
                currentPage = 1;
                AppState.save();
                
            } catch (error) {
                console.error('Error finding nearby pubs:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error finding nearby pubs. Please try again.</li>';
                showSuccessToast('Error finding nearby pubs. Please try again.');
            }
        }

        // ENHANCED centerOnLocation with smart map showing
        function centerOnLocation() {
            trackEvent('center_on_location', 'Map Interaction');
            smartShowMap(); // Auto-show map
            
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 14);
                showSuccessToast('Centered on your location!');
            } else {
                getUserLocation();
            }
        }

        // Add pub markers to map
        function addPubMarkersToMap(pubs) {
            // Clear existing markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];

            pubs.forEach(pub => {
                if (pub.latitude && pub.longitude) {
                    const hasGF = pub.bottle || pub.tap || pub.cask || pub.can;
                    const markerColor = hasGF ? '#4CAF50' : '#757575';
                    
                    const marker = L.circleMarker([pub.latitude, pub.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    let popupContent = `<strong>${pub.name}</strong><br>`;
                    popupContent += `${pub.address}<br>`;
                    if (pub.distance !== undefined) {
                        popupContent += `<em>${pub.distance.toFixed(2)} km away</em><br>`;
                    }
                    
                    if (hasGF) {
                        let gfOptions = [];
                        if (pub.bottle) gfOptions.push('Bottle');
                        if (pub.tap) gfOptions.push('Tap');
                        if (pub.cask) gfOptions.push('Cask');
                        if (pub.can) gfOptions.push('Can');
                        popupContent += `<br><strong>GF Options:</strong> ${gfOptions.join(', ')}`;
                    } else {
                        popupContent += '<br><em>No GF options recorded</em>';
                    }

                    marker.bindPopup(popupContent);
                    pubMarkers.push(marker);
                }
            });
        }

        // Smart coordinate modal functions
        function openCoordinateModal(pubName, postcode, pubId) {
            currentPub = { name: pubName, postcode: postcode, id: pubId };
            
            document.getElementById('modalPubName').textContent = `Help us locate ${pubName}!`;
            document.getElementById('coordinateModal').style.display = 'block';
            document.getElementById('modalInstructions').textContent = 'üó∫Ô∏è Searching for the pub area...';
            document.getElementById('selectedLocationInfo').style.display = 'none';
            document.getElementById('confirmLocation').classList.remove('active');
            selectedCoordinates = null;
            
            setTimeout(() => {
                if (coordinateMap) {
                    coordinateMap.remove();
                }
                
                coordinateMap = L.map('coordinateMap').setView([51.505, -0.09], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(coordinateMap);
                
                searchPostcodeLocation(postcode);
                coordinateMap.on('click', onMapClick);
            }, 100);
        }

        async function searchPostcodeLocation(postcode) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(postcode)}&countrycodes=gb&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    coordinateMap.setView([lat, lng], 16);
                    
                    L.circle([lat, lng], {
                        radius: 200,
                        fillColor: '#667eea',
                        fillOpacity: 0.1,
                        color: '#667eea',
                        weight: 2,
                        opacity: 0.3
                    }).addTo(coordinateMap);
                    
                    document.getElementById('modalInstructions').innerHTML = 
                        `üìç Found ${postcode}! Click on the map where <strong>${currentPub.name}</strong> is located.`;
                } else {
                    throw new Error('Postcode not found');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                coordinateMap.setView([54.5, -2], 6);
                document.getElementById('modalInstructions').innerHTML = 
                    `üîç Couldn't find ${postcode}. Please zoom to the area and click where <strong>${currentPub.name}</strong> is located.`;
            }
        }

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (selectedMarker) {
                coordinateMap.removeLayer(selectedMarker);
            }
            
            selectedMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">üìç</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(coordinateMap);
            
            selectedMarker.bindPopup(`<strong>${currentPub.name}</strong><br>Is this the correct location?`).openPopup();
            
            selectedCoordinates = { lat: lat.toFixed(6), lng: lng.toFixed(6) };
            
            document.getElementById('selectedCoordinates').textContent = 
                `${selectedCoordinates.lat}, ${selectedCoordinates.lng}`;
            document.getElementById('selectedLocationInfo').style.display = 'block';
            document.getElementById('confirmLocation').classList.add('active');
            document.getElementById('modalInstructions').innerHTML = 
                `‚úÖ Great! Is this where <strong>${currentPub.name}</strong> is located?`;
        }

        async function confirmLocation() {
            if (!selectedCoordinates) return;
            
            try {
                const response = await fetch('/update_coordinates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pub_id: currentPub.id,
                        latitude: parseFloat(selectedCoordinates.lat),
                        longitude: parseFloat(selectedCoordinates.lng)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessToast(`üéâ Thank you! ${currentPub.name} has been located on the map.`);
                    closeCoordinateModal();
                    trackEvent('coordinate_confirmed', 'Community Contribution', currentPub.name);
                    
                    if (userLocation) {
                        findNearbyPubs();
                    } else {
                        searchSpecificPub(currentPub.id);
                    }
                } else {
                    showSuccessToast('Error saving location: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving coordinates:', error);
                showSuccessToast('Error saving location. Please try again.');
            }
        }

        function closeCoordinateModal() {
            document.getElementById('coordinateModal').style.display = 'none';
            if (coordinateMap) {
                coordinateMap.remove();
                coordinateMap = null;
            }
            selectedMarker = null;
            selectedCoordinates = null;
        }

        // ENHANCED findOnMap with smart map showing
        function findOnMap(lat, lng, pubName, postcode, pubId) {
            trackPubView(pubName);
            smartShowMap(); // Auto-show map
            
            if (lat && lng && lat !== 'null' && lng !== 'null' && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                map.setView([parseFloat(lat), parseFloat(lng)], 16);
                
                const highlightMarker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                    radius: 12,
                    fillColor: '#ff6b6b',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                highlightMarker.bindPopup(`<strong>${pubName}</strong><br><em>You searched for this pub!</em>`).openPopup();
                showSuccessToast(`Found ${pubName} on the map!`);
                
                setTimeout(() => {
                    map.removeLayer(highlightMarker);
                }, 5000);
            } else {
                openCoordinateModal(pubName, postcode, pubId);
            }
        }

        function searchForPub(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            trackEvent('search_online', 'External Search', pubName);
            window.open(googleUrl, '_blank');
        }

        function formatBeerDetails(beerDetails) {
            if (!beerDetails || beerDetails === 'None' || beerDetails.trim() === '') {
                return '<div style="color: #9ca3af; font-style: italic;">No beers recorded yet</div>';
            }
            
            return beerDetails.split(', ').map(beer => {
                const parts = beer.split(' - ');
                if (parts.length >= 2) {
                    const format = parts[0];
                    const details = parts.slice(1).join(' - ');
                    return `<div class="beer-item"><span class="beer-type">${format.charAt(0).toUpperCase() + format.slice(1)}:</span> ${details}</div>`;
                }
                return `<div class="beer-item">${beer}</div>`;
            }).join('');
        }

        // Display search results with pagination
        function displaySearchResults(data, append = false) {
            console.log('displaySearchResults called with pagination support!');
            const results = document.getElementById('results');
            
            const pubs = Array.isArray(data) ? data : data.pubs;
            const pagination = data.pagination || null;
            
            if (!append) {
                results.innerHTML = '';
            }
            
            if (pubs.length === 0 && !append) {
                results.innerHTML = '<li class="no-results">No pubs found.</li>';
                return;
            }
            
            pubs.forEach(pub => {
                console.log('Processing pub:', pub);
                const li = document.createElement('li');
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('Bottle');
                if (pub.tap) gfOptions.push('Tap');
                if (pub.cask) gfOptions.push('Cask');
                if (pub.can) gfOptions.push('Can');
                
                const gfText = gfOptions.length > 0 ? gfOptions.join(', ') : 'None';
                const beerDetails = pub.beer_details || 'None';
                
                let detailsDistanceText = '';
                const lat = parseFloat(pub.latitude);
                const lng = parseFloat(pub.longitude);
                
                if (userLocation && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        lat, lng
                    );
                    detailsDistanceText = `<div style="color: #667eea; font-size: 14px; font-weight: 600; margin: 8px 0;">${distance.toFixed(2)} km from your location</div>`;
                }

                li.className = 'result-item';
                li.innerHTML = `
                    <div class="result-details">
                        <strong>${pub.name}</strong>
                        <div class="address">${pub.address}, ${pub.postcode}</div>
                        <div class="local-authority">${pub.local_authority}</div>
                        ${detailsDistanceText}
                        <div style="margin-top: 10px;">
                            <button onclick="searchForPub('${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}')" 
                                    style="margin-right: 8px; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                                Find Online
                            </button>
                            <button onclick="findOnMap(${pub.latitude || 'null'}, ${pub.longitude || 'null'}, '${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}', ${pub.pub_id})" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                Find on Map
                            </button>
                        </div>
                    </div>
                    <div class="beer-column">
                        <h4>Available Beers</h4>
                        <div class="beer-details">
                            ${formatBeerDetails(beerDetails)}
                        </div>
                    </div>
                    <div class="button-column">
                        <button class="update-button" onclick="toggleUpdateForm(${pub.pub_id})">Update</button>
                    </div>
                    <div class="update-form" id="form-${pub.pub_id}" style="display: none;">
                        <div class="update-mode">
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="add" checked> Add New Beers</label>
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="replace"> Replace All Beers</label>
                        </div>
                        <div class="beer-options-grid">
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="bottle-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'bottle')">
                                        <span class="beer-icon">üç∫</span> Bottle
                                    </label>
                                </div>
                                <div id="beer-input-bottle-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-bottle-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-bottle-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-bottle-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="tap-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'tap')">
                                        <span class="beer-icon">üö∞</span> Tap
                                    </label>
                                </div>
                                <div id="beer-input-tap-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-tap-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-tap-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-tap-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="cask-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'cask')">
                                        <span class="beer-icon">üõ¢Ô∏è</span> Cask
                                    </label>
                                </div>
                                <div id="beer-input-cask-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-cask-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-cask-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-cask-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="can-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'can')">
                                        <span class="beer-icon">ü•´</span> Can
                                    </label>
                                </div>
                                <div id="beer-input-can-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-can-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-can-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-can-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="save-button-container">
                            <button class="save-beer-btn" onclick="submitUpdate(${pub.pub_id})">
                                <span class="save-icon">üíæ</span> Save Beer Updates
                            </button>
                        </div>
                    </div>
                `;
                results.appendChild(li);
                updateBeerInputs(pub.pub_id);
            });
            
            if (pagination && !append) {
                addPaginationControls(pagination);
            }
        }

        function addPaginationControls(pagination) {
            const results = document.getElementById('results');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';
            paginationDiv.innerHTML = `
                <div class="pagination-info">
                    Showing page ${pagination.page} of ${pagination.pages} (${pagination.total} total results)
                </div>
                <div class="pagination-buttons">
                    ${pagination.has_prev ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">‚Üê Previous</button>` : ''}
                    ${pagination.page > 2 ? `<button onclick="loadPage(1)" class="pagination-btn">1</button>` : ''}
                    ${pagination.page > 3 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page > 1 ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">${pagination.page - 1}</button>` : ''}
                    <button class="pagination-btn active">${pagination.page}</button>
                    ${pagination.page < pagination.pages ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">${pagination.page + 1}</button>` : ''}
                    ${pagination.page < pagination.pages - 2 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page < pagination.pages - 1 ? `<button onclick="loadPage(${pagination.pages})" class="pagination-btn">${pagination.pages}</button>` : ''}
                    ${pagination.has_next ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">Next ‚Üí</button>` : ''}
                </div>
            `;
            results.appendChild(paginationDiv);
        }

        async function loadPage(page) {
            currentPage = page;
            const url = `/search?query=${encodeURIComponent(currentQuery)}&search_type=${currentSearchType}&page=${page}` + (currentGfOnly ? '&gf_only=true' : '');
            
            showLoadingToast('Loading page...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading...</li>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                hideLoadingToast();
                displaySearchResults(data);
                addPubMarkersToMap(data.pubs || data);
                
                AppState.save();
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading page:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading results. Please try again.</li>';
            }
        }

        async function searchSpecificPub(pubId) {
            console.log('searchSpecificPub called with ID:', pubId);
            showLoadingToast('Loading pub details...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading pub details...</li>';
            
            try {
                const url = `/search?pub_id=${pubId}`;
                console.log('Fetching URL:', url);
                const response = await fetch(url);
                const pubs = await response.json();
                
                console.log('Response from server:', pubs);
                hideLoadingToast();
                
                if (pubs.length > 0) {
                    console.log('Calling displaySearchResults with:', pubs);
                    displaySearchResults(pubs);
                    addPubMarkersToMap(pubs);
                    
                    const pub = pubs[0];
                    trackPubView(pub.name);
                    
                    if (pub.latitude && pub.longitude) {
                        smartShowMap();
                        map.setView([pub.latitude, pub.longitude], 15);
                    }
                    
                    currentQuery = '';
                    currentSearchType = 'all';
                    currentGfOnly = false;
                    currentPage = 1;
                    AppState.save(pubId);
                } else {
                    results.innerHTML = '<li class="no-results">Pub not found.</li>';
                }
            } catch (error) {
                console.error('Error searching for specific pub:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading pub details.</li>';
            }
        }

        function toggleUpdateForm(pubId) {
            const form = document.getElementById(`form-${pubId}`);
            const isVisible = form.style.display === 'block';
            form.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateBeerInputs(pubId);
                trackEvent('open_update_form', 'User Interaction', `pub_${pubId}`);
            }
        }

        function updateBeerInputs(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked;
            const tap = document.getElementById(`tap-${pubId}`).checked;
            const cask = document.getElementById(`cask-${pubId}`).checked;
            const can = document.getElementById(`can-${pubId}`).checked;

            document.getElementById(`beer-input-bottle-${pubId}`).style.display = bottle ? 'block' : 'none';
            document.getElementById(`beer-input-tap-${pubId}`).style.display = tap ? 'block' : 'none';
            document.getElementById(`beer-input-cask-${pubId}`).style.display = cask ? 'block' : 'none';
            document.getElementById(`beer-input-can-${pubId}`).style.display = can ? 'block' : 'none';
        }

        function handleCheckboxChange(pubId, type) {
            const checkbox = document.getElementById(`${type}-${pubId}`);
            const inputContainer = document.getElementById(`beer-input-${type}-${pubId}`);
            inputContainer.style.display = checkbox.checked ? 'block' : 'none';
            if (checkbox.checked) {
                inputContainer.querySelector('input').focus();
                trackEvent('select_beer_format', 'Beer Update', type);
            }
        }

        async function submitUpdate(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked ? 1 : 0;
            const tap = document.getElementById(`tap-${pubId}`).checked ? 1 : 0;
            const cask = document.getElementById(`cask-${pubId}`).checked ? 1 : 0;
            const can = document.getElementById(`can-${pubId}`).checked ? 1 : 0;
            const updateMode = document.querySelector(`input[name="updateMode-${pubId}"]:checked`)?.value || 'add';

            showLoadingToast('Saving beer updates...');

            const updates = [];
            if (bottle) {
                const brewery = document.getElementById(`brewery-bottle-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-bottle-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-bottle-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'bottle', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (tap) {
                const brewery = document.getElementById(`brewery-tap-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-tap-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-tap-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'tap', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (cask) {
                const brewery = document.getElementById(`brewery-cask-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-cask-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-cask-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'cask', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (can) {
                const brewery = document.getElementById(`brewery-can-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-can-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-can-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'can', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }

            try {
                const updateResponse = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pub_id: pubId, bottle, tap, cask, can })
                });

                if (updates.length > 0) {
                    await fetch('/update_beers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pub_id: pubId, updates, update_mode: updateMode })
                    });
                }

                const result = await updateResponse.json();
                hideLoadingToast();
                showSuccessToast(result.message || 'Beer updates saved successfully!');
                trackEvent('submit_beer_update', 'Community Contribution', `pub_${pubId}`);
                
                const form = document.getElementById(`form-${pubId}`);
                form.style.display = 'none';
                
                // Refresh the pub data to show updates
                await searchSpecificPub(pubId);
                
            } catch (error) {
                console.error('Error submitting update:', error);
                hideLoadingToast();
                showSuccessToast('Error saving updates. Please try again.');
            }
        }

        // ENHANCED SEARCH FUNCTION WITH POSTCODE DETECTION
        async function searchPubs() {
            const query = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            const gfOnly = document.getElementById('gfOnly').checked;
            const results = document.getElementById('results');
            
            if (!query) {
                results.innerHTML = '<li class="no-results">Please enter a search term.</li>';
                return;
            }
            
            currentQuery = query;
            currentSearchType = searchType;
            currentGfOnly = gfOnly;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            // Check if query looks like a postcode
            const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
            
            try {
                let url;
                let searchResults;
                
                if (isPostcode && (searchType === 'postcode' || searchType === 'all')) {
                    // Handle postcode search - geocode then find nearby
                    console.log('Detected postcode search:', query);
                    showLoadingToast('Finding location...');
                    
                    // First geocode the postcode
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData && geocodeData.length > 0) {
                        const lat = parseFloat(geocodeData[0].lat);
                        const lng = parseFloat(geocodeData[0].lon);
                        
                        showLoadingToast('Finding nearby pubs...');
                        
                        // Now search for nearby pubs
                        url = `/nearby?lat=${lat}&lng=${lng}&radius=5&gf_only=${gfOnly}`;
                        
                        // Auto-show map and update to show the postcode area
                        smartShowMap();
                        if (map) {
                            map.setView([lat, lng], 14);
                            
                            // Add a marker for the searched postcode
                            if (window.postcodeMarker) {
                                map.removeLayer(window.postcodeMarker);
                            }
                            window.postcodeMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: `<div style="
                                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                        width: 30px;
                                        height: 30px;
                                        border-radius: 50%;
                                        border: 3px solid white;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: bold;
                                        font-size: 14px;
                                    ">üìç</div>`,
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            }).addTo(map);
                            
                            window.postcodeMarker.bindPopup(`<strong>${query}</strong><br>Searching nearby pubs...`).openPopup();
                        }
                    } else {
                        throw new Error('Postcode not found');
                    }
                } else {
                    // Regular text search
                    url = `/search?query=${encodeURIComponent(query)}&search_type=${searchType}&page=1` + (gfOnly ? '&gf_only=true' : '');
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    if (isPostcode) {
                        results.innerHTML = `<li class="no-results">No pubs found within 5km of ${query}. Try expanding your search area.</li>`;
                        showSuccessToast(`No pubs found near ${query}`);
                    } else {
                        results.innerHTML = '<li class="no-results">No pubs found.</li>';
                        showSuccessToast('No pubs found for your search');
                    }
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message for postcode searches
                if (isPostcode && pubs.length > 0) {
                    showSuccessToast(`‚úÖ Found ${pubs.length} pubs within 5km of ${query}`);
                } else {
                    showSuccessToast(`Found ${pubs.length} pubs matching "${query}"`);
                }
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                if (isPostcode) {
                    results.innerHTML = `<li class="no-results">Could not find location for "${query}". Please check the postcode and try again.</li>`;
                    showSuccessToast(`Could not find location for "${query}"`);
                } else {
                    results.innerHTML = '<li class="no-results">Error searching pubs. Please try again.</li>';
                    showSuccessToast('Error searching pubs. Please try again.');
                }
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('gfOnly').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            hideResultsSection();
            
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
            }
            
            currentQuery = '';
            currentSearchType = 'all';
            currentGfOnly = false;
            currentPage = 1;
            AppState.save();
        }

        // Enhanced report form submission
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            showLoadingToast('Submitting report...');
            
            const formData = {
                existingPub: selectedPubData,
                pubName: selectedPubData ? selectedPubData.name : document.getElementById('reportPubName').value,
                address: selectedPubData ? selectedPubData.address : document.getElementById('reportAddress').value,
                postcode: selectedPubData ? selectedPubData.postcode : document.getElementById('reportPostcode').value,
                format: document.getElementById('reportFormat').value,
                brewery: document.getElementById('reportBrewery').value || 'Unknown',
                beerName: document.getElementById('reportBeerName').value || 'Unknown',
                beerStyle: document.getElementById('reportBeerStyle').value || 'Unknown'
            };
            
            // Validation
            if (!selectedPubData) {
                // New pub - check required fields
                if (!formData.pubName || !formData.address || !formData.postcode) {
                    hideLoadingToast();
                    showSuccessToast('Please fill in all required pub details.');
                    return;
                }
            }
            
            if (!formData.format) {
                hideLoadingToast();
                showSuccessToast('Please select a beer format.');
                return;
            }
            
            const photo = document.getElementById('reportPhoto').files[0];
            
            try {
                // Here you would normally send to your backend
                // For now, we'll simulate success
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                let message = selectedPubData ? 
                    `üéâ Thank you! Your GF beer find at ${formData.pubName} has been submitted.` :
                    `üéâ Thank you! Your new pub "${formData.pubName}" and GF beer find have been submitted.`;
                
                hideLoadingToast();
                showSuccessToast(message);
                closeReportModal();
                addToRecentActivity(formData);
                
                trackEvent('submit_beer_report', 'Community Contribution', formData.pubName);
                
            } catch (error) {
                hideLoadingToast();
                showSuccessToast('Sorry, there was an error submitting your report. Please try again.');
            }
        });

        // Add pub search listener
        document.getElementById('reportPubSearch').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            searchPubsForReport(query);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestions = document.getElementById('pubSuggestions');
            const searchInput = document.getElementById('reportPubSearch');
            
            if (!suggestions.contains(e.target) && !searchInput.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const input = document.getElementById('searchInput');
            const suggestions = document.getElementById('suggestions');

            // Initialize Leaflet map
            map = L.map('map').setView([51.505, -0.09], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            loadDashboardStats();
            getUserLocation();
            await AppState.restore();

            // Event listeners for coordinate modal
            document.getElementById('confirmLocation').addEventListener('click', confirmLocation);
            document.getElementById('cancelModal').addEventListener('click', closeCoordinateModal);

            // Close modals when clicking outside
            document.getElementById('coordinateModal').addEventListener('click', (e) => {
                if (e.target.id === 'coordinateModal') {
                    closeCoordinateModal();
                }
            });

            document.getElementById('reportModal').addEventListener('click', (e) => {
                if (e.target.id === 'reportModal') {
                    closeReportModal();
                }
            });

            document.getElementById('aboutModal').addEventListener('click', (e) => {
                if (e.target.id === 'aboutModal') {
                    closeAboutModal();
                }
            });

            document.getElementById('gfInfoModal').addEventListener('click', (e) => {
                if (e.target.id === 'gfInfoModal') {
                    closeGFInfoModal();
                }
            });

            // ENHANCED AUTOCOMPLETE WITH POSTCODE DETECTION
            input.addEventListener('input', debounce(async () => {
                const query = input.value.trim();
                const searchType = document.getElementById('searchType').value;
                const gfOnly = document.getElementById('gfOnly').checked;
                
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                // Check if it looks like a postcode
                const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
                
                if (isPostcode) {
                    // Show postcode search option
                    suggestions.innerHTML = `
                        <div class="postcode-suggestion" style="padding: 15px; cursor: pointer; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin: 5px;">
                            <strong>üìç Search for pubs near "${query}"</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                Find pubs within 5km of this postcode
                            </div>
                        </div>
                    `;
                    suggestions.style.display = 'block';
                    
                    // Add click handler
                    suggestions.querySelector('.postcode-suggestion').addEventListener('click', () => {
                        searchPubs();
                        suggestions.style.display = 'none';
                    });
                    return;
                }

                // Regular autocomplete for non-postcodes
                try {
                    const url = `/autocomplete?q=${encodeURIComponent(query)}&search_type=${searchType}` + (gfOnly ? '&gf_only=true' : '');
                    const response = await fetch(url);
                    if (!response.ok) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const data = await response.json();

                    suggestions.innerHTML = '';
                    if (data.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }

                    if (data.length >= 10) {
                        const showAllDiv = document.createElement('div');
                        showAllDiv.className = 'show-all-option';
                        showAllDiv.innerHTML = `<strong>üîç Show all ${data.length}+ results for "${query}"</strong>`;
                        showAllDiv.addEventListener('click', () => {
                            document.getElementById('searchInput').value = query;
                            searchPubs();
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(showAllDiv);
                    }

                    data.forEach(pub => {
                        const div = document.createElement('div');
                        div.textContent = `${pub.name}, ${pub.address} (${pub.postcode})`;
                        div.addEventListener('click', () => {
                            clearSearch();
                            searchSpecificPub(pub.pub_id);
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } catch (error) {
                    suggestions.style.display = 'none';
                }
            }, 300));

            // Hide suggestions on outside click
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            // Save state on form changes
            document.getElementById('searchType').addEventListener('change', () => AppState.save());
            document.getElementById('gfOnly').addEventListener('change', () => AppState.save());
        });
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</body>
</html>
