<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coeliacs Like Beer Too - Find GF-Friendly Pubs - {{ cache_buster }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
</head>
<body>
    <h1>Coeliacs Like Beer Too</h1>
    <div class="search-container">
        <div class="search-grid">
            <div class="search-row">
                <select id="searchType" class="search-type-dropdown">
                    <option value="all">Search All</option>
                    <option value="name">Pub Name</option>
                    <option value="postcode">Postcode</option>
                    <option value="area">Local Authority</option>
                </select>
                <input type="text" id="searchInput" placeholder="Enter pub name, postcode, or local authority" onkeydown="if (event.key === 'Enter') searchPubs()">
                <label class="gf-checkbox"><input type="checkbox" id="gfOnly"> Gluten Free</label>
            </div>
            <div class="button-row">
                <button class="map-control-btn" id="toggleMapBtn">üó∫Ô∏è Hide Map</button>
                <div class="main-buttons">
                    <button onclick="searchPubs()">Search</button>
                    <button class="nearby-button" onclick="findNearbyPubs()">Pubs Near Me</button>
                </div>
                <button class="map-control-btn" onclick="centerOnLocation()">üìç My Location</button>
            </div>
        </div>
        <div id="suggestions"></div>
    </div>
    
    <div id="locationStatus" class="location-status location-loading" style="display: none;">
        Getting your location...
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
    <ul id="results"></ul>

    <!-- Smart Coordinate Modal -->
    <div id="coordinateModal" class="coordinate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalPubName">Help us locate this pub!</h2>
                <p>We'll search near the postcode and you can click to pinpoint the exact location.</p>
            </div>
            
            <div class="modal-instructions">
                <span id="modalInstructions">üó∫Ô∏è Searching for the pub area...</span>
            </div>
            
            <div id="coordinateMap" class="modal-map"></div>
            
            <div id="selectedLocationInfo" class="selected-location" style="display: none;">
                <div>üìç Selected location:</div>
                <div class="coordinates" id="selectedCoordinates"></div>
            </div>
            
            <div class="modal-buttons">
                <button id="confirmLocation" class="modal-button confirm-button">
                    ‚úÖ Confirm Location
                </button>
                <button id="cancelModal" class="modal-button cancel-button">
                    ‚ùå Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // Cache-busting timestamp
        console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
        
        var map;
        var userLocation = null;
        var pubMarkers = [];
        var userMarker = null;

        // Smart coordinate modal variables
        var coordinateMap;
        var selectedMarker;
        var currentPub;
        var selectedCoordinates = null;

        // Global pagination variables
        let currentPage = 1;
        let currentQuery = '';
        let currentSearchType = 'all';
        let currentGfOnly = false;

        // State management for refresh persistence
        const AppState = {
            save: function(pubId = null) {
                const state = {
                    query: currentQuery,
                    searchType: currentSearchType,
                    gfOnly: currentGfOnly,
                    page: currentPage,
                    mapVisible: document.getElementById('map').style.display !== 'none',
                    specificPubId: pubId || null, // Store specific pub ID if provided
                    timestamp: Date.now()
                };
                // Store in URL hash for persistence
                window.location.hash = btoa(JSON.stringify(state));
            },
            
            load: function() {
                try {
                    if (window.location.hash) {
                        const state = JSON.parse(atob(window.location.hash.substring(1)));
                        // Only load state if it's recent (within last hour)
                        if (Date.now() - state.timestamp < 3600000) {
                            return state;
                        }
                    }
                } catch (e) {
                    console.log('No valid state to restore');
                }
                return null;
            },
            
            restore: async function() {
                const state = this.load();
                if (state) {
                    console.log('Restoring state:', state);
                    
                    // Restore form values
                    document.getElementById('searchInput').value = state.query || '';
                    document.getElementById('searchType').value = state.searchType || 'all';
                    document.getElementById('gfOnly').checked = state.gfOnly || false;
                    
                    // Restore global variables
                    currentQuery = state.query || '';
                    currentSearchType = state.searchType || 'all';
                    currentGfOnly = state.gfOnly || false;
                    currentPage = state.page || 1;
                    
                    // Restore map visibility
                    const mapElement = document.getElementById('map');
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    if (!state.mapVisible) {
                        mapElement.style.display = 'none';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                    }
                    
                    // Restore search results - prioritize specific pub ID over regular search
                    if (state.specificPubId) {
                        console.log('Restoring specific pub:', state.specificPubId);
                        await searchSpecificPub(state.specificPubId);
                    } else if (state.query) {
                        console.log('Restoring search query:', state.query);
                        await loadPage(state.page);
                    }
                }
            }
        };

        // Debounce function to limit rapid requests
        let debounceTimeout;
        function debounce(func, wait) {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get user's location
        function getUserLocation() {
            const statusEl = document.getElementById('locationStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'location-status location-loading';
            statusEl.textContent = 'Getting your location...';

            if (!navigator.geolocation) {
                statusEl.className = 'location-status location-error';
                statusEl.textContent = 'Geolocation not supported by this browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    statusEl.className = 'location-status location-success';
                    statusEl.textContent = 'Location found! Click "Find Nearby Pubs" to see what\'s around you.';
                    
                    // Add user marker to map
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('You are here!')
                        .openPopup();
                    
                    // Center map on user location
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                },
                (error) => {
                    let errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    statusEl.className = 'location-status location-error';
                    statusEl.textContent = errorMessage;
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            );
        }

        // Find nearby pubs
        async function findNearbyPubs() {
            if (!userLocation) {
                alert('Please allow location access first');
                getUserLocation();
                return;
            }

            const gfOnly = document.getElementById('gfOnly').checked;
            const radius = 5; // 5km radius
            
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Finding nearby pubs...</li>';
            
            // Immediately center map on user location
            map.setView([userLocation.lat, userLocation.lng], 14);
            
            try {
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&gf_only=${gfOnly}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const nearbyPubs = await response.json();
                
                if (nearbyPubs.error) {
                    throw new Error(nearbyPubs.error);
                }
                
                displaySearchResults(nearbyPubs);
                addPubMarkersToMap(nearbyPubs);
                
                // If we found pubs, fit the map to show all nearby pubs plus user location
                if (nearbyPubs.length > 0) {
                    const allPoints = [];
                    
                    // Add user location
                    allPoints.push([userLocation.lat, userLocation.lng]);
                    
                    // Add all pub locations that have coordinates
                    nearbyPubs.forEach(pub => {
                        if (pub.latitude && pub.longitude) {
                            allPoints.push([parseFloat(pub.latitude), parseFloat(pub.longitude)]);
                        }
                    });
                    
                    // Fit map to show all points with some padding
                    if (allPoints.length > 1) {
                        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
                        map.fitBounds(group.getBounds().pad(0.1)); // 10% padding
                    }
                }
                
                // Clear search state for nearby search
                currentQuery = '';
                currentSearchType = 'all';
                currentGfOnly = gfOnly;
                currentPage = 1;
                AppState.save(); // Save cleared search state for nearby
                
            } catch (error) {
                console.error('Error finding nearby pubs:', error);
                results.innerHTML = '<li class="no-results">Error finding nearby pubs. Please try again.</li>';
            }
        }

        // Center map on user location
        function centerOnLocation() {
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 14);
            } else {
                getUserLocation();
            }
        }

        // Add pub markers to map
        function addPubMarkersToMap(pubs) {
            // Clear existing markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];

            pubs.forEach(pub => {
                if (pub.latitude && pub.longitude) {
                    const hasGF = pub.bottle || pub.tap || pub.cask || pub.can;
                    const markerColor = hasGF ? '#4CAF50' : '#757575';
                    
                    const marker = L.circleMarker([pub.latitude, pub.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    let popupContent = `<strong>${pub.name}</strong><br>`;
                    popupContent += `${pub.address}<br>`;
                    if (pub.distance !== undefined) {
                        popupContent += `<em>${pub.distance.toFixed(2)} km away</em><br>`;
                    }
                    
                    if (hasGF) {
                        let gfOptions = [];
                        if (pub.bottle) gfOptions.push('Bottle');
                        if (pub.tap) gfOptions.push('Tap');
                        if (pub.cask) gfOptions.push('Cask');
                        if (pub.can) gfOptions.push('Can');
                        popupContent += `<br><strong>GF Options:</strong> ${gfOptions.join(', ')}`;
                    } else {
                        popupContent += '<br><em>No GF options recorded</em>';
                    }

                    marker.bindPopup(popupContent);
                    pubMarkers.push(marker);
                }
            });
        }

        // Smart coordinate modal functions
        function openCoordinateModal(pubName, postcode, pubId) {
            currentPub = { name: pubName, postcode: postcode, id: pubId };
            
            document.getElementById('modalPubName').textContent = `Help us locate ${pubName}!`;
            document.getElementById('coordinateModal').style.display = 'block';
            document.getElementById('modalInstructions').textContent = 'üó∫Ô∏è Searching for the pub area...';
            document.getElementById('selectedLocationInfo').style.display = 'none';
            document.getElementById('confirmLocation').classList.remove('active');
            selectedCoordinates = null;
            
            // Initialize the modal map
            setTimeout(() => {
                if (coordinateMap) {
                    coordinateMap.remove();
                }
                
                coordinateMap = L.map('coordinateMap').setView([51.505, -0.09], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(coordinateMap);
                
                // Search for the postcode location
                searchPostcodeLocation(postcode);
                
                // Add click handler for map
                coordinateMap.on('click', onMapClick);
            }, 100);
        }

        // Search for postcode location using a geocoding service
        async function searchPostcodeLocation(postcode) {
            try {
                // Using Nominatim (free geocoding service)
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(postcode)}&countrycodes=gb&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    // Center map on postcode area
                    coordinateMap.setView([lat, lng], 16);
                    
                    // Add a subtle area indicator
                    L.circle([lat, lng], {
                        radius: 200,
                        fillColor: '#667eea',
                        fillOpacity: 0.1,
                        color: '#667eea',
                        weight: 2,
                        opacity: 0.3
                    }).addTo(coordinateMap);
                    
                    document.getElementById('modalInstructions').innerHTML = 
                        `üìç Found ${postcode}! Click on the map where <strong>${currentPub.name}</strong> is located.`;
                } else {
                    throw new Error('Postcode not found');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                // Fallback to UK center
                coordinateMap.setView([54.5, -2], 6);
                document.getElementById('modalInstructions').innerHTML = 
                    `üîç Couldn't find ${postcode}. Please zoom to the area and click where <strong>${currentPub.name}</strong> is located.`;
            }
        }

        // Handle map clicks
        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            // Remove previous marker
            if (selectedMarker) {
                coordinateMap.removeLayer(selectedMarker);
            }
            
            // Add new marker with custom styling
            selectedMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">üìç</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(coordinateMap);
            
            selectedMarker.bindPopup(`<strong>${currentPub.name}</strong><br>Is this the correct location?`).openPopup();
            
            // Store coordinates
            selectedCoordinates = { lat: lat.toFixed(6), lng: lng.toFixed(6) };
            
            // Update UI
            document.getElementById('selectedCoordinates').textContent = 
                `${selectedCoordinates.lat}, ${selectedCoordinates.lng}`;
            document.getElementById('selectedLocationInfo').style.display = 'block';
            document.getElementById('confirmLocation').classList.add('active');
            document.getElementById('modalInstructions').innerHTML = 
                `‚úÖ Great! Is this where <strong>${currentPub.name}</strong> is located?`;
        }

        // Confirm the selected location
        async function confirmLocation() {
            if (!selectedCoordinates) return;
            
            try {
                const response = await fetch('/update_coordinates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pub_id: currentPub.id,
                        latitude: parseFloat(selectedCoordinates.lat),
                        longitude: parseFloat(selectedCoordinates.lng)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`üéâ Thank you! ${currentPub.name} has been located on the map.`);
                    closeCoordinateModal();
                    
                    // Refresh the current view to show the updated pub with coordinates
                    if (userLocation) {
                        findNearbyPubs();
                    } else {
                        // Re-search for this specific pub to show updated info
                        searchSpecificPub(currentPub.id);
                    }
                } else {
                    alert('Error saving location: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving coordinates:', error);
                alert('Error saving location. Please try again.');
            }
        }

        // Close the modal
        function closeCoordinateModal() {
            document.getElementById('coordinateModal').style.display = 'none';
            if (coordinateMap) {
                coordinateMap.remove();
                coordinateMap = null;
            }
            selectedMarker = null;
            selectedCoordinates = null;
        }

        // Updated findOnMap function with smart modal
        function findOnMap(lat, lng, pubName, postcode, pubId) {
            if (lat && lng && lat !== 'null' && lng !== 'null' && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                // Existing functionality for pubs with coordinates
                map.setView([parseFloat(lat), parseFloat(lng)], 16);
                
                const highlightMarker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                    radius: 12,
                    fillColor: '#ff6b6b',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map);
                
                highlightMarker.bindPopup(`<strong>${pubName}</strong><br><em>You searched for this pub!</em>`).openPopup();
                
                setTimeout(() => {
                    map.removeLayer(highlightMarker);
                }, 5000);
            } else {
                // NEW: Open smart coordinate modal for pubs without coordinates
                openCoordinateModal(pubName, postcode, pubId);
            }
        }

        // Open Google search for the pub
        function searchForPub(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            window.open(googleUrl, '_blank');
        }

        // Format beer details for better display
        function formatBeerDetails(beerDetails) {
            if (!beerDetails || beerDetails === 'None' || beerDetails.trim() === '') {
                return '<div style="color: #9ca3af; font-style: italic;">No beers recorded yet</div>';
            }
            
            return beerDetails.split(', ').map(beer => {
                const parts = beer.split(' - ');
                if (parts.length >= 2) {
                    const format = parts[0];
                    const details = parts.slice(1).join(' - ');
                    return `<div class="beer-item"><span class="beer-type">${format.charAt(0).toUpperCase() + format.slice(1)}:</span> ${details}</div>`;
                }
                return `<div class="beer-item">${beer}</div>`;
            }).join('');
        }

        // Display search results with pagination
        function displaySearchResults(data, append = false) {
            console.log('displaySearchResults called with pagination support!');
            const results = document.getElementById('results');
            
            // Handle both old format (array) and new format (object with pagination)
            const pubs = Array.isArray(data) ? data : data.pubs;
            const pagination = data.pagination || null;
            
            if (!append) {
                results.innerHTML = '';
            }
            
            if (pubs.length === 0 && !append) {
                results.innerHTML = '<li class="no-results">No pubs found.</li>';
                return;
            }
            
            pubs.forEach(pub => {
                console.log('Processing pub:', pub);
                const li = document.createElement('li');
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('Bottle');
                if (pub.tap) gfOptions.push('Tap');
                if (pub.cask) gfOptions.push('Cask');
                if (pub.can) gfOptions.push('Can');
                
                const gfText = gfOptions.length > 0 ? gfOptions.join(', ') : 'None';
                const beerDetails = pub.beer_details || 'None';
                
                // Calculate distance if user location is available and pub has coordinates
                let detailsDistanceText = '';
                
                // Convert coordinates to numbers if they're strings
                const lat = parseFloat(pub.latitude);
                const lng = parseFloat(pub.longitude);
                
                if (userLocation && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        lat, lng
                    );
                    detailsDistanceText = `<div style="color: #667eea; font-size: 14px; font-weight: 600; margin: 8px 0;">${distance.toFixed(2)} km from your location</div>`;
                }

                li.className = 'result-item';
                li.innerHTML = `
                    <div class="result-details">
                        <strong>${pub.name}</strong>
                        <div class="address">${pub.address}, ${pub.postcode}</div>
                        <div class="local-authority">${pub.local_authority}</div>
                        ${detailsDistanceText}
                        <div style="margin-top: 10px;">
                            <button onclick="searchForPub('${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}')" 
                                    style="margin-right: 8px; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                                Find Online
                            </button>
                            <button onclick="findOnMap(${pub.latitude || 'null'}, ${pub.longitude || 'null'}, '${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}', ${pub.pub_id})" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                Find on Map
                            </button>
                        </div>
                    </div>
                    <div class="beer-column">
                        <h4>Available Beers</h4>
                        <div class="beer-details">
                            ${formatBeerDetails(beerDetails)}
                        </div>
                    </div>
                    <div class="button-column">
                        <button class="update-button" onclick="toggleUpdateForm(${pub.pub_id})">Update</button>
                    </div>
                    <div class="update-form" id="form-${pub.pub_id}" style="display: none;">
                        <div class="update-mode">
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="add" checked> Add New Beers</label>
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="replace"> Replace All Beers</label>
                        </div>
                        <div class="beer-options-grid">
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="bottle-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'bottle')">
                                        <span class="beer-icon">üç∫</span> Bottle
                                    </label>
                                </div>
                                <div id="beer-input-bottle-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-bottle-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-bottle-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-bottle-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="tap-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'tap')">
                                        <span class="beer-icon">üö∞</span> Tap
                                    </label>
                                </div>
                                <div id="beer-input-tap-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-tap-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-tap-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-tap-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="cask-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'cask')">
                                        <span class="beer-icon">üõ¢Ô∏è</span> Cask
                                    </label>
                                </div>
                                <div id="beer-input-cask-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-cask-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-cask-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-cask-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="can-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'can')">
                                        <span class="beer-icon">ü•´</span> Can
                                    </label>
                                </div>
                                <div id="beer-input-can-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-can-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-can-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-can-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="save-button-container">
                            <button class="save-beer-btn" onclick="submitUpdate(${pub.pub_id})">
                                <span class="save-icon">üíæ</span> Save Beer Updates
                            </button>
                        </div>
                    </div>
                `;
                results.appendChild(li);
                updateBeerInputs(pub.pub_id);
            });
            
            // Add pagination controls if we have pagination data
            if (pagination && !append) {
                addPaginationControls(pagination);
            }
        }

        // Add pagination controls
        function addPaginationControls(pagination) {
            const results = document.getElementById('results');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';
            paginationDiv.innerHTML = `
                <div class="pagination-info">
                    Showing page ${pagination.page} of ${pagination.pages} (${pagination.total} total results)
                </div>
                <div class="pagination-buttons">
                    ${pagination.has_prev ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">‚Üê Previous</button>` : ''}
                    ${pagination.page > 2 ? `<button onclick="loadPage(1)" class="pagination-btn">1</button>` : ''}
                    ${pagination.page > 3 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page > 1 ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">${pagination.page - 1}</button>` : ''}
                    <button class="pagination-btn active">${pagination.page}</button>
                    ${pagination.page < pagination.pages ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">${pagination.page + 1}</button>` : ''}
                    ${pagination.page < pagination.pages - 2 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page < pagination.pages - 1 ? `<button onclick="loadPage(${pagination.pages})" class="pagination-btn">${pagination.pages}</button>` : ''}
                    ${pagination.has_next ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">Next ‚Üí</button>` : ''}
                </div>
            `;
            results.appendChild(paginationDiv);
        }

        // Load a specific page
        async function loadPage(page) {
            currentPage = page;
            const url = `/search?query=${encodeURIComponent(currentQuery)}&search_type=${currentSearchType}&page=${page}` + (currentGfOnly ? '&gf_only=true' : '');
            
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading...</li>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                displaySearchResults(data);
                addPubMarkersToMap(data.pubs || data);
                
                // Save state after successful load
                AppState.save();
                
                // Scroll to top of results
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading page:', error);
                results.innerHTML = '<li class="no-results">Error loading results. Please try again.</li>';
            }
        }

        // Search for a specific pub by ID
        async function searchSpecificPub(pubId) {
            console.log('searchSpecificPub called with ID:', pubId);
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading pub details...</li>';
            
            try {
                const url = `/search?pub_id=${pubId}`;
                console.log('Fetching URL:', url);
                const response = await fetch(url);
                const pubs = await response.json();
                
                console.log('Response from server:', pubs);
                
                if (pubs.length > 0) {
                    console.log('Calling displaySearchResults with:', pubs);
                    displaySearchResults(pubs);
                    addPubMarkersToMap(pubs);
                    
                    // Center map on the pub if it has coordinates
                    const pub = pubs[0];
                    if (pub.latitude && pub.longitude) {
                        map.setView([pub.latitude, pub.longitude], 15);
                    }
                    
                    // Clear regular search state and save specific pub state
                    currentQuery = '';
                    currentSearchType = 'all';
                    currentGfOnly = false;
                    currentPage = 1;
                    AppState.save(pubId); // Save with specific pub ID
                } else {
                    results.innerHTML = '<li class="no-results">Pub not found.</li>';
                }
            } catch (error) {
                console.error('Error searching for specific pub:', error);
                results.innerHTML = '<li class="no-results">Error loading pub details.</li>';
            }
        }

        function toggleUpdateForm(pubId) {
            const form = document.getElementById(`form-${pubId}`);
            form.style.display = form.style.display === 'block' ? 'none' : 'block';
            if (form.style.display === 'block') {
                updateBeerInputs(pubId);
            }
        }

        function updateBeerInputs(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked;
            const tap = document.getElementById(`tap-${pubId}`).checked;
            const cask = document.getElementById(`cask-${pubId}`).checked;
            const can = document.getElementById(`can-${pubId}`).checked;

            document.getElementById(`beer-input-bottle-${pubId}`).style.display = bottle ? 'block' : 'none';
            document.getElementById(`beer-input-tap-${pubId}`).style.display = tap ? 'block' : 'none';
            document.getElementById(`beer-input-cask-${pubId}`).style.display = cask ? 'block' : 'none';
            document.getElementById(`beer-input-can-${pubId}`).style.display = can ? 'block' : 'none';
        }

        function handleCheckboxChange(pubId, type) {
            const checkbox = document.getElementById(`${type}-${pubId}`);
            const inputContainer = document.getElementById(`beer-input-${type}-${pubId}`);
            inputContainer.style.display = checkbox.checked ? 'block' : 'none';
            if (checkbox.checked) {
                inputContainer.querySelector('input').focus();
            }
        }

        async function submitUpdate(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked ? 1 : 0;
            const tap = document.getElementById(`tap-${pubId}`).checked ? 1 : 0;
            const cask = document.getElementById(`cask-${pubId}`).checked ? 1 : 0;
            const can = document.getElementById(`can-${pubId}`).checked ? 1 : 0;
            const updateMode = document.querySelector(`input[name="updateMode-${pubId}"]:checked`)?.value || 'add';

            const updates = [];
            if (bottle) {
                const brewery = document.getElementById(`brewery-bottle-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-bottle-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-bottle-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'bottle', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (tap) {
                const brewery = document.getElementById(`brewery-tap-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-tap-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-tap-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'tap', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (cask) {
                const brewery = document.getElementById(`brewery-cask-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-cask-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-cask-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'cask', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (can) {
                const brewery = document.getElementById(`brewery-can-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-can-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-can-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'can', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }

            const updateResponse = await fetch('/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pub_id: pubId, bottle, tap, cask, can })
            });

            if (updates.length > 0) {
                await fetch('/update_beers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pub_id: pubId, updates, update_mode: updateMode })
                });
            }

            const result = await updateResponse.json();
            alert(result.message);
            
            // Just close the update form instead of refreshing the entire view
            const form = document.getElementById(`form-${pubId}`);
            form.style.display = 'none';
        }

        async function searchPubs() {
            const query = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            const gfOnly = document.getElementById('gfOnly').checked;
            const results = document.getElementById('results');
            
            if (!query) {
                results.innerHTML = '<li class="no-results">Please enter a search term.</li>';
                return;
            }
            
            // Store current search parameters
            currentQuery = query;
            currentSearchType = searchType;
            currentGfOnly = gfOnly;
            currentPage = 1;
            
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            const url = `/search?query=${encodeURIComponent(query)}&search_type=${searchType}&page=1` + (gfOnly ? '&gf_only=true' : '');
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                // Handle both old format (array) and new format (object with pagination)
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                if (pubs.length === 0) {
                    results.innerHTML = '<li class="no-results">No pubs found.</li>';
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                // Save state after successful search
                AppState.save();
            } catch (error) {
                console.error('Error searching pubs:', error);
                results.innerHTML = '<li class="no-results">Error searching pubs. Please try again.</li>';
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('gfOnly').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            
            // Clear pub markers but keep user marker
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            // Clear state (including specific pub ID)
            currentQuery = '';
            currentSearchType = 'all';
            currentGfOnly = false;
            currentPage = 1;
            AppState.save(); // Save cleared state
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const input = document.getElementById('searchInput');
            const suggestions = document.getElementById('suggestions');

            // Initialize Leaflet map
            map = L.map('map').setView([51.505, -0.09], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Get user location on load
            getUserLocation();

            // Restore state from previous session
            await AppState.restore();

            // Event listeners for coordinate modal
            document.getElementById('confirmLocation').addEventListener('click', confirmLocation);
            document.getElementById('cancelModal').addEventListener('click', closeCoordinateModal);

            // Close modal when clicking outside
            document.getElementById('coordinateModal').addEventListener('click', (e) => {
                if (e.target.id === 'coordinateModal') {
                    closeCoordinateModal();
                }
            });

            // Autocomplete with debouncing
            input.addEventListener('input', debounce(async () => {
                const query = input.value.trim();
                const searchType = document.getElementById('searchType').value;
                const gfOnly = document.getElementById('gfOnly').checked;
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                try {
                    const url = `/autocomplete?q=${encodeURIComponent(query)}&search_type=${searchType}` + (gfOnly ? '&gf_only=true' : '');
                    const response = await fetch(url);
                    if (!response.ok) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const data = await response.json();

                    suggestions.innerHTML = '';
                    if (data.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }

                    // Add "Show All Results" option at the top if there are many results
                    if (data.length >= 10) {
                        const showAllDiv = document.createElement('div');
                        showAllDiv.className = 'show-all-option';
                        showAllDiv.innerHTML = `<strong>üîç Show all ${data.length}+ results for "${query}"</strong>`;
                        showAllDiv.addEventListener('click', () => {
                            document.getElementById('searchInput').value = query;
                            searchPubs();
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(showAllDiv);
                    }

                    data.forEach(pub => {
                        const div = document.createElement('div');
                        div.textContent = `${pub.name}, ${pub.address} (${pub.postcode})`;
                        div.addEventListener('click', () => {
                            // Instead of setting the search input, directly search for this specific pub
                            clearSearch();
                            
                            // Search for this specific pub using its ID
                            searchSpecificPub(pub.pub_id);
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } catch (error) {
                    suggestions.style.display = 'none';
                }
            }, 300));

            // Hide suggestions on outside click
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            // Toggle map visibility
            const toggleMapButton = document.getElementById('toggleMapBtn');
            let mapVisible = true;
            toggleMapButton.addEventListener('click', () => {
                mapVisible = !mapVisible;
                const mapElement = document.getElementById('map');
                
                mapElement.style.display = mapVisible ? 'block' : 'none';
                toggleMapButton.innerHTML = mapVisible ? 'üó∫Ô∏è Hide Map' : 'üó∫Ô∏è Show Map';
                
                // Save state
                AppState.save();
                
                // Resize map when shown
                if (mapVisible) {
                    setTimeout(() => map.invalidateSize(), 100);
                }
            });

            // Save state on form changes
            document.getElementById('searchType').addEventListener('change', () => AppState.save());
            document.getElementById('gfOnly').addEventListener('change', () => AppState.save());
        });
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
</body>
</html>