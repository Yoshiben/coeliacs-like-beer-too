<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coeliacs Like Beer Too! - Find GF-Friendly Pubs - {{ cache_buster }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!------------------------------------------->
    <!-- Google Analytics with GDPR compliance -->
    <!------------------------------------------->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WSHR39KSXS"></script>
    
    <!--------------------------->
    <!-- Basic analytics setup -->
    <!--------------------------->
    
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Set default consent to denied (GDPR compliant)
        gtag('consent', 'default', {
            'analytics_storage': 'denied'
        });
        
        gtag('js', new Date());
        gtag('config', 'G-WSHR39KSXS', {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
        });
    </script>
</head>
<body>
    
    <!----------------------->
    <!-- HTML hero section -->
    <!----------------------->
    
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Coeliacs Like Beer Too!</h1>
            <p class="hero-subtitle">The UK's largest community-driven guide to gluten free beer</p>
            
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalPubs">Loading...</span>
                    <span class="stat-label">Pubs in the UK</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="gfPubs">Loading...</span>
                    <span class="stat-label">Serving GF Beer</span>
                </div>
            </div>
        </div>
    </div>

    <!------------------------->
    <!-- HTML search section -->
    <!------------------------->
    
    <div class="search-section" id="search">
        <div class="container">
            <div class="search-card">
                <div class="search-header">
                    <h2 class="section-title">🔍 What are you searching for? 🍺</h2>
                </div>
                <div class="search-body">
                    <div class="search-options">
                        <!-- Top Left: Pubs Near Me -->
                        <div class="search-option name" onclick="startLocationSearch()">
                            <span class="search-icon">📍</span>
                            <h3 class="search-title">Pubs Near Me</h3>
                            <p class="search-description">Find pubs close to you, control the search distance.</p>
                        </div>
                        <!-- Top Right: Pubs by Name -->      
                        <div class="search-option location" onclick="openModal('nameModal')">
                            <span class="search-icon">🏠</span>
                            <h3 class="search-title">Pubs by Name</h3>
                            <p class="search-description">Search for a specific pub name - "Milestone" etc</p>
                        </div>
                        <!-- Bottom Left: Pubs by Area -->
                        <div class="search-option area" onclick="openModal('areaModal')">
                            <span class="search-icon">🗺️</span>
                            <h3 class="search-title">Pubs by Area</h3>
                            <p class="search-description">Explore pubs in regions, cities, or postcodes</p>
                        </div>
                        <!-- Bottom Right: Pubs by Beer -->
                        <div class="search-option beer" onclick="openModal('beerModal')">
                            <span class="search-icon">🍺</span>
                            <h3 class="search-title">Pubs by Beer</h3>
                            <p class="search-description">Find pubs serving specific GF beers - "Zapato", "IPA" etc.</p>
                        </div>            
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!------------------------------->
    <!-- HTML search modal section -->
    <!------------------------------->
    
    <div id="nameModal" class="search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🏠 Search by Pub Name</h3>
                <p class="modal-subtitle">Enter the name of the pub you're looking for</p>
            </div>
            <input type="text" class="form-input" placeholder="e.g. The Red Lion, Wetherspoons" id="nameInput">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSearchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="searchByName()">Search</button>
            </div>
        </div>
    </div>
    
    <div id="areaModal" class="search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🗺️ Search by Area</h3>
                <p class="modal-subtitle">Find pubs in a specific location</p>
            </div>
            
            <!-- Search Type Selector -->
            <div class="form-group">
                <label class="form-label">Search by:</label>
                <select id="areaSearchType" class="form-select" onchange="updateAreaPlaceholder()">
                    <option value="postcode">📮 Postcode</option>
                    <option value="city">🏙️ City/Region</option>
                </select>
            </div>
            
            <!-- Search Input -->
            <input type="text" class="form-input" placeholder="Enter postcode..." id="areaInput">
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSearchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="searchByArea()">Search</button>
            </div>
        </div>
    </div>
    
    <!-- ================================
     🔄 REPLACE: Your existing beerModal HTML with this enhanced version
     Find your beerModal div and replace the entire modal-content
     ================================ -->

    <div id="beerModal" class="search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🍺 Search by Beer</h3>
                <p class="modal-subtitle">Find pubs serving specific gluten-free beers</p>
            </div>
            
            <!-- Search Type Selector -->
            <div class="form-group">
                <label class="form-label">Search by:</label>
                <select id="beerSearchType" class="form-select" onchange="updateBeerPlaceholder()">
                    <option value="brewery">🏭 Brewery Name</option>
                    <option value="beer">🍺 Specific Beer</option>
                    <option value="style">🎨 Beer Style</option>
                </select>
            </div>
            
            <!-- Search Input with Autocomplete -->
            <div class="beer-search-container">
                <input type="text" class="form-input" placeholder="Start typing brewery name..." id="beerInput">
                <div id="beerSuggestions" class="suggestions beer-search-suggestions"></div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSearchModal()">Cancel</button>
                <button class="btn btn-primary" onclick="searchByBeer()">Search</button>
            </div>
        </div>
    </div>

    <!-- Distance Selection Modal -->
    <div id="distanceModal" class="search-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📍 How far will you travel?</h3>
            </div>
           
            <div class="distance-options">
                <div class="distance-option" onclick="searchNearbyWithDistance(1)">
                    <div class="distance-number">1km</div>
                    <div class="distance-label">Walking distance</div>
                </div>
                <div class="distance-option" onclick="searchNearbyWithDistance(3)">
                    <div class="distance-number">3km</div>
                    <div class="distance-label">Short journey</div>
                </div>
                <div class="distance-option popular" onclick="searchNearbyWithDistance(5)">
                    <div class="distance-number">5km</div>
                    <div class="distance-label">Most popular</div>
                </div>
                <div class="distance-option" onclick="searchNearbyWithDistance(10)">
                    <div class="distance-number">10km</div>
                    <div class="distance-label">Longer trip</div>
                </div>
                <div class="distance-option" onclick="searchNearbyWithDistance(20)">
                    <div class="distance-number">20km</div>
                    <div class="distance-label">Day out</div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeSearchModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Full-Screen Results Overlay -->
    <div id="resultsOverlay" class="results-overlay">
        <div class="results-container">
            <!-- Results Header -->
            <div class="results-nav">
                <button class="btn-nav-small" onclick="closeResults()">
                    🏠 Home
                </button>
                <h2 class="results-title" id="resultsTitle">Search Results</h2>
                <button class="btn-nav-small" onclick="toggleSearchResultsFullMap()">
                    🗺️ <span id="resultsMapBtnText">Map</span>
                </button>
            </div>
            
            <!-- Results Content -->
            <div class="results-content">
                <div class="results-list-container" id="resultsListContainer">
                    <!-- Loading state -->
                    <div class="results-loading" id="resultsLoading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Finding nearby GF beer...</div>
                    </div>
                    
                    <!-- Results list -->
                    <div class="results-list" id="resultsList" style="display: none;">
                        <!-- Results will be populated here -->
                    </div>
                    
                    <!-- No results -->
                    <div class="no-results-found" id="noResultsFound" style="display: none;">
                        <div class="no-results-icon">🔍</div>
                        <div class="no-results-title">No pubs found</div>
                        <div class="no-results-text">Try expanding your search distance or removing filters</div>
                    </div>
                </div>
                
                <!-- Results Map (hidden by default) -->
                <div class="results-map-container" id="resultsMapContainer" style="display: none;">
                    <div id="resultsMap" class="results-map"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Pub Details Overlay -->
    <div id="pubDetailsOverlay" class="pub-details-overlay">
        <div class="pub-details-container" id="pubContainer">
            <div class="pub-details-card">
                <!-- NEW: Top navigation - ADD THIS -->
                <div class="pub-nav-top">
                    <button class="btn-nav-small" onclick="closePubDetails()">
                        🏠 Home
                    </button>
                    <button class="btn-nav-small" onclick="goBackToResults(); return false;" type="button">
                        ← Back
                    </button>
                </div>
    
                <div class="pub-header">
                    <h1 class="pub-title" id="pubDetailsTitle">Pub Name</h1>
                    <div class="pub-address" id="pubDetailsAddress">Address</div>
                    <div class="pub-location" id="pubDetailsLocation">Location</div>
                </div>
    
                <div class="beer-section">
                    <div class="beer-section-title">
                        🍺 Available Gluten Free Beers
                    </div>
                    <div class="beer-status" id="pubDetailsBeer">
                        Loading beer information...
                    </div>
                </div>
    
                <div class="pub-action-grid">
                    <button class="btn btn-external" id="pubFindOnline">
                        🔍 Find Online
                    </button>
                    <button class="btn btn-external" id="pubGetDirections">
                        🧭 Get Directions
                    </button>
                    <button class="btn btn-toggle" id="pubToggleMap" onclick="togglePubDetailsSplitMap()">
                        🗺️ <span id="pubMapBtnText">Show on Map</span>
                    </button>
                    <button class="btn btn-positive" onclick="openReportModal()">
                        📝 Report GF Beer
                    </button>
                </div>
            </div>
    
            <div class="pub-map-container" id="pubMapContainer">
                <div class="pub-map-placeholder">
                    🗺️ Interactive Map Loading...
                </div>
            </div>
        </div>
    </div>

    <!-- Dynamic Results Section - Pushed down when visible -->
    <div id="results-section" style="display: none;">
        <div class="results-header">
            <h2 class="section-title">📍 Search Results</h2>
        </div>
        <ul id="results" class="results-list"></ul>
    </div>

    <!-- Map Section (Hidden by Default, Smart Show) -->
    <div class="map-container" id="mapContainer" style="display: none;">
        <div class="map-section-header">
            <h2 class="section-title">🗺️ Interactive Map</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Location Status -->
    <div id="locationStatus" class="location-status location-loading" style="display: none;">
        Finding your location...
    </div>

    <!-- Features Grid -->
<!--     <div class="features-section" id="featuresSection">
        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">ℹ️</span>
                <h3 class="feature-title">About Us</h3>
                <p class="feature-description">Learn about our mission to help coeliacs find great beer across the UK.</p>
                <button class="btn btn-primary" onclick="showAboutUs()">Learn More</button>
            </div> -->
            
            <!-- SWAPPED: What is GF Beer now comes before Report -->
<!--             <div class="feature-card">
                <span class="feature-icon">🔬</span>
                <h3 class="feature-title">What is GF Beer?</h3>
                <p class="feature-description">Everything you need to know about gluten free beer standards and safety.</p>
                <button class="btn btn-primary" onclick="showGFInfo()">Learn More</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">📸</span>
                <h3 class="feature-title">Report GF Beer</h3>
                <p class="feature-description">Found gluten free beer somewhere? Share it with the community and help others!</p>
                <button class="btn btn-primary" onclick="openReportModal()">Add Report</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">🏭</span>
                <h3 class="feature-title">GF Breweries</h3>
                <p class="feature-description">Discover breweries making amazing gluten free beers and where to find them.</p>
                <button class="btn btn-primary" onclick="window.location.href='/breweries'">Discover Breweries</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">📧</span>
                <h3 class="feature-title">Weekly Updates</h3>
                <p class="feature-description">Get notified about new GF beer finds, pub additions, and brewery news.</p>
                <button class="btn btn-primary" onclick="showComingSoon('Newsletter')">Coming Soon</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">⭐</span>
                <h3 class="feature-title">GF Beer Reviews</h3>
                <p class="feature-description">Real reviews from coeliacs - discover which beers are worth trying and which to avoid.</p>
                <button class="btn btn-primary" onclick="showComingSoon('Beer Reviews')">Coming Soon</button>
            </div>
        </div>
    </div> -->

    <!-- Recent Activity -->
<!--     <div class="activity-section" id="activitySection">
        <div class="activity-card">
            <div class="activity-header">
                <h2 class="activity-title">🔥 Recent GF Beer Updates</h2>
                <a href="#" class="view-all" onclick="showAllActivity()">View All</a>
            </div>
            
            <div id="recentActivity">
                <div class="activity-item">
                    <div class="activity-avatar">🍺</div>
                    <div class="activity-content">
                        <div class="activity-text">Welcome to the community! Start by searching for pubs near you.</div>
                        <div class="activity-time">Search above to see real pub data</div>
                    </div>
                </div>
            </div>
        </div>
    </div> -->

    <!-- Footer -->
<!--     <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">🍺 Coeliacs Like Beer Too</h3>
                <p class="footer-description">The UK's largest community-driven guide to gluten free beer. Built by coeliacs, for coeliacs.</p>
                <div class="footer-stats">
                    <span id="footerPubCount">52,847</span> pubs · 
                    <span id="footerGFCount">1,249</span> with GF options
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">🔗 Quick Links</h4>
                <div class="footer-links">
                    <a href="#" onclick="showAboutUs()" class="footer-link">About Us</a>
                    <a href="#" onclick="showGFInfo()" class="footer-link">What is GF Beer?</a>
                    <a href="#" onclick="openReportModal()" class="footer-link">Report GF Beer</a>
                    <a href="#" onclick="scrollToSearch()" class="footer-link">Search Pubs</a>       
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">📋 Legal & Privacy</h4>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link" target="_blank">Privacy Policy</a>
                    <a href="/terms" class="footer-link" target="_blank">Terms of Service</a>
                    <a href="/cookies" class="footer-link" target="_blank">Cookie Policy</a>
                    <a href="/accessibility" class="footer-link" target="_blank">Accessibility</a>
                    <a href="/liability" class="footer-link" target="_blank">Liability Notice</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">💬 Community</h4>
                <div class="footer-links">
                    <a href="#" onclick="showComingSoon('Contact Form')" class="footer-link">Contact Us</a>
                    <a href="#" onclick="showComingSoon('Community Forum')" class="footer-link">Community Forum</a>
                    <a href="#" onclick="showComingSoon('Newsletter')" class="footer-link">Newsletter</a>
                    <a href="#" onclick="showComingSoon('Social Media')" class="footer-link">Follow Us</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p class="footer-copyright">
                    © 2025 Coeliacs Like Beer Too. All rights reserved. 
                    <span class="footer-disclaimer">This site is for informational purposes only. Always verify with venues directly.</span>
                </p>
                <div class="footer-version">
                    <span class="footer-cache-info">v{{ cache_buster }}</span>
                </div>
            </div>
        </div>
    </footer> -->

<!-- ================================
     OPTIMIZED REPORT MODAL HTML
     Single screen, pre-population ready
     ================================ -->
    
    
    <!-- JavaScript to handle file upload preview -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const photoInput = document.getElementById('reportPhoto');
        const photoLabel = document.querySelector('.photo-upload-compact');
        
        if (photoInput && photoLabel) {
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const fileName = file.name.length > 20 ? 
                        file.name.substring(0, 17) + '...' : 
                        file.name;
                    
                    photoLabel.querySelector('.photo-upload-text').innerHTML = `
                        <strong>📸 ${fileName}</strong><br>
                        <small>Click to change photo</small>
                    `;
                    photoLabel.style.borderColor = 'var(--success-color, #10b981)';
                    photoLabel.style.background = 'rgba(16, 185, 129, 0.05)';
                }
            });
        }
    });
    </script>
    
    <!-- About Us Modal - UPDATED -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ℹ️ About Coeliacs Like Beer Too</h2>
                <button class="modal-close" onclick="closeModal('aboutModal')" aria-label="Close about modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="about-content">
                    <div class="about-section">
                        <h3>🍺 Our Mission</h3>
                        <p>We believe that being coeliac shouldn't mean missing out on great beer experiences. Our mission is to create the UK's most comprehensive, community-driven guide to gluten free beer options across the country.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>👥 Our Story</h3>
                        <p>Started by coeliacs, for coeliacs. We understand the frustration of walking into a pub and not knowing if they have any safe options. That's why we built this platform - to help our community find amazing gluten free beer wherever they are in the UK.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>🤝 Community Driven</h3>
                        <p>Every beer report, every pub update, every photo comes from real people in the coeliac community. Together, we're building something that helps everyone discover new places and feel confident about their choices.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>📈 Growing Together</h3>
                        <p>With thousands of pubs in our database and growing reports every day, we're becoming the go-to resource for gluten free beer discovery. Join us in making the UK more accessible for coeliacs!</p>
                    </div>
                    
                    <div class="contact-info">
                        <h3>💬 Get in Touch</h3>
                        <p>Questions, suggestions, or partnership opportunities? We'd love to hear from you!</p>
                        <button onclick="showComingSoon('Contact Form')" class="btn btn-primary">Contact Us</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GF Info Modal - UPDATED -->
    <div id="gfInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🔬 What is Gluten Free Beer?</h2>
                <button class="modal-close" onclick="closeModal('gfInfoModal')" aria-label="Close GF info modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="gf-content">
                    <div class="gf-section">
                        <h3>🧪 Official Standards</h3>
                        <div class="standards-grid">
                            <div class="standard-item">
                                <strong>🇬🇧 UK & EU</strong>
                                <p>Less than 20ppm gluten</p>
                            </div>
                            <div class="standard-item">
                                <strong>🇺🇸 USA</strong>
                                <p>Made only with gluten free ingredients</p>
                            </div>
                            <div class="standard-item">
                                <strong>🇦🇺 Australia</strong>
                                <p>Made only with gluten free ingredients</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gf-section">
                        <h3>🏷️ Types of GF Beer</h3>
                        <div class="beer-types">
                            <div class="beer-type-item">
                                <strong>✅ Certified Gluten Free</strong>
                                <p>Made from naturally gluten free grains (rice, sorghum, millet). Safest option.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>⚗️ Gluten Removed/Reduced</strong>
                                <p>Made from barley/wheat but treated with enzymes to break down gluten. Some coeliacs react.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>🌾 "Made Without Gluten"</strong>
                                <p>No gluten ingredients added, but may have cross-contamination. Check carefully!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gf-section">
                        <h3>⚠️ Important Notes</h3>
                        <ul class="safety-notes">
                            <li><strong>Cross-contamination</strong> can happen in breweries that also make regular beer</li>
                            <li><strong>Always check labels</strong> and ask staff about preparation methods</li>
                            <li><strong>Coeliacs vs Gluten Intolerant</strong> - Coeliac disease is an autoimmune condition requiring strict gluten avoidance, while gluten intolerance is a separate digestive sensitivity</li>
                            <li><strong>When in doubt</strong>, choose certified gluten free options</li>
                        </ul>
                    </div>
                    
                    <div class="disclaimer">
                        <p><strong>Disclaimer:</strong> This information is for guidance only. Always consult with healthcare professionals and verify product safety for your individual needs.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Smart Coordinate Modal - UPDATED -->
    <div id="coordinateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalPubName">Help us locate this pub!</h2>
                <button class="modal-close" onclick="closeModal('coordinateModal')" aria-label="Close coordinate modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <p>We'll search near the postcode and you can click to pinpoint the exact location.</p>
                
                <div class="modal-instructions">
                    <span id="modalInstructions">🗺️ Searching for the pub area...</span>
                </div>
                
                <div id="coordinateMap" class="modal-map"></div>
                
                <div id="selectedLocationInfo" class="selected-location" style="display: none;">
                    <div>📍 Selected location:</div>
                    <div class="coordinates" id="selectedCoordinates"></div>
                </div>
                
                <div class="form-actions">
                    <button id="confirmLocation" class="btn btn-success">
                        ✅ Confirm Location
                    </button>
                    <button id="cancelModal" class="btn btn-secondary" onclick="closeModal('coordinateModal')">
                        ❌ Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ================================
     REPORT MODAL HTML
     🔧 ACTION: ADD this entire modal to templates/index.html
     📍 LOCATION: Add after your existing modals (after aboutModal, gfInfoModal, etc.)
     📝 NOTE: This should go BEFORE the bottom navigation bar
     ================================ -->

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">📸 Report GF Beer Find</h2>
                <button class="modal-close" onclick="closeModal('reportModal')" aria-label="Close report modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="reportForm" class="modal-form" onsubmit="handleReportSubmission(event)">
                    
                    <!-- Pub Search Field (hidden when pre-populated) -->
                    <div class="form-group" id="pubSearchGroup">
                        <label class="form-label">Find Your Pub *</label>
                        <input type="text" id="reportPubSearch" class="form-input" 
                               placeholder="Start typing pub name..." autocomplete="off">
                        <div id="pubSuggestions" class="suggestions"></div>
                        <small style="color: var(--text-muted); font-size: 0.8rem;">
                            Search for an existing pub first - we'll check our database!
                        </small>
                    </div>
                    
                    <!-- Selected Pub Info (shown when pub selected) -->
                    <div id="selectedPubInfo" class="selected-pub-info" style="display: none;">
                        <div class="selected-pub-card">
                            <strong id="selectedPubName"></strong>
                            <div id="selectedPubAddress"></div>
                            <button type="button" onclick="clearSelectedPub()" class="btn btn-secondary btn-sm">
                                Choose Different Pub
                            </button>
                        </div>
                    </div>
                    
                    <!-- New Pub Fields (shown when adding new pub) -->
                    <div id="newPubFields" class="new-pub-fields" style="display: none;">
                        <h4>📍 Add New Pub</h4>
                        <div class="form-group">
                            <label class="form-label">Pub Name *</label>
                            <input type="text" id="reportPubName" class="form-input" placeholder="The Red Lion">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <input type="text" id="reportAddress" class="form-input" placeholder="123 High Street">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode *</label>
                            <input type="text" id="reportPostcode" class="form-input" placeholder="SW1A 1AA">
                        </div>
                    </div>
                    
                    <!-- Beer Format (Required) -->
                    <div class="form-group">
                        <label class="form-label">Beer Format *</label>
                        <select id="reportFormat" name="reportFormat" class="form-select" required>
                            <option value="">Select format...</option>
                            <option value="bottle">🍺 Bottle</option>
                            <option value="tap">🚰 Tap</option>
                            <option value="cask">🛢️ Cask</option>
                            <option value="can">🥫 Can</option>
                        </select>
                    </div>
                    
                    <!-- Brewery (Dropdown with search) -->
                    <div class="form-group">
                        <label class="form-label">Brewery</label>
                        <div class="brewery-dropdown-container">
                            <input type="text" id="reportBrewery" name="reportBrewery" class="form-input" 
                                   placeholder="Start typing brewery name..." 
                                   autocomplete="off" onInput="searchBreweries(this.value)">
                            <div id="breweryDropdown" class="suggestions brewery-suggestions"></div>
                        </div>
                    </div>
                    
                    <!-- Beer Name (Auto-complete based on brewery) -->
                    <div class="form-group">
                        <label class="form-label">Beer Name</label>
                        <div class="beer-name-container">
                            <input type="text" id="reportBeerName" name="reportBeerName" class="form-input" 
                                   placeholder="Start typing beer name..." 
                                   autocomplete="off" onInput="searchBeerNames(this.value)">
                            <div id="beerNameDropdown" class="suggestions beer-suggestions"></div>
                        </div>
                    </div>
                    
                    <!-- Beer Style (Auto-complete based on selected beer) -->
                    <div class="form-group">
                        <label class="form-label">Beer Style</label>
                        <div class="beer-style-container">
                            <input type="text" id="reportBeerStyle" name="reportBeerStyle" class="form-input" 
                                   placeholder="IPA, Lager, Stout..." 
                                   autocomplete="off" onInput="searchBeerStyles(this.value)">
                            <div id="beerStyleDropdown" class="suggestions style-suggestions"></div>
                        </div>
                    </div>
                    
                    <!-- Beer ABV (Auto-complete based on selected beer) -->
                    <div class="form-group">
                        <label class="form-label">ABV (Alcohol %)</label>
                        <input type="number" id="reportBeerABV" name="reportBeerABV" class="form-input" 
                               placeholder="4.5" step="0.1" min="0" max="20">
                    </div>
                    
                    <!-- Compact Photo Upload -->
                    <div class="form-group">
                        <label class="form-label">Photo (Optional)</label>
                        <label for="reportPhoto" class="photo-upload-compact">
                            <div class="photo-upload-icon">📷</div>
                            <input type="file" id="reportPhoto" name="reportPhoto" 
                                   accept="image/*" style="display: none;">
                        </label>
                    </div>
                    
                    <!-- Form Actions (Sticky at bottom) -->
                    <div class="form-actions">
                        <button type="button" onclick="closeModal('reportModal')" class="btn btn-secondary">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-success">
                            Submit Report
                        </button>
                    </div>
                    
                </form>
            </div>
        </div>
    </div>
    
    <!-- Loading Toast - UPDATED -->
    <div id="loadingToast" class="toast toast-loading" style="display: none;">
        <div class="toast-content">
            <div class="spinner"></div>
            <span id="loadingMessage">Loading...</span>
        </div>
    </div>
    
    <!-- Success Toast - UPDATED -->
    <div id="successToast" class="toast toast-success" style="display: none;">
        <div class="toast-content">
            <span class="toast-icon">✅</span>
            <span id="successMessage">Success!</span>
        </div>
    </div>
    
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-consent" style="display: none;">
        <div class="cookie-content">
            <div class="cookie-text">
                <h4>🍪 We use cookies</h4>
                <p>We use essential cookies to make our site work. With your consent, we may also use analytics cookies to improve your experience.</p>
            </div>
            <div class="cookie-buttons">
                <button onclick="acceptAllCookies()" class="cookie-btn cookie-btn-accept">Accept All</button>
                <button onclick="acceptEssentialOnly()" class="cookie-btn cookie-btn-essential">Essential Only</button>
                <button onclick="showCookieSettings()" class="cookie-btn cookie-btn-settings">Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Cookie Settings Modal -->
    <div id="cookieSettings" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">🍪 Cookie Settings</h2>
                <button class="modal-close" onclick="closeModal('cookieSettings')" aria-label="Close cookie settings">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="cookie-settings-content">
                    <div class="cookie-category">
                        <div class="cookie-category-header">
                            <h3>Essential Cookies</h3>
                            <label class="cookie-toggle">
                                <input type="checkbox" checked disabled>
                                <span class="toggle-slider essential"></span>
                            </label>
                        </div>
                        <p>These cookies are necessary for the website to function and cannot be switched off. They are usually only set in response to actions made by you which amount to a request for services.</p>
                        <div class="cookie-details">
                            <strong>Examples:</strong> Session management, search preferences, location consent
                        </div>
                    </div>
                    
                    <div class="cookie-category">
                        <div class="cookie-category-header">
                            <h3>Analytics Cookies</h3>
                            <label class="cookie-toggle">
                                <input type="checkbox" id="analyticsConsent">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p>These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our service.</p>
                        <div class="cookie-details">
                            <strong>Provider:</strong> Google Analytics<br>
                            <strong>Purpose:</strong> Usage statistics, popular features, performance monitoring
                        </div>
                    </div>
                    
                    <div class="cookie-info">
                        <h4>📋 Your Rights</h4>
                        <ul>
                            <li>You can change your preferences at any time</li>
                            <li>Withdrawing consent may limit website functionality</li>
                            <li>Essential cookies cannot be disabled</li>
                            <li>See our <a href="/cookies" target="_blank">Cookie Policy</a> for full details</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="savesCookiePreferences()" class="btn btn-primary">Save Preferences</button>
                    <button onclick="acceptAllFromSettings()" class="btn btn-success">Accept All</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Cookie Settings Button (appears after consent given) -->
    <div id="cookieSettingsFloat" class="cookie-settings-float" style="display: none;">
        <button onclick="showCookieSettings()" class="cookie-float-btn" title="Cookie Settings">
            🍪
        </button>
    </div>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item active">
            <div class="nav-icon">🏠</div>
            <div class="nav-label">Home</div>
        </a>
        
        <a href="#" onclick="toggleSearchResultsFullMap(); return false;" class="nav-item">
            <div class="nav-icon">🗺️</div>
            <div class="nav-label">Map</div>
        </a>
        
        <a href="/breweries" class="nav-item">
            <div class="nav-icon">🍺</div>
            <div class="nav-label">Breweries</div>
        </a>
        
        <a href="/about" class="nav-item">
            <div class="nav-icon">ℹ️</div>
            <div class="nav-label">About</div>
        </a>
        
        <a href="/more" class="nav-item">
            <div class="nav-icon">⋯</div>
            <div class="nav-label">More</div>
        </a>
    </nav>

    <!-- END OF HTML SCRIPT -->
    <!-- START OF JAVASCRIPT -->

    <script>
        // Cache-busting timestamp
        console.log('🚀 CACHE BUSTER:', '{{ cache_buster }}');
        
        var map;
        var userLocation = null;
        var pubMarkers = [];
        var userMarker = null;

        // Smart coordinate modal variables
        var coordinateMap;
        var selectedMarker;
        var currentPub;
        var selectedCoordinates = null;

        // Global pagination variables
        let currentPage = 1;
        let currentQuery = '';
        let currentSearchType = 'all';
        let currentGfOnly = false;

        // Global variables for auto-complete
        let brewerySearchTimeout;
        let beerSearchTimeout;
        let styleSearchTimeout;
        
        // console.log('🔍 Initial lastSearchState:', typeof lastSearchState !== 'undefined' ? lastSearchState : 'UNDEFINED');
        let lastSearchState = null;
        console.log('🔍 After declaration lastSearchState:', lastSearchState);

        // DEBUG: Mobile overlay detector
        // REPLACE your showDebugInfo function (remove the worm code from inside it)
        function showDebugInfo() {
            // Create debug panel
            const debugPanel = document.createElement('div');
            debugPanel.id = 'debugPanel';
            debugPanel.style.cssText = `
                position: fixed;
                top: 10px;
                left: 10px;
                right: 10px;
                background: rgba(255, 255, 0, 0.9);
                color: black;
                padding: 10px;
                border-radius: 10px;
                z-index: 99999;
                font-size: 12px;
                max-height: 400px;
                overflow-y: auto;
            `;
            
            let debugInfo = '<strong>🔍 RESULTS VISIBILITY CHECK:</strong><br>';
            
            // Check results overlay
            const resultsOverlay = document.getElementById('resultsOverlay');
            if (resultsOverlay) {
                const styles = window.getComputedStyle(resultsOverlay);
                debugInfo += `📋 Results Overlay: display=${styles.display}, active=${resultsOverlay.classList.contains('active')}<br>`;
            }
            
            // Check results containers
            const resultsListContainer = document.getElementById('resultsListContainer');
            if (resultsListContainer) {
                const styles = window.getComputedStyle(resultsListContainer);
                debugInfo += `📦 List Container: display=${styles.display}<br>`;
            }
            
            const resultsList = document.getElementById('resultsList');
            if (resultsList) {
                const styles = window.getComputedStyle(resultsList);
                const resultsCount = resultsList.children.length;
                debugInfo += `📝 Results List: display=${styles.display}, items=${resultsCount}<br>`;
                
                if (resultsCount > 0) {
                    debugInfo += `✅ First result: ${resultsList.firstChild.textContent.substring(0, 50)}...<br>`;
                } else {
                    debugInfo += `❌ No results in list!<br>`;
                }
            }
            
            // Check what's visible
            debugInfo += '<br><strong>VISIBLE ELEMENTS:</strong><br>';
            
            const searchSection = document.querySelector('.search-section');
            if (searchSection) {
                const styles = window.getComputedStyle(searchSection);
                debugInfo += `🔍 Search Section: display=${styles.display}<br>`;
            }
            
            const heroSection = document.querySelector('.hero-section');
            if (heroSection) {
                const styles = window.getComputedStyle(heroSection);
                debugInfo += `🦸 Hero Section: display=${styles.display}<br>`;
            }
            
            // Check z-index issues
            debugInfo += '<br><strong>Z-INDEX CHECK:</strong><br>';
            const overlayZ = resultsOverlay ? window.getComputedStyle(resultsOverlay).zIndex : 'N/A';
            debugInfo += `📊 Results Overlay z-index: ${overlayZ}<br>`;

            const pubDetailsOverlay = document.getElementById('pubDetailsOverlay');
            if (pubDetailsOverlay) {
                const styles = window.getComputedStyle(pubDetailsOverlay);
                debugInfo += `🏠 Pub Details: display=${styles.display}, active=${pubDetailsOverlay.classList.contains('active')}<br>`;
            }
            
            const pubContainer = document.getElementById('pubContainer');
            if (pubContainer) {
                debugInfo += `📦 Pub Container: split-view=${pubContainer.classList.contains('split-view')}<br>`;
            }
            
            debugPanel.innerHTML = debugInfo + '<br><button onclick="this.parentElement.remove()">Close Debug</button>';
            document.body.appendChild(debugPanel);
        }

        // Add debug button to page - THIS SHOULD ALREADY EXIST IN YOUR CODE
        window.addEventListener('load', () => {
            const debugBtn = document.createElement('button');
            debugBtn.textContent = '🐛 Debug';  // Your worm!
            debugBtn.style.cssText = `
                position: fixed;
                bottom: 100px;
                right: 10px;
                z-index: 99999;
                background: yellow;
                color: black;
                padding: 10px;
                border-radius: 50%;
                border: 2px solid black;
            `;
            debugBtn.onclick = showDebugInfo;
            document.body.appendChild(debugBtn);
        });
        
        // ================================
        // 🔄 REPLACE: Your searchBreweries function to show ALL breweries
        // ================================
        
        async function searchBreweries(query) {
            clearTimeout(brewerySearchTimeout);
            const dropdown = document.getElementById('breweryDropdown');
            
            // Show ALL breweries on click/focus (increased limits)
            if (query.length < 1) {
                try {
                    const response = await fetch('/api/breweries');
                    const breweries = await response.json();
                    
                    dropdown.innerHTML = '';
                    if (breweries.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    // Add header showing total count
                    const header = document.createElement('div');
                    header.className = 'dropdown-header';
                    header.innerHTML = `🍺 ${breweries.length} Breweries Available`;
                    dropdown.appendChild(header);
                    
                    // Show ALL breweries (increased from 20 to 100)
                    breweries.slice(0, 100).forEach(brewery => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item brewery-item';
                        div.innerHTML = `<strong>${brewery}</strong>`;
                        div.addEventListener('click', () => selectBrewery(brewery));
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error loading breweries:', error);
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            brewerySearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/api/breweries?q=${encodeURIComponent(query)}`);
                    const breweries = await response.json();
                    
                    dropdown.innerHTML = '';
                    if (breweries.length === 0) {
                        dropdown.style.display = 'none';
                        return;
                    }
                    
                    // Add search header
                    const header = document.createElement('div');
                    header.className = 'dropdown-header';
                    header.innerHTML = `🔍 ${breweries.length} matches for "${query}"`;
                    dropdown.appendChild(header);
                    
                    // Show ALL search results (increased from 8 to 50)
                    breweries.slice(0, 50).forEach(brewery => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item brewery-item';
                        div.innerHTML = `<strong>${brewery}</strong>`;
                        div.addEventListener('click', () => selectBrewery(brewery));
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error searching breweries:', error);
                    dropdown.style.display = 'none';
                }
            }, 200); // Faster response time too
        }

        // ================================
        // 🔄 REPLACE: Your selectBrewery function to never auto-fill
        // ================================
        
        function selectBrewery(brewery) {
            console.log('🍺 selectBrewery called with:', brewery);
            
            // Set brewery field
            const breweryInput = document.getElementById('reportBrewery');
            breweryInput.value = brewery;
            console.log('✅ Set brewery to:', breweryInput.value);
            
            // Hide brewery dropdown
            document.getElementById('breweryDropdown').style.display = 'none';
            
            // Clear dependent fields completely
            const beerNameInput = document.getElementById('reportBeerName');
            const beerStyleInput = document.getElementById('reportBeerStyle');
            const beerABVInput = document.getElementById('reportBeerABV');
            
            beerNameInput.value = '';
            beerStyleInput.value = '';
            beerABVInput.value = '';
            
            console.log('✅ Cleared all beer fields');
            
            // Load beers and show dropdown immediately
            loadBeersAndShowDropdown(brewery);
            
            trackEvent('brewery_selected', 'Form Interaction', brewery);
        }
        
        // ================================
        // ➕ ADD: New function to load beers and immediately show dropdown
        // ================================
        
        async function loadBeersAndShowDropdown(brewery) {
            const beerNameInput = document.getElementById('reportBeerName');
            const beerDropdown = document.getElementById('beerNameDropdown');
            
            console.log(`🍺 Loading beers for ${brewery} and showing dropdown...`);
            
            try {
                const response = await fetch(`/api/brewery/${encodeURIComponent(brewery)}/beers`);
                const beers = await response.json();
                
                console.log('🔍 API response:', beers);
                console.log('🔍 Number of beers:', beers.length);
                
                if (beers.length === 0) {
                    // No beers - show "add new" option
                    beerNameInput.placeholder = `Add new beer for ${brewery}`;
                    showSuccessToast(`📝 No existing beers for ${brewery}. Add a new one!`);
                    
                    // Show "add new" dropdown
                    showAddNewBeerDropdown(brewery);
                    
                } else {
                    // ALWAYS show dropdown, never auto-fill
                    beerNameInput.placeholder = `Choose from ${beers.length} ${brewery} beers...`;
                    showSuccessToast(`🍺 Found ${beers.length} beers from ${brewery}! Click below to choose.`);
                    
                    // Populate and show dropdown immediately
                    populateBeerDropdownWithAddNew(beers, brewery);
                }
                
                // Focus the beer name field to show dropdown
                setTimeout(() => {
                    beerNameInput.focus();
                }, 200);
                
            } catch (error) {
                console.error('❌ Error loading beers:', error);
                beerNameInput.placeholder = 'Enter beer name...';
                showSuccessToast(`❌ Error loading ${brewery} beers. You can still add manually!`);
            }
        }
        
        // ================================
        // ➕ ADD: Enhanced dropdown with "Add New Beer" option
        // ================================
        
        function populateBeerDropdownWithAddNew(beers, brewery) {
            const dropdown = document.getElementById('beerNameDropdown');
            
            dropdown.innerHTML = '';
            
            // Header showing count
            const header = document.createElement('div');
            header.className = 'dropdown-header';
            header.innerHTML = `🍺 ${beers.length} ${brewery} Beers`;
            dropdown.appendChild(header);
            
            // Add "Add New Beer" option at the top
            const addNewDiv = document.createElement('div');
            addNewDiv.className = 'suggestion-item add-new-item';
            addNewDiv.innerHTML = `
                <strong>➕ Add New Beer for ${brewery}</strong><br>
                <small style="color: var(--text-muted);">Add a beer not in our database</small>
            `;
            addNewDiv.addEventListener('click', () => {
                document.getElementById('reportBeerName').value = '';
                document.getElementById('reportBeerStyle').value = '';
                document.getElementById('reportBeerABV').value = '';
                dropdown.style.display = 'none';
                document.getElementById('reportBeerName').placeholder = `Enter new beer name for ${brewery}`;
                document.getElementById('reportBeerName').focus();
                showSuccessToast(`📝 Ready to add new beer for ${brewery}!`);
            });
            dropdown.appendChild(addNewDiv);
            
            // Add all existing beers
            beers.forEach(beer => {
                const div = document.createElement('div');
                div.className = 'suggestion-item beer-item';
                div.innerHTML = `
                    <strong>${beer.name}</strong><br>
                    <small style="color: var(--text-muted);">
                        ${beer.style || 'Unknown style'} • ${beer.abv || '?'}% ABV
                        ${beer.gluten_status ? ' • ' + beer.gluten_status.replace('_', ' ') : ''}
                    </small>
                `;
                div.addEventListener('click', () => selectBeer(beer));
                dropdown.appendChild(div);
            });
            
            dropdown.style.display = 'block';
            console.log(`✅ Populated dropdown with ${beers.length} beers + add new option`);
        }
        
        // ================================
        // ➕ ADD: Show "Add New Beer" dropdown when no beers exist
        // ================================
        
        function showAddNewBeerDropdown(brewery) {
            const dropdown = document.getElementById('beerNameDropdown');
            
            dropdown.innerHTML = '';
            
            // Header
            const header = document.createElement('div');
            header.className = 'dropdown-header';
            header.innerHTML = `📝 No ${brewery} Beers in Database`;
            dropdown.appendChild(header);
            
            // Add new beer option
            const addNewDiv = document.createElement('div');
            addNewDiv.className = 'suggestion-item add-new-item';
            addNewDiv.innerHTML = `
                <strong>➕ Add First Beer for ${brewery}</strong><br>
                <small style="color: var(--text-muted);">Be the first to add a ${brewery} beer!</small>
            `;
            addNewDiv.addEventListener('click', () => {
                dropdown.style.display = 'none';
                document.getElementById('reportBeerName').placeholder = `Enter new beer name for ${brewery}`;
                document.getElementById('reportBeerName').focus();
                showSuccessToast(`🎉 Adding first beer for ${brewery}!`);
            });
            dropdown.appendChild(addNewDiv);
            
            dropdown.style.display = 'block';
        }
                
        // ================================
        // SEARCH BEER NAMES
        // ================================
        
        async function searchBeerNames(query) {
            clearTimeout(beerSearchTimeout);
            const dropdown = document.getElementById('beerNameDropdown');
            const brewery = document.getElementById('reportBrewery').value;
            
            if (query.length < 1) {
                // If we have a brewery selected, show its beers
                if (brewery) {
                    try {
                        const response = await fetch(`/api/brewery/${encodeURIComponent(brewery)}/beers`);
                        const beers = await response.json();
                        if (beers.length > 0) {
                            populateBeerDropdown(beers);
                        } else {
                            dropdown.style.display = 'none';
                        }
                    } catch (error) {
                        dropdown.style.display = 'none';
                    }
                } else {
                    dropdown.style.display = 'none';
                }
                return;
            }
            
            beerSearchTimeout = setTimeout(async () => {
                try {
                    let url;
                    if (brewery) {
                        url = `/api/brewery/${encodeURIComponent(brewery)}/beers?q=${encodeURIComponent(query)}`;
                    } else {
                        url = `/api/beers/search?q=${encodeURIComponent(query)}`;
                    }
                    
                    const response = await fetch(url);
                    const beers = await response.json();
                    
                    dropdown.innerHTML = '';
                    
                    if (beers.length === 0) {
                        // Show "Add new beer" option
                        const div = document.createElement('div');
                        div.className = 'suggestion-item add-new-item';
                        div.innerHTML = `
                            <strong>➕ Add "${query}" as new beer</strong>
                            <small style="color: var(--text-muted);">${brewery ? 'for ' + brewery : 'We\'ll add this to our database'}</small>
                        `;
                        div.addEventListener('click', () => {
                            document.getElementById('reportBeerName').value = query;
                            dropdown.style.display = 'none';
                            document.getElementById('reportBeerStyle').focus();
                        });
                        dropdown.appendChild(div);
                        dropdown.style.display = 'block';
                        return;
                    }
                    
                    // Add header for search results
                    const header = document.createElement('div');
                    header.className = 'dropdown-header';
                    header.innerHTML = `🔍 ${beers.length} matches for "${query}"`;
                    dropdown.appendChild(header);
                    
                    beers.forEach(beer => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item beer-item';
                        div.innerHTML = `
                            <strong>${beer.name}</strong><br>
                            <small style="color: var(--text-muted);">
                                ${beer.style || 'Unknown style'} • ${beer.abv || '?'}% ABV
                            </small>
                        `;
                        div.addEventListener('click', () => selectBeer(beer));
                        dropdown.appendChild(div);
                    });
                    dropdown.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error searching beer names:', error);
                    dropdown.style.display = 'none';
                }
            }, 200);
        }

        
        // ➕ ADD - Beer style search functionality
        async function searchBeerStyles(query) {
            clearTimeout(styleSearchTimeout);
            const dropdown = document.getElementById('beerStyleDropdown');
            
            if (query.length < 2) {
                dropdown.style.display = 'none';
                return;
            }
            
            // Common beer styles for quick selection
            const commonStyles = [
                'IPA', 'Pale Ale', 'Lager', 'Pilsner', 'Stout', 'Porter', 
                'Wheat Beer', 'Saison', 'Amber Ale', 'Brown Ale', 'Bitter',
                'Session IPA', 'Double IPA', 'Hazy IPA', 'Sour', 'Gose'
            ];
            
            const filtered = commonStyles.filter(style => 
                style.toLowerCase().includes(query.toLowerCase())
            );
            
            dropdown.innerHTML = '';
            if (filtered.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            
            filtered.forEach(style => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = style;
                div.addEventListener('click', () => {
                    document.getElementById('reportBeerStyle').value = style;
                    dropdown.style.display = 'none';
                    
                    trackEvent('style_selected', 'Form Interaction', style);
                });
                dropdown.appendChild(div);
            });
            dropdown.style.display = 'block';
        }

        // ================================
        // This handles the smart auto-fill when brewery is selected
        // ================================
        
        // ================================
        // 🔄 REPLACE: Your loadBeersForBrewery function to always show dropdown
        // ================================
        
        async function loadBeersForBrewery(brewery) {
            const beerNameInput = document.getElementById('reportBeerName');
            const beerStyleInput = document.getElementById('reportBeerStyle');
            const beerABVInput = document.getElementById('reportBeerABV');
            
            console.log(`🍺 Loading beers for ${brewery}...`);
            
            try {
                const response = await fetch(`/api/brewery/${encodeURIComponent(brewery)}/beers`);
                const beers = await response.json();
                
                console.log('🔍 DEBUG - API response:', beers);
                console.log('🔍 DEBUG - Number of beers:', beers.length);
                
                if (beers.length === 0) {
                    // No beers found - let user add new one
                    console.log('📝 No existing beers found - ready for new beer entry');
                    beerNameInput.placeholder = `Add new beer for ${brewery}`;
                    beerStyleInput.placeholder = 'Enter beer style (IPA, Lager, etc.)';
                    beerABVInput.placeholder = '4.5';
                    
                    showSuccessToast(`📝 No existing beers for ${brewery}. Add a new one!`);
                    
                    // Focus beer name field for user to start typing
                    setTimeout(() => {
                        beerNameInput.focus();
                    }, 500);
                    
                } else {
                    // CHANGED: Always show dropdown, even for single beer
                    console.log(`🔍 DEBUG - Found ${beers.length} beers, showing dropdown`);
                    beerNameInput.placeholder = `Choose from ${beers.length} ${brewery} beers...`;
                    
                    showSuccessToast(`Found ${beers.length} beers from ${brewery}! Choose one below.`);
                    
                    // Always show dropdown - let user choose
                    populateBeerDropdown(beers);
                    
                    // Focus the beer name field to show dropdown
                    setTimeout(() => {
                        beerNameInput.focus();
                    }, 300);
                }
                
            } catch (error) {
                console.error('❌ Error loading beers for brewery:', error);
                beerNameInput.placeholder = 'Enter beer name...';
                showSuccessToast(`❌ Error loading ${brewery} beers. You can still add manually!`);
            }
        }
        
        // ➕ ADD: Function to show beer dropdown
        function populateBeerDropdown(beers) {
            const dropdown = document.getElementById('beerNameDropdown');
            
            dropdown.innerHTML = '';
            
            // Add a header showing count
            const header = document.createElement('div');
            header.className = 'dropdown-header';
            header.innerHTML = `🍺 ${beers.length} Beers Available`;
            dropdown.appendChild(header);
            
            beers.forEach(beer => {
                const div = document.createElement('div');
                div.className = 'suggestion-item beer-item';
                div.innerHTML = `
                    <strong>${beer.name}</strong><br>
                    <small style="color: var(--text-muted);">
                        ${beer.style || 'Unknown style'} • ${beer.abv || '?'}% ABV
                        ${beer.gluten_status ? ' • ' + beer.gluten_status.replace('_', ' ') : ''}
                    </small>
                `;
                div.addEventListener('click', () => selectBeer(beer));
                dropdown.appendChild(div);
            });
            
            dropdown.style.display = 'block';
            console.log(`✅ Populated dropdown with ${beers.length} beers`);
        }
        
        // ➕ ADD: Function to handle beer selection
        // ================================
        // 🔄 REPLACE: selectBeer function - clean JavaScript only
        // ================================
        
        function selectBeer(beer) {
            const beerNameInput = document.getElementById('reportBeerName');
            const beerStyleInput = document.getElementById('reportBeerStyle');
            const beerABVInput = document.getElementById('reportBeerABV');
            const dropdown = document.getElementById('beerNameDropdown');
            
            // Fill all the fields
            beerNameInput.value = beer.name;
            beerStyleInput.value = beer.style || '';
            beerABVInput.value = beer.abv || '';
            
            // Hide dropdown
            dropdown.style.display = 'none';
            
            // Add CSS class for visual feedback (proper way)
            beerNameInput.classList.add('auto-filled');
            beerStyleInput.classList.add('auto-filled');
            beerABVInput.classList.add('auto-filled');
            
            // Remove the CSS class after 2 seconds
            setTimeout(() => {
                beerNameInput.classList.remove('auto-filled');
                beerStyleInput.classList.remove('auto-filled');
                beerABVInput.classList.remove('auto-filled');
            }, 2000);
            
            showSuccessToast(`✅ Selected: ${beer.name} (${beer.abv}% ${beer.style})!`);
            
            // Focus format field since beer details are complete
            setTimeout(() => {
                const formatField = document.getElementById('reportFormat');
                if (formatField && !formatField.value) {
                    formatField.focus();
                }
            }, 300);
            
            trackEvent('beer_selected', 'Form Interaction', beer.name);
        }
        
        // ➕ ADD - Enhanced photo upload handler
        function handlePhotoUpload() {
            const photoInput = document.getElementById('reportPhoto');
            const photoLabel = document.querySelector('.photo-upload-compact');
            
            if (photoInput && photoLabel) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const fileName = file.name.length > 20 ? 
                            file.name.substring(0, 17) + '...' : 
                            file.name;
                        
                        photoLabel.querySelector('.photo-upload-text').innerHTML = `
                            <strong>📸 ${fileName}</strong><br>
                            <small>Click to change photo</small>
                        `;
                        photoLabel.style.borderColor = 'var(--success-border)';
                        photoLabel.style.background = 'var(--success-bg)';
                        
                        trackEvent('photo_selected', 'Form Interaction', 'photo_upload');
                    }
                });
            }
        }


        // ================================
        // UPDATED LOCATION FUNCTIONS WITH DISTANCE MODAL
        // ================================
        
        // Main function - now opens distance modal first
        function startLocationSearch() {
            console.log('🎯 Starting location search with distance selection...');
            
            // Track the action
            trackEvent('location_search_start', 'Search', 'distance_modal');
            
            // Show distance selection modal
            openModal('distanceModal');
        }
        
        // Called when user selects a distance
        async function searchNearbyWithDistance(radiusKm) {
            console.log(`🎯 Searching within ${radiusKm}km...`);
            
            // Close distance modal
            closeSearchModal();
            
            // Show results overlay immediately
            showResultsOverlay(`Pubs within ${radiusKm}km`);
            
            // Check if we have location
            if (!userLocation) {
                showResultsLoading('Getting your location...');
                try {
                    await requestUserLocationForSearch();
                } catch (error) {
                    showNoResults('Could not get your location');
                    return;
                }
            }
            
            // SAVE the search state AFTER we have confirmed location
            lastSearchState = {
                type: 'nearby',
                radius: radiusKm,
                userLocation: userLocation, // Save the actual location object
                timestamp: Date.now()
            };
            
            console.log('💾 Saved search state:', lastSearchState);
            
            // Start the search
            await findNearbyPubsWithRadius(radiusKm);
        }

        // ➕ ADD NEW - Smart back function that restores previous search
        function goBackToResults() {
            console.log('🔙 Going back to previous search results...');
            
            // Prevent any default behavior
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            if (!lastSearchState) {
                console.log('❌ No previous search state, going home');
                closePubDetails();
                return false;
            }
            
            // Check if state is recent (within last 30 minutes)
            const thirtyMinutes = 30 * 60 * 1000;
            if (Date.now() - lastSearchState.timestamp > thirtyMinutes) {
                console.log('⏰ Search state too old, going home');
                closePubDetails();
                return false;
            }
            
            console.log('✅ Restoring search state:', lastSearchState);
            
            // Close pub details
            closePubDetails();
            
            // Restore the search based on type
            if (lastSearchState.type === 'nearby') {
                restoreNearbySearch(lastSearchState);
            } else if (lastSearchState.type === 'name') {
                restoreNameSearch(lastSearchState);
            } else if (lastSearchState.type === 'area') {
                restoreAreaSearch(lastSearchState);
            } else if (lastSearchState.type === 'beer') {
                restoreBeerSearch(lastSearchState);
            } else {
                // Fallback
                console.log('❌ Unknown search type');
                closePubDetails();
            }
            
            trackEvent('back_to_results', 'Navigation', lastSearchState.type);
            return false; // Prevent any navigation
}

        // Add this right after your goBackToResults function (around line 1280)
        function debugBackButton() {
            console.log('🔙 Back button debug:');
            console.log('1. lastSearchState:', lastSearchState);
            console.log('2. userLocation:', userLocation);
            goBackToResults();
        }
        
        // ➕ ADD NEW - Restore nearby search
        async function restoreNearbySearch(state) {
            console.log('🔄 Restoring nearby search...', state);
            
            // FIRST: Restore user location from saved state
            if (state.userLocation) {
                userLocation = state.userLocation;
                console.log('✅ Restored user location:', userLocation);
            } else {
                console.log('❌ No saved user location, requesting fresh location...');
                // If no saved location, get fresh location
                try {
                    await requestUserLocationForSearch();
                } catch (error) {
                    console.error('❌ Could not get location:', error);
                    showNoResults('Could not get your location');
                    return;
                }
            }
            
            // Show results overlay and ensure it's visible
            const resultsOverlay = document.getElementById('resultsOverlay');
            resultsOverlay.classList.add('active');
            resultsOverlay.style.display = 'flex'; // Force display
            document.getElementById('resultsTitle').textContent = `Pubs within ${state.radius}km`;
            showResultsLoading('Restoring your search...');
            
            // Hide body scroll
            document.body.style.overflow = 'hidden';
            
            // Re-run the search with proper location
            try {
                console.log('🔍 Re-running search with location:', userLocation);
                await findNearbyPubsWithRadius(state.radius);
                showSuccessToast('📍 Restored your search results!');
            } catch (error) {
                console.error('❌ Error restoring search:', error);
                showNoResults('Could not restore search. Please try again.');
            }
        }
        
        // ➕ ADD NEW - Functions to save state for other search types
        function saveNameSearchState(query, results) {
            lastSearchState = {
                type: 'name',
                query: query,
                results: results,
                timestamp: Date.now()
            };
        }
        
        function saveAreaSearchState(query, results) {
            lastSearchState = {
                type: 'area',
                query: query,
                results: results,
                timestamp: Date.now()
            };
        }
        
        function saveBeerSearchState(query, results) {
            lastSearchState = {
                type: 'beer',
                query: query,
                results: results,
                timestamp: Date.now()
            };
        }
        
        // ➕ ADD NEW - Restore functions for other search types
        function restoreNameSearch(state) {
            showResultsOverlay(`Pub name: "${state.query}"`);
            if (state.results && state.results.length > 0) {
                displayResultsInOverlay(state.results, `Found "${state.query}"`);
            } else {
                showResultsLoading('Restoring search...');
                // Re-run the name search
                performSearch(state.query, 'name');
            }
        }
        
        function restoreAreaSearch(state) {
            showResultsOverlay(`Area: "${state.query}"`);
            if (state.results && state.results.length > 0) {
                displayResultsInOverlay(state.results, `Pubs in "${state.query}"`);
            } else {
                showResultsLoading('Restoring search...');
                // Re-run the area search
                performSearch(state.query, 'area');
            }
        }
        
        function restoreBeerSearch(state) {
            showResultsOverlay(`Beer: "${state.query}"`);
            if (state.results && state.results.length > 0) {
                displayResultsInOverlay(state.results, `Serving "${state.query}"`);
            } else {
                showResultsLoading('Restoring search...');
                // Re-run the beer search
                performSearch(state.query, 'beer');
            }
        }

        
        // Updated location request specifically for search
        function requestUserLocationForSearch() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Location not supported'));
                    return;
                }
        
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        console.log('✅ Location obtained:', userLocation);
                        resolve(userLocation);
                    },
                    (error) => {
                        console.log('❌ Location error:', error);
                        reject(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 300000
                    }
                );
            });
        }
        
        // REPLACE: In templates/index.html, find the findNearbyPubsWithRadius function
        // Replace the line that forces gf_only = true
        
        async function findNearbyPubsWithRadius(radiusKm) {
            // ADD THESE 7 LINES HERE - RIGHT AFTER THE OPENING BRACE
            // SAVE STATE RIGHT AT THE START
            lastSearchState = {
                type: 'nearby',
                radius: radiusKm,
                userLocation: userLocation,
                timestamp: Date.now()
            };
            console.log('💾 Saved search state at start of findNearbyPubsWithRadius:', lastSearchState);
            
            if (!userLocation) {
                showNoResults('Location not available');
                return;
            }
            
            console.log(`🔍 Searching for pubs within ${radiusKm}km...`);
            showResultsLoading(`Finding pubs within ${radiusKm}km...`);
            
            try {
                // CHANGE: Don't force gf_only=true, let users see all pubs initially
                const gfOnly = false; // Changed from: const gfOnly = true;
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radiusKm}&gf_only=${gfOnly}`;
                
                console.log('📡 API request:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const nearbyPubs = data.pubs || data;
                
                console.log(`✅ Found ${nearbyPubs.length} pubs`);
                
                if (nearbyPubs.length === 0) {
                    showNoResults(`No pubs found within ${radiusKm}km`);
                    return;
                }
                
                // Show results
                displayResultsInOverlay(nearbyPubs, `${nearbyPubs.length} pubs within ${radiusKm}km`);
                
                // Track success
                trackSearch(`nearby_${radiusKm}km`, 'location', nearbyPubs.length);
                
            } catch (error) {
                console.error('❌ Error finding nearby pubs:', error);
                showNoResults('Error finding pubs. Please try again.');
            }
        }
        
        
        // Results overlay management
        // REPLACE the showResultsOverlay function
        function showResultsOverlay(title) {
            console.log('📋 Showing results overlay with title:', title);
            
            // Update title
            document.getElementById('resultsTitle').textContent = title;
            
            // Get the overlay
            const resultsOverlay = document.getElementById('resultsOverlay');
            
            // Make sure it's visible
            resultsOverlay.classList.add('active');
            resultsOverlay.style.display = 'flex';
            
            // HIDE the home page sections
            const searchSection = document.querySelector('.search-section');
            if (searchSection) {
                searchSection.style.display = 'none';
            }
            
            const heroSection = document.querySelector('.hero-section');
            if (heroSection) {
                heroSection.style.display = 'none';
            }
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
            
            // Make sure the results list container is visible by default
            const resultsListContainer = document.getElementById('resultsListContainer');
            if (resultsListContainer) {
                resultsListContainer.style.display = 'block';
            }
            
            console.log('✅ Results overlay shown, home sections hidden');
        }
        
        // REPLACE the closeResults function to properly restore the home page
        function closeResults() {
            console.log('🏠 Closing results and returning to homepage');
            
            // Close results overlay
            const resultsOverlay = document.getElementById('resultsOverlay');
            if (resultsOverlay) {
                resultsOverlay.classList.remove('active');
                resultsOverlay.style.display = 'none';
            }
            
            // RESET results map to list view for next search
            const resultsListContainer = document.getElementById('resultsListContainer');
            const resultsMapContainer = document.getElementById('resultsMapContainer');
            const resultsMapBtnText = document.getElementById('resultsMapBtnText');
            
            if (resultsListContainer) resultsListContainer.style.display = 'block';
            if (resultsMapContainer) resultsMapContainer.style.display = 'none';
            if (resultsMapBtnText) resultsMapBtnText.textContent = 'Map';
            
            // SHOW the hero section again
            const heroSection = document.querySelector('.hero-section');
            if (heroSection) {
                heroSection.style.display = 'block';
            }
            
            // SHOW the home page search section again
            const searchSection = document.querySelector('.search-section');
            if (searchSection) {
                searchSection.style.display = 'block';
            }
            
            // Also close pub details overlay if open
            const pubDetailsOverlay = document.getElementById('pubDetailsOverlay');
            if (pubDetailsOverlay) {
                pubDetailsOverlay.classList.remove('active');
                pubDetailsOverlay.style.display = 'none';
            }
            
            // RESET pub map state too
            pubMapVisible = false;
            const pubContainer = document.getElementById('pubContainer');
            if (pubContainer) {
                pubContainer.classList.remove('split-view');
            }
            const pubMapContainer = document.getElementById('pubMapContainer');
            if (pubMapContainer) {
                pubMapContainer.classList.remove('map-visible');
            }
            
            // Restore background scrolling
            document.body.style.overflow = '';
            document.body.classList.remove('pub-details-open');
            
            // Clear the overlay content to prevent stale data
            const resultsList = document.getElementById('resultsList');
            const resultsLoading = document.getElementById('resultsLoading');
            const noResultsFound = document.getElementById('noResultsFound');
            
            if (resultsList) resultsList.innerHTML = '';
            if (resultsLoading) resultsLoading.style.display = 'flex';
            if (noResultsFound) noResultsFound.style.display = 'none';
            
            // DO NOT CLEAR lastSearchState - we want back button to work!
            
            trackEvent('close_results', 'Navigation');
        }
        
        // ================================
        // ➕ ADD: Function to reset homepage to clean search state
        // ================================
        
        // 🔄 REPLACE: Your resetHomepageToCleanState function
        function resetHomepageToCleanState() {
            console.log('🧹 Resetting homepage to clean state');
            
            // ✅ ADD: Force hide ALL overlay elements
            const allOverlays = document.querySelectorAll('[id*="Overlay"], [id*="Modal"]');
            allOverlays.forEach(overlay => {
                overlay.classList.remove('active');
                overlay.style.display = 'none';
            });
            
            // Hide map if visible
            const mapContainer = document.getElementById('mapContainer');
            if (mapVisible && mapContainer) {
                mapContainer.style.display = 'none';
                mapVisible = false;
                
                const toggleBtn = document.getElementById('toggleMapBtn');
                if (toggleBtn) {
                    toggleBtn.innerHTML = '🗺️ Show Map';
                }
            }
            
            // Show features and activity sections
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            if (featuresSection) {
                featuresSection.style.display = 'block';
                featuresSection.style.marginTop = '0';
            }
            
            if (activitySection) {
                activitySection.style.display = 'block';
                activitySection.style.marginTop = '0';
            }
            
            // Hide results section if visible
            const resultsSection = document.getElementById('results-section');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            
            // Reset search section margin
            const searchSection = document.getElementById('search');
            if (searchSection) {
                searchSection.style.marginTop = '-20px';
            }
            
            // Clear any search state
            currentQuery = '';
            currentSearchType = 'all';
            currentPage = 1;
            
            // Clear URL hash
            if (window.location.hash) {
                window.location.hash = '';
            }
            
            console.log('✅ Homepage reset to clean search state');
        }

        // 📝 ADD NEW - Better debugging for the location issue
        function debugLocationState() {
            console.log('🔍 Current location state:');
            console.log('userLocation:', userLocation);
            console.log('lastSearchState:', lastSearchState);
            
            if (lastSearchState && lastSearchState.userLocation) {
                console.log('Saved location:', lastSearchState.userLocation);
            } else {
                console.log('❌ No saved location in state');
            }
        }
        
        function showResultsLoading(message) {
            document.getElementById('resultsLoading').style.display = 'flex';
            document.getElementById('resultsList').style.display = 'none';
            document.getElementById('noResultsFound').style.display = 'none';
            
            document.querySelector('.loading-text').textContent = message;
        }
        
        function showNoResults(message) {
            document.getElementById('resultsLoading').style.display = 'none';
            document.getElementById('resultsList').style.display = 'none';
            document.getElementById('noResultsFound').style.display = 'flex';
            
            document.querySelector('.no-results-text').textContent = message;
        }
        
        function displayResultsInOverlay(pubs, title) {
            // Store pubs globally for map access
            currentSearchPubs = pubs;
            console.log('💾 Stored search results for map:', pubs.length, 'pubs');
            
            // Hide loading and no results
            document.getElementById('resultsLoading').style.display = 'none';
            document.getElementById('noResultsFound').style.display = 'none';
            
            // Get the results list container
            const resultsListContainer = document.getElementById('resultsListContainer');
            const resultsList = document.getElementById('resultsList');
            
            // IMPORTANT: Show the list container
            if (resultsListContainer) {
                resultsListContainer.style.display = 'block';
            }
            
            // Show and populate the results list
            resultsList.style.display = 'block';
            resultsList.innerHTML = '';
            
            // Update title
            document.getElementById('resultsTitle').textContent = title;
            
            // Generate results HTML
            pubs.forEach(pub => {
                const resultItem = createResultItemForOverlay(pub);
                resultsList.appendChild(resultItem);
            });
            
            // Save search state for back button
            if (!lastSearchState) {
                lastSearchState = {
                    type: 'nearby',
                    radius: 5,
                    userLocation: userLocation,
                    timestamp: Date.now()
                };
                console.log('💾 Auto-saved search state in displayResultsInOverlay');
            }
            
            console.log(`✅ Displayed ${pubs.length} results in overlay`);
        }
        
        // ================================
        // ENHANCED PUB CARDS WITH BETTER BEER DISPLAY
        // ================================
        
        function createResultItemForOverlay(pub) {
            const div = document.createElement('div');
            div.className = 'result-item';
            
            // Calculate distance if available
            let distanceText = '';
            if (pub.distance !== undefined) {
                distanceText = `<div class="result-distance">${pub.distance.toFixed(1)}km away</div>`;
            }
            
            // Enhanced GF availability display
            const gfInfo = createGFAvailabilityDisplay(pub);
            
            div.innerHTML = `
                <div class="result-header">
                    <div class="result-main-info">
                        <h3 class="result-title">${pub.name}</h3>
                        ${distanceText}
                    </div>
                    ${gfInfo.hasGF ? '<div class="gf-indicator">✅ GF Available</div>' : '<div class="gf-indicator unknown">❓ GF Unknown</div>'}
                </div>
                
                <div class="result-location">
                    <div class="result-address">${pub.address}</div>
                    <div class="result-postcode">${pub.postcode}</div>
                    <div class="result-authority">${pub.local_authority}</div>
                </div>
                
                <div class="gf-availability-section">
                    ${gfInfo.display}
                </div>
                
                <div class="result-actions">
                    <button class="btn btn-primary" onclick="showPubDetails(${pub.pub_id})">
                        📍 View Details
                    </button>
                    <button class="btn btn-secondary" onclick="viewPubOnline('${pub.name}', '${pub.postcode}')">
                        🔍 View Online
                    </button>
                    <button class="btn btn-secondary" onclick="getDirectionsToPub('${pub.name}', '${pub.address}', '${pub.postcode}')">
                        🧭 Directions
                    </button>
                </div>
            `;
            
            return div;
        }

        function createGFAvailabilityDisplay(pub) {
            const hasBottle = pub.bottle === 1;
            const hasTap = pub.tap === 1;
            const hasCask = pub.cask === 1;
            const hasCan = pub.can === 1;
            const hasAnyGF = hasBottle || hasTap || hasCask || hasCan;
            
            if (!hasAnyGF) {
                return {
                    hasGF: false,
                    display: `
                        <div class="gf-status unknown">
                            <div class="gf-status-title">❓ GF Status Unknown</div>
                            <div class="gf-status-text">Help the community by reporting what you find!</div>
                        </div>
                    `
                };
            }
            
            // Build format list
            const formats = [];
            if (hasBottle) formats.push({ icon: '🍺', name: 'Bottle' });
            if (hasTap) formats.push({ icon: '🚰', name: 'Tap' });
            if (hasCask) formats.push({ icon: '🛢️', name: 'Cask' });
            if (hasCan) formats.push({ icon: '🥫', name: 'Can' });
            
            return {
                hasGF: true,
                display: `
                    <div class="gf-status confirmed">
                        <div class="gf-status-title">✅ Gluten Free Options Confirmed</div>
                        <div class="gf-formats">
                            ${formats.map(format => `
                                <span class="gf-format-tag">
                                    ${format.icon} ${format.name}
                                </span>
                            `).join('')}
                        </div>
                        <div class="gf-note">💡 Call ahead to confirm current selection</div>
                    </div>
                `
            };
        }

        function viewPubOnline(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            
            window.open(googleUrl, '_blank');
            trackEvent('view_pub_online', 'External Navigation', pubName);
            
            showSuccessToast(`🔍 Searching for ${pubName} online...`);
        }
        
        function getDirectionsToPub(pubName, address, postcode) {
            const fullAddress = `${pubName}, ${address}, ${postcode}`;
            const encodedAddress = encodeURIComponent(fullAddress);
            
            // Check if mobile for better maps experience
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            let mapsUrl;
            if (isMobile) {
                // Mobile - try to open in native maps app
                mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedAddress}`;
            } else {
                // Desktop - open in browser
                mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
            }
            
            window.open(mapsUrl, '_blank');
            trackEvent('get_directions', 'External Navigation', pubName);
            
            showSuccessToast(`🧭 Opening directions to ${pubName}...`);
        }
        
        // ================================
        // 🔄 REPLACE: Your toggleResultsMap function with working version
        // ================================
        
        // RENAME: toggleResultsMap -> toggleSearchResultsFullMap
        function toggleSearchResultsFullMap() {
            const listContainer = document.getElementById('resultsListContainer');
            const mapContainer = document.getElementById('resultsMapContainer');
            const mapBtnText = document.getElementById('resultsMapBtnText');
            
            if (mapContainer.style.display === 'none' || !mapContainer.style.display) {
                // Show FULL SCREEN map for search results
                listContainer.style.display = 'none';
                mapContainer.style.display = 'block';
                mapBtnText.textContent = 'List';
                
                // Initialize the results map
                setTimeout(() => {
                    initializeResultsMap();
                }, 100);
                
                trackEvent('results_map_toggle', 'Map Interaction', 'show');
            } else {
                // Show list
                listContainer.style.display = 'block';
                mapContainer.style.display = 'none';
                mapBtnText.textContent = 'Map';
                
                trackEvent('results_map_toggle', 'Map Interaction', 'hide');
            }
        }
        
        // RENAME: togglePubMap -> togglePubDetailsSplitMap
        function togglePubDetailsSplitMap() {
            const container = document.getElementById('pubContainer');
            const mapContainer = document.getElementById('pubMapContainer');
            const mapBtnText = document.getElementById('pubMapBtnText');
            const mapBtn = document.getElementById('pubToggleMap');
            
            pubMapVisible = !pubMapVisible;
            
            if (pubMapVisible) {
                // Show SPLIT VIEW for individual pub details
                container.classList.add('split-view');
                mapContainer.classList.add('map-visible');
                mapBtnText.textContent = 'Hide Map';
                mapBtn.classList.add('active');
                
                console.log('🗺️ Pub split-view map toggled ON');
                
                // Initialize map if we have coordinates
                if (currentPubData && currentPubData.latitude && currentPubData.longitude) {
                    setTimeout(() => {
                        initializePubMap(currentPubData);
                    }, 300);
                } else {
                    // Show placeholder message
                    setTimeout(() => {
                        const placeholder = document.querySelector('.pub-map-placeholder');
                        if (placeholder) {
                            placeholder.innerHTML = `
                                <div>📍 Location coordinates not available</div>
                                <small style="opacity: 0.7;">Help us by reporting the exact location!</small>
                            `;
                        }
                    }, 300);
                }
                
                trackEvent('pub_map_toggle', 'Map Interaction', 'show');
            } else {
                // Hide split view
                container.classList.remove('split-view');
                mapContainer.classList.remove('map-visible');
                mapBtnText.textContent = 'Show on Map';
                mapBtn.classList.remove('active');
                
                console.log('🗺️ Pub split-view map toggled OFF');
                trackEvent('pub_map_toggle', 'Map Interaction', 'hide');
            }
        }
        
        // ================================
        // ➕ ADD: Initialize results map with current search results
        // ================================
        
        function initializeResultsMap() {
            const mapElement = document.getElementById('resultsMap');
            if (!mapElement) {
                console.error('Results map element not found');
                return;
            }
            
            // Clear any existing map
            mapElement.innerHTML = '';
            
            // Create new Leaflet map
            const resultsMap = L.map('resultsMap').setView([54.5, -3], 6); // Center on UK
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(resultsMap);
            
            // Add user location if available
            if (userLocation) {
                const userMarker = L.circleMarker([userLocation.lat, userLocation.lng], {
                    radius: 8,
                    fillColor: '#667eea',
                    color: '#ffffff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(resultsMap);
                
                userMarker.bindPopup('📍 Your location');
                
                // Center on user location
                resultsMap.setView([userLocation.lat, userLocation.lng], 10);
            }
            
            // Add markers for current search results
            addResultsToMap(resultsMap);
            
            // Invalidate size to ensure proper rendering
            setTimeout(() => {
                resultsMap.invalidateSize();
            }, 100);
            
            console.log('✅ Results map initialized');
        }
        
        // ================================
        // ➕ ADD: Add current search results to map
        // ================================
        
        // ================================
        // 🔄 REPLACE: Your addResultsToMap function to actually use pub data
        // ================================
        
        let currentSearchPubs = []; // Store search results globally
        
        function addResultsToMap(mapInstance) {
            console.log('📍 Adding pub data to map...', currentSearchPubs);
            
            if (!currentSearchPubs || currentSearchPubs.length === 0) {
                console.log('❌ No pub data available for map');
                showMapMessage(mapInstance, '🗺️ Map View', 'No pub location data available for current search');
                return;
            }
            
            let markersAdded = 0;
            const mapBounds = [];
            
            currentSearchPubs.forEach((pub, index) => {
                if (pub.latitude && pub.longitude && !isNaN(parseFloat(pub.latitude)) && !isNaN(parseFloat(pub.longitude))) {
                    const lat = parseFloat(pub.latitude);
                    const lng = parseFloat(pub.longitude);
                    
                    // Create marker
                    const marker = L.circleMarker([lat, lng], {
                        radius: 10,
                        fillColor: '#4CAF50',
                        color: '#ffffff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    }).addTo(mapInstance);
                    
                    // Create popup content
                    let popupContent = `<div style="text-align: center; padding: 8px; min-width: 200px;">`;
                    popupContent += `<strong style="color: var(--text-primary); font-size: 14px;">${pub.name}</strong><br>`;
                    popupContent += `<small style="color: var(--text-secondary);">${pub.address}</small><br>`;
                    popupContent += `<small style="color: var(--text-muted);">${pub.postcode}</small>`;
                    
                    // Add distance if available
                    if (pub.distance !== undefined) {
                        popupContent += `<br><small style="color: var(--primary-color, #667eea); font-weight: 600;">${pub.distance.toFixed(1)}km away</small>`;
                    }
                    
                    // Add GF status
                    if (pub.bottle || pub.tap || pub.cask || pub.can) {
                        let gfOptions = [];
                        if (pub.bottle) gfOptions.push('🍺');
                        if (pub.tap) gfOptions.push('🚰');
                        if (pub.cask) gfOptions.push('🛢️');
                        if (pub.can) gfOptions.push('🥫');
                        popupContent += `<div style="margin-top: 8px; color: var(--success-color, #10b981);"><strong>GF: ${gfOptions.join(' ')}</strong></div>`;
                    }
                    
                    // Add click action
                    popupContent += `<div style="margin-top: 8px;"><button onclick="showPubDetails(${pub.pub_id})" style="background: var(--primary-gradient); color: white; border: none; padding: 4px 8px; border-radius: 12px; font-size: 12px; cursor: pointer;">View Details</button></div>`;
                    popupContent += `</div>`;
                    
                    marker.bindPopup(popupContent);
                    
                    // Add to bounds for auto-zoom
                    mapBounds.push([lat, lng]);
                    markersAdded++;
                    
                    console.log(`✅ Added marker for ${pub.name} at ${lat}, ${lng}`);
                } else {
                    console.log(`❌ Missing coordinates for ${pub.name}`);
                }
            });
            
            if (markersAdded === 0) {
                showMapMessage(mapInstance, '📍 Pubs Found', 'Pub locations will appear here once coordinate data is added');
            } else {
                console.log(`✅ Added ${markersAdded} pub markers to map`);
                
                // Auto-zoom to show all markers
                if (mapBounds.length > 0) {
                    if (mapBounds.length === 1) {
                        // Single marker - center on it
                        mapInstance.setView(mapBounds[0], 15);
                    } else {
                        // Multiple markers - fit bounds
                        mapInstance.fitBounds(mapBounds, { padding: [20, 20] });
                    }
                }
            }
        }
        
        // ================================
        // ➕ ADD: Function to show message overlay on map
        // ================================
        
        function showMapMessage(mapInstance, title, message) {
            const mapElement = document.getElementById('resultsMap');
            if (!mapElement) return;
            
            // Remove any existing overlay
            const existingOverlay = mapElement.querySelector('.map-message-overlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'map-message-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.95);
                padding: 20px;
                border-radius: 12px;
                text-align: center;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(10px);
                max-width: 80%;
            `;
            overlay.innerHTML = `
                <div style="font-size: 1.2rem; margin-bottom: 8px; font-weight: 600;">${title}</div>
                <div style="color: #666; font-size: 0.9rem; line-height: 1.4;">${message}</div>
            `;
            mapElement.appendChild(overlay);
        }
        
        // ================================
        // 🔄 UPDATE: Store search results when displaying them
        // ================================
        
        function displayResultsInOverlay(pubs, title) {
            // Store pubs globally for map access
            currentSearchPubs = pubs;
            console.log('💾 Stored search results for map:', pubs.length, 'pubs');
            
            document.getElementById('resultsLoading').style.display = 'none';
            document.getElementById('noResultsFound').style.display = 'none';
            document.getElementById('resultsList').style.display = 'block';
            
            // Update title
            document.getElementById('resultsTitle').textContent = title;
            
            // Generate results HTML
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            pubs.forEach(pub => {
                const resultItem = createResultItemForOverlay(pub);
                resultsList.appendChild(resultItem);
            });
            
            console.log(`✅ Displayed ${pubs.length} results in overlay`);
        }

        
        // ================================
        // ➕ ADD: Navigation function for map
        // ================================
        
        function goToMap() {
            console.log('🗺️ Navigating to map view');
            
            // Close any open modals or overlays
            closeResults();
            closePubDetails();
            
            // Close any search modals
            closeSearchModal();
            
            // Show the homepage map if it exists
            const mapContainer = document.getElementById('mapContainer');
            if (mapContainer) {
                // Show map section
                if (!mapVisible) {
                    toggleMap();
                }
                
                // Scroll to map
                setTimeout(() => {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                
                showSuccessToast('🗺️ Showing interactive map');
            } else {
                // Fallback - show coming soon message
                showSuccessToast('🗺️ Full map view coming soon! Use "Pubs Near Me" to see local results on map.');
            }
            
            trackEvent('navigation_map', 'Navigation', 'bottom_nav');
        }

        // ================================
        // CLEAN LOCATION REQUEST FUNCTION - BA
        // ================================
        function requestUserLocation() {
            if (!navigator.geolocation) {
                hideLoadingToast();
                showSuccessToast('❌ Location services not supported');
                return;
            }
        
            console.log('📍 Requesting location permission...');
            
            navigator.geolocation.getCurrentPosition(
                // SUCCESS
                (position) => {
                    console.log('✅ Location granted:', position.coords);
                    
                    // Store location globally
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    // Add marker to map if it exists
                    if (typeof map !== 'undefined' && map) {
                        if (userMarker) {
                            map.removeLayer(userMarker);
                        }
                        userMarker = L.marker([userLocation.lat, userLocation.lng])
                            .addTo(map)
                            .bindPopup('📍 You are here!');
                    }
                    
                    // Start the search
                    findNearbyPubs();
                },
                // ERROR
                (error) => {
                    console.log('❌ Location error:', error.code, error.message);
                    hideLoadingToast();
                    
                    let message = '';
                    let shouldShowFallback = false;
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            message = '📍 Location access denied. Please allow location access and try again.';
                            shouldShowFallback = true;
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = '📍 Location unavailable. Please check your GPS settings.';
                            shouldShowFallback = true;
                            break;
                        case error.TIMEOUT:
                            message = '📍 Location request timed out. Please try again.';
                            break;
                    }
                    
                    showSuccessToast(message);
                    
                    // Offer manual entry fallback
                    if (shouldShowFallback) {
                        setTimeout(() => {
                            if (confirm('Would you like to enter your location manually instead?')) {
                                openModal('locationModal');
                            }
                        }, 2000);
                    }
                },
                // OPTIONS
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // Cache for 5 minutes
                }
            );
        }

        // ================================
        // CLEAN FINDNEARBYPUBS FUNCTION - BA
        // ================================
        
        async function findNearbyPubs() {
            // Validate we have location
            if (!userLocation) {
                showSuccessToast('❌ Location not available');
                return;
            }
        
            console.log('🔍 Searching for nearby pubs...', userLocation);
            
            // Show the search is happening
            showResultsSection();
            showLoadingToast('Finding nearby GF beer...');
            
            // Clear previous results
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Finding nearby pubs...</li>';
            
            // Auto-show map and center on user location
            if (!mapVisible) {
                toggleMap();
            }
            
            // Center map on user location
            if (typeof map !== 'undefined' && map) {
                map.setView([userLocation.lat, userLocation.lng], 15);
            }
            
            try {
                // Build API request
                const radius = 5; // km
                const gfOnly = true; // Default to GF pubs only for mobile
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&gf_only=${gfOnly}`;
                
                console.log('📡 API request:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const nearbyPubs = data.pubs || data;
                
                hideLoadingToast();
                
                console.log(`✅ Found ${nearbyPubs.length} nearby pubs`);
                
                if (nearbyPubs.length === 0) {
                    results.innerHTML = '<li class="no-results">No GF-friendly pubs found within 5km. Try expanding your search area.</li>';
                    showSuccessToast('No GF pubs found nearby');
                    return;
                }
                
                // Display results
                displaySearchResults(nearbyPubs);
                
                // Add markers to map
                addPubMarkersToMap(nearbyPubs);
                
                // Success feedback
                const message = `✅ Found ${nearbyPubs.length} GF pubs near you!`;
                showSuccessToast(message);
                
                // Track success
                trackSearch('nearby', 'location', nearbyPubs.length);
                
                // Save state
                currentQuery = '';
                currentSearchType = 'nearby';
                currentPage = 1;
                AppState.save();
                
            } catch (error) {
                console.error('❌ Error finding nearby pubs:', error);
                hideLoadingToast();
                
                results.innerHTML = '<li class="no-results">Error finding nearby pubs. Please check your connection and try again.</li>';
                showSuccessToast('Error finding nearby pubs. Please try again.');
            }
        }

        // ================================
        // MOBILE UX FEEDBACK - ADD TO YOUR EXISTING JS - BA
        // ================================

        function initMobileFeedback() {
            const searchOptions = document.querySelectorAll('.search-option');
            
            searchOptions.forEach(option => {
                // Touch start - immediate feedback
                option.addEventListener('touchstart', function(e) {
                    this.style.transform = 'scale(0.97)';
                    
                    // Haptic feedback (if supported)
                    if ('vibrate' in navigator) {
                        navigator.vibrate(8); // Very subtle
                    }
                }, { passive: true });
                
                // Touch end - release
                option.addEventListener('touchend', function(e) {
                    this.style.transform = '';
                    
                    // Add tapped state briefly
                    this.classList.add('tapped');
                    setTimeout(() => {
                        this.classList.remove('tapped');
                    }, 200);
                }, { passive: true });
                
                // Click handler with loading state
                option.addEventListener('click', function(e) {
                    // Add loading state
                    this.classList.add('loading');
                    
                    // Remove after modal should open
                    setTimeout(() => {
                        this.classList.remove('loading');
                    }, 400);
                    
                    // Success feedback
                    if ('vibrate' in navigator) {
                        navigator.vibrate([10, 50, 10]); // Success pattern
                    }
                });
                
                // Cancel touch if user drags away
                option.addEventListener('touchcancel', function(e) {
                    this.style.transform = '';
                }, { passive: true });
                
                // Prevent scrolling while touching buttons
                option.addEventListener('touchmove', function(e) {
                    e.preventDefault();
                });
            });
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initMobileFeedback);

// Optional: Add swipe gestures (uncomment if you want)
/*
function addSwipeGestures() {
    const searchOptions = document.querySelectorAll('.search-option');
    
    searchOptions.forEach(option => {
        let startY = 0;
        
        option.addEventListener('touchstart', function(e) {
            startY = e.touches[0].clientY;
        }, { passive: true });
        
        option.addEventListener('touchend', function(e) {
            const endY = e.changedTouches[0].clientY;
            const diff = startY - endY;
            
            // Swipe up for quick action
            if (diff > 50) {
                // Quick action - maybe open modal faster?
                console.log('Swiped up on', this.querySelector('.search-title').textContent);
            }
        }, { passive: true });
    });
}
*/

        // ================================
        // TOAST NOTIFICATION SYSTEM
        // ================================
        
        function showLoadingToast(message = 'Loading...') {
            const toast = document.getElementById('loadingToast');
            document.getElementById('loadingMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
        }

        function hideLoadingToast() {
            const toast = document.getElementById('loadingToast');
            toast.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }

        function showSuccessToast(message = 'Success!') {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-in';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // ================================
        // GOOGLE ANALYTICS TRACKING
        // ================================
        
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }

        function trackSearch(query, searchType, results) {
            trackEvent('search', 'Search', `${searchType}: ${query} (${results} results)`);
        }

        function trackPubView(pubName) {
            trackEvent('pub_view', 'Pub Interaction', pubName);
        }

        // ================================
        // ENHANCED UI FUNCTIONS
        // ================================
        
        let selectedPubData = null;
        let pubSearchTimeout = null;
        let mapVisible = false;
        
        function scrollToSearch() {
            document.getElementById('search').scrollIntoView({ behavior: 'smooth' });
        }

       // 🔄 REPLACE: Your goHome function  
        function goHome() {
            console.log('🏠 Going to homepage - clearing all overlays');
            
            // Close ALL possible overlays by ID
            const overlaysToClose = [
                'resultsOverlay',
                'pubDetailsOverlay',
                'reportModal',
                'nameModal',
                'areaModal',
                'beerModal',
                'distanceModal',
                'aboutModal',
                'gfInfoModal',
                'coordinateModal',
                'cookieSettings'
            ];
            
            overlaysToClose.forEach(overlayId => {
                const overlay = document.getElementById(overlayId);
                if (overlay) {
                    overlay.classList.remove('active');
                    overlay.style.display = 'none'; // Force hide with style
                    console.log(`✅ Closed ${overlayId}`);
                }
            });
            
            // Restore body state completely
            document.body.style.overflow = '';
            document.body.classList.remove('pub-details-open');
            
            // Clear search state
            lastSearchState = null;
            
            // Reset to clean homepage
            resetHomepageToCleanState();
            
            // Ensure we're at the top
            window.scrollTo(0, 0);
            
            trackEvent('go_home', 'Navigation', 'home_button');

            // NUCLEAR OPTION - Force hide everything with overlay in the name
            document.querySelectorAll('[class*="overlay"], [id*="overlay"], [id*="Overlay"], .modal').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });
            
            console.log('✅ Homepage restored to clean state');
        }

        // ================================
        // LOAD STATS IN HERO SECTION
        // ================================

        async function loadStats() {
            try {
                console.log('📊 Loading stats...');
                const response = await fetch('/api/stats');
                const data = await response.json();
                
                console.log('📊 Stats loaded:', data);
                
                // Update the numbers using your HTML IDs
                const totalPubsElement = document.getElementById('totalPubs');
                const gfPubsElement = document.getElementById('gfPubs');
                
                if (totalPubsElement && data.total_pubs) {
                    totalPubsElement.textContent = data.total_pubs.toLocaleString();
                    console.log('✅ Updated total pubs:', data.total_pubs);
                }
                
                if (gfPubsElement && data.gf_pubs) {
                    gfPubsElement.textContent = data.gf_pubs.toLocaleString();
                    console.log('✅ Updated GF pubs:', data.gf_pubs);
                }
                
            } catch (error) {
                console.error('❌ Error loading stats:', error);
                // Fallback to default values if API fails
                const totalPubsElement = document.getElementById('totalPubs');
                const gfPubsElement = document.getElementById('gfPubs');
                
                if (totalPubsElement) totalPubsElement.textContent = '49,841';
                if (gfPubsElement) gfPubsElement.textContent = '9,971';
                
                console.log('Using fallback numbers');
            }
        }

        // Call the function when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Page loaded, calling loadStats...');
            loadStats();
        });
        
        // Also call immediately if page already loaded
        if (document.readyState !== 'loading') {
            loadStats();
        }

        // ================================
        // OPEN AND CLOSE SEARCH MODALS
        // ================================

        function openModal(modalId) {
            // Small delay to let button animation finish cleanly
            setTimeout(() => {
                document.getElementById(modalId).style.display = 'flex';
                
                // Handle specific modals
                if (modalId === 'areaModal') {
                    // Initialize area modal with proper placeholder
                    setTimeout(() => {
                        initializeAreaModal();
                    }, 100);
                } else if (modalId === 'beerModal') {
                    // Initialize beer modal with proper placeholder
                    setTimeout(() => {
                        initializeBeerModal();
                    }, 100);
                } else {
                    // Focus other modal inputs normally
                    setTimeout(() => {
                        const input = document.querySelector(`#${modalId} .form-input`);
                        if (input) {
                            input.focus();
                        }
                    }, 100);
                }
            }, 150); // Just enough to let highlight animation complete
        }

        // Also add smooth modal close animation
        function closeSearchModal() {
            // IMMEDIATELY remove any button highlights
            document.querySelectorAll('.search-option.tapped, .search-option.loading').forEach(option => {
                option.classList.remove('tapped', 'loading');
            });
            
            const modals = ['nameModal', 'beerModal', 'areaModal', 'distanceModal'];
            modals.forEach(modal => {
                const modalEl = document.getElementById(modal);
                if (modalEl && modalEl.style.display !== 'none') {
                    // Slower fade out - gives highlight time to disappear
                    modalEl.style.opacity = '0';
                    // modalEl.style.transition = 'opacity 0.3s ease-out'; // Smooth fade
                    
                    setTimeout(() => {
                        modalEl.style.display = 'none';
                        modalEl.style.opacity = '1'; // Reset for next time
                        modalEl.style.transition = ''; // Reset transition
                    }, 350); // Longer delay - 350ms instead of 200ms
                }
            });
        }

        // SMART MAP TOGGLE - Auto-show when needed
        function toggleMap() {
            mapVisible = !mapVisible;
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');
            const featuresSection = document.getElementById('featuresSection');
            const searchSection = document.getElementById('search');
            
            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.innerHTML = '🗺️ Hide Map';
                
                if (featuresSection) {
                    featuresSection.classList.remove('map-hidden');
                }
                
                // Fix overlap: Add space below map for search
                searchSection.style.marginTop = '40px';
                
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
                
                setTimeout(() => {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.innerHTML = '🗺️ Show Map';
                
                if (featuresSection) {
                    featuresSection.classList.add('map-hidden');
                }
                
                // Reset margin
                searchSection.style.marginTop = '-20px';
            }
            
            AppState.save();
        }

        // SMART MAP SHOWING - Auto show map when needed
        function smartShowMap() {
            if (!mapVisible) {
                toggleMap();
            }
        }

        // Enhanced openReportModal function
        // ================================
        // ✏️ UPDATE - REPLACE your existing openReportModal function
        // Replace the entire function with this enhanced version
        // ================================

        // ================================
        // 🔍 DEBUG - REPORT MODAL FIX
        // ✏️ UPDATE - Replace your openReportModal function with this debug version
        // ================================
        
        function openReportModal(pubData = null) {
            console.log('🔍 Debug: openReportModal called with:', pubData);
            
            // Debug: Check if modal exists
            const modal = document.getElementById('reportModal');
            console.log('🔍 Debug: modal element found:', modal);
            
            if (!modal) {
                console.error('❌ ERROR: reportModal not found in DOM!');
                console.log('🔍 Available modals:', document.querySelectorAll('[id*="modal"]'));
                showSuccessToast('❌ Report modal not found - please refresh the page');
                return;
            }
            
            // Debug: Check modal structure
            const modalTitle = modal.querySelector('.modal-title');
            console.log('🔍 Debug: modal title found:', modalTitle);
            
            if (!modalTitle) {
                console.error('❌ ERROR: .modal-title not found in reportModal!');
                console.log('🔍 Modal innerHTML:', modal.innerHTML.substring(0, 200) + '...');
                showSuccessToast('❌ Modal structure error - please refresh the page');
                return;
            }
            
            const pubSearchField = document.getElementById('reportPubSearch');
            const selectedPubInfo = document.getElementById('selectedPubInfo');
            const newPubFields = document.getElementById('newPubFields');
            
            console.log('🔍 Debug: form elements found:', {
                pubSearchField: !!pubSearchField,
                selectedPubInfo: !!selectedPubInfo,
                newPubFields: !!newPubFields
            });
            
            // If coming from a specific pub, handle differently
            if (pubData) {
                console.log('🍺 Debug: Pre-populating with pub data');
                
                // Hide pub search entirely
                const pubSearchGroup = document.getElementById('pubSearchGroup');
                if (pubSearchGroup) {
                    pubSearchGroup.style.display = 'none';
                } else {
                    console.warn('⚠️ Warning: pubSearchGroup not found');
                }
                
                // Show the pub info at top
                modalTitle.innerHTML = `📸 Report GF Beer Find<br><small style="color: var(--text-secondary); font-weight: 400;">at ${pubData.name}</small>`;
                
                // Store the pub data globally
                window.selectedPubData = {
                    pub_id: pubData.pub_id || pubData.id,
                    name: pubData.name,
                    address: pubData.address,
                    postcode: pubData.postcode
                };
                
                console.log('✅ Debug: Pre-populated pub data:', window.selectedPubData);
                
            } else {
                console.log('🔍 Debug: Normal flow - show pub search');
                
                // Normal flow - show pub search
                const pubSearchGroup = document.getElementById('pubSearchGroup');
                if (pubSearchGroup) {
                    pubSearchGroup.style.display = 'block';
                }
                modalTitle.innerHTML = '📸 Report GF Beer Find';
                window.selectedPubData = null;
            }
            
            // Reset form
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.reset();
                console.log('✅ Debug: Form reset');
            } else {
                console.error('❌ ERROR: reportForm not found!');
            }
            
            if (selectedPubInfo) selectedPubInfo.style.display = 'none';
            if (newPubFields) newPubFields.style.display = 'none';
            
            // Hide all dropdowns
            const dropdowns = ['breweryDropdown', 'beerNameDropdown', 'beerStyleDropdown'];
            dropdowns.forEach(id => {
                const dropdown = document.getElementById(id);
                if (dropdown) {
                    dropdown.style.display = 'none';
                } else {
                    console.warn(`⚠️ Warning: ${id} not found`);
                }
            });
            
            // Reset photo upload styling
            const photoLabel = document.querySelector('.photo-upload-compact');
            if (photoLabel) {
                photoLabel.style.borderColor = 'var(--border-light)';
                photoLabel.style.background = 'var(--bg-section)';
                const textEl = photoLabel.querySelector('.photo-upload-text');
                if (textEl) {
                    textEl.innerHTML = `
                        <strong>Add a photo</strong><br>
                        <small>Beer menu, bottle, or tap</small>
                    `;
                }
                console.log('✅ Debug: Photo upload reset');
            } else {
                console.warn('⚠️ Warning: photo-upload-compact not found');
            }
            
            // Show modal
            modal.style.display = 'block';
            console.log('✅ Debug: Modal displayed');
            
            // Track event
            if (typeof trackEvent === 'function') {
                trackEvent('open_report_modal', 'Modal', pubData ? 'from_pub_page' : 'general');
            }
            
            // Initialize dropdowns
            try {
                initializeReportModalDropdowns();
                console.log('✅ Debug: Dropdowns initialized');
            } catch (error) {
                console.error('❌ ERROR: initializeReportModalDropdowns failed:', error);
            }
            
            // Focus appropriate field
            setTimeout(() => {
                if (pubData) {
                    // Focus beer format since pub is pre-filled
                    const formatField = document.getElementById('reportFormat');
                    if (formatField) {
                        formatField.focus();
                        console.log('✅ Debug: Focused format field');
                    }
                } else {
                    // Focus pub search
                    if (pubSearchField) {
                        pubSearchField.focus();
                        console.log('✅ Debug: Focused pub search field');
                    }
                }
            }, 100);
            
            console.log('🎉 Debug: openReportModal completed successfully');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'reportModal') {
                document.getElementById('reportForm').reset();
                selectedPubData = null;
                document.getElementById('selectedPubInfo').style.display = 'none';
                document.getElementById('newPubFields').style.display = 'none';
                document.getElementById('pubSuggestions').style.display = 'none';
            }
        }

        // Update the existing pub page report button
        function updatePubPageReportButton() {
            // This would be called when showing pub details
            const reportButton = document.querySelector('[onclick="openReportModal()"]');
            if (reportButton && currentPubData) {
                reportButton.setAttribute('onclick', `openReportModal(${JSON.stringify(currentPubData)})`);
            }
        }

        // Enhanced form submission to handle pre-populated pub
        // UPDATE: In templates/index.html, add debug logging to handleReportSubmission

        function handleReportSubmission(event) {
            event.preventDefault();
            
            console.log('🚀 Submit button clicked!');
            
            const formData = new FormData(event.target);
            const reportData = {
                beer_format: formData.get('reportFormat') || document.getElementById('reportFormat').value,
                brewery: formData.get('reportBrewery') || document.getElementById('reportBrewery').value,
                beer_name: formData.get('reportBeerName') || document.getElementById('reportBeerName').value,
                beer_style: formData.get('reportBeerStyle') || document.getElementById('reportBeerStyle').value,
                beer_abv: formData.get('reportBeerABV') || document.getElementById('reportBeerABV').value,
                notes: formData.get('reportNotes') || ''
            };
            
            // ADD: Debug logging to see what we're collecting
            console.log('📋 Form data collected:', reportData);
            console.log('📋 Selected pub data:', window.selectedPubData);
            
            // Add pub data
            if (window.selectedPubData) {
                reportData.pub_id = window.selectedPubData.pub_id;
                reportData.pub_name = window.selectedPubData.name;
                console.log('🏠 Using pre-populated pub:', window.selectedPubData.name);
            } else {
                // Use searched/entered pub data
                reportData.pub_name = formData.get('reportPubName') || 'Unknown Pub';
                reportData.address = formData.get('reportAddress') || '';
                reportData.postcode = formData.get('reportPostcode') || '';
                console.log('🏠 Using manual pub data');
            }
            
            console.log('📋 Complete report data BEFORE sending:', reportData);
            
            // Validate required fields
            const requiredFields = [];
            if (!reportData.beer_format) requiredFields.push('Beer Format');
            if (!reportData.brewery) requiredFields.push('Brewery');
            if (!reportData.beer_name) requiredFields.push('Beer Name');
            if (!reportData.pub_id && !reportData.pub_name) requiredFields.push('Pub Name');
            
            if (requiredFields.length > 0) {
                const missingFields = requiredFields.join(', ');
                console.log('❌ Missing required fields:', missingFields);
                showSuccessToast(`❌ Please fill in: ${missingFields}`);
                return;
            }
            
            console.log('✅ All required fields present, submitting...');
            
            // Submit the report
            submitBeerReport(reportData);
        }

        // UPDATE: In templates/index.html, add debug logging to submitBeerReport
        async function submitBeerReport(reportData) {
            console.log('📡 Submitting beer report:', reportData);
            
            showLoadingToast('Submitting your beer report...');
            
            try {
                // FIXED: Make sure we're sending the data in the format the backend expects
                const payload = {
                    pub_id: reportData.pub_id || null,
                    beer_format: reportData.beer_format,
                    // UPDATE: Use the field names your backend expects
                    new_brewery: reportData.brewery,     // Backend expects 'new_brewery'
                    new_beer_name: reportData.beer_name, // Backend expects 'new_beer_name'
                    new_style: reportData.beer_style,    // Backend expects 'new_style'
                    new_abv: reportData.beer_abv,        // Backend expects 'new_abv'
                    submitted_by_name: 'Anonymous',
                    submitted_by_email: '',
                    user_notes: reportData.notes || `${reportData.beer_format} - ${reportData.brewery} ${reportData.beer_name}`,
                    photo_url: '',
                    // New pub data if needed
                    new_pub_name: reportData.pub_name,
                    new_address: reportData.address,
                    new_postcode: reportData.postcode
                };
                
                console.log('📡 Sending payload to API:', payload);
                
                const response = await fetch('/api/submit_beer_update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('📡 API Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.log('❌ API Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                console.log('✅ API Success response:', result);
                
                hideLoadingToast();
                showSuccessToast('🎉 Beer report submitted successfully! Thanks for contributing!');
                
                // Close modal and reset form
                closeModal('reportModal');
                document.getElementById('reportForm').reset();
                
                // Track success
                trackEvent('beer_report_submitted', 'User Contribution', reportData.brewery + ' - ' + reportData.beer_name);
                
            } catch (error) {
                console.error('❌ Error submitting beer report:', error);
                hideLoadingToast();
                showSuccessToast(`❌ Error submitting report: ${error.message}`);
            }
        }
        
        // Function to call from pub page buttons
        function openReportModalForCurrentPub() {
            if (currentPubData) {
                openReportModal(currentPubData);
            } else {
                console.warn('No current pub data available');
                openReportModal();
            }
        }

        function showAboutUs() {
            document.getElementById('aboutModal').style.display = 'block';
            trackEvent('open_about_modal', 'Modal');
        }

        function showGFInfo() {
            document.getElementById('gfInfoModal').style.display = 'block';
            trackEvent('open_gf_info_modal', 'Modal');
        }

        function showComingSoon(feature) {
            trackEvent('coming_soon_click', 'Feature Interest', feature);
            showSuccessToast(`${feature} is coming soon! 🚀 We're working hard to bring you this feature.`);
        }

        function showAllActivity() {
            trackEvent('view_all_activity', 'Navigation');
            showSuccessToast('Full activity feed coming soon! 📊 This will show all recent GF beer finds.');
        }

        // SMART RESULTS SECTION - Pushes content down
        function showResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'block';
            
            // Add margin to push content down
            featuresSection.style.marginTop = '40px';
            activitySection.style.marginTop = '40px';
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'none';
            
            // Remove margin
            featuresSection.style.marginTop = '0';
            activitySection.style.marginTop = '0';
        }

        // ================================
        // CORE FUNCTIONALITY
        // ================================

        // State management for refresh persistence
        const AppState = {
            save: function(pubId = null) {
                const state = {
                    query: currentQuery,
                    searchType: currentSearchType,
                    // gfOnly: currentGfOnly,
                    page: currentPage,
                    mapVisible: mapVisible,
                    specificPubId: pubId || null,
                    timestamp: Date.now()
                };
                window.location.hash = btoa(JSON.stringify(state));
            },
            
            load: function() {
                try {
                    if (window.location.hash) {
                        const state = JSON.parse(atob(window.location.hash.substring(1)));
                        if (Date.now() - state.timestamp < 3600000) {
                            return state;
                        }
                    }
                } catch (e) {
                    console.log('No valid state to restore');
                }
                return null;
            },
            
            restore: async function() {
                const state = this.load();
                if (state) {
                    console.log('Restoring state:', state);
                    
                    document.getElementById('searchInput').value = state.query || '';
                    document.getElementById('searchType').value = state.searchType || 'all';
                    // document.getElementById('gfOnly').checked = state.gfOnly || false;
                    
                    currentQuery = state.query || '';
                    currentSearchType = state.searchType || 'all';
                    // currentGfOnly = state.gfOnly || false;
                    currentPage = state.page || 1;
                    mapVisible = state.mapVisible || false;
                    
                    const mapContainer = document.getElementById('mapContainer');
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    if (mapVisible) {
                        mapContainer.style.display = 'block';
                        toggleBtn.innerHTML = '🗺️ Hide Map';
                    } else {
                        mapContainer.style.display = 'none';
                        toggleBtn.innerHTML = '🗺️ Show Map';
                    }
                    
                    if (state.specificPubId) {
                        console.log('Restoring specific pub:', state.specificPubId);
                        await searchSpecificPub(state.specificPubId);
                    } else if (state.query) {
                        console.log('Restoring search query:', state.query);
                        await loadPage(state.page);
                    }
                }
            }
        };

        // Debounce function to limit rapid requests
        let debounceTimeout;
        function debounce(func, wait) {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Fixed Search Functions
        
        function searchByLocation() {
            const query = document.getElementById('locationInput').value.trim();
            if (!query) {
                showSuccessToast('Please enter a location to search');
                return;
            }
            
            closeSearchModal();
            
            // Use your existing search logic but with location type
            performSearchWithState(query, 'location');
            
            trackEvent('search_by_location', 'Search', query);
        }
        
        function searchByName() {
            const query = document.getElementById('nameInput').value.trim();
            if (!query) {
                showSuccessToast('Please enter a pub name to search');
                return;
            }
            
            console.log('🏠 Searching for pub name:', query);
            
            closeSearchModal();
            
            // Show results overlay immediately
            showResultsOverlay(`Pub name: "${query}"`);
            showResultsLoading('Searching for pubs...');
            
            // Perform the search
            performNameSearch(query);
            
            trackEvent('search_by_name', 'Search', query);
        }

        // ================================
        // ➕ ADD: New function to handle name search with your API
        // ================================
        
        // ================================
        // 🔄 REPLACE: Your performNameSearch function with proximity ordering
        // ================================
        
        async function performNameSearch(query) {
            console.log('🔍 Performing name search for:', query);
            
            try {
                let url = `/search?query=${encodeURIComponent(query)}&search_type=name&page=1`;
                
                // Add user location if available for distance calculation
                if (userLocation) {
                    url += `&lat=${userLocation.lat}&lng=${userLocation.lng}`;
                    console.log('📍 Including user location for proximity ordering');
                } else {
                    console.log('📍 No user location available - will try to get it');
                    // Try to get location for better ordering
                    await tryToGetUserLocation();
                    if (userLocation) {
                        url += `&lat=${userLocation.lat}&lng=${userLocation.lng}`;
                        console.log('📍 Got location and added to search');
                    }
                }
                
                console.log('📡 API call:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📡 API response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let pubs = Array.isArray(data) ? data : data.pubs;
                
                if (pubs.length === 0) {
                    showNoResults(`No pubs found matching "${query}"`);
                    return;
                }
                
                // If we have user location, calculate distances and sort
                if (userLocation) {
                    pubs = pubs.map(pub => {
                        if (pub.latitude && pub.longitude) {
                            pub.distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(pub.latitude), parseFloat(pub.longitude)
                            );
                        } else {
                            pub.distance = 999; // Put pubs without coordinates at the end
                        }
                        return pub;
                    });
                    
                    // Sort by distance (closest first)
                    pubs.sort((a, b) => a.distance - b.distance);
                    console.log('📍 Sorted results by proximity');
                } else {
                    console.log('📍 No user location - showing results without distance ordering');
                }
                
                console.log(`✅ Found ${pubs.length} pubs matching "${query}"`);
                
                // Save state for back button
                saveNameSearchState(query, pubs);
                
                // Display results
                const titleText = userLocation ? 
                    `${pubs.length} pubs matching "${query}" (nearest first)` :
                    `${pubs.length} pubs matching "${query}"`;
                    
                displayResultsInOverlay(pubs, titleText);
                
                // Success feedback
                const successText = userLocation ?
                    `✅ Found ${pubs.length} pubs matching "${query}" - sorted by distance` :
                    `✅ Found ${pubs.length} pubs matching "${query}"`;
                showSuccessToast(successText);
                
                // Track success
                trackSearch(query, 'name', pubs.length);
                
            } catch (error) {
                console.error('❌ Error searching by name:', error);
                showNoResults(`Error searching for "${query}". Please try again.`);
                showSuccessToast(`❌ Error searching for "${query}"`);
            }
        }
        
        // ================================
        // ➕ ADD: Helper function to try getting user location for better ordering
        // ================================
        
        async function tryToGetUserLocation() {
            if (userLocation) return; // Already have it
            
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.log('📍 Geolocation not supported');
                    resolve();
                    return;
                }
                
                console.log('📍 Attempting to get user location for proximity ordering...');
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log('✅ Got user location for proximity:', userLocation);
                        resolve();
                    },
                    (error) => {
                        console.log('📍 Could not get location:', error.message);
                        resolve(); // Don't fail the search, just continue without location
                    },
                    {
                        enableHighAccuracy: false, // Faster, less accurate is fine for ordering
                        timeout: 3000, // Quick timeout so we don't delay search
                        maximumAge: 600000 // Use cached location up to 10 minutes old
                    }
                );
            });
        }
        
        // ================================
        // ➕ ADD: Beer search placeholder function
        // ================================
        
        function updateBeerPlaceholder() {
            const searchType = document.getElementById('beerSearchType').value;
            const input = document.getElementById('beerInput');
            
            if (searchType === 'brewery') {
                input.placeholder = 'Enter brewery name';
                console.log('🏭 Switched to brewery search mode');
            } else if (searchType === 'beer') {
                input.placeholder = 'Enter specific beer name';
                console.log('🍺 Switched to beer name search mode');
            } else {
                input.placeholder = 'Enter beer style';
                console.log('🎨 Switched to beer style search mode');
            }
        }

        function initializeBeerModal() {
            // Set default placeholder
            updateBeerPlaceholder();
            
            // Clear any previous input
            document.getElementById('beerInput').value = '';
            
            // Initialize autocomplete
            initializeBeerAutocomplete();
            
            // Focus the input field
            setTimeout(() => {
                document.getElementById('beerInput').focus();
            }, 200);
        }
        
        // ================================
        // 🔄 REPLACE: Your searchByBeer function with this working version
        // ================================
        
        function searchByBeer() {
            const query = document.getElementById('beerInput').value.trim();
            const searchType = document.getElementById('beerSearchType').value;
            
            if (!query) {
                showSuccessToast('Please enter something to search for');
                return;
            }
            
            console.log(`🍺 Searching by ${searchType}:`, query);
            
            closeSearchModal();
            
            // Show results overlay immediately
            const searchTypeText = searchType === 'brewery' ? 'brewery' : searchType === 'beer' ? 'beer' : 'style';
            showResultsOverlay(`${searchTypeText}: "${query}"`);
            showResultsLoading('Finding pubs with this beer...');
            
            // Perform the search
            performBeerSearch(query, searchType);
            
            trackEvent('search_by_beer', 'Search', `${searchType}:${query}`);
        }
        
        // ================================
        // ➕ ADD: Beer search with proximity sorting
        // ================================
        
        async function performBeerSearch(query, searchType) {
            console.log(`🍺 Performing ${searchType} search for:`, query);
            
            try {
                // Try to get user location first for better sorting
                if (!userLocation) {
                    await tryToGetUserLocation();
                }
                
                // Use your existing search API 
                let url = `/search?query=${encodeURIComponent(query)}&search_type=all&page=1`;
                
                // Add user location if available for proximity sorting
                if (userLocation) {
                    url += `&lat=${userLocation.lat}&lng=${userLocation.lng}`;
                    console.log('📍 Including user location for proximity sorting');
                }
                
                console.log('📡 API call:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📡 API response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let pubs = Array.isArray(data) ? data : data.pubs;
                
                // Filter results based on search type and query
                pubs = pubs.filter(pub => {
                    if (!pub.beer_details) return false;
                    
                    const beerDetails = pub.beer_details.toLowerCase();
                    const searchQuery = query.toLowerCase();
                    
                    if (searchType === 'brewery') {
                        return beerDetails.includes(searchQuery);
                    } else if (searchType === 'beer') {
                        return beerDetails.includes(searchQuery);
                    } else { // style
                        return beerDetails.includes(searchQuery);
                    }
                });
                
                if (pubs.length === 0) {
                    showNoResults(`No pubs found serving "${query}"`);
                    return;
                }
                
                // Sort by proximity if we have user location
                if (userLocation) {
                    pubs = pubs.map(pub => {
                        if (pub.latitude && pub.longitude) {
                            pub.distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(pub.latitude), parseFloat(pub.longitude)
                            );
                        } else {
                            pub.distance = 999;
                        }
                        return pub;
                    });
                    
                    pubs.sort((a, b) => a.distance - b.distance);
                    console.log('📍 Sorted results by proximity to user');
                }
                
                console.log(`✅ Found ${pubs.length} pubs serving ${query}`);
                
                // Save state for back button
                saveBeerSearchState(`${query} (${searchType})`, pubs);
                
                // Display results
                const titleText = userLocation ? 
                    `${pubs.length} pubs serving "${query}" (nearest first)` :
                    `${pubs.length} pubs serving "${query}"`;
                    
                displayResultsInOverlay(pubs, titleText);
                
                // Success feedback
                const successText = userLocation ?
                    `✅ Found ${pubs.length} pubs serving "${query}" - sorted by distance` :
                    `✅ Found ${pubs.length} pubs serving "${query}"`;
                showSuccessToast(successText);
                
                // Track success
                trackSearch(query, searchType, pubs.length);
                
            } catch (error) {
                console.error('❌ Error searching by beer:', error);
                showNoResults(`Error searching for "${query}". Please try again.`);
                showSuccessToast(`❌ Error searching for "${query}"`);
            }
        }
        
        // ================================
        // ➕ ADD: Beer autocomplete (basic version for MVP)
        // ================================
        
        let beerAutocompleteTimeout;
        
        function initializeBeerAutocomplete() {
            const input = document.getElementById('beerInput');
            const suggestions = document.getElementById('beerSuggestions');
            
            if (!input || !suggestions) return;
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                const searchType = document.getElementById('beerSearchType').value;
                
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                clearTimeout(beerAutocompleteTimeout);
                beerAutocompleteTimeout = setTimeout(() => {
                    fetchBeerSuggestions(query, searchType);
                }, 300);
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.beer-search-container')) {
                    suggestions.style.display = 'none';
                }
            });
        }
        
        async function fetchBeerSuggestions(query, searchType) {
            const suggestions = document.getElementById('beerSuggestions');
            
            try {
                let endpoint;
                if (searchType === 'brewery') {
                    endpoint = `/api/breweries?q=${encodeURIComponent(query)}`;
                } else {
                    // For beer names and styles, we'll use a simple approach for MVP
                    endpoint = `/api/breweries?q=${encodeURIComponent(query)}`;
                }
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                suggestions.innerHTML = '';
                
                if (data.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                data.slice(0, 8).forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item;
                    div.addEventListener('click', () => {
                        document.getElementById('beerInput').value = item;
                        suggestions.style.display = 'none';
                    });
                    suggestions.appendChild(div);
                });
                
                suggestions.style.display = 'block';
                
            } catch (error) {
                console.error('Error fetching beer suggestions:', error);
                suggestions.style.display = 'none';
            }
        }
        
        // ================================
        // ➕ ADD: Function to update placeholder based on search type
        // ================================
        
        function updateAreaPlaceholder() {
            const searchType = document.getElementById('areaSearchType').value;
            const input = document.getElementById('areaInput');
            
            if (searchType === 'postcode') {
                input.placeholder = 'Enter a postcode...';
                input.setAttribute('pattern', '[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? ?[0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}');
                console.log('📮 Switched to postcode mode');
            } else {
                input.placeholder = 'Enter a city or region...';
                input.removeAttribute('pattern');
                console.log('🏙️ Switched to city mode');
            }
        }
        
        // ================================
        // 🔄 REPLACE: Your searchByArea function with this enhanced version
        // ================================
        
        function searchByArea() {
            const query = document.getElementById('areaInput').value.trim();
            const searchType = document.getElementById('areaSearchType').value;
            
            if (!query) {
                showSuccessToast('Please enter a location to search');
                return;
            }
            
            console.log(`🗺️ Searching by ${searchType}:`, query);
            
            closeSearchModal();
            
            // Show results overlay immediately
            const searchTypeText = searchType === 'postcode' ? 'postcode' : 'area';
            showResultsOverlay(`${searchTypeText}: "${query}"`);
            showResultsLoading('Finding pubs in this area...');
            
            // Perform the appropriate search
            if (searchType === 'postcode') {
                performPostcodeSearch(query);
            } else {
                performCitySearch(query);
            }
            
            trackEvent('search_by_area', 'Search', `${searchType}:${query}`);
        }
        
        // ================================
        // ➕ ADD: Postcode search with geocoding + nearby search
        // ================================
        
        async function performPostcodeSearch(postcode) {
            console.log('📮 Performing postcode search for:', postcode);
            
            try {
                // First, geocode the postcode
                showResultsLoading('Finding postcode location...');
                console.log('🔍 Geocoding postcode...');
                
                const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(postcode)}&countrycodes=gb&limit=1`);
                const geocodeData = await geocodeResponse.json();
                
                if (!geocodeData || geocodeData.length === 0) {
                    throw new Error('Postcode not found');
                }
                
                const lat = parseFloat(geocodeData[0].lat);
                const lng = parseFloat(geocodeData[0].lon);
                const locationName = geocodeData[0].display_name;
                
                console.log(`✅ Postcode geocoded to: ${lat}, ${lng}`);
                
                // Now search for nearby pubs
                showResultsLoading('Finding pubs near this postcode...');
                
                const radius = 5; // km - reasonable radius for postcode search
                const url = `/nearby?lat=${lat}&lng=${lng}&radius=${radius}`;
                console.log('📡 API call:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const pubs = await response.json();
                console.log('📡 API response:', pubs);
                
                if (pubs.length === 0) {
                    showNoResults(`No pubs found within ${radius}km of ${postcode}`);
                    return;
                }
                
                console.log(`✅ Found ${pubs.length} pubs near ${postcode}`);
                
                // Save state for back button
                saveAreaSearchState(`${postcode} (postcode)`, pubs);
                
                // Display results
                displayResultsInOverlay(pubs, `${pubs.length} pubs near ${postcode} (${radius}km radius)`);
                
                // Success feedback
                showSuccessToast(`✅ Found ${pubs.length} pubs near ${postcode}`);
                
                // Track success
                trackSearch(postcode, 'postcode', pubs.length);
                
            } catch (error) {
                console.error('❌ Error searching by postcode:', error);
                showNoResults(`Could not find location for "${postcode}". Please check the postcode and try again.`);
                showSuccessToast(`❌ Could not find postcode "${postcode}"`);
            }
        }
        
        // ================================
        // ➕ ADD: City/region search using your database
        // ================================
        
        // ================================
        // 🔄 REPLACE: Your performCitySearch function with proximity sorting
        // ================================
        
        async function performCitySearch(city) {
            console.log('🏙️ Performing city search for:', city);
            
            try {
                // Try to get user location first for better sorting
                if (!userLocation) {
                    await tryToGetUserLocation();
                }
                
                // Use your existing search API with area filter
                let url = `/search?query=${encodeURIComponent(city)}&search_type=area&page=1`;
                
                // Add user location if available for proximity sorting
                if (userLocation) {
                    url += `&lat=${userLocation.lat}&lng=${userLocation.lng}`;
                    console.log('📍 Including user location for proximity sorting');
                }
                
                console.log('📡 API call:', url);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📡 API response:', data);
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                let pubs = Array.isArray(data) ? data : data.pubs;
                
                if (pubs.length === 0) {
                    showNoResults(`No pubs found in "${city}"`);
                    return;
                }
                
                // Sort by proximity if we have user location
                if (userLocation) {
                    pubs = pubs.map(pub => {
                        if (pub.latitude && pub.longitude) {
                            pub.distance = calculateDistance(
                                userLocation.lat, userLocation.lng,
                                parseFloat(pub.latitude), parseFloat(pub.longitude)
                            );
                        } else {
                            pub.distance = 999;
                        }
                        return pub;
                    });
                    
                    pubs.sort((a, b) => a.distance - b.distance);
                    console.log('📍 Sorted results by proximity to user');
                }
                
                console.log(`✅ Found ${pubs.length} pubs in ${city}`);
                
                // Save state for back button
                saveAreaSearchState(`${city} (city)`, pubs);
                
                // Display results
                const titleText = userLocation ? 
                    `${pubs.length} pubs in ${city} (nearest first)` :
                    `${pubs.length} pubs in ${city}`;
                    
                displayResultsInOverlay(pubs, titleText);
                
                // Success feedback
                const successText = userLocation ?
                    `✅ Found ${pubs.length} pubs in ${city} - sorted by distance` :
                    `✅ Found ${pubs.length} pubs in ${city}`;
                showSuccessToast(successText);
                
                // Track success
                trackSearch(city, 'city', pubs.length);
                
            } catch (error) {
                console.error('❌ Error searching by city:', error);
                showNoResults(`Error searching for "${city}". Please try again.`);
                showSuccessToast(`❌ Error searching for "${city}"`);
            }
        }

        // ➕ ADD NEW - Enhanced performSearch that saves state
        async function performSearchWithState(query, searchType) {
            currentQuery = query;
            currentSearchType = searchType;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            try {
                // Your existing search logic here...
                const backendSearchType = mapSearchType(searchType);
                const url = `/search?query=${encodeURIComponent(query)}&search_type=${backendSearchType}&page=1`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    results.innerHTML = `<li class="no-results">No pubs found for "${query}". Try a different search term.</li>`;
                    showSuccessToast(`No pubs found for "${query}"`);
                    return;
                }
                
                // SAVE STATE after successful search
                if (searchType === 'name') {
                    saveNameSearchState(query, pubs);
                } else if (searchType === 'area') {
                    saveAreaSearchState(query, pubs);
                } else if (searchType === 'beer') {
                    saveBeerSearchState(query, pubs);
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message
                const message = `Found ${pubs.length} pubs for "${query}"`;
                showSuccessToast(message);
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                results.innerHTML = `<li class="no-results">Error searching for "${query}". Please try again.</li>`;
                showSuccessToast(`Error searching for "${query}"`);
            }
        }
        
        // Updated unified search function that works with your existing backend
        async function performSearch(query, searchType) {
            currentQuery = query;
            currentSearchType = searchType;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            // Check if query looks like a postcode (for location searches)
            const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
            
            try {
                let url;
                
                if ((searchType === 'location' && isPostcode) || searchType === 'postcode') {
                    // Handle postcode search - geocode then find nearby
                    console.log('Detected postcode search:', query);
                    showLoadingToast('Finding location...');
                    
                    // First geocode the postcode
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData && geocodeData.length > 0) {
                        const lat = parseFloat(geocodeData[0].lat);
                        const lng = parseFloat(geocodeData[0].lon);
                        
                        showLoadingToast('Finding nearby pubs...');
                        
                        url = `/nearby?lat=${lat}&lng=${lng}&radius=5`;
                        
                        // Auto-show map and update to show the postcode area
                        smartShowMap();
                        if (map) {
                            map.setView([lat, lng], 14);
                            
                            // Add postcode marker
                            if (window.postcodeMarker) {
                                map.removeLayer(window.postcodeMarker);
                            }
                            window.postcodeMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">📍</div>`,
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            }).addTo(map);
                            
                            window.postcodeMarker.bindPopup(`<strong>${query}</strong><br>Searching nearby pubs...`).openPopup();
                        }
                    } else {
                        throw new Error('Location not found');
                    }
                } else {
                    // Regular text search - map search types to your existing backend
                    const backendSearchType = mapSearchType(searchType);
                    url = `/search?query=${encodeURIComponent(query)}&search_type=${backendSearchType}&page=1`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    results.innerHTML = `<li class="no-results">No pubs found for "${query}". Try a different search term.</li>`;
                    showSuccessToast(`No pubs found for "${query}"`);
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message
                const message = `Found ${pubs.length} pubs for "${query}"`;
                showSuccessToast(message);
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                results.innerHTML = `<li class="no-results">Error searching for "${query}". Please try again.</li>`;
                showSuccessToast(`Error searching for "${query}"`);
            }
        }
        
        // Map new search types to your existing backend search types
        function mapSearchType(newType) {
            const mapping = {
                'location': 'all',  // Location searches can be postcodes or areas
                'name': 'name',     // Direct mapping
                'beer': 'all',      // Beer searches will search in beer details
                'area': 'area'      // Direct mapping
            };
            
            return mapping[newType] || 'all';
        }
        
        // Add event listeners for Enter key in modals
        document.addEventListener('DOMContentLoaded', () => {
            // Enter key handlers for search modals
            document.getElementById('locationInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchByLocation();
            });
            
            document.getElementById('nameInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchByName();
            });
            
            document.getElementById('beerInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchByBeer();
            });
            
            document.getElementById('areaInput')?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') searchByArea();
            });
            
            // Close modal when clicking outside
            document.querySelectorAll('.search-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeSearchModal();
                    }
                });
            });
        });

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in kilometers
        }

        // ENHANCED centerOnLocation with smart map showing
        function centerOnLocation() {
            trackEvent('center_on_location', 'Map Interaction');
            smartShowMap(); // Auto-show map
            
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 14);
                showSuccessToast('Centered on your location!');
            } else {
                getUserLocation();
            }
        }

        // TEMPORARY DEBUG - Find what's causing the gray overlay
        function debugFindGrayOverlay() {
            console.log('🔍 Searching for visible overlays...');
            
            // Check all elements with common overlay classes
            const overlaySelectors = [
                '.results-overlay',
                '.pub-details-overlay',
                '.modal',
                '.search-modal',
                '#resultsOverlay',
                '#pubDetailsOverlay',
                '[class*="overlay"]',
                '[id*="overlay"]',
                '[id*="Overlay"]'
            ];
            
            overlaySelectors.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    const styles = window.getComputedStyle(el);
                    if (styles.display !== 'none' && styles.visibility !== 'hidden') {
                        console.log('⚠️ VISIBLE ELEMENT:', {
                            selector: selector,
                            id: el.id,
                            className: el.className,
                            display: styles.display,
                            visibility: styles.visibility,
                            position: styles.position,
                            zIndex: styles.zIndex,
                            backgroundColor: styles.backgroundColor,
                            element: el
                        });
                    }
                });
            });
            
            // Also check for any fixed position elements
            const allElements = document.querySelectorAll('*');
            allElements.forEach(el => {
                const styles = window.getComputedStyle(el);
                if (styles.position === 'fixed' && styles.display !== 'none' && el.offsetHeight > 100) {
                    console.log('🔧 FIXED ELEMENT:', {
                        id: el.id,
                        className: el.className,
                        height: el.offsetHeight,
                        bottom: styles.bottom,
                        backgroundColor: styles.backgroundColor,
                        element: el
                    });
                }
            });
        }
        
        // NEW: Function to show pub details from map popup
        function showPubDetailsFromMap(pubId) {
            // First, we need to get the pub data
            searchSpecificPub(pubId);
            trackEvent('view_pub_from_map', 'Map Interaction', `pub_${pubId}`);
        }

        // Display search results with pagination
        // function displaySearchResults(data, append = false) {
        //     console.log('displaySearchResults called with pagination support!');
        //     const results = document.getElementById('results');
            
        //     const pubs = Array.isArray(data) ? data : data.pubs;
        //     const pagination = data.pagination || null;
            
        //     if (!append) {
        //         results.innerHTML = '';
                
        //         // Add GF filter suggestion if there are mixed results
        //         if (pubs.length > 0) {
        //             const gfCount = pubs.filter(pub => pub.bottle || pub.tap || pub.cask || pub.can).length;
        //             const totalCount = pubs.length;
                    
        //             // Only show filter if there are both GF and non-GF pubs
        //             if (gfCount > 0 && gfCount < totalCount) {
        //                 const filterDiv = document.createElement('div');
        //                 filterDiv.className = 'filter-suggestion';
        //                 filterDiv.innerHTML = `
        //                     <button class="btn btn-secondary" onclick="showOnlyGF()">
        //                         🍺 Show only pubs with GF beer (${gfCount} of ${totalCount} pubs)
        //                     </button>
        //                 `;
        //                 results.appendChild(filterDiv);
        //             }
        //         }
        //     }
            
        //     if (pubs.length === 0 && !append) {
        //         results.innerHTML = '<li class="no-results">No pubs found.</li>';
        //         return;
        //     }
            
        //     pubs.forEach(pub => {
        //         const resultItem = createResultItem(pub);
        //         results.appendChild(resultItem);
        //     });
            
        //     if (pagination && !append) {
        //         addPaginationControls(pagination);
        //     }
        // }
        
        // Add this new function too
        function showOnlyGF() {
            // For now, just show a coming soon message
            showSuccessToast('🍺 GF-only filter coming soon!');
            trackEvent('gf_filter_clicked', 'User Interest', 'filter_suggestion');
        }

        function formatBeerDetails(beerDetails, pub) {
            // Check if we have specific beer data
            if (!beerDetails || beerDetails === 'None' || beerDetails.trim() === '') {
                // Show generic GF availability instead
                return formatGenericGFAvailability(pub);
            }
            
            // Show specific beers if we have them
            return beerDetails.split(', ').map(beer => {
                const parts = beer.split(' - ');
                if (parts.length >= 2) {
                    const format = parts[0];
                    const details = parts.slice(1).join(' - ');
                    return `<div class="beer-item"><span class="beer-type">${format.charAt(0).toUpperCase() + format.slice(1)}:</span> ${details}</div>`;
                }
                return `<div class="beer-item">${beer}</div>`;
            }).join('');
        }

        // ADD: New function for showing generic GF availability
        function formatGenericGFAvailability(pub) {
            let gfOptions = [];
            let rotatingTap = false;
            
            // Check what formats are available
            if (pub.bottle) gfOptions.push('bottle');
            if (pub.tap) {
                gfOptions.push('tap');
                rotatingTap = true; // Assume tap might rotate
            }
            if (pub.cask) gfOptions.push('cask');
            if (pub.can) gfOptions.push('can');
            
            if (gfOptions.length === 0) {
                return '<div style="color: #9ca3af; font-style: italic;">❓ GF availability needs verification</div>';
            }
            
            let display = '<div class="gf-availability">';
            
            // Show confirmed formats
            display += '<div class="confirmed-formats">';
            display += '<strong style="color: #10b981;">✅ Confirmed GF Options:</strong><br>';
            
            gfOptions.forEach(format => {
                const icons = {
                    bottle: '🍺',
                    tap: '🚰',
                    cask: '🛢️',
                    can: '🥫'
                };
                
                if (format === 'tap') {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)} <span class="rotating-note">(selection may vary)</span></div>`;
                } else {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)}</div>`;
                }
            });
            display += '</div>';
            
            // Add helpful note
            display += '<div class="gf-note">💡 <em>Call ahead to confirm current selection</em></div>';
            display += '</div>';
            
            return display;
        }

        function addPaginationControls(pagination) {
            const results = document.getElementById('results');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';
            paginationDiv.innerHTML = `
                <div class="pagination-info">
                    Showing page ${pagination.page} of ${pagination.pages} (${pagination.total} total results)
                </div>
                <div class="pagination-buttons">
                    ${pagination.has_prev ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">← Previous</button>` : ''}
                    ${pagination.page > 2 ? `<button onclick="loadPage(1)" class="pagination-btn">1</button>` : ''}
                    ${pagination.page > 3 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page > 1 ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">${pagination.page - 1}</button>` : ''}
                    <button class="pagination-btn active">${pagination.page}</button>
                    ${pagination.page < pagination.pages ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">${pagination.page + 1}</button>` : ''}
                    ${pagination.page < pagination.pages - 2 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page < pagination.pages - 1 ? `<button onclick="loadPage(${pagination.pages})" class="pagination-btn">${pagination.pages}</button>` : ''}
                    ${pagination.has_next ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">Next →</button>` : ''}
                </div>
            `;
            results.appendChild(paginationDiv);
        }

        async function loadPage(page) {
            currentPage = page;
            const url = `/search?query=${encodeURIComponent(currentQuery)}&search_type=${currentSearchType}&page=${page}`;
            
            showLoadingToast('Loading page...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading...</li>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                hideLoadingToast();
                displaySearchResults(data);
                addPubMarkersToMap(data.pubs || data);
                
                AppState.save();
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading page:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading results. Please try again.</li>';
            }
        }

        // ==========================================
        // AFTER: New searchSpecificPub Function
        // ==========================================
        async function searchSpecificPub(pubId) {
            console.log('searchSpecificPub called with ID:', pubId);
            showLoadingToast('Loading pub details...');
            
            try {
                const url = `/search?pub_id=${pubId}`;
                const response = await fetch(url);
                const pubs = await response.json();
                
                hideLoadingToast();
                
                if (pubs.length > 0) {
                    const pub = pubs[0];
                    
                    // NEW WAY: Shows full-screen pub details page
                    showPubDetails(pub);
                    
                    currentQuery = '';
                    currentSearchType = 'all';
                    currentPage = 1;
                    AppState.save(pubId);
                } else {
                    showSuccessToast('Pub not found.');
                }
            } catch (error) {
                console.error('Error searching for specific pub:', error);
                hideLoadingToast();
                showSuccessToast('Error loading pub details.');
            }
        }

        async function searchPubs() {
            const query = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            // const gfOnly = document.getElementById('gfOnly')?.checked ?? false;
            const results = document.getElementById('results');
            
            if (!query) {
                results.innerHTML = '<li class="no-results">Please enter a search term.</li>';
                return;
            }
            
            currentQuery = query;
            currentSearchType = searchType;
            // currentGfOnly = gfOnly;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            // Check if query looks like a postcode
            const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
            
            try {
                let url;
                let searchResults;
                
                if (isPostcode && (searchType === 'postcode' || searchType === 'all')) {
                    // Handle postcode search - geocode then find nearby
                    console.log('Detected postcode search:', query);
                    showLoadingToast('Finding location...');
                    
                    // First geocode the postcode
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData && geocodeData.length > 0) {
                        const lat = parseFloat(geocodeData[0].lat);
                        const lng = parseFloat(geocodeData[0].lon);
                        
                        showLoadingToast('Finding nearby pubs...');
                        
                        url = `/nearby?lat=${lat}&lng=${lng}&radius=5`;
                        
                        // Auto-show map and update to show the postcode area
                        smartShowMap();
                        if (map) {
                            map.setView([lat, lng], 14);
                            
                            // Add postcode marker
                            if (window.postcodeMarker) {
                                map.removeLayer(window.postcodeMarker);
                            }
                            window.postcodeMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">📍</div>`,
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            }).addTo(map);
                            
                            window.postcodeMarker.bindPopup(`<strong>${query}</strong><br>Searching nearby pubs...`).openPopup();
                        }
                    } else {
                        throw new Error('Postcode not found');
                    }
                } else {
                    // Regular text search
                    url = `/search?query=${encodeURIComponent(query)}&search_type=${searchType}&page=1`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    if (isPostcode) {
                        results.innerHTML = `<li class="no-results">No pubs found within 5km of ${query}. Try expanding your search area.</li>`;
                        showSuccessToast(`No pubs found near ${query}`);
                    } else {
                        results.innerHTML = '<li class="no-results">No pubs found.</li>';
                        showSuccessToast('No pubs found for your search');
                    }
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message
                const message = isPostcode && pubs.length > 0 ? 
                    `✅ Found ${pubs.length} pubs within 5km of ${query}` :
                    `Found ${pubs.length} pubs matching "${query}"`;
                showSuccessToast(message);
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                if (isPostcode) {
                    results.innerHTML = `<li class="no-results">Could not find location for "${query}". Please check the postcode and try again.</li>`;
                    showSuccessToast(`Could not find location for "${query}"`);
                } else {
                    results.innerHTML = '<li class="no-results">Error searching pubs. Please try again.</li>';
                    showSuccessToast('Error searching pubs. Please try again.');
                }
            }
        }

        function toggleUpdateForm(pubId) {
            showComingSoon('Update Form');
        }

        function openInGoogleMaps(lat, lng, pubName, address) {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            }
            
            trackEvent('open_navigation', 'External Navigation', pubName);
            showSuccessToast('🧭 Opening directions...');
        }

        function findOnMap(lat, lng, pubName, postcode, pubId) {
            trackPubView(pubName);
            
            // Always show the map when someone clicks "Find on Map"
            if (!mapVisible) {
                toggleMap();
            }
            
            if (lat && lng && lat !== 'null' && lng !== 'null' && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                setTimeout(() => {
                    // Zoom to the location
                    map.setView([parseFloat(lat), parseFloat(lng)], 17);
                    
                    // Remove any existing highlight markers
                    if (window.currentHighlightMarker) {
                        map.removeLayer(window.currentHighlightMarker);
                    }
                    
                    // Create a special highlight marker
                    window.currentHighlightMarker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                        radius: 15,
                        fillColor: '#ff6b6b',
                        color: '#fff',
                        weight: 4,
                        opacity: 1,
                        fillOpacity: 0.9,
                        className: 'pulsing-marker'
                    }).addTo(map);
                    
                    const markerElement = window.currentHighlightMarker.getElement();
                    if (markerElement) {
                        markerElement.style.animation = 'pulse 2s infinite';
                    }
                    
                    window.currentHighlightMarker.bindPopup(`
                        <div style="text-align: center; padding: 8px;">
                            <strong style="color: #2d3748; font-size: 16px;">${pubName}</strong>
                            <br><em style="color: #667eea;">📍 Found on map!</em>
                            <br><small style="color: #718096;">Click for details</small>
                        </div>
                    `).openPopup();
                    
                    showSuccessToast(`📍 Found ${pubName} on map!`);
                    
                    setTimeout(() => {
                        if (window.currentHighlightMarker) {
                            map.removeLayer(window.currentHighlightMarker);
                            window.currentHighlightMarker = null;
                        }
                    }, 8000);
                    
                }, mapVisible ? 50 : 300);
            } else {
                showComingSoon('Coordinate Modal for pub location');
            }
        }

        function searchForPub(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            trackEvent('search_online', 'External Search', pubName);
            window.open(googleUrl, '_blank');
        }

        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            const isVisible = filters.style.display !== 'none';
            filters.style.display = isVisible ? 'none' : 'block';
            
            // Update button text
            const btn = document.querySelector('.btn-advanced-filters');
            if (btn) {
                btn.textContent = isVisible ? '🔧 Advanced Filters' : '🔧 Hide Filters';
            }
        }
        
        function clearAllFilters() {
            document.getElementById('beerFormat').value = 'all';
            document.getElementById('beerStyle').value = 'all';
            document.getElementById('breweryFilter').value = 'all';
            document.getElementById('maxDistance').value = '10';
            
            // Re-run search with cleared filters
            searchPubs();
        }

        function clearSelectedPub() {
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('reportPubSearch').value = '';
            document.getElementById('reportPubSearch').focus();
        }

        // REPLACE: Fixed loadDashboardStats function
        async function loadDashboardStats() {
            try {
                console.log('🔄 Loading dashboard stats from database...');
                const response = await fetch('/api/stats');
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('✅ Stats loaded:', stats);
                    
                    // Animate the numbers counting up
                    animateNumber('totalPubs', stats.total_pubs);
                    animateNumber('gfPubs', stats.gf_pubs);
                    
                    // Update footer stats too
                    document.getElementById('footerPubCount').textContent = stats.total_pubs.toLocaleString();
                    document.getElementById('footerGFCount').textContent = stats.gf_pubs.toLocaleString();
                    
                    console.log(`📊 Dashboard updated: ${stats.total_pubs} pubs, ${stats.gf_pubs} GF pubs`);
                    
                } else {
                    console.warn('⚠️ Stats API returned error, using fallback data');
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('⚠️ Could not load live stats, using fallback data:', error);
                
                // Sensible fallback numbers
                animateNumber('totalPubs', 49841);
                animateNumber('gfPubs', 1249);
                
                // Update footer with fallback data
                document.getElementById('footerPubCount').textContent = '49,841';
                document.getElementById('footerGFCount').textContent = '1,249';
            }
        }
        
        // Enhanced number animation with better formatting
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Element ${elementId} not found`);
                return;
            }
            
            const startNumber = 0;
            const duration = 2000; // 2 seconds
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease out animation
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOut);
                
                // Format the number with commas
                element.textContent = currentNumber.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                } else {
                    // Ensure final number is exactly correct
                    element.textContent = targetNumber.toLocaleString();
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // Cookie functions
        function acceptAllCookies() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'true');
            hideCookieBanner();
            initializeAnalytics();
            showSuccessToast('✅ Cookie preferences saved. Thanks!');
            trackEvent('cookie_consent', 'Privacy', 'accept_all');
        }
        
        function acceptEssentialOnly() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'false');
            hideCookieBanner();
            showSuccessToast('✅ Essential cookies only. You can change this anytime.');
        }

        function showCookieSettings() {
            document.getElementById('cookieSettings').style.display = 'block';
            const analyticsConsent = localStorage.getItem('analyticsConsent');
            document.getElementById('analyticsConsent').checked = analyticsConsent === 'true';
        }

        function savesCookiePreferences() {
            const analyticsConsent = document.getElementById('analyticsConsent').checked;
            
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', analyticsConsent.toString());
            
            closeModal('cookieSettings');
            hideCookieBanner();
            
            if (analyticsConsent) {
                initializeAnalytics();
                showSuccessToast('✅ Preferences saved. Analytics enabled.');
                trackEvent('cookie_consent', 'Privacy', 'analytics_enabled');
            } else {
                showSuccessToast('✅ Preferences saved. Analytics disabled.');
            }
        }

        function acceptAllFromSettings() {
            document.getElementById('analyticsConsent').checked = true;
            savesCookiePreferences();
        }

        function hideCookieBanner() {
            const banner = document.getElementById('cookieConsent');
            banner.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                banner.style.display = 'none';
                document.getElementById('cookieSettingsFloat').style.display = 'block';
            }, 300);
        }

        function initializeAnalytics() {
            if (typeof gtag !== 'undefined' && localStorage.getItem('analyticsConsent') === 'true') {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted'
                });
                console.log('✅ Google Analytics initialized with user consent');
            }
        }

        // Full-screen pub details functionality
        let pubMapVisible = false;
        let currentPubData = null;
        
        
        // UPDATE the showPubDetails function to prevent background scrolling:
        
        function showPubDetails(pubId) {
            console.log('🎯 showPubDetails called with:', pubId, typeof pubId);
            
            // Validate pubId
            if (!pubId || isNaN(pubId)) {
                console.error('❌ Invalid pub ID:', pubId);
                showSuccessToast('❌ Invalid pub ID');
                return;
            }
            
            console.log('✅ Valid pub ID, closing results and loading details...');
            
            // Close results overlay first  
            closeResults();
            
            // Add loading state
            showLoadingToast('Loading pub details...');
            
            // Use your existing searchSpecificPub function
            searchSpecificPubForDetails(pubId);
        }

        // Temporary debug - add this right after your existing showPubDetails function
        function debugShowPubDetails(pubId) {
            console.log('🔍 DEBUG: showPubDetails flow');
            console.log('1. pubId received:', pubId, 'type:', typeof pubId);
            console.log('2. resultsOverlay visible?', document.getElementById('resultsOverlay').classList.contains('active'));
            console.log('3. Calling original showPubDetails...');
            showPubDetails(pubId);
            setTimeout(() => {
                console.log('4. After 500ms - pubDetailsOverlay visible?', document.getElementById('pubDetailsOverlay').classList.contains('active'));
                console.log('5. After 500ms - resultsOverlay visible?', document.getElementById('resultsOverlay').classList.contains('active'));
            }, 500);
        }
        
        // 📝 ADD NEW - New function to handle the API call specifically for details
        async function searchSpecificPubForDetails(pubId) {
            console.log('🔍 Searching for specific pub:', pubId);
            
            try {
                const url = `/search?pub_id=${pubId}`;
                console.log('📡 API call:', url);
                
                const response = await fetch(url);
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const pubs = await response.json();
                console.log('📡 API response:', pubs);
                
                hideLoadingToast();
                
                if (pubs && pubs.length > 0) {
                    const pub = pubs[0];
                    console.log('✅ Pub found:', pub.name);
                    
                    // Call your existing function to show the overlay
                    displayPubDetailsOverlay(pub);
                } else {
                    console.error('❌ No pub found in response');
                    showSuccessToast('❌ Pub not found');
                }
            } catch (error) {
                console.error('❌ Error searching for specific pub:', error);
                hideLoadingToast();
                showSuccessToast('❌ Error loading pub details');
            }
        }
        
        // 📝 RENAME - Your existing showPubDetails function should be renamed to this:
        function displayPubDetailsOverlay(pub) {
            console.log('🎨 Displaying pub details overlay for:', pub.name);
            
            // Store complete pub data including coordinates
            currentPubData = {
                pub_id: pub.pub_id,
                name: pub.name,
                address: pub.address,
                postcode: pub.postcode,
                latitude: pub.latitude,
                longitude: pub.longitude,
                local_authority: pub.local_authority
            };
            
            // Update the pub details content
            document.getElementById('pubDetailsTitle').textContent = pub.name;
            document.getElementById('pubDetailsAddress').textContent = `${pub.address}, ${pub.postcode}`;
            document.getElementById('pubDetailsLocation').textContent = pub.local_authority;
            
            // Update beer information
            const beerElement = document.getElementById('pubDetailsBeer');
            const beerSection = document.querySelector('.beer-section');
            
            if (pub.bottle || pub.tap || pub.cask || pub.can) {
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('🍺 Bottle');
                if (pub.tap) gfOptions.push('🚰 Tap');
                if (pub.cask) gfOptions.push('🛢️ Cask');
                if (pub.can) gfOptions.push('🥫 Can');
                
                beerElement.innerHTML = `<strong>✅ Confirmed GF Options:</strong><br>${gfOptions.join(', ')}<br><em>💡 Call ahead to confirm current selection</em>`;
                
                const formatText = gfOptions.length > 1 ? `${gfOptions.length} GF options` : gfOptions[0];
                beerSection.setAttribute('data-formats', formatText);
            } else {
                beerElement.innerHTML = '❓ GF availability needs verification<br><em>Help the community by reporting what you find!</em>';
                beerSection.setAttribute('data-formats', '❓ GF status unknown');
            }
            
            // Set up action buttons
            document.getElementById('pubFindOnline').onclick = () => {
                const searchQuery = `${pub.name} ${pub.postcode} pub`;
                const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
                window.open(googleUrl, '_blank');
                trackEvent('search_online', 'External Search', pub.name);
            };
            
            document.getElementById('pubGetDirections').onclick = () => {
                if (pub.latitude && pub.longitude) {
                    openInGoogleMaps(pub.latitude, pub.longitude, pub.name, pub.address);
                } else {
                    showSuccessToast('📍 Location coordinates not available for directions');
                }
            };
            
            // Update report button to use current pub data
            const reportButton = document.querySelector('button[onclick="openReportModal()"]');
            if (reportButton) {
                reportButton.setAttribute('onclick', 'openReportModalForCurrentPub()');
                console.log('✅ Updated report button for pub:', pub.name);
            }
            
            // Reset map state
            pubMapVisible = false;
            document.getElementById('pubContainer').classList.remove('split-view');
            document.getElementById('pubMapContainer').classList.remove('map-visible');
            document.getElementById('pubMapBtnText').textContent = 'Show on Map';
            document.getElementById('pubToggleMap').classList.remove('active');
            
            // Lock body scroll
            document.body.classList.add('pub-details-open');
            
            // Show the overlay
            const overlay = document.getElementById('pubDetailsOverlay');
            overlay.classList.add('active');
            overlay.style.display = 'flex'; // Force display
            
            // Track the view
            trackPubView(pub.name);
            trackEvent('pub_details_view', 'Navigation', pub.name);
        }
        
        function closePubDetails() {
            console.log('🚪 Closing pub details overlay');
            
            const pubDetailsOverlay = document.getElementById('pubDetailsOverlay');
            if (pubDetailsOverlay) {
                pubDetailsOverlay.classList.remove('active');
                // Force hide with inline style
                pubDetailsOverlay.style.display = 'none';
            }
            
            // Unlock body scroll
            document.body.classList.remove('pub-details-open');
            document.body.style.overflow = '';
            
            // Reset map state
            pubMapVisible = false;
            const container = document.getElementById('pubContainer');
            if (container) {
                container.classList.remove('split-view');
            }
            
            const mapBtnText = document.getElementById('pubMapBtnText');
            if (mapBtnText) {
                mapBtnText.textContent = 'Show on Map';
            }
            
            console.log('✅ Pub details closed');
        }
        
        // 🔄 REPLACING - Replace the existing togglePubMap function
        // function togglePubMap() {
        //     const container = document.getElementById('pubContainer');
        //     const mapContainer = document.getElementById('pubMapContainer');
        //     const mapBtnText = document.getElementById('pubMapBtnText');
        //     const mapBtn = document.getElementById('pubToggleMap');
            
        //     pubMapVisible = !pubMapVisible;
            
        //     if (pubMapVisible) {
        //         // Show split view
        //         container.classList.add('split-view');
        //         mapContainer.classList.add('map-visible');
        //         mapBtnText.textContent = 'Hide Map';
        //         mapBtn.classList.add('active');
                
        //         console.log('🗺️ Map toggled ON');
                
        //         // Initialize map if we have coordinates
        //         if (currentPubData && currentPubData.latitude && currentPubData.longitude) {
        //             setTimeout(() => {
        //                 initializePubMap(currentPubData);
        //             }, 300);
        //         } else {
        //             // Show placeholder message
        //             setTimeout(() => {
        //                 const placeholder = document.querySelector('.pub-map-placeholder');
        //                 if (placeholder) {
        //                     placeholder.innerHTML = `
        //                         <div>📍 Location coordinates not available</div>
        //                         <small style="opacity: 0.7;">Help us by reporting the exact location!</small>
        //                     `;
        //                 }
        //             }, 300);
        //         }
                
        //         trackEvent('pub_map_toggle', 'Map Interaction', 'show');
        //     } else {
        //         // Hide split view
        //         container.classList.remove('split-view');
        //         mapContainer.classList.remove('map-visible');
        //         mapBtnText.textContent = 'Show on Map';
        //         mapBtn.classList.remove('active');
                
        //         console.log('🗺️ Map toggled OFF');
        //         trackEvent('pub_map_toggle', 'Map Interaction', 'hide');
        //     }
        // }
        
        // REPLACE the initializePubMap function with this cleaner version:

        function initializePubMap(pub) {
            const mapContainer = document.querySelector('.pub-map-placeholder');
            
            if (!pub.latitude || !pub.longitude) {
                mapContainer.innerHTML = '📍 Location coordinates not available<br><small style="opacity: 0.7;">Help us by reporting the exact location!</small>';
                return;
            }
            
            // Clear the placeholder and create a map container
            mapContainer.innerHTML = '<div id="pubMapLeaflet" style="width: 100%; height: 100%; border-radius: 0 0 var(--radius-xl) var(--radius-xl);"></div>';
            
            // Get CSS variables for consistent styling
            const rootStyles = getComputedStyle(document.documentElement);
            const pubFillColor = rootStyles.getPropertyValue('--marker-pub-fill').trim() || '#4CAF50';
            const pubStrokeColor = rootStyles.getPropertyValue('--marker-pub-stroke').trim() || '#ffffff';
            const userFillColor = rootStyles.getPropertyValue('--marker-user-fill').trim() || '#667eea';
            const userStrokeColor = rootStyles.getPropertyValue('--marker-user-stroke').trim() || '#ffffff';
            
            // Initialize Leaflet map for the pub
            const pubMap = L.map('pubMapLeaflet').setView([pub.latitude, pub.longitude], 16);
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(pubMap);
            
            // Add marker for the pub using CSS variables
            const pubMarker = L.circleMarker([pub.latitude, pub.longitude], {
                radius: 12,
                fillColor: pubFillColor,
                color: pubStrokeColor,
                weight: 3,
                opacity: 1,
                fillOpacity: 0.9
            }).addTo(pubMap);
            
            // Add popup to the marker
            let popupContent = `<div style="text-align: center; padding: 8px;">`;
            popupContent += `<strong style="color: var(--text-primary); font-size: 14px;">${pub.name}</strong><br>`;
            popupContent += `<small style="color: var(--text-muted);">${pub.address}</small><br>`;
            
            // Add GF options if available
            if (pub.bottle || pub.tap || pub.cask || pub.can) {
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('🍺');
                if (pub.tap) gfOptions.push('🚰');
                if (pub.cask) gfOptions.push('🛢️');
                if (pub.can) gfOptions.push('🥫');
                popupContent += `<div style="margin-top: 8px; color: var(--success-color, #10b981);"><strong>GF: ${gfOptions.join(' ')}</strong></div>`;
            }
            popupContent += `</div>`;
            
            pubMarker.bindPopup(popupContent).openPopup();
            
            // Add user location if available
            if (userLocation) {
                L.circleMarker([userLocation.lat, userLocation.lng], {
                    radius: 8,
                    fillColor: userFillColor,
                    color: userStrokeColor,
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(pubMap).bindPopup('Your location');
                
                // Calculate and show distance
                const distance = calculateDistance(
                    userLocation.lat, userLocation.lng,
                    pub.latitude, pub.longitude
                );
                
                // Update popup with distance
                popupContent = popupContent.replace('</div>', `<div style="color: var(--primary-color, #667eea); font-size: 12px; margin-top: 4px;">${distance.toFixed(2)} km away</div></div>`);
                pubMarker.bindPopup(popupContent).openPopup();
            }
            
            // Ensure map renders properly
            setTimeout(() => {
                pubMap.invalidateSize();
            }, 100);
            
            console.log('✅ Pub map initialized for:', pub.name);
        }

        function checkCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            const analyticsConsent = localStorage.getItem('analyticsConsent');
            
            if (!consent) {
                setTimeout(() => {
                    document.getElementById('cookieConsent').style.display = 'block';
                }, 1000);
            } else {
                document.getElementById('cookieSettingsFloat').style.display = 'block';
                
                if (analyticsConsent === 'true') {
                    initializeAnalytics();
                }
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            // document.getElementById('gfOnly').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            hideResultsSection();
            
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
            }
            
            currentQuery = '';
            currentSearchType = 'all';
            // currentGfOnly = false;
            currentPage = 1;
            AppState.save();
        }

        // ================================
        // ✏️ UPDATE - REPLACE your existing initializeReportModalDropdowns function
        // Replace the entire function with this enhanced version  
        // ================================

        function initializeReportModalDropdowns() {
            console.log('🔧 Initializing report modal auto-complete...');
            
            // Initialize photo upload handler
            handlePhotoUpload();
            
            // Add these lines to your existing initializeReportModalDropdowns function:
            
            // Brewery field - show dropdown on focus/click
            const breweryInput = document.getElementById('reportBrewery');
            if (breweryInput) {
                breweryInput.addEventListener('focus', () => {
                    searchBreweries(''); // Empty string shows all breweries
                });
                
                breweryInput.addEventListener('click', () => {
                    searchBreweries(''); // Empty string shows all breweries  
                });
            }
            
            // Beer name field - show brewery's beers on focus if brewery selected
            const beerNameInput = document.getElementById('reportBeerName');
            if (beerNameInput) {
                beerNameInput.addEventListener('focus', () => {
                    const brewery = document.getElementById('reportBrewery').value;
                    if (brewery && !beerNameInput.value) {
                        loadBeersForBrewery(brewery);
                    }
                });
            }
            
            // Hide dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.brewery-dropdown-container')) {
                    const dropdown = document.getElementById('breweryDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
                if (!e.target.closest('.beer-name-container')) {
                    const dropdown = document.getElementById('beerNameDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
                if (!e.target.closest('.beer-style-container')) {
                    const dropdown = document.getElementById('beerStyleDropdown');
                    if (dropdown) dropdown.style.display = 'none';
                }
            });
            
            console.log('✅ Report modal auto-complete initialized');
        }

        // ADD: Homepage reset function
        function resetToHomepage() {
            // Clear search inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('searchType').value = 'all';
            
            // Hide results section
            hideResultsSection();
            
            // Hide map if visible
            if (mapVisible) {
                toggleMap();
            }
            
            // Clear any markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.currentHighlightMarker) {
                map.removeLayer(window.currentHighlightMarker);
                window.currentHighlightMarker = null;
            }
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
                window.postcodeMarker = null;
            }
            
            // Clear URL hash/state
            window.location.hash = '';
            
            // Reset global variables
            currentQuery = '';
            currentSearchType = 'all';
            currentPage = 1;
            mapVisible = false;
            
            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Show clean homepage sections
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            if (featuresSection) featuresSection.style.display = 'block';
            if (activitySection) activitySection.style.display = 'block';
            
            // Update button text
            const toggleBtn = document.getElementById('toggleMapBtn');
            if (toggleBtn) toggleBtn.innerHTML = '🗺️ Show Map';
            
            // Success feedback
            showSuccessToast('🏠 Reset to homepage - ready for a fresh search!');
            trackEvent('reset_homepage', 'Navigation', 'homepage_reset');
        }

        console.log('🍺 Coeliacs Like Beer Too - JavaScript loaded successfully!');
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</body>
</html>
