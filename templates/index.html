<!---------------------------
    LEAFLET.JS - Keep this external dependency
    ---------------------------->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!---------------------------
    SINGLE MODULE ENTRY POINT
    All modules now load through main.js in proper order
    ---------------------------->
    <script type="module" src="/static/main.js?v={{ cache_buster }}"></script>

    <!---------------------------
    LEGACY SUPPORT & INITIALIZATION
    Essential functions and setup that can't be modularized yet
    ---------------------------->
    <script>
        // Wait for app to initialize before setting up remaining handlers
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Setting up legacy event handlers...');
            
            // Check if app initialized successfully after a delay
            setTimeout(() => {
                if (!window.CoeliacsApp?.initialized) {
                    console.warn('‚ö†Ô∏è App initialization may have failed');
                    showInitializationFallback();
                }
            }, 3000);
            
            // Handle file upload preview for photo input
            const photoInput = document.getElementById('reportPhoto');
            const photoLabel = document.querySelector('.photo-upload-compact');
            
            if (photoInput && photoLabel) {
                photoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const fileName = file.name.length > 20 ? 
                            file.name.substring(0, 17) + '...' : 
                            file.name;
                        
                        const textEl = photoLabel.querySelector('.photo-upload-text');
                        if (textEl) {
                            textEl.innerHTML = `
                                <strong>üì∏ ${fileName}</strong><br>
                                <small>Click to change photo</small>
                            `;
                        }
                        photoLabel.classList.add('active');
                    }
                });
            }
        });
        
        // Fallback initialization if modules fail to load
        function showInitializationFallback() {
            const fallbackDiv = document.createElement('div');
            fallbackDiv.className = 'initialization-fallback';
            fallbackDiv.innerHTML = `
                <strong>‚ö†Ô∏è Slow Loading</strong>
                The app is taking longer than expected to load...
                <button onclick="location.reload()" class="fallback-btn">
                    Refresh Page
                </button>
            `;
            document.body.appendChild(fallbackDiv);
            
            setTimeout(() => {
                fallbackDiv.remove();
            }, 10000);
        }
        
        // Debug helper - available globally
        window.debugApp = function() {
            console.log('üîç App State:', window.AppState);
            console.log('üîç Available Modules:', Object.keys(window.CoeliacsApp?.modules || {}));
            if (window.CoeliacsApp?.state) {
                console.log('üîç Module Status:', window.CoeliacsApp.state.modules);
            }
        };
        
        // Performance monitoring
        window.addEventListener('load', function() {
            // Log performance metrics
            if (performance && performance.timing) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                console.log(`‚ö° Page load time: ${loadTime}ms`);
                
                // Track slow loads
                if (loadTime > 3000 && window.CoeliacsApp?.modules?.tracking) {
                    window.CoeliacsApp.modules.tracking.trackEvent('slow_page_load', 'Performance', `${loadTime}ms`);
                }
            }
        });
    </script>
    
    <script>
        // Cache-busting timestamp
        console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
        
        // Environment info for debugging
        console.log('üì± User Agent:', navigator.userAgent.substring(0, 50) + '...');
        console.log('üì∫ Viewport:', window.innerWidth + 'x' + window.innerHeight);
        console.log('üåê Connection:', navigator.connection?.effectiveType || 'unknown');
    </script>
