<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coeliacs Like Beer Too! - Find GF-Friendly Pubs - {{ cache_buster }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Google Analytics with GDPR compliance -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WSHR39KSXS"></script>
    
    <!-- Basic Analytics Setup -->
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Set default consent to denied (GDPR compliant)
        gtag('consent', 'default', {
            'analytics_storage': 'denied'
        });
        
        gtag('js', new Date());
        gtag('config', 'G-WSHR39KSXS', {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
        });
    </script>
</head>
<body>
    
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Coeliacs Like Beer Too!</h1>
            <p class="hero-subtitle">The UK's largest community-driven guide to gluten free beer</p>
            
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalPubs">Loading...</span>
                    <span class="stat-label">UK Pubs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="gfPubs">Loading...</span>
                    <span class="stat-label">GF Pubs</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section - UPDATED VERSION -->
    <div class="search-section" id="search">
        <div class="container">
            <div class="search-card">
                <div class="search-header">
                    <h2 class="section-title">üîç Find Gluten Free Beer Near You üç∫</h2>
                </div>
                <div class="search-body">
                    <div class="search-grid">
                        <div class="search-row">
                            <select id="searchType" class="form-select" aria-label="Select search type above: all, pub name, postcode, or local authority">
                                <option value="all">Search All</option>
                                <option value="name">Pub Name</option>
                                <option value="postcode">Postcode</option>
                                <option value="area">Local Authority</option>
                            </select>
                            <input type="text" id="searchInput" class="form-input" placeholder="Enter pub name, postcode, or local authority" onkeydown="if (event.key === 'Enter') searchPubs()" aria-label="Search input for pubs" autocomplete="off">
                            <div id="suggestions" class="suggestions"></div>
                        </div>
                        <div class="search-actions">
                            <button onclick="searchPubs()" class="btn btn-primary" aria-label="Search for pubs">Search Pubs</button>
                            <button class="btn btn-success" onclick="findNearbyPubs()" aria-label="Find pubs near my current location">Pubs Near Me</button>
                            <button class="btn btn-secondary" id="toggleMapBtn" onclick="toggleMap()" aria-label="Toggle map visibility">üó∫Ô∏è Show Map</button>
                            <button class="btn btn-secondary" onclick="centerOnLocation()" aria-label="Center map on my location">üìç My Location</button>
                            <button class="btn btn-danger" onclick="resetToHomepage()" title="Clear everything and start fresh" aria-label="Reset to homepage">üè† Reset</button>
                        </div>
                    </div>
                    <div id="suggestions" class="suggestions"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full-Screen Pub Details Overlay -->
    <div id="pubDetailsOverlay" class="pub-details-overlay">
        <div class="pub-details-container" id="pubContainer">
            <div class="pub-details-card">
                <div class="pub-header">
                    <h1 class="pub-title" id="pubDetailsTitle">Pub Name</h1>
                    <div class="pub-address" id="pubDetailsAddress">Address</div>
                    <div class="pub-location" id="pubDetailsLocation">Location</div>
                </div>
    
                <div class="beer-section">
                    <div class="beer-section-title">
                        üç∫ Available Gluten Free Beers
                    </div>
                    <div class="beer-status" id="pubDetailsBeer">
                        Loading beer information...
                    </div>
                </div>
    
                <div class="pub-action-grid">
                    <button class="btn btn-primary" id="pubFindOnline">
                        üîç Find Online
                    </button>
                    <button class="btn btn-success" id="pubGetDirections">
                        üß≠ Get Directions
                    </button>
                    <button class="btn btn-secondary" id="pubToggleMap" onclick="togglePubMap()">
                        üó∫Ô∏è <span id="pubMapBtnText">Show on Map</span>
                    </button>
                    <button class="btn btn-success" onclick="openReportModal()">
                        üìù Report GF Beer
                    </button>
                </div>
    
                <div class="pub-nav-buttons">
                    <button class="btn btn-primary" onclick="closePubDetails()">
                        üè† Home<
                    </button>
                    <button class="btn btn-primary" onclick="closePubDetails()">
                        ‚Üê Back to Results
                    </button>
                </div>
            </div>
    
            <div class="pub-map-container" id="pubMapContainer">
                <div class="pub-map-placeholder">
                    üó∫Ô∏è Interactive Map Loading...
                </div>
            </div>
        </div>
    </div>

<!--     <div class="advanced-filters" id="advancedFilters" style="display: none;">
    <h4>üîç Advanced Filters</h4>
    <div class="filter-grid">
        <select id="beerFormat" class="filter-select">
            <option value="all">Any Format</option>
            <option value="bottle">üç∫ Bottles Only</option>
            <option value="tap">üö∞ Tap Only</option>
            <option value="cask">üõ¢Ô∏è Cask Only</option>
            <option value="can">ü•´ Cans Only</option>
        </select>
        
        <select id="beerStyle" class="filter-select">
            <option value="all">Any Style</option>
            <option value="ipa">IPA</option>
            <option value="lager">Lager</option>
            <option value="ale">Ale</option>
            <option value="stout">Stout</option>
            <option value="wheat">Wheat Beer</option>
        </select>
        
        <select id="breweryFilter" class="filter-select">
            <option value="all">Any Brewery</option>
        </select>
        
        <select id="maxDistance" class="filter-select">
            <option value="5">Within 5km</option>
            <option value="10">Within 10km</option>
            <option value="25">Within 25km</option>
            <option value="50">Within 50km</option>
        </select>
    </div>
    
    <button onclick="clearAllFilters()" class="btn-clear-filters">Clear Filters</button>
</div> -->

<!-- ADD THIS: Toggle button for filters -->
<!-- <button onclick="toggleAdvancedFilters()" class="btn-advanced-filters">
    üîß Advanced Filters
</button> -->

    <!-- Dynamic Results Section - Pushed down when visible -->
    <div id="results-section" style="display: none;">
        <div class="results-header">
            <h2 class="section-title">üìç Search Results</h2>
        </div>
        <ul id="results" class="results-list"></ul>
    </div>

    <!-- Map Section (Hidden by Default, Smart Show) -->
    <div class="map-container" id="mapContainer" style="display: none;">
        <div class="map-section-header">
            <h2 class="section-title">üó∫Ô∏è Interactive Map</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Location Status -->
    <div id="locationStatus" class="location-status location-loading" style="display: none;">
        Getting your location...
    </div>

    <!-- Features Grid -->
    <div class="features-section" id="featuresSection">
        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">‚ÑπÔ∏è</span>
                <h3 class="feature-title">About Us</h3>
                <p class="feature-description">Learn about our mission to help coeliacs find great beer across the UK.</p>
                <button class="btn btn-primary" onclick="showAboutUs()">Learn More</button>
            </div>
            
            <!-- SWAPPED: What is GF Beer now comes before Report -->
            <div class="feature-card">
                <span class="feature-icon">üî¨</span>
                <h3 class="feature-title">What is GF Beer?</h3>
                <p class="feature-description">Everything you need to know about gluten free beer standards and safety.</p>
                <button class="btn btn-primary" onclick="showGFInfo()">Learn More</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üì∏</span>
                <h3 class="feature-title">Report GF Beer</h3>
                <p class="feature-description">Found gluten free beer somewhere? Share it with the community and help others!</p>
                <button class="btn btn-primary" onclick="openReportModal()">Add Report</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üè≠</span>
                <h3 class="feature-title">GF Breweries</h3>
                <p class="feature-description">Discover breweries making amazing gluten free beers and where to find them.</p>
                <button class="btn btn-primary" onclick="window.location.href='/breweries'">Discover Breweries</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üìß</span>
                <h3 class="feature-title">Weekly Updates</h3>
                <p class="feature-description">Get notified about new GF beer finds, pub additions, and brewery news.</p>
                <button class="btn btn-primary" onclick="showComingSoon('Newsletter')">Coming Soon</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">‚≠ê</span>
                <h3 class="feature-title">GF Beer Reviews</h3>
                <p class="feature-description">Real reviews from coeliacs - discover which beers are worth trying and which to avoid.</p>
                <button class="btn btn-primary" onclick="showComingSoon('Beer Reviews')">Coming Soon</button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section" id="activitySection">
        <div class="activity-card">
            <div class="activity-header">
                <h2 class="activity-title">üî• Recent GF Beer Updates</h2>
                <a href="#" class="view-all" onclick="showAllActivity()">View All</a>
            </div>
            
            <div id="recentActivity">
                <div class="activity-item">
                    <div class="activity-avatar">üç∫</div>
                    <div class="activity-content">
                        <div class="activity-text">Welcome to the community! Start by searching for pubs near you.</div>
                        <div class="activity-time">Search above to see real pub data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">üç∫ Coeliacs Like Beer Too</h3>
                <p class="footer-description">The UK's largest community-driven guide to gluten free beer. Built by coeliacs, for coeliacs.</p>
                <div class="footer-stats">
                    <span id="footerPubCount">52,847</span> pubs ¬∑ 
                    <span id="footerGFCount">1,249</span> with GF options
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üîó Quick Links</h4>
                <div class="footer-links">
                    <a href="#" onclick="showAboutUs()" class="footer-link">About Us</a>
                    <a href="#" onclick="showGFInfo()" class="footer-link">What is GF Beer?</a>
                    <a href="#" onclick="openReportModal()" class="footer-link">Report GF Beer</a>
                    <a href="#" onclick="scrollToSearch()" class="footer-link">Search Pubs</a>       
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üìã Legal & Privacy</h4>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link" target="_blank">Privacy Policy</a>
                    <a href="/terms" class="footer-link" target="_blank">Terms of Service</a>
                    <a href="/cookies" class="footer-link" target="_blank">Cookie Policy</a>
                    <a href="/accessibility" class="footer-link" target="_blank">Accessibility</a>
                    <a href="/liability" class="footer-link" target="_blank">Liability Notice</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üí¨ Community</h4>
                <div class="footer-links">
                    <a href="#" onclick="showComingSoon('Contact Form')" class="footer-link">Contact Us</a>
                    <a href="#" onclick="showComingSoon('Community Forum')" class="footer-link">Community Forum</a>
                    <a href="#" onclick="showComingSoon('Newsletter')" class="footer-link">Newsletter</a>
                    <a href="#" onclick="showComingSoon('Social Media')" class="footer-link">Follow Us</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p class="footer-copyright">
                    ¬© 2025 Coeliacs Like Beer Too. All rights reserved. 
                    <span class="footer-disclaimer">This site is for informational purposes only. Always verify with venues directly.</span>
                </p>
                <div class="footer-version">
                    <span class="footer-cache-info">v{{ cache_buster }}</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Enhanced Report GF Beer Modal - UPDATED -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üì∏ Report GF Beer Find</h2>
                <button class="modal-close" onclick="closeModal('reportModal')" aria-label="Close report modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="reportForm" class="modal-form">
                    <div class="form-group">
                        <label class="form-label">Find Your Pub *</label>
                        <input type="text" id="reportPubSearch" class="form-input" required placeholder="Start typing pub name..." autocomplete="off">
                        <div id="pubSuggestions" class="suggestions"></div>
                        <small>Search for an existing pub first - we'll check our database!</small>
                    </div>
                    
                    <div id="selectedPubInfo" class="selected-pub-info" style="display: none;">
                        <div class="selected-pub-card">
                            <strong id="selectedPubName"></strong>
                            <div id="selectedPubAddress"></div>
                            <button type="button" onclick="clearSelectedPub()" class="btn btn-secondary btn-sm">Choose Different Pub</button>
                        </div>
                    </div>
                    
                    <div id="newPubFields" class="new-pub-fields" style="display: none;">
                        <h4>üìç Add New Pub</h4>
                        <div class="form-group">
                            <label class="form-label">Pub Name *</label>
                            <input type="text" id="reportPubName" class="form-input" placeholder="The Red Lion">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address *</label>
                            <input type="text" id="reportAddress" class="form-input" placeholder="123 High Street">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode *</label>
                            <input type="text" id="reportPostcode" class="form-input" placeholder="SW1A 1AA">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Beer Format *</label>
                        <select id="reportFormat" class="form-select" required>
                            <option value="">Select format...</option>
                            <option value="bottle">üç∫ Bottle</option>
                            <option value="tap">üö∞ Tap</option>
                            <option value="cask">üõ¢Ô∏è Cask</option>
                            <option value="can">ü•´ Can</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Brewery</label>
                        <input type="text" id="reportBrewery" class="form-input" placeholder="Brewdog">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Beer Name</label>
                        <input type="text" id="reportBeerName" class="form-input" placeholder="Punk AF">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Beer Style</label>
                        <input type="text" id="reportBeerStyle" class="form-input" placeholder="IPA">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Photo (Optional)</label>
                        <input type="file" id="reportPhoto" class="form-input" accept="image/*">
                        <small>Share a photo of the beer or menu</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" onclick="closeModal('reportModal')" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-success">Submit Report</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- About Us Modal - UPDATED -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ÑπÔ∏è About Coeliacs Like Beer Too</h2>
                <button class="modal-close" onclick="closeModal('aboutModal')" aria-label="Close about modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="about-content">
                    <div class="about-section">
                        <h3>üç∫ Our Mission</h3>
                        <p>We believe that being coeliac shouldn't mean missing out on great beer experiences. Our mission is to create the UK's most comprehensive, community-driven guide to gluten free beer options across the country.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>üë• Our Story</h3>
                        <p>Started by coeliacs, for coeliacs. We understand the frustration of walking into a pub and not knowing if they have any safe options. That's why we built this platform - to help our community find amazing gluten free beer wherever they are in the UK.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>ü§ù Community Driven</h3>
                        <p>Every beer report, every pub update, every photo comes from real people in the coeliac community. Together, we're building something that helps everyone discover new places and feel confident about their choices.</p>
                    </div>
                    
                    <div class="about-section">
                        <h3>üìà Growing Together</h3>
                        <p>With thousands of pubs in our database and growing reports every day, we're becoming the go-to resource for gluten free beer discovery. Join us in making the UK more accessible for coeliacs!</p>
                    </div>
                    
                    <div class="contact-info">
                        <h3>üí¨ Get in Touch</h3>
                        <p>Questions, suggestions, or partnership opportunities? We'd love to hear from you!</p>
                        <button onclick="showComingSoon('Contact Form')" class="btn btn-primary">Contact Us</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- GF Info Modal - UPDATED -->
    <div id="gfInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üî¨ What is Gluten Free Beer?</h2>
                <button class="modal-close" onclick="closeModal('gfInfoModal')" aria-label="Close GF info modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="gf-content">
                    <div class="gf-section">
                        <h3>üß™ Official Standards</h3>
                        <div class="standards-grid">
                            <div class="standard-item">
                                <strong>üá¨üáß UK & EU</strong>
                                <p>Less than 20ppm gluten</p>
                            </div>
                            <div class="standard-item">
                                <strong>üá∫üá∏ USA</strong>
                                <p>Less than 20ppm gluten</p>
                            </div>
                            <div class="standard-item">
                                <strong>üá¶üá∫ Australia</strong>
                                <p>Less than 5ppm gluten (stricter!)</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gf-section">
                        <h3>üè∑Ô∏è Types of GF Beer</h3>
                        <div class="beer-types">
                            <div class="beer-type-item">
                                <strong>‚úÖ Certified Gluten Free</strong>
                                <p>Made from naturally gluten free grains (rice, sorghum, millet). Safest option.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>‚öóÔ∏è Gluten Removed/Reduced</strong>
                                <p>Made from barley/wheat but treated with enzymes to break down gluten. Some coeliacs react.</p>
                            </div>
                            <div class="beer-type-item">
                                <strong>üåæ "Made Without Gluten"</strong>
                                <p>No gluten ingredients added, but may have cross-contamination. Check carefully!</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="gf-section">
                        <h3>‚ö†Ô∏è Important Notes</h3>
                        <ul class="safety-notes">
                            <li><strong>Cross-contamination</strong> can happen in breweries that also make regular beer</li>
                            <li><strong>Always check labels</strong> and ask staff about preparation methods</li>
                            <li><strong>Coeliacs vs Gluten Intolerant</strong> - Coeliac disease is an autoimmune condition requiring strict gluten avoidance, while gluten intolerance is a separate digestive sensitivity</li>
                            <li><strong>When in doubt</strong>, choose certified gluten free options</li>
                        </ul>
                    </div>
                    
                    <div class="gf-section">
                        <h3>üç∫ Popular GF Beer Brands in UK</h3>
                        <div class="brand-grid">
                            <span class="brand-tag">Brewdog (GF Range)</span>
                            <span class="brand-tag">Glutenberg</span>
                            <span class="brand-tag">Omission</span>
                            <span class="brand-tag">Stella Artois (GF)</span>
                            <span class="brand-tag">Ghostfish</span>
                            <span class="brand-tag">Ground Breaker</span>
                        </div>
                    </div>
                    
                    <div class="disclaimer">
                        <p><strong>Disclaimer:</strong> This information is for guidance only. Always consult with healthcare professionals and verify product safety for your individual needs.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Smart Coordinate Modal - UPDATED -->
    <div id="coordinateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalPubName">Help us locate this pub!</h2>
                <button class="modal-close" onclick="closeModal('coordinateModal')" aria-label="Close coordinate modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <p>We'll search near the postcode and you can click to pinpoint the exact location.</p>
                
                <div class="modal-instructions">
                    <span id="modalInstructions">üó∫Ô∏è Searching for the pub area...</span>
                </div>
                
                <div id="coordinateMap" class="modal-map"></div>
                
                <div id="selectedLocationInfo" class="selected-location" style="display: none;">
                    <div>üìç Selected location:</div>
                    <div class="coordinates" id="selectedCoordinates"></div>
                </div>
                
                <div class="form-actions">
                    <button id="confirmLocation" class="btn btn-success">
                        ‚úÖ Confirm Location
                    </button>
                    <button id="cancelModal" class="btn btn-secondary" onclick="closeModal('coordinateModal')">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Toast - UPDATED -->
    <div id="loadingToast" class="toast toast-loading" style="display: none;">
        <div class="toast-content">
            <div class="spinner"></div>
            <span id="loadingMessage">Loading...</span>
        </div>
    </div>
    
    <!-- Success Toast - UPDATED -->
    <div id="successToast" class="toast toast-success" style="display: none;">
        <div class="toast-content">
            <span class="toast-icon">‚úÖ</span>
            <span id="successMessage">Success!</span>
        </div>
    </div>

    <!-- Add this cookie consent banner to your index.html, just before the closing </body> tag -->
    
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-consent" style="display: none;">
        <div class="cookie-content">
            <div class="cookie-text">
                <h4>üç™ We use cookies</h4>
                <p>We use essential cookies to make our site work. With your consent, we may also use analytics cookies to improve your experience.</p>
            </div>
            <div class="cookie-buttons">
                <button onclick="acceptAllCookies()" class="cookie-btn cookie-btn-accept">Accept All</button>
                <button onclick="acceptEssentialOnly()" class="cookie-btn cookie-btn-essential">Essential Only</button>
                <button onclick="showCookieSettings()" class="cookie-btn cookie-btn-settings">Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Cookie Settings Modal -->
    <div id="cookieSettings" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üç™ Cookie Settings</h2>
                <button class="modal-close" onclick="closeModal('cookieSettings')" aria-label="Close cookie settings">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="cookie-settings-content">
                    <div class="cookie-category">
                        <div class="cookie-category-header">
                            <h3>Essential Cookies</h3>
                            <label class="cookie-toggle">
                                <input type="checkbox" checked disabled>
                                <span class="toggle-slider essential"></span>
                            </label>
                        </div>
                        <p>These cookies are necessary for the website to function and cannot be switched off. They are usually only set in response to actions made by you which amount to a request for services.</p>
                        <div class="cookie-details">
                            <strong>Examples:</strong> Session management, search preferences, location consent
                        </div>
                    </div>
                    
                    <div class="cookie-category">
                        <div class="cookie-category-header">
                            <h3>Analytics Cookies</h3>
                            <label class="cookie-toggle">
                                <input type="checkbox" id="analyticsConsent">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        <p>These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our service.</p>
                        <div class="cookie-details">
                            <strong>Provider:</strong> Google Analytics<br>
                            <strong>Purpose:</strong> Usage statistics, popular features, performance monitoring
                        </div>
                    </div>
                    
                    <div class="cookie-info">
                        <h4>üìã Your Rights</h4>
                        <ul>
                            <li>You can change your preferences at any time</li>
                            <li>Withdrawing consent may limit website functionality</li>
                            <li>Essential cookies cannot be disabled</li>
                            <li>See our <a href="/cookies" target="_blank">Cookie Policy</a> for full details</li>
                        </ul>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button onclick="savesCookiePreferences()" class="btn btn-primary">Save Preferences</button>
                    <button onclick="acceptAllFromSettings()" class="btn btn-success">Accept All</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Cookie Settings Button (appears after consent given) -->
    <div id="cookieSettingsFloat" class="cookie-settings-float" style="display: none;">
        <button onclick="showCookieSettings()" class="cookie-float-btn" title="Cookie Settings">
            üç™
        </button>
    </div>

    <script>
        // Cache-busting timestamp
        console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
        
        var map;
        var userLocation = null;
        var pubMarkers = [];
        var userMarker = null;

        // Smart coordinate modal variables
        var coordinateMap;
        var selectedMarker;
        var currentPub;
        var selectedCoordinates = null;

        // Global pagination variables
        let currentPage = 1;
        let currentQuery = '';
        let currentSearchType = 'all';
        let currentGfOnly = false;

        // ================================
        // TOAST NOTIFICATION SYSTEM
        // ================================
        
        function showLoadingToast(message = 'Loading...') {
            const toast = document.getElementById('loadingToast');
            document.getElementById('loadingMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
        }

        function hideLoadingToast() {
            const toast = document.getElementById('loadingToast');
            toast.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }

        function showSuccessToast(message = 'Success!') {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-in';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // ================================
        // GOOGLE ANALYTICS TRACKING
        // ================================
        
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }

        function trackSearch(query, searchType, results) {
            trackEvent('search', 'Search', `${searchType}: ${query} (${results} results)`);
        }

        function trackPubView(pubName) {
            trackEvent('pub_view', 'Pub Interaction', pubName);
        }

        // ================================
        // ENHANCED UI FUNCTIONS
        // ================================
        
        let selectedPubData = null;
        let pubSearchTimeout = null;
        let mapVisible = false;
        
        function scrollToSearch() {
            document.getElementById('search').scrollIntoView({ behavior: 'smooth' });
        }

        // ADD: New function for home navigation
        function goHome() {
            window.location.href = '/';
            trackEvent('go_home', 'Navigation', 'home_button');
        }

        // SMART MAP TOGGLE - Auto-show when needed
        function toggleMap() {
            mapVisible = !mapVisible;
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');
            const featuresSection = document.getElementById('featuresSection');
            const searchSection = document.getElementById('search');
            
            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                
                if (featuresSection) {
                    featuresSection.classList.remove('map-hidden');
                }
                
                // Fix overlap: Add space below map for search
                searchSection.style.marginTop = '40px';
                
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
                
                setTimeout(() => {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                
                if (featuresSection) {
                    featuresSection.classList.add('map-hidden');
                }
                
                // Reset margin
                searchSection.style.marginTop = '-20px';
            }
            
            AppState.save();
        }

        // SMART MAP SHOWING - Auto show map when needed
        function smartShowMap() {
            if (!mapVisible) {
                toggleMap();
            }
        }

        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            trackEvent('open_report_modal', 'Modal');
            
            // Initialize brewery dropdown when modal opens
            setTimeout(() => {
                initializeReportModalDropdowns();
                document.getElementById('reportPubSearch').focus();
            }, 100);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'reportModal') {
                document.getElementById('reportForm').reset();
                selectedPubData = null;
                document.getElementById('selectedPubInfo').style.display = 'none';
                document.getElementById('newPubFields').style.display = 'none';
                document.getElementById('pubSuggestions').style.display = 'none';
            }
        }

        function showAboutUs() {
            document.getElementById('aboutModal').style.display = 'block';
            trackEvent('open_about_modal', 'Modal');
        }

        function showGFInfo() {
            document.getElementById('gfInfoModal').style.display = 'block';
            trackEvent('open_gf_info_modal', 'Modal');
        }

        function showComingSoon(feature) {
            trackEvent('coming_soon_click', 'Feature Interest', feature);
            showSuccessToast(`${feature} is coming soon! üöÄ We're working hard to bring you this feature.`);
        }

        function showAllActivity() {
            trackEvent('view_all_activity', 'Navigation');
            showSuccessToast('Full activity feed coming soon! üìä This will show all recent GF beer finds.');
        }

        // SMART RESULTS SECTION - Pushes content down
        function showResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'block';
            
            // Add margin to push content down
            featuresSection.style.marginTop = '40px';
            activitySection.style.marginTop = '40px';
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'none';
            
            // Remove margin
            featuresSection.style.marginTop = '0';
            activitySection.style.marginTop = '0';
        }

        // ================================
        // CORE FUNCTIONALITY
        // ================================

        // State management for refresh persistence
        const AppState = {
            save: function(pubId = null) {
                const state = {
                    query: currentQuery,
                    searchType: currentSearchType,
                    // gfOnly: currentGfOnly,
                    page: currentPage,
                    mapVisible: mapVisible,
                    specificPubId: pubId || null,
                    timestamp: Date.now()
                };
                window.location.hash = btoa(JSON.stringify(state));
            },
            
            load: function() {
                try {
                    if (window.location.hash) {
                        const state = JSON.parse(atob(window.location.hash.substring(1)));
                        if (Date.now() - state.timestamp < 3600000) {
                            return state;
                        }
                    }
                } catch (e) {
                    console.log('No valid state to restore');
                }
                return null;
            },
            
            restore: async function() {
                const state = this.load();
                if (state) {
                    console.log('Restoring state:', state);
                    
                    document.getElementById('searchInput').value = state.query || '';
                    document.getElementById('searchType').value = state.searchType || 'all';
                    // document.getElementById('gfOnly').checked = state.gfOnly || false;
                    
                    currentQuery = state.query || '';
                    currentSearchType = state.searchType || 'all';
                    // currentGfOnly = state.gfOnly || false;
                    currentPage = state.page || 1;
                    mapVisible = state.mapVisible || false;
                    
                    const mapContainer = document.getElementById('mapContainer');
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    if (mapVisible) {
                        mapContainer.style.display = 'block';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                    } else {
                        mapContainer.style.display = 'none';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                    }
                    
                    if (state.specificPubId) {
                        console.log('Restoring specific pub:', state.specificPubId);
                        await searchSpecificPub(state.specificPubId);
                    } else if (state.query) {
                        console.log('Restoring search query:', state.query);
                        await loadPage(state.page);
                    }
                }
            }
        };

        // Debounce function to limit rapid requests
        let debounceTimeout;
        function debounce(func, wait) {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get user's location
        function getUserLocation() {
            const statusEl = document.getElementById('locationStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'location-status location-loading';
            statusEl.textContent = 'Getting your location...';

            if (!navigator.geolocation) {
                statusEl.className = 'location-status location-error';
                statusEl.textContent = 'Geolocation not supported by this browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    statusEl.className = 'location-status location-success';
                    statusEl.textContent = 'Location found! Click "Pubs Near Me" to see what\'s around you.';
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('You are here!')
                        .openPopup();
                    
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                },
                (error) => {
                    let errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    statusEl.className = 'location-status location-error';
                    statusEl.textContent = errorMessage;
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            );
        }

        async function findNearbyPubs() {
            if (!userLocation) {
                showSuccessToast('Getting your location first...');
                getUserLocation();
                return;
            }
        
            trackEvent('find_nearby_pubs', 'Location Search');
            smartShowMap(); // Auto-show map
            
            // const gfOnly = document.getElementById('gfOnly')?.checked ?? true;
            const radius = 5;
            
            showResultsSection();
            showLoadingToast('Finding nearby GF beer...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Finding nearby pubs...</li>';
            
            // Center map on user location
            if (map) {
                map.setView([userLocation.lat, userLocation.lng], 15);
            }
            
            try {
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&gf_only=${gfOnly}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const nearbyPubs = data.pubs || data;
                
                hideLoadingToast();
                
                displaySearchResults(nearbyPubs);
                addPubMarkersToMap(nearbyPubs);
                
                const resultCount = nearbyPubs.length;
                const message = `Found ${resultCount} pubs near you!`;
                showSuccessToast(message);
                
                trackSearch('nearby', 'location', resultCount);
                
                // Save state
                currentQuery = '';
                currentSearchType = 'nearby';
                // currentGfOnly = gfOnly;
                currentPage = 1;
                AppState.save();
                
            } catch (error) {
                console.error('Error finding nearby pubs:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error finding nearby pubs. Please try again.</li>';
                showSuccessToast('Error finding nearby pubs. Please try again.');
            }
        }

        // ENHANCED centerOnLocation with smart map showing
        function centerOnLocation() {
            trackEvent('center_on_location', 'Map Interaction');
            smartShowMap(); // Auto-show map
            
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 14);
                showSuccessToast('Centered on your location!');
            } else {
                getUserLocation();
            }
        }

        // Add pub markers to map
        function addPubMarkersToMap(pubs) {
            // Clear existing markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
        
            pubs.forEach(pub => {
                if (pub.latitude && pub.longitude) {
                    const hasGF = pub.bottle || pub.tap || pub.cask || pub.can;
                    const markerColor = hasGF ? '#4CAF50' : '#757575';
                    
                    const marker = L.circleMarker([pub.latitude, pub.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
        
                    let popupContent = `<strong>${pub.name}</strong><br>`;
                    popupContent += `${pub.address}<br>`;
                    if (pub.distance !== undefined) {
                        popupContent += `<em>${pub.distance.toFixed(2)} km away</em><br>`;
                    }
                    
                    if (hasGF) {
                        let gfOptions = [];
                        if (pub.bottle) gfOptions.push('Bottle');
                        if (pub.tap) gfOptions.push('Tap');
                        if (pub.cask) gfOptions.push('Cask');
                        if (pub.can) gfOptions.push('Can');
                        popupContent += `<br><strong>GF Options:</strong> ${gfOptions.join(', ')}<br>`;
                        popupContent += `<button onclick="showPubDetailsFromMap(${pub.pub_id})" style="margin-top: 8px; padding: 6px 12px; background: var(--primary-gradient); color: white; border: none; border-radius: 15px; cursor: pointer; font-size: 12px;">View Details</button>`;
                    } else {
                        popupContent += '<br><em>No GF options recorded</em>';
                    }
        
                    marker.bindPopup(popupContent);
                    pubMarkers.push(marker);
                }
            });
        }
        
        // NEW: Function to show pub details from map popup
        function showPubDetailsFromMap(pubId) {
            // First, we need to get the pub data
            searchSpecificPub(pubId);
            trackEvent('view_pub_from_map', 'Map Interaction', `pub_${pubId}`);
        }

        // Display search results with pagination
        function displaySearchResults(data, append = false) {
            console.log('displaySearchResults called with pagination support!');
            const results = document.getElementById('results');
            
            const pubs = Array.isArray(data) ? data : data.pubs;
            const pagination = data.pagination || null;
            
            if (!append) {
                results.innerHTML = '';
                
                // Add GF filter suggestion if there are mixed results
                if (pubs.length > 0) {
                    const gfCount = pubs.filter(pub => pub.bottle || pub.tap || pub.cask || pub.can).length;
                    const totalCount = pubs.length;
                    
                    // Only show filter if there are both GF and non-GF pubs
                    if (gfCount > 0 && gfCount < totalCount) {
                        const filterDiv = document.createElement('div');
                        filterDiv.className = 'filter-suggestion';
                        filterDiv.innerHTML = `
                            <button class="btn btn-secondary" onclick="showOnlyGF()">
                                üç∫ Show only pubs with GF beer (${gfCount} of ${totalCount} pubs)
                            </button>
                        `;
                        results.appendChild(filterDiv);
                    }
                }
            }
            
            if (pubs.length === 0 && !append) {
                results.innerHTML = '<li class="no-results">No pubs found.</li>';
                return;
            }
            
            pubs.forEach(pub => {
                console.log('Processing pub:', pub);
                const li = document.createElement('li');
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('Bottle');
                if (pub.tap) gfOptions.push('Tap');
                if (pub.cask) gfOptions.push('Cask');
                if (pub.can) gfOptions.push('Can');
                
                const gfText = gfOptions.length > 0 ? gfOptions.join(', ') : 'None';
                const beerDetails = pub.beer_details || 'None';
                
                let detailsDistanceText = '';
                const lat = parseFloat(pub.latitude);
                const lng = parseFloat(pub.longitude);
                
                if (userLocation && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        lat, lng
                    );
                    detailsDistanceText = `<div style="color: #667eea; font-size: 14px; font-weight: 600; margin: 8px 0;">${distance.toFixed(2)} km from your location</div>`;
                }
        
                li.className = 'result-item';
                li.innerHTML = `
                    <div class="result-details">
                        <strong>${pub.name}</strong>
                        <div class="address">${pub.address}, ${pub.postcode}</div>
                        <div class="local-authority">${pub.local_authority}</div>
                        ${detailsDistanceText}
                        <div style="margin-top: 10px;">
                            <button onclick="searchForPub('${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}')" 
                                    style="margin-right: 8px; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                                Find Online
                            </button>
                            <button onclick="findOnMap(${pub.latitude || 'null'}, ${pub.longitude || 'null'}, '${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}', ${pub.pub_id})" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                Find on Map
                            </button>
                            <button onclick="openInGoogleMaps(${pub.latitude}, ${pub.longitude}, '${pub.name.replace(/'/g, "\\'")}', '${pub.address}')" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                üß≠ Directions
                            </button>
                        </div>
                    </div>
                    <div class="beer-column">
                        <h4>Available Beers</h4>
                        <div class="beer-details">
                            ${formatBeerDetails(beerDetails, pub)}
                        </div>
                    </div>
                    <div class="button-column">
                        <button class="update-button" onclick="toggleUpdateForm(${pub.pub_id})">Update</button>
                    </div>
                `;
                results.appendChild(li);
            });
            
            if (pagination && !append) {
                addPaginationControls(pagination);
            }
        }
        
        // Add this new function too
        function showOnlyGF() {
            // For now, just show a coming soon message
            showSuccessToast('üç∫ GF-only filter coming soon!');
            trackEvent('gf_filter_clicked', 'User Interest', 'filter_suggestion');
        }

        function formatBeerDetails(beerDetails, pub) {
            // Check if we have specific beer data
            if (!beerDetails || beerDetails === 'None' || beerDetails.trim() === '') {
                // Show generic GF availability instead
                return formatGenericGFAvailability(pub);
            }
            
            // Show specific beers if we have them
            return beerDetails.split(', ').map(beer => {
                const parts = beer.split(' - ');
                if (parts.length >= 2) {
                    const format = parts[0];
                    const details = parts.slice(1).join(' - ');
                    return `<div class="beer-item"><span class="beer-type">${format.charAt(0).toUpperCase() + format.slice(1)}:</span> ${details}</div>`;
                }
                return `<div class="beer-item">${beer}</div>`;
            }).join('');
        }

        // ADD: New function for showing generic GF availability
        function formatGenericGFAvailability(pub) {
            let gfOptions = [];
            let rotatingTap = false;
            
            // Check what formats are available
            if (pub.bottle) gfOptions.push('bottle');
            if (pub.tap) {
                gfOptions.push('tap');
                rotatingTap = true; // Assume tap might rotate
            }
            if (pub.cask) gfOptions.push('cask');
            if (pub.can) gfOptions.push('can');
            
            if (gfOptions.length === 0) {
                return '<div style="color: #9ca3af; font-style: italic;">‚ùì GF availability needs verification</div>';
            }
            
            let display = '<div class="gf-availability">';
            
            // Show confirmed formats
            display += '<div class="confirmed-formats">';
            display += '<strong style="color: #10b981;">‚úÖ Confirmed GF Options:</strong><br>';
            
            gfOptions.forEach(format => {
                const icons = {
                    bottle: 'üç∫',
                    tap: 'üö∞',
                    cask: 'üõ¢Ô∏è',
                    can: 'ü•´'
                };
                
                if (format === 'tap') {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)} <span class="rotating-note">(selection may vary)</span></div>`;
                } else {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)}</div>`;
                }
            });
            display += '</div>';
            
            // Add helpful note
            display += '<div class="gf-note">üí° <em>Call ahead to confirm current selection</em></div>';
            display += '</div>';
            
            return display;
        }

        function addPaginationControls(pagination) {
            const results = document.getElementById('results');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';
            paginationDiv.innerHTML = `
                <div class="pagination-info">
                    Showing page ${pagination.page} of ${pagination.pages} (${pagination.total} total results)
                </div>
                <div class="pagination-buttons">
                    ${pagination.has_prev ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">‚Üê Previous</button>` : ''}
                    ${pagination.page > 2 ? `<button onclick="loadPage(1)" class="pagination-btn">1</button>` : ''}
                    ${pagination.page > 3 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page > 1 ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">${pagination.page - 1}</button>` : ''}
                    <button class="pagination-btn active">${pagination.page}</button>
                    ${pagination.page < pagination.pages ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">${pagination.page + 1}</button>` : ''}
                    ${pagination.page < pagination.pages - 2 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page < pagination.pages - 1 ? `<button onclick="loadPage(${pagination.pages})" class="pagination-btn">${pagination.pages}</button>` : ''}
                    ${pagination.has_next ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">Next ‚Üí</button>` : ''}
                </div>
            `;
            results.appendChild(paginationDiv);
        }

        async function loadPage(page) {
            currentPage = page;
            const url = `/search?query=${encodeURIComponent(currentQuery)}&search_type=${currentSearchType}&page=${page}`;
            
            showLoadingToast('Loading page...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading...</li>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                hideLoadingToast();
                displaySearchResults(data);
                addPubMarkersToMap(data.pubs || data);
                
                AppState.save();
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading page:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading results. Please try again.</li>';
            }
        }

        // ==========================================
        // AFTER: New searchSpecificPub Function
        // ==========================================
        async function searchSpecificPub(pubId) {
            console.log('searchSpecificPub called with ID:', pubId);
            showLoadingToast('Loading pub details...');
            
            try {
                const url = `/search?pub_id=${pubId}`;
                const response = await fetch(url);
                const pubs = await response.json();
                
                hideLoadingToast();
                
                if (pubs.length > 0) {
                    const pub = pubs[0];
                    
                    // NEW WAY: Shows full-screen pub details page
                    showPubDetails(pub);
                    
                    currentQuery = '';
                    currentSearchType = 'all';
                    currentPage = 1;
                    AppState.save(pubId);
                } else {
                    showSuccessToast('Pub not found.');
                }
            } catch (error) {
                console.error('Error searching for specific pub:', error);
                hideLoadingToast();
                showSuccessToast('Error loading pub details.');
            }
        }

        async function searchPubs() {
            const query = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            // const gfOnly = document.getElementById('gfOnly')?.checked ?? false;
            const results = document.getElementById('results');
            
            if (!query) {
                results.innerHTML = '<li class="no-results">Please enter a search term.</li>';
                return;
            }
            
            currentQuery = query;
            currentSearchType = searchType;
            // currentGfOnly = gfOnly;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            // Check if query looks like a postcode
            const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
            
            try {
                let url;
                let searchResults;
                
                if (isPostcode && (searchType === 'postcode' || searchType === 'all')) {
                    // Handle postcode search - geocode then find nearby
                    console.log('Detected postcode search:', query);
                    showLoadingToast('Finding location...');
                    
                    // First geocode the postcode
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData && geocodeData.length > 0) {
                        const lat = parseFloat(geocodeData[0].lat);
                        const lng = parseFloat(geocodeData[0].lon);
                        
                        showLoadingToast('Finding nearby pubs...');
                        
                        url = `/nearby?lat=${lat}&lng=${lng}&radius=5`;
                        
                        // Auto-show map and update to show the postcode area
                        smartShowMap();
                        if (map) {
                            map.setView([lat, lng], 14);
                            
                            // Add postcode marker
                            if (window.postcodeMarker) {
                                map.removeLayer(window.postcodeMarker);
                            }
                            window.postcodeMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: `<div style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">üìç</div>`,
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            }).addTo(map);
                            
                            window.postcodeMarker.bindPopup(`<strong>${query}</strong><br>Searching nearby pubs...`).openPopup();
                        }
                    } else {
                        throw new Error('Postcode not found');
                    }
                } else {
                    // Regular text search
                    url = `/search?query=${encodeURIComponent(query)}&search_type=${searchType}&page=1`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    if (isPostcode) {
                        results.innerHTML = `<li class="no-results">No pubs found within 5km of ${query}. Try expanding your search area.</li>`;
                        showSuccessToast(`No pubs found near ${query}`);
                    } else {
                        results.innerHTML = '<li class="no-results">No pubs found.</li>';
                        showSuccessToast('No pubs found for your search');
                    }
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message
                const message = isPostcode && pubs.length > 0 ? 
                    `‚úÖ Found ${pubs.length} pubs within 5km of ${query}` :
                    `Found ${pubs.length} pubs matching "${query}"`;
                showSuccessToast(message);
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                if (isPostcode) {
                    results.innerHTML = `<li class="no-results">Could not find location for "${query}". Please check the postcode and try again.</li>`;
                    showSuccessToast(`Could not find location for "${query}"`);
                } else {
                    results.innerHTML = '<li class="no-results">Error searching pubs. Please try again.</li>';
                    showSuccessToast('Error searching pubs. Please try again.');
                }
            }
        }

        function toggleUpdateForm(pubId) {
            showComingSoon('Update Form');
        }

        function openInGoogleMaps(lat, lng, pubName, address) {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            }
            
            trackEvent('open_navigation', 'External Navigation', pubName);
            showSuccessToast('üß≠ Opening directions...');
        }

        function findOnMap(lat, lng, pubName, postcode, pubId) {
            trackPubView(pubName);
            
            // Always show the map when someone clicks "Find on Map"
            if (!mapVisible) {
                toggleMap();
            }
            
            if (lat && lng && lat !== 'null' && lng !== 'null' && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                setTimeout(() => {
                    // Zoom to the location
                    map.setView([parseFloat(lat), parseFloat(lng)], 17);
                    
                    // Remove any existing highlight markers
                    if (window.currentHighlightMarker) {
                        map.removeLayer(window.currentHighlightMarker);
                    }
                    
                    // Create a special highlight marker
                    window.currentHighlightMarker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                        radius: 15,
                        fillColor: '#ff6b6b',
                        color: '#fff',
                        weight: 4,
                        opacity: 1,
                        fillOpacity: 0.9,
                        className: 'pulsing-marker'
                    }).addTo(map);
                    
                    const markerElement = window.currentHighlightMarker.getElement();
                    if (markerElement) {
                        markerElement.style.animation = 'pulse 2s infinite';
                    }
                    
                    window.currentHighlightMarker.bindPopup(`
                        <div style="text-align: center; padding: 8px;">
                            <strong style="color: #2d3748; font-size: 16px;">${pubName}</strong>
                            <br><em style="color: #667eea;">üìç Found on map!</em>
                            <br><small style="color: #718096;">Click for details</small>
                        </div>
                    `).openPopup();
                    
                    showSuccessToast(`üìç Found ${pubName} on map!`);
                    
                    setTimeout(() => {
                        if (window.currentHighlightMarker) {
                            map.removeLayer(window.currentHighlightMarker);
                            window.currentHighlightMarker = null;
                        }
                    }, 8000);
                    
                }, mapVisible ? 50 : 300);
            } else {
                showComingSoon('Coordinate Modal for pub location');
            }
        }

        function searchForPub(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            trackEvent('search_online', 'External Search', pubName);
            window.open(googleUrl, '_blank');
        }

        function toggleAdvancedFilters() {
            const filters = document.getElementById('advancedFilters');
            const isVisible = filters.style.display !== 'none';
            filters.style.display = isVisible ? 'none' : 'block';
            
            // Update button text
            const btn = document.querySelector('.btn-advanced-filters');
            if (btn) {
                btn.textContent = isVisible ? 'üîß Advanced Filters' : 'üîß Hide Filters';
            }
        }
        
        function clearAllFilters() {
            document.getElementById('beerFormat').value = 'all';
            document.getElementById('beerStyle').value = 'all';
            document.getElementById('breweryFilter').value = 'all';
            document.getElementById('maxDistance').value = '10';
            
            // Re-run search with cleared filters
            searchPubs();
        }

        function clearSelectedPub() {
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('reportPubSearch').value = '';
            document.getElementById('reportPubSearch').focus();
        }

        // REPLACE: Fixed loadDashboardStats function
        async function loadDashboardStats() {
            try {
                console.log('üîÑ Loading dashboard stats from database...');
                const response = await fetch('/api/stats');
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('‚úÖ Stats loaded:', stats);
                    
                    // Animate the numbers counting up
                    animateNumber('totalPubs', stats.total_pubs);
                    animateNumber('gfPubs', stats.gf_pubs);
                    
                    // Update footer stats too
                    document.getElementById('footerPubCount').textContent = stats.total_pubs.toLocaleString();
                    document.getElementById('footerGFCount').textContent = stats.gf_pubs.toLocaleString();
                    
                    console.log(`üìä Dashboard updated: ${stats.total_pubs} pubs, ${stats.gf_pubs} GF pubs`);
                    
                } else {
                    console.warn('‚ö†Ô∏è Stats API returned error, using fallback data');
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load live stats, using fallback data:', error);
                
                // Sensible fallback numbers
                animateNumber('totalPubs', 49841);
                animateNumber('gfPubs', 1249);
                
                // Update footer with fallback data
                document.getElementById('footerPubCount').textContent = '49,841';
                document.getElementById('footerGFCount').textContent = '1,249';
            }
        }
        
        // Enhanced number animation with better formatting
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Element ${elementId} not found`);
                return;
            }
            
            const startNumber = 0;
            const duration = 2000; // 2 seconds
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease out animation
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOut);
                
                // Format the number with commas
                element.textContent = currentNumber.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                } else {
                    // Ensure final number is exactly correct
                    element.textContent = targetNumber.toLocaleString();
                }
            }
            
            requestAnimationFrame(updateNumber);
        }

        // Cookie functions
        function acceptAllCookies() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'true');
            hideCookieBanner();
            initializeAnalytics();
            showSuccessToast('‚úÖ Cookie preferences saved. Thanks!');
            trackEvent('cookie_consent', 'Privacy', 'accept_all');
        }
        
        function acceptEssentialOnly() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'false');
            hideCookieBanner();
            showSuccessToast('‚úÖ Essential cookies only. You can change this anytime.');
        }

        function showCookieSettings() {
            document.getElementById('cookieSettings').style.display = 'block';
            const analyticsConsent = localStorage.getItem('analyticsConsent');
            document.getElementById('analyticsConsent').checked = analyticsConsent === 'true';
        }

        function savesCookiePreferences() {
            const analyticsConsent = document.getElementById('analyticsConsent').checked;
            
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', analyticsConsent.toString());
            
            closeModal('cookieSettings');
            hideCookieBanner();
            
            if (analyticsConsent) {
                initializeAnalytics();
                showSuccessToast('‚úÖ Preferences saved. Analytics enabled.');
                trackEvent('cookie_consent', 'Privacy', 'analytics_enabled');
            } else {
                showSuccessToast('‚úÖ Preferences saved. Analytics disabled.');
            }
        }

        function acceptAllFromSettings() {
            document.getElementById('analyticsConsent').checked = true;
            savesCookiePreferences();
        }

        function hideCookieBanner() {
            const banner = document.getElementById('cookieConsent');
            banner.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                banner.style.display = 'none';
                document.getElementById('cookieSettingsFloat').style.display = 'block';
            }, 300);
        }

        function initializeAnalytics() {
            if (typeof gtag !== 'undefined' && localStorage.getItem('analyticsConsent') === 'true') {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted'
                });
                console.log('‚úÖ Google Analytics initialized with user consent');
            }
        }

        // Full-screen pub details functionality
        let pubMapVisible = false;
        let currentPubData = null;
        
        function showPubDetails(pub) {
            currentPubData = pub;
            
            // Update the pub details content
            document.getElementById('pubDetailsTitle').textContent = pub.name;
            document.getElementById('pubDetailsAddress').textContent = `${pub.address}, ${pub.postcode}`;
            document.getElementById('pubDetailsLocation').textContent = pub.local_authority;
            
            // Update beer information
            const beerElement = document.getElementById('pubDetailsBeer');
            if (pub.bottle || pub.tap || pub.cask || pub.can) {
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('üç∫ Bottle');
                if (pub.tap) gfOptions.push('üö∞ Tap');
                if (pub.cask) gfOptions.push('üõ¢Ô∏è Cask');
                if (pub.can) gfOptions.push('ü•´ Can');
                beerElement.innerHTML = `<strong>‚úÖ Confirmed GF Options:</strong><br>${gfOptions.join(', ')}<br><em>üí° Call ahead to confirm current selection</em>`;
            } else {
                beerElement.innerHTML = '‚ùì GF availability needs verification<br><em>Help the community by reporting what you find!</em>';
            }
            
            // Set up action buttons
            document.getElementById('pubFindOnline').onclick = () => {
                const searchQuery = `${pub.name} ${pub.postcode} pub`;
                const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
                window.open(googleUrl, '_blank');
                trackEvent('search_online', 'External Search', pub.name);
            };
            
            document.getElementById('pubGetDirections').onclick = () => {
                if (pub.latitude && pub.longitude) {
                    openInGoogleMaps(pub.latitude, pub.longitude, pub.name, pub.address);
                } else {
                    showSuccessToast('üìç Location coordinates not available for directions');
                }
            };
            
            // Show the overlay
            document.getElementById('pubDetailsOverlay').classList.add('active');
            
            // Track the view
            trackPubView(pub.name);
            trackEvent('pub_details_view', 'Navigation', pub.name);
        }
        
        function closePubDetails() {
            document.getElementById('pubDetailsOverlay').classList.remove('active');
            pubMapVisible = false;
            document.getElementById('pubContainer').classList.remove('split-view');
            document.getElementById('pubMapBtnText').textContent = 'Show on Map';
            
            trackEvent('pub_details_close', 'Navigation');
        }
        
        function togglePubMap() {
            const container = document.getElementById('pubContainer');
            const mapBtnText = document.getElementById('pubMapBtnText');
            
            pubMapVisible = !pubMapVisible;
            
            if (pubMapVisible) {
                container.classList.add('split-view');
                mapBtnText.textContent = 'Hide Map';
                
                // Initialize map if we have coordinates
                if (currentPubData && currentPubData.latitude && currentPubData.longitude) {
                    setTimeout(() => {
                        initializePubMap(currentPubData);
                    }, 300);
                } else {
                    setTimeout(() => {
                        const placeholder = document.querySelector('.pub-map-placeholder');
                        placeholder.innerHTML = 'üìç Location coordinates not available<br><small style="opacity: 0.7;">Help us by reporting the exact location!</small>';
                    }, 300);
                }
                
                trackEvent('pub_map_toggle', 'Map Interaction', 'show');
            } else {
                container.classList.remove('split-view');
                mapBtnText.textContent = 'Show on Map';
                trackEvent('pub_map_toggle', 'Map Interaction', 'hide');
            }
        }
        
        function initializePubMap(pub) {
            // This would integrate with your existing Leaflet map
            const placeholder = document.querySelector('.pub-map-placeholder');
            placeholder.innerHTML = `üó∫Ô∏è ${pub.name}<br><small style="opacity: 0.7;">Lat: ${pub.latitude}, Lng: ${pub.longitude}</small>`;
            
            // TODO: Integrate with actual Leaflet map
            console.log('Would initialize map for:', pub);

        function checkCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            const analyticsConsent = localStorage.getItem('analyticsConsent');
            
            if (!consent) {
                setTimeout(() => {
                    document.getElementById('cookieConsent').style.display = 'block';
                }, 1000);
            } else {
                document.getElementById('cookieSettingsFloat').style.display = 'block';
                
                if (analyticsConsent === 'true') {
                    initializeAnalytics();
                }
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            // document.getElementById('gfOnly').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            hideResultsSection();
            
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
            }
            
            currentQuery = '';
            currentSearchType = 'all';
            // currentGfOnly = false;
            currentPage = 1;
            AppState.save();
        }

        // Stub functions for features not fully implemented
        function initializeReportModalDropdowns() {
            showComingSoon('Report Modal Dropdowns');
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', async () => {
            const input = document.getElementById('searchInput');
            const suggestions = document.getElementById('suggestions');

            // Initialize Leaflet map
            map = L.map('map').setView([51.505, -0.09], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            loadDashboardStats();
            getUserLocation();
            await AppState.restore();
            checkCookieConsent();

            // ENHANCED AUTOCOMPLETE WITH POSTCODE DETECTION
            input.addEventListener('input', debounce(async () => {
                const query = input.value.trim();
                const searchType = document.getElementById('searchType').value;
                // const gfOnly = document.getElementById('gfOnly').checked;

                console.log('üîç Autocomplete triggered for:', query);
                console.log('üîç Search type:', searchType);
                
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                // Check if it looks like a postcode
                const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
                
                if (isPostcode) {
                    // Show postcode search option
                    suggestions.innerHTML = `
                        <div class="postcode-suggestion">
                            <strong>üìç Search for pubs near "${query}"</strong>
                            <div class="postcode-suggestion-subtitle">
                                Find pubs within 5km of this postcode
                            </div>
                        </div>
                    `;
                    suggestions.style.display = 'block';
                    
                    // Add click handler
                    suggestions.querySelector('.postcode-suggestion').addEventListener('click', () => {
                        searchPubs();
                        suggestions.style.display = 'none';
                    });
                    return;
                }

                // Regular autocomplete for non-postcodes
                try {
                    const url = `/autocomplete?q=${encodeURIComponent(query)}&search_type=${searchType}`;
                    console.log('üåê Autocomplete fetching:', url);
                    
                    const response = await fetch(url);
                    console.log('üì° Autocomplete response status:', response.status);
                    if (!response.ok) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const data = await response.json();
                    console.log('‚úÖ Autocomplete data received:', data);

                    suggestions.innerHTML = '';
                    if (data.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }

                    if (data.length >= 10) {
                        const showAllDiv = document.createElement('div');
                        showAllDiv.className = 'suggestion-item highlight'; 
                        showAllDiv.innerHTML = `<strong>üîç Show all ${data.length}+ results for "${query}"</strong>`;
                        showAllDiv.addEventListener('click', () => {
                            document.getElementById('searchInput').value = query;
                            searchPubs();
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(showAllDiv);
                    }

                    data.forEach(pub => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item'; // uses suggestion for drop down autocomplete
                        div.textContent = `${pub.name}, ${pub.address} (${pub.postcode})`;
                        div.addEventListener('click', () => {
                            clearSearch();
                            
                            // Show results section first
                            showResultsSection();
                            
                            searchSpecificPub(pub.pub_id);
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } catch (error) {
                    console.error('‚ùå Autocomplete error:', error);
                    suggestions.style.display = 'none';
                }
            }, 300));

            // Hide suggestions on outside click
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            // Save state on form changes
            document.getElementById('searchType').addEventListener('change', () => AppState.save());
        });

        // ADD: Homepage reset function
        function resetToHomepage() {
            // Clear search inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('searchType').value = 'all';
            
            // Hide results section
            hideResultsSection();
            
            // Hide map if visible
            if (mapVisible) {
                toggleMap();
            }
            
            // Clear any markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.currentHighlightMarker) {
                map.removeLayer(window.currentHighlightMarker);
                window.currentHighlightMarker = null;
            }
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
                window.postcodeMarker = null;
            }
            
            // Clear URL hash/state
            window.location.hash = '';
            
            // Reset global variables
            currentQuery = '';
            currentSearchType = 'all';
            currentPage = 1;
            mapVisible = false;
            
            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Show clean homepage sections
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            if (featuresSection) featuresSection.style.display = 'block';
            if (activitySection) activitySection.style.display = 'block';
            
            // Update button text
            const toggleBtn = document.getElementById('toggleMapBtn');
            if (toggleBtn) toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
            
            // Success feedback
            showSuccessToast('üè† Reset to homepage - ready for a fresh search!');
            trackEvent('reset_homepage', 'Navigation', 'homepage_reset');
        }

        console.log('üç∫ Coeliacs Like Beer Too - JavaScript loaded successfully!');
    </script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

</body>
</html>
