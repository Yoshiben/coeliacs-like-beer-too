<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coeliacs Like Beer Too! - Find GF-Friendly Pubs - {{ cache_buster }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v={{ cache_buster }}">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Google Analytics with GDPR compliance -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-WSHR39KSXS"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        
        // Set default consent to denied (GDPR compliant)
        gtag('consent', 'default', {
            'analytics_storage': 'denied'
        });
        
        gtag('js', new Date());
        gtag('config', 'G-WSHR39KSXS', {
            'anonymize_ip': true,
            'cookie_flags': 'SameSite=None;Secure'
        });
    </script>
</head>
<body>
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-content">
            <h1 class="hero-title">Coeliacs Like Beer Too!</h1>
            <p class="hero-subtitle">The UK's largest community-driven guide to gluten free beer</p>
            
            <div class="hero-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalPubs">Loading...</span>
                    <span class="stat-label">UK Pubs</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="gfPubs">Loading...</span>
                    <span class="stat-label">GF Pubs</span> <!-- Changed from "GF Options" -->
                </div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section" id="search">
        <h2 class="section-title">üîç Find Gluten Free Beer Near You</h2>
        <div class="search-grid">
            <div class="search-row">
                <select id="searchType" class="search-type-dropdown">
                    <option value="all">Search All</option>
                    <option value="name">Pub Name</option>
                    <option value="postcode">Postcode</option>
                    <option value="area">Local Authority</option>
                </select>
                <input type="text" id="searchInput" class="search-input" placeholder="Enter pub name, postcode, or local authority" onkeydown="if (event.key === 'Enter') searchPubs()">
                <label class="gf-checkbox"><input type="checkbox" id="gfOnly"> Gluten Free Only</label>
            </div>
            <div class="search-actions">
                <button onclick="searchPubs()" class="search-btn">Search Pubs</button>
                <button class="search-btn secondary" onclick="findNearbyPubs()">Pubs Near Me</button>
                <button class="map-control-btn" id="toggleMapBtn" onclick="toggleMap()">üó∫Ô∏è Show Map</button>
                <button class="map-control-btn" onclick="centerOnLocation()">üìç My Location</button>
                <button class="map-control-btn reset-btn" onclick="resetToHomepage()" title="Clear everything and start fresh">üè† Reset</button>
            </div>
        </div>
        <div id="suggestions"></div>
    </div>

    <!-- Dynamic Results Section - Pushed down when visible -->
    <div id="results-section" style="display: none;">
        <div class="results-header">
            <h2 class="section-title">üìç Search Results</h2>
        </div>
        <ul id="results"></ul>
    </div>

    <!-- Map Section (Hidden by Default, Smart Show) -->
    <div class="map-container" id="mapContainer" style="display: none;">
        <div class="map-section-header">
            <h2 class="section-title">üó∫Ô∏è Interactive Map</h2>
        </div>
        <div id="map"></div>
    </div>

    <!-- Location Status -->
    <div id="locationStatus" class="location-status location-loading" style="display: none;">
        Getting your location...
    </div>

    <!-- Features Grid -->
    <div class="features-section" id="featuresSection">
        <div class="features-grid">
            <div class="feature-card">
                <span class="feature-icon">‚ÑπÔ∏è</span>
                <h3 class="feature-title">About Us</h3>
                <p class="feature-description">Learn about our mission to help coeliacs find great beer across the UK.</p>
                <button class="feature-action" onclick="showAboutUs()">Learn More</button>
            </div>
            
            <!-- SWAPPED: What is GF Beer now comes before Report -->
            <div class="feature-card">
                <span class="feature-icon">üî¨</span>
                <h3 class="feature-title">What is GF Beer?</h3>
                <p class="feature-description">Everything you need to know about gluten free beer standards and safety.</p>
                <button class="feature-action" onclick="showGFInfo()">Learn More</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üì∏</span>
                <h3 class="feature-title">Report GF Beer</h3>
                <p class="feature-description">Found gluten free beer somewhere? Share it with the community and help others!</p>
                <button class="feature-action" onclick="openReportModal()">Add Report</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üè≠</span>
                <h3 class="feature-title">GF Breweries</h3>
                <p class="feature-description">Discover breweries making amazing gluten free beers and where to find them.</p>
                <button class="feature-action" onclick="window.location.href='/breweries'">Discover Breweries</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">üìß</span>
                <h3 class="feature-title">Weekly Updates</h3>
                <p class="feature-description">Get notified about new GF beer finds, pub additions, and brewery news.</p>
                <button class="feature-action" onclick="showComingSoon('Newsletter')">Coming Soon</button>
            </div>
            
            <div class="feature-card">
                <span class="feature-icon">‚≠ê</span>
                <h3 class="feature-title">GF Beer Reviews</h3>
                <p class="feature-description">Real reviews from coeliacs - discover which beers are worth trying and which to avoid.</p>
                <button class="feature-action" onclick="showComingSoon('Beer Reviews')">Coming Soon</button>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section" id="activitySection">
        <div class="activity-card">
            <div class="activity-header">
                <h2 class="activity-title">üî• Recent GF Beer Updates</h2>
                <a href="#" class="view-all" onclick="showAllActivity()">View All</a>
            </div>
            
            <div id="recentActivity">
                <div class="activity-item">
                    <div class="activity-avatar">üç∫</div>
                    <div class="activity-content">
                        <div class="activity-text">Welcome to the community! Start by searching for pubs near you.</div>
                        <div class="activity-time">Search above to see real pub data</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3 class="footer-title">üç∫ Coeliacs Like Beer Too</h3>
                <p class="footer-description">The UK's largest community-driven guide to gluten free beer. Built by coeliacs, for coeliacs.</p>
                <div class="footer-stats">
                    <span id="footerPubCount">52,847</span> pubs ¬∑ 
                    <span id="footerGFCount">1,249</span> with GF options
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üîó Quick Links</h4>
                <div class="footer-links">
                    <a href="#" onclick="showAboutUs()" class="footer-link">About Us</a>
                    <a href="#" onclick="showGFInfo()" class="footer-link">What is GF Beer?</a>
                    <a href="#" onclick="openReportModal()" class="footer-link">Report GF Beer</a>
                    <a href="#" onclick="scrollToSearch()" class="footer-link">Search Pubs</a>       
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üìã Legal & Privacy</h4>
                <div class="footer-links">
                    <a href="/privacy" class="footer-link" target="_blank">Privacy Policy</a>
                    <a href="/terms" class="footer-link" target="_blank">Terms of Service</a>
                    <a href="/cookies" class="footer-link" target="_blank">Cookie Policy</a>
                    <a href="/accessibility" class="footer-link" target="_blank">Accessibility</a>
                    <a href="/liability" class="footer-link" target="_blank">Liability Notice</a>
                </div>
            </div>
            
            <div class="footer-section">
                <h4 class="footer-subtitle">üí¨ Community</h4>
                <div class="footer-links">
                    <a href="#" onclick="showComingSoon('Contact Form')" class="footer-link">Contact Us</a>
                    <a href="#" onclick="showComingSoon('Community Forum')" class="footer-link">Community Forum</a>
                    <a href="#" onclick="showComingSoon('Newsletter')" class="footer-link">Newsletter</a>
                    <a href="#" onclick="showComingSoon('Social Media')" class="footer-link">Follow Us</a>
                </div>
            </div>
        </div>
        
        <div class="footer-bottom">
            <div class="footer-bottom-content">
                <p class="footer-copyright">
                    ¬© 2025 Coeliacs Like Beer Too. All rights reserved. 
                    <span class="footer-disclaimer">This site is for informational purposes only. Always verify with venues directly.</span>
                </p>
                <div class="footer-version">
                    <span class="footer-cache-info">v{{ cache_buster }}</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Enhanced Report GF Beer Modal -->
    <div id="reportModal" class="report-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì∏ Report GF Beer Find</h2>
                <button class="close-modal" onclick="closeReportModal()">&times;</button>
            </div>
            
            <form id="reportForm" class="report-form">
                <div class="form-group">
                    <label>Find Your Pub *</label>
                    <input type="text" id="reportPubSearch" required placeholder="Start typing pub name..." autocomplete="off">
                    <div id="pubSuggestions" class="pub-suggestions"></div>
                    <small>Search for an existing pub first - we'll check our database!</small>
                </div>
                
                <div id="selectedPubInfo" class="selected-pub-info" style="display: none;">
                    <div class="selected-pub-card">
                        <strong id="selectedPubName"></strong>
                        <div id="selectedPubAddress"></div>
                        <button type="button" onclick="clearSelectedPub()" class="btn-clear">Choose Different Pub</button>
                    </div>
                </div>
                
                <div id="newPubFields" class="new-pub-fields" style="display: none;">
                    <h4>üìç Add New Pub</h4>
                    <div class="form-group">
                        <label>Pub Name *</label>
                        <input type="text" id="reportPubName" placeholder="The Red Lion">
                    </div>
                    <div class="form-group">
                        <label>Address *</label>
                        <input type="text" id="reportAddress" placeholder="123 High Street">
                    </div>
                    <div class="form-group">
                        <label>Postcode *</label>
                        <input type="text" id="reportPostcode" placeholder="SW1A 1AA">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Beer Format *</label>
                    <select id="reportFormat" required>
                        <option value="">Select format...</option>
                        <option value="bottle">üç∫ Bottle</option>
                        <option value="tap">üö∞ Tap</option>
                        <option value="cask">üõ¢Ô∏è Cask</option>
                        <option value="can">ü•´ Can</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Brewery</label>
                    <input type="text" id="reportBrewery" placeholder="Brewdog">
                </div>
                
                <div class="form-group">
                    <label>Beer Name</label>
                    <input type="text" id="reportBeerName" placeholder="Punk AF">
                </div>

                <div id="currentPubBeers" class="current-pub-beers" style="display: none;">
                    <h4>üìç Current GF Beers at This Pub</h4>
                    <div id="pubBeersList"></div>
                    <div class="action-choice">
                        <label>
                            <input type="radio" name="updateAction" value="update" checked> 
                            Update existing beer
                        </label>
                        <label>
                            <input type="radio" name="updateAction" value="add"> 
                            Add new beer to this pub
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="beerStyleGroup">
                    <label>Beer Style</label>
                    <input type="text" id="reportBeerStyle" placeholder="Beer style">
                    <small>Style information</small>
                </div>

                <div class="form-group">
                    <label>Photo (Optional)</label>
                    <input type="file" id="reportPhoto" accept="image/*">
                    <small>Share a photo of the beer or menu</small>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeReportModal()" class="btn-cancel">Cancel</button>
                    <button type="submit" class="btn-submit">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- About Us Modal -->
    <div id="aboutModal" class="report-modal">
        <div class="modal-content about-modal-content">
            <div class="modal-header">
                <h2>‚ÑπÔ∏è About Coeliacs Like Beer Too</h2>
                <button class="close-modal" onclick="closeAboutModal()">&times;</button>
            </div>
            
            <div class="about-content">
                <div class="about-section">
                    <h3>üç∫ Our Mission</h3>
                    <p>We believe that being coeliac shouldn't mean missing out on great beer experiences. Our mission is to create the UK's most comprehensive, community-driven guide to gluten free beer options across the country.</p>
                </div>
                
                <div class="about-section">
                    <h3>üë• Our Story</h3>
                    <p>Started by coeliacs, for coeliacs. We understand the frustration of walking into a pub and not knowing if they have any safe options. That's why we built this platform - to help our community find amazing gluten free beer wherever they are in the UK.</p>
                </div>
                
                <div class="about-section">
                    <h3>ü§ù Community Driven</h3>
                    <p>Every beer report, every pub update, every photo comes from real people in the coeliac community. Together, we're building something that helps everyone discover new places and feel confident about their choices.</p>
                </div>
                
                <div class="about-section">
                    <h3>üìà Growing Together</h3>
                    <p>With thousands of pubs in our database and growing reports every day, we're becoming the go-to resource for gluten free beer discovery. Join us in making the UK more accessible for coeliacs!</p>
                </div>
                
                <div class="contact-info">
                    <h3>üí¨ Get in Touch</h3>
                    <p>Questions, suggestions, or partnership opportunities? We'd love to hear from you!</p>
                    <button onclick="showComingSoon('Contact Form')" class="btn-contact">Contact Us</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GF Info Modal -->
    <div id="gfInfoModal" class="report-modal">
        <div class="modal-content gf-modal-content">
            <div class="modal-header">
                <h2>üî¨ What is Gluten Free Beer?</h2>
                <button class="close-modal" onclick="closeGFInfoModal()">&times;</button>
            </div>
            
            <div class="gf-content">
                <div class="gf-section">
                    <h3>üß™ Official Standards</h3>
                    <div class="standards-grid">
                        <div class="standard-item">
                            <strong>üá¨üáß UK & EU</strong>
                            <p>Less than 20ppm gluten</p>
                        </div>
                        <div class="standard-item">
                            <strong>üá∫üá∏ USA</strong>
                            <p>Less than 20ppm gluten</p>
                        </div>
                        <div class="standard-item">
                            <strong>üá¶üá∫ Australia</strong>
                            <p>Less than 5ppm gluten (stricter!)</p>
                        </div>
                    </div>
                </div>
                
                <div class="gf-section">
                    <h3>üè∑Ô∏è Types of GF Beer</h3>
                    <div class="beer-types">
                        <div class="beer-type-item">
                            <strong>‚úÖ Certified Gluten Free</strong>
                            <p>Made from naturally gluten free grains (rice, sorghum, millet). Safest option.</p>
                        </div>
                        <div class="beer-type-item">
                            <strong>‚öóÔ∏è Gluten Removed/Reduced</strong>
                            <p>Made from barley/wheat but treated with enzymes to break down gluten. Some coeliacs react.</p>
                        </div>
                        <div class="beer-type-item">
                            <strong>üåæ "Made Without Gluten"</strong>
                            <p>No gluten ingredients added, but may have cross-contamination. Check carefully!</p>
                        </div>
                    </div>
                </div>
                
                <div class="gf-section">
                    <h3>‚ö†Ô∏è Important Notes</h3>
                    <ul class="safety-notes">
                        <li><strong>Cross-contamination</strong> can happen in breweries that also make regular beer</li>
                        <li><strong>Always check labels</strong> and ask staff about preparation methods</li>
                        <li><strong>Coeliacs vs Gluten Intolerant</strong> - Coeliac disease is an autoimmune condition requiring strict gluten avoidance, while gluten intolerance is a separate digestive sensitivity</li>
                        <li><strong>When in doubt</strong>, choose certified gluten free options</li>
                    </ul>
                </div>
                
                <div class="gf-section">
                    <h3>üç∫ Popular GF Beer Brands in UK</h3>
                    <div class="brand-grid">
                        <span class="brand-tag">Brewdog (GF Range)</span>
                        <span class="brand-tag">Glutenberg</span>
                        <span class="brand-tag">Omission</span>
                        <span class="brand-tag">Stella Artois (GF)</span>
                        <span class="brand-tag">Ghostfish</span>
                        <span class="brand-tag">Ground Breaker</span>
                    </div>
                </div>
                
                <div class="disclaimer">
                    <p><strong>Disclaimer:</strong> This information is for guidance only. Always consult with healthcare professionals and verify product safety for your individual needs.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Smart Coordinate Modal -->
    <div id="coordinateModal" class="coordinate-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalPubName">Help us locate this pub!</h2>
                <p>We'll search near the postcode and you can click to pinpoint the exact location.</p>
            </div>
            
            <div class="modal-instructions">
                <span id="modalInstructions">üó∫Ô∏è Searching for the pub area...</span>
            </div>
            
            <div id="coordinateMap" class="modal-map"></div>
            
            <div id="selectedLocationInfo" class="selected-location" style="display: none;">
                <div>üìç Selected location:</div>
                <div class="coordinates" id="selectedCoordinates"></div>
            </div>
            
            <div class="modal-buttons">
                <button id="confirmLocation" class="modal-button confirm-button">
                    ‚úÖ Confirm Location
                </button>
                <button id="cancelModal" class="modal-button cancel-button">
                    ‚ùå Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Toast -->
    <div id="loadingToast" class="toast loading-toast" style="display: none;">
        <div class="toast-content">
            <div class="spinner"></div>
            <span id="loadingMessage">Loading...</span>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="toast success-toast" style="display: none;">
        <div class="toast-content">
            <span class="toast-icon">‚úÖ</span>
            <span id="successMessage">Success!</span>
        </div>
    </div>

    <script>
        // Cache-busting timestamp
        console.log('üöÄ CACHE BUSTER:', '{{ cache_buster }}');
        
        var map;
        var userLocation = null;
        var pubMarkers = [];
        var userMarker = null;

        // Smart coordinate modal variables
        var coordinateMap;
        var selectedMarker;
        var currentPub;
        var selectedCoordinates = null;

        // Global pagination variables
        let currentPage = 1;
        let currentQuery = '';
        let currentSearchType = 'all';
        let currentGfOnly = false;

        // ================================
        // TOAST NOTIFICATION SYSTEM
        // ================================
        
        function showLoadingToast(message = 'Loading...') {
            const toast = document.getElementById('loadingToast');
            document.getElementById('loadingMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
        }

        function hideLoadingToast() {
            const toast = document.getElementById('loadingToast');
            toast.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 300);
        }

        function showSuccessToast(message = 'Success!') {
            const toast = document.getElementById('successToast');
            document.getElementById('successMessage').textContent = message;
            toast.style.display = 'block';
            toast.style.animation = 'slideInUp 0.3s ease-out';
            
            // Auto hide after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutDown 0.3s ease-in';
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // ================================
        // GOOGLE ANALYTICS TRACKING
        // ================================
        
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            }
        }

        function trackSearch(query, searchType, results) {
            trackEvent('search', 'Search', `${searchType}: ${query} (${results} results)`);
        }

        function trackPubView(pubName) {
            trackEvent('pub_view', 'Pub Interaction', pubName);
        }

        // ================================
        // ENHANCED UI FUNCTIONS
        // ================================
        
        let selectedPubData = null;
        let pubSearchTimeout = null;
        let mapVisible = false;
        
        function scrollToSearch() {
            document.getElementById('search').scrollIntoView({ behavior: 'smooth' });
        }

        // ADD: New function for home navigation
        function goHome() {
            window.location.href = '/';
            trackEvent('go_home', 'Navigation', 'home_button');
        }

        // SMART MAP TOGGLE - Auto-show when needed
        /* ========================================
   IMPLEMENTATION INSTRUCTIONS:
   
   UPDATE: Your toggleMap() function to handle
   proper spacing classes
   ======================================== */

        // UPDATE: Enhanced toggleMap function with proper spacing
        function toggleMap() {
            mapVisible = !mapVisible;
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('toggleMapBtn');
            const featuresSection = document.getElementById('featuresSection');
            
            if (mapVisible) {
                mapContainer.style.display = 'block';
                toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                
                // Remove the map-hidden class to ensure proper spacing
                if (featuresSection) {
                    featuresSection.classList.remove('map-hidden');
                }
                
                // Initialize map if not already done, or resize if it exists
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                    }
                }, 100);
                
                // Smooth scroll to show the map
                setTimeout(() => {
                    mapContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 150);
            } else {
                mapContainer.style.display = 'none';
                toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                
                // Add the map-hidden class to restore top margin
                if (featuresSection) {
                    featuresSection.classList.add('map-hidden');
                }
            }
            
            AppState.save();
        }

        // SMART MAP SHOWING - Auto show map when needed
        function smartShowMap() {
            if (!mapVisible) {
                toggleMap();
            }
        }

        function openReportModal() {
            document.getElementById('reportModal').style.display = 'block';
            trackEvent('open_report_modal', 'Modal');
            
            // Initialize brewery dropdown when modal opens
            setTimeout(() => {
                initializeReportModalDropdowns();
                document.getElementById('reportPubSearch').focus();
            }, 100);
        }

        function closeReportModal() {
            document.getElementById('reportModal').style.display = 'none';
            document.getElementById('reportForm').reset();
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('newPubFields').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
        }

        function showAboutUs() {
            document.getElementById('aboutModal').style.display = 'block';
            trackEvent('open_about_modal', 'Modal');
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        function showGFInfo() {
            document.getElementById('gfInfoModal').style.display = 'block';
            trackEvent('open_gf_info_modal', 'Modal');
        }

        function closeGFInfoModal() {
            document.getElementById('gfInfoModal').style.display = 'none';
        }

        function showComingSoon(feature) {
            trackEvent('coming_soon_click', 'Feature Interest', feature);
            showSuccessToast(`${feature} is coming soon! üöÄ We're working hard to bring you this feature.`);
        }

        function showAllActivity() {
            trackEvent('view_all_activity', 'Navigation');
            showSuccessToast('Full activity feed coming soon! üìä This will show all recent GF beer finds.');
        }

        // SMART RESULTS SECTION - Pushes content down
        function showResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'block';
            
            // Add margin to push content down
            featuresSection.style.marginTop = '40px';
            activitySection.style.marginTop = '40px';
            
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function hideResultsSection() {
            const resultsSection = document.getElementById('results-section');
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            
            resultsSection.style.display = 'none';
            
            // Remove margin
            featuresSection.style.marginTop = '0';
            activitySection.style.marginTop = '0';
        }

        function checkCookieConsent() {
    const consent = localStorage.getItem('cookieConsent');
    const analyticsConsent = localStorage.getItem('analyticsConsent');
    
    if (!consent) {
        // Show cookie banner after page loads
        setTimeout(() => {
            document.getElementById('cookieConsent').style.display = 'block';
        }, 1000);
    } else {
        // Show floating cookie settings button
        document.getElementById('cookieSettingsFloat').style.display = 'block';
        
        // Initialize analytics if user previously consented
        if (analyticsConsent === 'true') {
            initializeAnalytics();
        }
    }
}

        // Accept all cookies
        function acceptAllCookies() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'true');
            
            hideCookieBanner();
            initializeAnalytics();
            showSuccessToast('‚úÖ Cookie preferences saved. Thanks!');
            
            trackEvent('cookie_consent', 'Privacy', 'accept_all');
        }
        
        // Accept essential cookies only
        function acceptEssentialOnly() {
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', 'false');
            
            hideCookieBanner();
            showSuccessToast('‚úÖ Essential cookies only. You can change this anytime.');
            
            // Track with basic method (no GA needed)
            console.log('Cookie consent: essential only');
        }
        
        // Show cookie settings modal
        function showCookieSettings() {
            document.getElementById('cookieSettings').style.display = 'block';
            document.body.classList.add('modal-open'); // ADD THIS LINE
            
            // Set current preferences in modal
            const analyticsConsent = localStorage.getItem('analyticsConsent');
            document.getElementById('analyticsConsent').checked = analyticsConsent === 'true';
        }
        
        // Close cookie settings modal
        function closeCookieSettings() {
            document.getElementById('cookieSettings').style.display = 'none';
            document.body.classList.remove('modal-open'); // ADD THIS LINE
        }
        
        // Save cookie preferences from settings modal
        function savesCookiePreferences() {
            const analyticsConsent = document.getElementById('analyticsConsent').checked;
            
            localStorage.setItem('cookieConsent', 'true');
            localStorage.setItem('analyticsConsent', analyticsConsent.toString());
            
            closeCookieSettings();
            hideCookieBanner();
            
            if (analyticsConsent) {
                initializeAnalytics();
                showSuccessToast('‚úÖ Preferences saved. Analytics enabled.');
                trackEvent('cookie_consent', 'Privacy', 'analytics_enabled');
            } else {
                showSuccessToast('‚úÖ Preferences saved. Analytics disabled.');
                console.log('Cookie consent: analytics disabled');
            }
        }
        
        // Accept all from settings modal
        function acceptAllFromSettings() {
            document.getElementById('analyticsConsent').checked = true;
            savesCookiePreferences();
        }
        
        // Hide cookie banner
        function hideCookieBanner() {
            const banner = document.getElementById('cookieConsent');
            banner.style.animation = 'slideOutDown 0.3s ease-in';
            setTimeout(() => {
                banner.style.display = 'none';
                document.getElementById('cookieSettingsFloat').style.display = 'block';
                document.body.classList.remove('modal-open'); // ADD THIS LINE
            }, 300);
        }
        
        // Initialize Google Analytics (only if consent given)
        function initializeAnalytics() {
            // Only initialize if gtag is available and user consented
            if (typeof gtag !== 'undefined' && localStorage.getItem('analyticsConsent') === 'true') {
                gtag('consent', 'update', {
                    'analytics_storage': 'granted'
                });
                
                console.log('‚úÖ Google Analytics initialized with user consent');
            }
        }

        // Fix for mobile viewport height issues
        function fixMobileViewport() {
            if (window.innerWidth <= 768) {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
        }
        
        // Call on resize and load
        window.addEventListener('resize', fixMobileViewport);
        window.addEventListener('load', fixMobileViewport);
        
        // Update your existing gtag initialization
        function initializeGoogleAnalytics() {
            // Set default consent to denied
            if (typeof gtag !== 'undefined') {
                gtag('consent', 'default', {
                    'analytics_storage': 'denied'
                });
                
                gtag('js', new Date());
                gtag('config', 'G-WSHR39KSXS', {
                    'anonymize_ip': true,
                    'cookie_flags': 'SameSite=None;Secure'
                });
            }
        }
        
        // Enhanced tracking function that respects consent
        function trackEvent(action, category = 'User Interaction', label = '') {
            if (localStorage.getItem('analyticsConsent') === 'true' && typeof gtag !== 'undefined') {
                gtag('event', action, {
                    event_category: category,
                    event_label: label
                });
            } else {
                // Fallback logging for essential tracking
                console.log(`Event: ${action} | Category: ${category} | Label: ${label}`);
            }
        }
        
        // NEW VERSION (replace with this):
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('cookieSettings');
            const modalContent = modal?.querySelector('.modal-content');
            
            if (modal && modal.style.display === 'block') {
                if (e.target === modal && !modalContent?.contains(e.target)) {
                    closeCookieSettings();
                }
            }
        });
        
        // ADD this NEW event listener after the click listener:
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('cookieSettings');
                if (modal && modal.style.display === 'block') {
                    closeCookieSettings();
                }
            }
        });
        
        // Initialize cookie consent check when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeGoogleAnalytics(); // Set default consent first
            checkCookieConsent(); // Then check if user already gave consent
        });
        
        // ================================
        // KEYBOARD ACCESSIBILITY
        // ================================
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeCookieSettings();
            }
        });

        // Enhanced pub search functionality
        function searchPubsForReport(query) {
            if (query.length < 2) {
                document.getElementById('pubSuggestions').style.display = 'none';
                return;
            }

            // Debounce the search
            clearTimeout(pubSearchTimeout);
            pubSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/autocomplete?q=${encodeURIComponent(query)}&search_type=name&limit=5`);
                    if (!response.ok) return;
                    
                    const pubs = await response.json();
                    const suggestions = document.getElementById('pubSuggestions');
                    
                    if (pubs.length === 0) {
                        suggestions.innerHTML = `
                            <div class="no-pub-found">
                                <strong>üè™ Pub not found in our database</strong>
                                <button type="button" onclick="showNewPubFields()" class="btn-add-new">Add New Pub</button>
                            </div>
                        `;
                        suggestions.style.display = 'block';
                        return;
                    }
                    
                    suggestions.innerHTML = '';
                    pubs.forEach(pub => {
                        const div = document.createElement('div');
                        div.className = 'pub-suggestion-item';
                        div.innerHTML = `
                            <strong>${pub.name}</strong>
                            <div>${pub.address}, ${pub.postcode}</div>
                        `;
                        div.onclick = () => selectExistingPub(pub);
                        suggestions.appendChild(div);
                    });
                    
                    // Add "Not here?" option
                    const notFoundDiv = document.createElement('div');
                    notFoundDiv.className = 'pub-suggestion-item add-new';
                    notFoundDiv.innerHTML = `
                        <strong>üè™ Don't see your pub?</strong>
                        <div>Add a new pub to our database</div>
                    `;
                    notFoundDiv.onclick = () => showNewPubFields();
                    suggestions.appendChild(notFoundDiv);
                    
                    suggestions.style.display = 'block';
                } catch (error) {
                    console.error('Error searching pubs:', error);
                }
            }, 300);
        }

        function selectExistingPub(pub) {
            selectedPubData = pub;
            document.getElementById('selectedPubName').textContent = pub.name;
            document.getElementById('selectedPubAddress').textContent = `${pub.address}, ${pub.postcode}`;
            document.getElementById('selectedPubInfo').style.display = 'block';
            document.getElementById('newPubFields').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
            document.getElementById('reportPubSearch').value = pub.name;
            
            // ADD THIS LINE - this is probably missing:
            showCurrentPubBeers(pub);
            
            trackEvent('select_existing_pub', 'Report Flow', pub.name);
        }

        function clearSelectedBeer() {
            const beerNameSelect = document.getElementById('reportBeerName');
            const selectedBeerInfo = document.getElementById('selectedBeerInfo');
            const beerStyleGroup = document.getElementById('beerStyleGroup');
            
            if (beerNameSelect) {
                beerNameSelect.selectedIndex = 0;
            }
            
            selectedBeerInfo.style.display = 'none';
            beerStyleGroup.style.display = 'none';
            
            console.log('üßπ Cleared beer selection');
        }

        function clearSelectedPub() {
            selectedPubData = null;
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('reportPubSearch').value = '';
            document.getElementById('reportPubSearch').focus();
        }

        function showNewPubFields() {
            const query = document.getElementById('reportPubSearch').value;
            document.getElementById('newPubFields').style.display = 'block';
            document.getElementById('selectedPubInfo').style.display = 'none';
            document.getElementById('pubSuggestions').style.display = 'none';
            trackEvent('add_new_pub', 'Report Flow');
            
            // Pre-fill with search query if available
            if (query) {
                document.getElementById('reportPubName').value = query;
            }
            
            // Focus on address field
            setTimeout(() => {
                document.getElementById('reportAddress').focus();
            }, 100);
        }

        function addToRecentActivity(report) {
            const activityContainer = document.getElementById('recentActivity');
            const newActivity = document.createElement('div');
            newActivity.className = 'activity-item';
            
            const pubName = selectedPubData ? selectedPubData.name : report.pubName;
            newActivity.innerHTML = `
                <div class="activity-avatar">üì∏</div>
                <div class="activity-content">
                    <div class="activity-text"><strong>You</strong> reported <strong>${report.brewery} ${report.beerName}</strong> at ${pubName}</div>
                    <div class="activity-time">Just now</div>
                </div>
            `;
            activityContainer.insertBefore(newActivity, activityContainer.firstChild);
        }

        // ENHANCED stats loading - Replace your loadDashboardStats function

        // REPLACE: Fixed loadDashboardStats function
        async function loadDashboardStats() {
            try {
                console.log('üîÑ Loading dashboard stats from database...');
                const response = await fetch('/api/stats');
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('‚úÖ Stats loaded:', stats);
                    
                    // Animate the numbers counting up
                    animateNumber('totalPubs', stats.total_pubs);
                    animateNumber('gfPubs', stats.gf_pubs);
                    
                    // Update footer stats too
                    document.getElementById('footerPubCount').textContent = stats.total_pubs.toLocaleString();
                    document.getElementById('footerGFCount').textContent = stats.gf_pubs.toLocaleString();
                    
                    // FIXED: Added missing closing quote here
                    console.log(`üìä Dashboard updated: ${stats.total_pubs} pubs, ${stats.gf_pubs} GF pubs`);
                    
                } else {
                    console.warn('‚ö†Ô∏è Stats API returned error, using fallback data');
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not load live stats, using fallback data:', error);
                
                // Sensible fallback numbers
                animateNumber('totalPubs', 49841);
                animateNumber('gfPubs', 1249);
                
                // Update footer with fallback data
                document.getElementById('footerPubCount').textContent = '49,841';
                document.getElementById('footerGFCount').textContent = '1,249';
            }
        }
        
        // Enhanced number animation with better formatting
        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            if (!element) {
                console.warn(`Element ${elementId} not found`);
                return;
            }
            
            const startNumber = 0;
            const duration = 2000; // 2 seconds
            const startTime = performance.now();
            
            function updateNumber(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease out animation
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentNumber = Math.floor(startNumber + (targetNumber - startNumber) * easeOut);
                
                // Format the number with commas
                element.textContent = currentNumber.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateNumber);
                } else {
                    // Ensure final number is exactly correct
                    element.textContent = targetNumber.toLocaleString();
                }
            }
            
            requestAnimationFrame(updateNumber);
        }
        
        // Add stats refresh function for debugging/admin use
        function refreshStats() {
            console.log('üîÑ Manually refreshing stats...');
            loadDashboardStats();
        }
        
        // Optional: Auto-refresh stats every 5 minutes
        function startStatsAutoRefresh() {
            setInterval(() => {
                console.log('üîÑ Auto-refreshing stats...');
                loadDashboardStats();
            }, 5 * 60 * 1000); // 5 minutes
        }
        
        // Call this if you want auto-refresh (optional)
        startStatsAutoRefresh();

        // ================================
        // CORE FUNCTIONALITY
        // ================================

        // State management for refresh persistence
        const AppState = {
            save: function(pubId = null) {
                const state = {
                    query: currentQuery,
                    searchType: currentSearchType,
                    gfOnly: currentGfOnly,
                    page: currentPage,
                    mapVisible: mapVisible,
                    specificPubId: pubId || null,
                    timestamp: Date.now()
                };
                window.location.hash = btoa(JSON.stringify(state));
            },
            
            load: function() {
                try {
                    if (window.location.hash) {
                        const state = JSON.parse(atob(window.location.hash.substring(1)));
                        if (Date.now() - state.timestamp < 3600000) {
                            return state;
                        }
                    }
                } catch (e) {
                    console.log('No valid state to restore');
                }
                return null;
            },
            
            restore: async function() {
                const state = this.load();
                if (state) {
                    console.log('Restoring state:', state);
                    
                    document.getElementById('searchInput').value = state.query || '';
                    document.getElementById('searchType').value = state.searchType || 'all';
                    document.getElementById('gfOnly').checked = state.gfOnly || false;
                    
                    currentQuery = state.query || '';
                    currentSearchType = state.searchType || 'all';
                    currentGfOnly = state.gfOnly || false;
                    currentPage = state.page || 1;
                    mapVisible = state.mapVisible || false;
                    
                    const mapContainer = document.getElementById('mapContainer');
                    const toggleBtn = document.getElementById('toggleMapBtn');
                    if (mapVisible) {
                        mapContainer.style.display = 'block';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Hide Map';
                    } else {
                        mapContainer.style.display = 'none';
                        toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
                    }
                    
                    if (state.specificPubId) {
                        console.log('Restoring specific pub:', state.specificPubId);
                        await searchSpecificPub(state.specificPubId);
                    } else if (state.query) {
                        console.log('Restoring search query:', state.query);
                        await loadPage(state.page);
                    }
                }
            }
        };

        // Debounce function to limit rapid requests
        let debounceTimeout;
        function debounce(func, wait) {
            return function (...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Calculate distance between two points
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get user's location
        function getUserLocation() {
            const statusEl = document.getElementById('locationStatus');
            statusEl.style.display = 'block';
            statusEl.className = 'location-status location-loading';
            statusEl.textContent = 'Getting your location...';

            if (!navigator.geolocation) {
                statusEl.className = 'location-status location-error';
                statusEl.textContent = 'Geolocation not supported by this browser';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    statusEl.className = 'location-status location-success';
                    statusEl.textContent = 'Location found! Click "Pubs Near Me" to see what\'s around you.';
                    
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }
                    userMarker = L.marker([userLocation.lat, userLocation.lng])
                        .addTo(map)
                        .bindPopup('You are here!')
                        .openPopup();
                    
                    map.setView([userLocation.lat, userLocation.lng], 14);
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 3000);
                },
                (error) => {
                    let errorMessage = 'Unable to get your location';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location services.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out.';
                            break;
                    }
                    statusEl.className = 'location-status location-error';
                    statusEl.textContent = errorMessage;
                    
                    setTimeout(() => {
                        statusEl.style.display = 'none';
                    }, 5000);
                }
            );
        }

        // ENHANCED Find nearby pubs with smart map showing
        async function findNearbyPubs() {
            if (!userLocation) {
                showSuccessToast('Getting your location first...');
                getUserLocation();
                return;
            }

            trackEvent('find_nearby_pubs', 'Location Search');
            smartShowMap(); // Auto-show map
            
            const gfOnly = document.getElementById('gfOnly').checked;
            const radius = 5;
            
            showResultsSection();
            showLoadingToast('Finding nearby pubs...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Finding nearby pubs...</li>';
            
            map.setView([userLocation.lat, userLocation.lng], 14);
            
            try {
                const url = `/nearby?lat=${userLocation.lat}&lng=${userLocation.lng}&radius=${radius}&gf_only=${gfOnly}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const nearbyPubs = await response.json();
                
                if (nearbyPubs.error) {
                    throw new Error(nearbyPubs.error);
                }
                
                hideLoadingToast();
                displaySearchResults(nearbyPubs);
                addPubMarkersToMap(nearbyPubs);
                
                showSuccessToast(`Found ${nearbyPubs.length} pubs near you!`);
                trackSearch('nearby', 'location', nearbyPubs.length);
                
                if (nearbyPubs.length > 0) {
                    const allPoints = [];
                    allPoints.push([userLocation.lat, userLocation.lng]);
                    
                    nearbyPubs.forEach(pub => {
                        if (pub.latitude && pub.longitude) {
                            allPoints.push([parseFloat(pub.latitude), parseFloat(pub.longitude)]);
                        }
                    });
                    
                    if (allPoints.length > 1) {
                        const group = new L.featureGroup(allPoints.map(point => L.marker(point)));
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                }
                
                currentQuery = '';
                currentSearchType = 'all';
                currentGfOnly = gfOnly;
                currentPage = 1;
                AppState.save();
                
            } catch (error) {
                console.error('Error finding nearby pubs:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error finding nearby pubs. Please try again.</li>';
                showSuccessToast('Error finding nearby pubs. Please try again.');
            }
        }

        // ENHANCED centerOnLocation with smart map showing
        function centerOnLocation() {
            trackEvent('center_on_location', 'Map Interaction');
            smartShowMap(); // Auto-show map
            
            if (userLocation) {
                map.setView([userLocation.lat, userLocation.lng], 14);
                showSuccessToast('Centered on your location!');
            } else {
                getUserLocation();
            }
        }

        // Add pub markers to map
        function addPubMarkersToMap(pubs) {
            // Clear existing markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];

            pubs.forEach(pub => {
                if (pub.latitude && pub.longitude) {
                    const hasGF = pub.bottle || pub.tap || pub.cask || pub.can;
                    const markerColor = hasGF ? '#4CAF50' : '#757575';
                    
                    const marker = L.circleMarker([pub.latitude, pub.longitude], {
                        radius: 8,
                        fillColor: markerColor,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    let popupContent = `<strong>${pub.name}</strong><br>`;
                    popupContent += `${pub.address}<br>`;
                    if (pub.distance !== undefined) {
                        popupContent += `<em>${pub.distance.toFixed(2)} km away</em><br>`;
                    }
                    
                    if (hasGF) {
                        let gfOptions = [];
                        if (pub.bottle) gfOptions.push('Bottle');
                        if (pub.tap) gfOptions.push('Tap');
                        if (pub.cask) gfOptions.push('Cask');
                        if (pub.can) gfOptions.push('Can');
                        popupContent += `<br><strong>GF Options:</strong> ${gfOptions.join(', ')}`;
                    } else {
                        popupContent += '<br><em>No GF options recorded</em>';
                    }

                    marker.bindPopup(popupContent);
                    pubMarkers.push(marker);
                }
            });
        }

        // Smart coordinate modal functions
        function openCoordinateModal(pubName, postcode, pubId) {
            currentPub = { name: pubName, postcode: postcode, id: pubId };
            
            document.getElementById('modalPubName').textContent = `Help us locate ${pubName}!`;
            document.getElementById('coordinateModal').style.display = 'block';
            document.getElementById('modalInstructions').textContent = 'üó∫Ô∏è Searching for the pub area...';
            document.getElementById('selectedLocationInfo').style.display = 'none';
            document.getElementById('confirmLocation').classList.remove('active');
            selectedCoordinates = null;
            
            setTimeout(() => {
                if (coordinateMap) {
                    coordinateMap.remove();
                }
                
                coordinateMap = L.map('coordinateMap').setView([51.505, -0.09], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(coordinateMap);
                
                searchPostcodeLocation(postcode);
                coordinateMap.on('click', onMapClick);
            }, 100);
        }

        async function searchPostcodeLocation(postcode) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(postcode)}&countrycodes=gb&limit=1`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lng = parseFloat(data[0].lon);
                    
                    coordinateMap.setView([lat, lng], 16);
                    
                    L.circle([lat, lng], {
                        radius: 200,
                        fillColor: '#667eea',
                        fillOpacity: 0.1,
                        color: '#667eea',
                        weight: 2,
                        opacity: 0.3
                    }).addTo(coordinateMap);
                    
                    document.getElementById('modalInstructions').innerHTML = 
                        `üìç Found ${postcode}! Click on the map where <strong>${currentPub.name}</strong> is located.`;
                } else {
                    throw new Error('Postcode not found');
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                coordinateMap.setView([54.5, -2], 6);
                document.getElementById('modalInstructions').innerHTML = 
                    `üîç Couldn't find ${postcode}. Please zoom to the area and click where <strong>${currentPub.name}</strong> is located.`;
            }
        }

        function onMapClick(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            if (selectedMarker) {
                coordinateMap.removeLayer(selectedMarker);
            }
            
            selectedMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                        width: 24px;
                        height: 24px;
                        border-radius: 50%;
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-weight: bold;
                        font-size: 12px;
                    ">üìç</div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                })
            }).addTo(coordinateMap);
            
            selectedMarker.bindPopup(`<strong>${currentPub.name}</strong><br>Is this the correct location?`).openPopup();
            
            selectedCoordinates = { lat: lat.toFixed(6), lng: lng.toFixed(6) };
            
            document.getElementById('selectedCoordinates').textContent = 
                `${selectedCoordinates.lat}, ${selectedCoordinates.lng}`;
            document.getElementById('selectedLocationInfo').style.display = 'block';
            document.getElementById('confirmLocation').classList.add('active');
            document.getElementById('modalInstructions').innerHTML = 
                `‚úÖ Great! Is this where <strong>${currentPub.name}</strong> is located?`;
        }

        async function confirmLocation() {
            if (!selectedCoordinates) return;
            
            try {
                const response = await fetch('/update_coordinates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pub_id: currentPub.id,
                        latitude: parseFloat(selectedCoordinates.lat),
                        longitude: parseFloat(selectedCoordinates.lng)
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccessToast(`üéâ Thank you! ${currentPub.name} has been located on the map.`);
                    closeCoordinateModal();
                    trackEvent('coordinate_confirmed', 'Community Contribution', currentPub.name);
                    
                    if (userLocation) {
                        findNearbyPubs();
                    } else {
                        searchSpecificPub(currentPub.id);
                    }
                } else {
                    showSuccessToast('Error saving location: ' + result.message);
                }
            } catch (error) {
                console.error('Error saving coordinates:', error);
                showSuccessToast('Error saving location. Please try again.');
            }
        }

        function closeCoordinateModal() {
            document.getElementById('coordinateModal').style.display = 'none';
            if (coordinateMap) {
                coordinateMap.remove();
                coordinateMap = null;
            }
            selectedMarker = null;
            selectedCoordinates = null;
        }

        // ENHANCED findOnMap with smart map showing
        // ENHANCED findOnMap function - Replace in your JavaScript
        // Also update your findOnMap function for better centering:
        // REPLACE: Enhanced findOnMap function with better scrolling and no redundant button
        // ====================================
        // FIX THE UX - Make it beautiful again
        // ====================================
        
        // The issue is probably in your findOnMap function
        // REPLACE your existing findOnMap function with this:
        
        function findOnMap(lat, lng, pubName, postcode, pubId) {
            trackPubView(pubName);
            
            // Always show the map when someone clicks "Find on Map"
            if (!mapVisible) {
                toggleMap();
            }
            
            if (lat && lng && lat !== 'null' && lng !== 'null' && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lng))) {
                setTimeout(() => {
                    // Zoom to the location
                    map.setView([parseFloat(lat), parseFloat(lng)], 17);
                    
                    // Remove any existing highlight markers
                    if (window.currentHighlightMarker) {
                        map.removeLayer(window.currentHighlightMarker);
                    }
                    
                    // Create a special highlight marker
                    window.currentHighlightMarker = L.circleMarker([parseFloat(lat), parseFloat(lng)], {
                        radius: 15,
                        fillColor: '#ff6b6b',
                        color: '#fff',
                        weight: 4,
                        opacity: 1,
                        fillOpacity: 0.9,
                        className: 'pulsing-marker'
                    }).addTo(map);
                    
                    const markerElement = window.currentHighlightMarker.getElement();
                    if (markerElement) {
                        markerElement.style.animation = 'pulse 2s infinite';
                    }
                    
                    // Clean popup without extra button
                    window.currentHighlightMarker.bindPopup(`
                        <div style="text-align: center; padding: 8px;">
                            <strong style="color: #2d3748; font-size: 16px;">${pubName}</strong>
                            <br><em style="color: #667eea;">üìç Found on map!</em>
                            <br><small style="color: #718096;">Details shown below</small>
                        </div>
                    `).openPopup();
                    
                    // CREATE BEAUTIFUL SPLIT SCREEN immediately
                    createSplitScreenLayout(pubId);
                    
                    // PERFECT SCROLLING: Show map at top, details below
                    setTimeout(() => {
                        const mapContainer = document.getElementById('mapContainer');
                        
                        if (mapContainer) {
                            const mapRect = mapContainer.getBoundingClientRect();
                            const optimalScrollY = window.pageYOffset + mapRect.top - 20;
                            
                            window.scrollTo({ 
                                top: Math.max(0, optimalScrollY), 
                                behavior: 'smooth' 
                            });
                            
                            showSuccessToast('üìç Map and pub details loaded!');
                        }
                    }, 300);
                    
                    // Clean up highlight after 8 seconds
                    setTimeout(() => {
                        if (window.currentHighlightMarker) {
                            map.removeLayer(window.currentHighlightMarker);
                            window.currentHighlightMarker = null;
                        }
                    }, 8000);
                    
                }, mapVisible ? 50 : 300);
            } else {
                openCoordinateModal(pubName, postcode, pubId);
            }
        }

// Make sure your createSplitScreenLayout function is working
// This should create the beautiful layout below the map
        // ADD: Homepage reset function
        function resetToHomepage() {
            // Clear search inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('searchType').value = 'all';
            document.getElementById('gfOnly').checked = false;
            
            // Hide results section
            hideResultsSection();
            
            // Hide map if visible
            if (mapVisible) {
                toggleMap();
            }
            
            // Hide split screen if visible
            const splitContainer = document.getElementById('split-screen-container');
            if (splitContainer) {
                splitContainer.style.display = 'none';
            }
            
            // Clear any markers
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.currentHighlightMarker) {
                map.removeLayer(window.currentHighlightMarker);
                window.currentHighlightMarker = null;
            }
            
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
                window.postcodeMarker = null;
            }
            
            // Clear URL hash/state
            window.location.hash = '';
            
            // Reset global variables
            currentQuery = '';
            currentSearchType = 'all';
            currentGfOnly = false;
            currentPage = 1;
            mapVisible = false;
            
            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Show clean homepage sections
            const featuresSection = document.getElementById('featuresSection');
            const activitySection = document.getElementById('activitySection');
            if (featuresSection) featuresSection.style.display = 'block';
            if (activitySection) featuresSection.style.display = 'block';
            
            // Update button text
            const toggleBtn = document.getElementById('toggleMapBtn');
            if (toggleBtn) toggleBtn.innerHTML = 'üó∫Ô∏è Show Map';
            
            // Success feedback
            showSuccessToast('üè† Reset to homepage - ready for a fresh search!');
            trackEvent('reset_homepage', 'Navigation', 'homepage_reset');
        }

        // ADD: New function - create split screen layout
        function createSplitScreenLayout(selectedPubId) {
            const mapContainer = document.getElementById('mapContainer');
            const resultsSection = document.getElementById('results-section');
            
            // Hide the full results section
            resultsSection.style.display = 'none';
            
            // Create split screen container if it doesn't exist
            let splitContainer = document.getElementById('split-screen-container');
            if (!splitContainer) {
                splitContainer = document.createElement('div');
                splitContainer.id = 'split-screen-container';
                splitContainer.className = 'split-screen-container';
                
                // Insert after map container
                mapContainer.parentNode.insertBefore(splitContainer, mapContainer.nextSibling);
            }
            
            // Get the specific pub data
            const selectedPub = getCurrentPubData(selectedPubId);
        
            if (selectedPub) {
                splitContainer.innerHTML = `
                    <div class="split-screen-header">
                        <button onclick="goHome()" class="home-btn" title="Back to Home">
                            üè† Home
                        </button>
                        <h2 class="section-title">üìç Pub Details</h2>
                    </div>
                    <div class="split-pub-details">
                        ${createSinglePubDisplay(selectedPub)}
                    </div>
                `;
                splitContainer.style.display = 'block';
            }
        }
        
        // ADD: New function - get current pub data from the last search
        function getCurrentPubData(pubId) {
            // Search through the current results for the pub
            const resultItems = document.querySelectorAll('.result-item');
            for (let item of resultItems) {
                const updateButton = item.querySelector(`[onclick*="toggleUpdateForm(${pubId})"]`);
                if (updateButton) {
                    // Extract pub data from the DOM element
                    const pubName = item.querySelector('strong').textContent;
                    const address = item.querySelector('.address').textContent;
                    const localAuthority = item.querySelector('.local-authority').textContent;
                    const beerDetails = item.querySelector('.beer-details').innerHTML;
                    
                    return {
                        pub_id: pubId,
                        name: pubName,
                        address: address.split(',')[0],
                        postcode: address.split(',').pop().trim(),
                        local_authority: localAuthority,
                        beer_details: beerDetails
                    };
                }
            }
            return null;
        }
        
        // UPDATE: Fixed createSinglePubDisplay function with working update button
        function createSinglePubDisplay(pub) {
            return `
                <div class="single-pub-card">
                    <div class="pub-header">
                        <h3>${pub.name}</h3>
                        <div class="pub-address">${pub.address}, ${pub.postcode}</div>
                        <div class="pub-authority">${pub.local_authority}</div>
                    </div>
                    
                    <div class="pub-beer-section">
                        <h4>üç∫ Available Gluten Free Beers</h4>
                        <div class="pub-beer-details">
                            ${pub.beer_details}
                        </div>
                    </div>
                    
                    <div class="pub-actions">
                        <button onclick="searchForPub('${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}')" 
                                class="pub-action-btn search-btn">
                            üîç Find Online
                        </button>
                        <button onclick="openInGoogleMaps(null, null, '${pub.name.replace(/'/g, "\\'")}', '${pub.address}')" 
                                class="pub-action-btn directions-btn">
                            üß≠ Get Directions
                        </button>
                        <button onclick="toggleSplitScreenUpdateForm(${pub.pub_id})" 
                                class="pub-action-btn update-btn">
                            üìù Update Info
                        </button>
                    </div>
                    
                    <div class="update-form" id="split-form-${pub.pub_id}" style="display: none;">
                        ${createUpdateFormContent(pub.pub_id)}
                    </div>
                </div>
            `;
        }

        // ADD: New function for split screen update form toggle
        function toggleSplitScreenUpdateForm(pubId) {
            const form = document.getElementById(`split-form-${pubId}`);
            if (form) {
                const isVisible = form.style.display === 'block';
                form.style.display = isVisible ? 'none' : 'block';
                
                if (!isVisible) {
                    // Scroll to show the form
                    setTimeout(() => {
                        form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }, 100);
                    trackEvent('open_split_update_form', 'User Interaction', `pub_${pubId}`);
                }
            }
        }
        
        // ADD: Create update form content (reusable)
        function createUpdateFormContent(pubId) {
            return `
                <div class="update-mode">
                    <label><input type="radio" name="splitUpdateMode-${pubId}" value="add" checked> Add to existing</label>
                    <label><input type="radio" name="splitUpdateMode-${pubId}" value="replace"> Replace all</label>
                </div>
                <div class="beer-options-grid">
                    <div class="beer-option">
                        <div class="beer-option-header">
                            <label class="beer-type-label">
                                <input type="checkbox" id="split-bottle-${pubId}" onchange="handleSplitCheckboxChange(${pubId}, 'bottle')">
                                <span class="beer-icon">üç∫</span> Bottle
                            </label>
                        </div>
                        <div id="split-beer-input-bottle-${pubId}" class="beer-input-container">
                            <div class="beer-form-grid">
                                <input type="text" id="split-brewery-bottle-${pubId}" class="beer-input brewery-input" placeholder="Brewery">
                                <input type="text" id="split-beer-name-bottle-${pubId}" class="beer-input name-input" placeholder="Name">
                                <input type="text" id="split-beer-style-bottle-${pubId}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                            </div>
                        </div>
                    </div>
                    <div class="beer-option">
                        <div class="beer-option-header">
                            <label class="beer-type-label">
                                <input type="checkbox" id="split-tap-${pubId}" onchange="handleSplitCheckboxChange(${pubId}, 'tap')">
                                <span class="beer-icon">üö∞</span> Tap
                            </label>
                        </div>
                        <div id="split-beer-input-tap-${pubId}" class="beer-input-container">
                            <div class="beer-form-grid">
                                <input type="text" id="split-brewery-tap-${pubId}" class="beer-input brewery-input" placeholder="Brewery">
                                <input type="text" id="split-beer-name-tap-${pubId}" class="beer-input name-input" placeholder="Name">
                                <input type="text" id="split-beer-style-tap-${pubId}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                            </div>
                        </div>
                    </div>
                    <div class="beer-option">
                        <div class="beer-option-header">
                            <label class="beer-type-label">
                                <input type="checkbox" id="split-cask-${pubId}" onchange="handleSplitCheckboxChange(${pubId}, 'cask')">
                                <span class="beer-icon">üõ¢Ô∏è</span> Cask
                            </label>
                        </div>
                        <div id="split-beer-input-cask-${pubId}" class="beer-input-container">
                            <div class="beer-form-grid">
                                <input type="text" id="split-brewery-cask-${pubId}" class="beer-input brewery-input" placeholder="Brewery">
                                <input type="text" id="split-beer-name-cask-${pubId}" class="beer-input name-input" placeholder="Name">
                                <input type="text" id="split-beer-style-cask-${pubId}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                            </div>
                        </div>
                    </div>
                    <div class="beer-option">
                        <div class="beer-option-header">
                            <label class="beer-type-label">
                                <input type="checkbox" id="split-can-${pubId}" onchange="handleSplitCheckboxChange(${pubId}, 'can')">
                                <span class="beer-icon">ü•´</span> Can
                            </label>
                        </div>
                        <div id="split-beer-input-can-${pubId}" class="beer-input-container">
                            <div class="beer-form-grid">
                                <input type="text" id="split-brewery-can-${pubId}" class="beer-input brewery-input" placeholder="Brewery">
                                <input type="text" id="split-beer-name-can-${pubId}" class="beer-input name-input" placeholder="Name">
                                <input type="text" id="split-beer-style-can-${pubId}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="save-button-container">
                    <button class="save-beer-btn" onclick="submitSplitScreenUpdate(${pubId})">
                        <span class="save-icon">üíæ</span> Save Beer Updates
                    </button>
                </div>
            `;
        }
        
        // ADD: Handle checkbox changes in split screen
        function handleSplitCheckboxChange(pubId, type) {
            const checkbox = document.getElementById(`split-${type}-${pubId}`);
            const inputContainer = document.getElementById(`split-beer-input-${type}-${pubId}`);
            inputContainer.style.display = checkbox.checked ? 'block' : 'none';
            if (checkbox.checked) {
                inputContainer.querySelector('input').focus();
            }
        }
        
        // ADD: Submit split screen updates
        async function submitSplitScreenUpdate(pubId) {
            const bottle = document.getElementById(`split-bottle-${pubId}`).checked ? 1 : 0;
            const tap = document.getElementById(`split-tap-${pubId}`).checked ? 1 : 0;
            const cask = document.getElementById(`split-cask-${pubId}`).checked ? 1 : 0;
            const can = document.getElementById(`split-can-${pubId}`).checked ? 1 : 0;
            const updateMode = document.querySelector(`input[name="splitUpdateMode-${pubId}"]:checked`)?.value || 'add';
        
            showLoadingToast('Saving beer updates...');
        
            const updates = [];
            ['bottle', 'tap', 'cask', 'can'].forEach(format => {
                if (document.getElementById(`split-${format}-${pubId}`).checked) {
                    const brewery = document.getElementById(`split-brewery-${format}-${pubId}`).value || 'Unknown';
                    const beerName = document.getElementById(`split-beer-name-${format}-${pubId}`).value || 'Unknown';
                    const beerStyle = document.getElementById(`split-beer-style-${format}-${pubId}`).value || 'Unknown';
                    updates.push({ 
                        beer_format: format, 
                        beer_brewery: brewery,
                        beer_name: beerName,
                        beer_style: beerStyle
                    });
                }
            });
        
            try {
                const updateResponse = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pub_id: pubId, bottle, tap, cask, can })
                });
        
                if (updates.length > 0) {
                    await fetch('/update_beers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pub_id: pubId, updates, update_mode: updateMode })
                    });
                }
        
                const result = await updateResponse.json();
                hideLoadingToast();
                showSuccessToast(result.message || 'Beer updates saved successfully!');
                trackEvent('submit_split_beer_update', 'Community Contribution', `pub_${pubId}`);
                
                const form = document.getElementById(`split-form-${pubId}`);
                form.style.display = 'none';
                
                // Refresh the split screen with updated data
                setTimeout(() => {
                    createSplitScreenLayout(pubId);
                }, 1000);
                
            } catch (error) {
                console.error('Error submitting split screen update:', error);
                hideLoadingToast();
                showSuccessToast('Error saving updates. Please try again.');
            }
        }
        
        // ADD: New function - scroll to pub details in split screen
        function scrollToPubDetailsSplit() {
            const splitContainer = document.getElementById('split-screen-container');
            if (splitContainer) {
                splitContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // New function to highlight specific pub in results
        function highlightPubInResults(pubId) {
            // Remove any existing highlights
            document.querySelectorAll('.result-item').forEach(item => {
                item.style.background = '';
                item.style.border = '';
            });
            
            // Find and highlight the specific pub
            const pubResults = document.querySelectorAll('.result-item');
            pubResults.forEach(item => {
                const updateButton = item.querySelector(`[onclick*="toggleUpdateForm(${pubId})"]`);
                if (updateButton) {
                    item.style.background = 'rgba(102, 126, 234, 0.1)';
                    item.style.border = '2px solid #667eea';
                    item.style.borderRadius = '15px';
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        function openInGoogleMaps(lat, lng, pubName, address) {
            const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            } else {
                const googleMapsUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
                window.open(googleMapsUrl, '_blank');
            }
            
            trackEvent('open_navigation', 'External Navigation', pubName);
            showSuccessToast('üß≠ Opening directions...');
        }
        
        // Add this CSS for the pulsing animation - add to your style.css

        function searchForPub(pubName, postcode) {
            const searchQuery = `${pubName} ${postcode} pub`;
            const googleUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
            trackEvent('search_online', 'External Search', pubName);
            window.open(googleUrl, '_blank');
        }

        function formatBeerDetails(beerDetails, pub) {
            // Check if we have specific beer data
            if (!beerDetails || beerDetails === 'None' || beerDetails.trim() === '') {
                // Show generic GF availability instead
                return formatGenericGFAvailability(pub);
            }
            
            // Show specific beers if we have them
            return beerDetails.split(', ').map(beer => {
                const parts = beer.split(' - ');
                if (parts.length >= 2) {
                    const format = parts[0];
                    const details = parts.slice(1).join(' - ');
                    return `<div class="beer-item"><span class="beer-type">${format.charAt(0).toUpperCase() + format.slice(1)}:</span> ${details}</div>`;
                }
                return `<div class="beer-item">${beer}</div>`;
            }).join('');
        }

        // ADD: New function for showing generic GF availability
        function formatGenericGFAvailability(pub) {
            let gfOptions = [];
            let rotatingTap = false;
            
            // Check what formats are available
            if (pub.bottle) gfOptions.push('bottle');
            if (pub.tap) {
                gfOptions.push('tap');
                rotatingTap = true; // Assume tap might rotate
            }
            if (pub.cask) gfOptions.push('cask');
            if (pub.can) gfOptions.push('can');
            
            if (gfOptions.length === 0) {
                return '<div style="color: #9ca3af; font-style: italic;">‚ùì GF availability needs verification</div>';
            }
            
            let display = '<div class="gf-availability">';
            
            // Show confirmed formats
            display += '<div class="confirmed-formats">';
            display += '<strong style="color: #10b981;">‚úÖ Confirmed GF Options:</strong><br>';
            
            gfOptions.forEach(format => {
                const icons = {
                    bottle: 'üç∫',
                    tap: 'üö∞',
                    cask: 'üõ¢Ô∏è',
                    can: 'ü•´'
                };
                
                if (format === 'tap') {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)} <span class="rotating-note">(selection may vary)</span></div>`;
                } else {
                    display += `<div class="gf-format">${icons[format]} ${format.charAt(0).toUpperCase() + format.slice(1)}</div>`;
                }
            });
            display += '</div>';
            
            // Add helpful note
            display += '<div class="gf-note">üí° <em>Call ahead to confirm current selection</em></div>';
            display += '</div>';
            
            return display;
        }
        
        // ADD: Enhanced update form with better options
        function createEnhancedUpdateForm(pubId) {
            return `
                <div class="update-form" id="form-${pubId}" style="display: none;">
                    <!-- Availability Mode Selection -->
                    <div class="availability-mode">
                        <h4>üìã What type of update?</h4>
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="updateType-${pubId}" value="specific" checked onchange="handleUpdateTypeChange(${pubId})">
                                <span>üç∫ Add specific beers</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="updateType-${pubId}" value="generic" onchange="handleUpdateTypeChange(${pubId})">
                                <span>‚úÖ Just confirm GF available</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="radio" name="updateType-${pubId}" value="none" onchange="handleUpdateTypeChange(${pubId})">
                                <span>‚ùå No GF options</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Generic GF Confirmation (shown when "generic" selected) -->
                    <div id="generic-options-${pubId}" class="generic-gf-options" style="display: none;">
                        <h4>üç∫ Which formats have GF beer?</h4>
                        <div class="gf-format-grid">
                            <label><input type="checkbox" id="generic-bottle-${pubId}"> üç∫ Bottles</label>
                            <label><input type="checkbox" id="generic-tap-${pubId}"> üö∞ Tap (rotating)</label>
                            <label><input type="checkbox" id="generic-cask-${pubId}"> üõ¢Ô∏è Cask</label>
                            <label><input type="checkbox" id="generic-can-${pubId}"> ü•´ Cans</label>
                        </div>
                        <div class="helpful-note">
                            <small>üí° This tells coeliacs you have GF options, even if the specific beers change regularly</small>
                        </div>
                    </div>
                    
                    <!-- Specific Beer Entry (shown when "specific" selected) -->
                    <div id="specific-options-${pubId}" class="specific-beer-options">
                        <div class="update-mode">
                            <label><input type="radio" name="updateMode-${pubId}" value="add" checked> Add to existing</label>
                            <label><input type="radio" name="updateMode-${pubId}" value="replace"> Replace all</label>
                        </div>
                        
                        <!-- Your existing beer entry grid would go here -->
                        <div class="beer-options-grid">
                            <!-- NOTE: You'd replace this comment with your existing beer input grid -->
                        </div>
                    </div>
                    
                    <div class="save-button-container">
                        <button class="save-beer-btn" onclick="submitEnhancedUpdate(${pubId})">
                            üíæ Save Update
                        </button>
                    </div>
                </div>
            `;
        }
        
        // ADD: Handle update type changes
        function handleUpdateTypeChange(pubId) {
            const updateType = document.querySelector(`input[name="updateType-${pubId}"]:checked`).value;
            const genericOptions = document.getElementById(`generic-options-${pubId}`);
            const specificOptions = document.getElementById(`specific-options-${pubId}`);
            
            if (updateType === 'generic') {
                genericOptions.style.display = 'block';
                specificOptions.style.display = 'none';
            } else if (updateType === 'specific') {
                genericOptions.style.display = 'none';
                specificOptions.style.display = 'block';
            } else { // 'none'
                genericOptions.style.display = 'none';
                specificOptions.style.display = 'none';
            }
        }

        // Display search results with pagination
        function displaySearchResults(data, append = false) {
            console.log('displaySearchResults called with pagination support!');
            const results = document.getElementById('results');
            
            const pubs = Array.isArray(data) ? data : data.pubs;
            const pagination = data.pagination || null;
            
            if (!append) {
                results.innerHTML = '';
            }
            
            if (pubs.length === 0 && !append) {
                results.innerHTML = '<li class="no-results">No pubs found.</li>';
                return;
            }
            
            pubs.forEach(pub => {
                console.log('Processing pub:', pub);
                const li = document.createElement('li');
                let gfOptions = [];
                if (pub.bottle) gfOptions.push('Bottle');
                if (pub.tap) gfOptions.push('Tap');
                if (pub.cask) gfOptions.push('Cask');
                if (pub.can) gfOptions.push('Can');
                
                const gfText = gfOptions.length > 0 ? gfOptions.join(', ') : 'None';
                const beerDetails = pub.beer_details || 'None';
                
                let detailsDistanceText = '';
                const lat = parseFloat(pub.latitude);
                const lng = parseFloat(pub.longitude);
                
                if (userLocation && lat && lng && !isNaN(lat) && !isNaN(lng)) {
                    const distance = calculateDistance(
                        userLocation.lat, userLocation.lng,
                        lat, lng
                    );
                    detailsDistanceText = `<div style="color: #667eea; font-size: 14px; font-weight: 600; margin: 8px 0;">${distance.toFixed(2)} km from your location</div>`;
                }

                li.className = 'result-item';
                li.innerHTML = `
                    <div class="result-details">
                        <strong>${pub.name}</strong>
                        <div class="address">${pub.address}, ${pub.postcode}</div>
                        <div class="local-authority">${pub.local_authority}</div>
                        ${detailsDistanceText}
                        <div style="margin-top: 10px;">
                            <button onclick="searchForPub('${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}')" 
                                    style="margin-right: 8px; padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);">
                                Find Online
                            </button>
                            <button onclick="findOnMap(${pub.latitude || 'null'}, ${pub.longitude || 'null'}, '${pub.name.replace(/'/g, "\\'")}', '${pub.postcode}', ${pub.pub_id})" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                Find on Map
                            </button>
                            <button onclick="openInGoogleMaps(${pub.latitude}, ${pub.longitude}, '${pub.name.replace(/'/g, "\\'")}', '${pub.address}')" 
                                    style="padding: 6px 12px; font-size: 12px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                üß≠ Directions
                            </button>
                        </div>
                    </div>
                    <div class="beer-column">
                        <h4>Available Beers</h4>
                        <div class="beer-details">
                            ${formatBeerDetails(beerDetails, pub)}
                        </div>
                    </div>
                    <div class="button-column">
                        <button class="update-button" onclick="toggleUpdateForm(${pub.pub_id})">Update</button>
                    </div>
                    <div class="update-form" id="form-${pub.pub_id}" style="display: none;">
                        <div class="update-mode">
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="add" checked> Add New Beers</label>
                            <label><input type="radio" name="updateMode-${pub.pub_id}" value="replace"> Replace All Beers</label>
                        </div>
                        <div class="beer-options-grid">
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="bottle-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'bottle')">
                                        <span class="beer-icon">üç∫</span> Bottle
                                    </label>
                                </div>
                                <div id="beer-input-bottle-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-bottle-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-bottle-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-bottle-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="tap-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'tap')">
                                        <span class="beer-icon">üö∞</span> Tap
                                    </label>
                                </div>
                                <div id="beer-input-tap-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-tap-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-tap-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-tap-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="cask-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'cask')">
                                        <span class="beer-icon">üõ¢Ô∏è</span> Cask
                                    </label>
                                </div>
                                <div id="beer-input-cask-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-cask-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-cask-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-cask-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                            <div class="beer-option">
                                <div class="beer-option-header">
                                    <label class="beer-type-label">
                                        <input type="checkbox" id="can-${pub.pub_id}" onchange="handleCheckboxChange(${pub.pub_id}, 'can')">
                                        <span class="beer-icon">ü•´</span> Can
                                    </label>
                                </div>
                                <div id="beer-input-can-${pub.pub_id}" class="beer-input-container">
                                    <div class="beer-form-grid">
                                        <input type="text" id="brewery-can-${pub.pub_id}" class="beer-input brewery-input" placeholder="Brewery">
                                        <input type="text" id="beer-name-can-${pub.pub_id}" class="beer-input name-input" placeholder="Name">
                                        <input type="text" id="beer-style-can-${pub.pub_id}" class="beer-input type-input" placeholder="Style (IPA, Lager, etc.)">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="save-button-container">
                            <button class="save-beer-btn" onclick="submitUpdate(${pub.pub_id})">
                                <span class="save-icon">üíæ</span> Save Beer Updates
                            </button>
                        </div>
                    </div>
                `;
                results.appendChild(li);
                updateBeerInputs(pub.pub_id);
            });
            
            if (pagination && !append) {
                addPaginationControls(pagination);
            }
        }

        function addPaginationControls(pagination) {
            const results = document.getElementById('results');
            const paginationDiv = document.createElement('div');
            paginationDiv.className = 'pagination-controls';
            paginationDiv.innerHTML = `
                <div class="pagination-info">
                    Showing page ${pagination.page} of ${pagination.pages} (${pagination.total} total results)
                </div>
                <div class="pagination-buttons">
                    ${pagination.has_prev ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">‚Üê Previous</button>` : ''}
                    ${pagination.page > 2 ? `<button onclick="loadPage(1)" class="pagination-btn">1</button>` : ''}
                    ${pagination.page > 3 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page > 1 ? `<button onclick="loadPage(${pagination.page - 1})" class="pagination-btn">${pagination.page - 1}</button>` : ''}
                    <button class="pagination-btn active">${pagination.page}</button>
                    ${pagination.page < pagination.pages ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">${pagination.page + 1}</button>` : ''}
                    ${pagination.page < pagination.pages - 2 ? '<span class="pagination-dots">...</span>' : ''}
                    ${pagination.page < pagination.pages - 1 ? `<button onclick="loadPage(${pagination.pages})" class="pagination-btn">${pagination.pages}</button>` : ''}
                    ${pagination.has_next ? `<button onclick="loadPage(${pagination.page + 1})" class="pagination-btn">Next ‚Üí</button>` : ''}
                </div>
            `;
            results.appendChild(paginationDiv);
        }

        async function loadPage(page) {
            currentPage = page;
            const url = `/search?query=${encodeURIComponent(currentQuery)}&search_type=${currentSearchType}&page=${page}` + (currentGfOnly ? '&gf_only=true' : '');
            
            showLoadingToast('Loading page...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading...</li>';
            
            try {
                const response = await fetch(url);
                const data = await response.json();
                
                hideLoadingToast();
                displaySearchResults(data);
                addPubMarkersToMap(data.pubs || data);
                
                AppState.save();
                results.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading page:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading results. Please try again.</li>';
            }
        }

        async function searchSpecificPub(pubId) {
            console.log('searchSpecificPub called with ID:', pubId);
            showLoadingToast('Loading pub details...');
            const results = document.getElementById('results');
            results.innerHTML = '<li class="loading">Loading pub details...</li>';
            
            try {
                const url = `/search?pub_id=${pubId}`;
                console.log('Fetching URL:', url);
                const response = await fetch(url);
                const pubs = await response.json();
                
                console.log('Response from server:', pubs);
                hideLoadingToast();
                
                if (pubs.length > 0) {
                    console.log('Calling displaySearchResults with:', pubs);
                    displaySearchResults(pubs);
                    addPubMarkersToMap(pubs);
                    
                    const pub = pubs[0];
                    trackPubView(pub.name);
                    
                    if (pub.latitude && pub.longitude) {
                        smartShowMap();
                        map.setView([pub.latitude, pub.longitude], 15);
                    }
                    
                    currentQuery = '';
                    currentSearchType = 'all';
                    currentGfOnly = false;
                    currentPage = 1;
                    AppState.save(pubId);
                } else {
                    results.innerHTML = '<li class="no-results">Pub not found.</li>';
                }
            } catch (error) {
                console.error('Error searching for specific pub:', error);
                hideLoadingToast();
                results.innerHTML = '<li class="no-results">Error loading pub details.</li>';
            }
        }

        function toggleUpdateForm(pubId) {
            const form = document.getElementById(`form-${pubId}`);
            const isVisible = form.style.display === 'block';
            form.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateBeerInputs(pubId);
                trackEvent('open_update_form', 'User Interaction', `pub_${pubId}`);
            }
        }

        function updateBeerInputs(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked;
            const tap = document.getElementById(`tap-${pubId}`).checked;
            const cask = document.getElementById(`cask-${pubId}`).checked;
            const can = document.getElementById(`can-${pubId}`).checked;

            document.getElementById(`beer-input-bottle-${pubId}`).style.display = bottle ? 'block' : 'none';
            document.getElementById(`beer-input-tap-${pubId}`).style.display = tap ? 'block' : 'none';
            document.getElementById(`beer-input-cask-${pubId}`).style.display = cask ? 'block' : 'none';
            document.getElementById(`beer-input-can-${pubId}`).style.display = can ? 'block' : 'none';
        }

        function handleCheckboxChange(pubId, type) {
            const checkbox = document.getElementById(`${type}-${pubId}`);
            const inputContainer = document.getElementById(`beer-input-${type}-${pubId}`);
            inputContainer.style.display = checkbox.checked ? 'block' : 'none';
            if (checkbox.checked) {
                inputContainer.querySelector('input').focus();
                trackEvent('select_beer_format', 'Beer Update', type);
            }
        }

        async function submitUpdate(pubId) {
            const bottle = document.getElementById(`bottle-${pubId}`).checked ? 1 : 0;
            const tap = document.getElementById(`tap-${pubId}`).checked ? 1 : 0;
            const cask = document.getElementById(`cask-${pubId}`).checked ? 1 : 0;
            const can = document.getElementById(`can-${pubId}`).checked ? 1 : 0;
            const updateMode = document.querySelector(`input[name="updateMode-${pubId}"]:checked`)?.value || 'add';

            showLoadingToast('Saving beer updates...');

            const updates = [];
            if (bottle) {
                const brewery = document.getElementById(`brewery-bottle-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-bottle-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-bottle-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'bottle', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (tap) {
                const brewery = document.getElementById(`brewery-tap-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-tap-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-tap-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'tap', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (cask) {
                const brewery = document.getElementById(`brewery-cask-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-cask-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-cask-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'cask', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }
            if (can) {
                const brewery = document.getElementById(`brewery-can-${pubId}`).value || 'Unknown';
                const beerName = document.getElementById(`beer-name-can-${pubId}`).value || 'Unknown';
                const beerStyle = document.getElementById(`beer-style-can-${pubId}`).value || 'Unknown';
                updates.push({ 
                    beer_format: 'can', 
                    beer_brewery: brewery,
                    beer_name: beerName,
                    beer_style: beerStyle
                });
            }

            try {
                const updateResponse = await fetch('/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pub_id: pubId, bottle, tap, cask, can })
                });

                if (updates.length > 0) {
                    await fetch('/update_beers', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pub_id: pubId, updates, update_mode: updateMode })
                    });
                }

                const result = await updateResponse.json();
                hideLoadingToast();
                showSuccessToast(result.message || 'Beer updates saved successfully!');
                trackEvent('submit_beer_update', 'Community Contribution', `pub_${pubId}`);
                
                const form = document.getElementById(`form-${pubId}`);
                form.style.display = 'none';
                
                // Refresh the pub data to show updates
                await searchSpecificPub(pubId);
                
            } catch (error) {
                console.error('Error submitting update:', error);
                hideLoadingToast();
                showSuccessToast('Error saving updates. Please try again.');
            }
        }

        // ============================================================================
        // OPTIMIZED FRONTEND - HANDLES AUTO BEER ID GENERATION
        // ============================================================================
        
        // Enhanced submit function with clear new beer handling
        async function submitValidatedBeerUpdate(pubId) {
            try {
                const beerUpdates = [];
                const beerOptions = document.querySelectorAll(`#form-${pubId} .beer-option`);
                
                beerOptions.forEach(option => {
                    const checkbox = option.querySelector('input[type="checkbox"]');
                    if (!checkbox.checked) return;
                    
                    const format = option.dataset.format;
                    const brewerySelect = option.querySelector('.brewery-select');
                    const beerSelect = option.querySelector('.beer-select');
                    
                    const updateData = {
                        pub_id: pubId,
                        beer_format: format
                    };
                    
                    // CASE 1: Existing beer from database
                    if (beerSelect.value && beerSelect.value !== 'NEW_BEER' && beerSelect.value !== '') {
                        updateData.beer_id = parseInt(beerSelect.value);
                        updateData.is_new_beer = false;
                        
                        console.log(`üìã Existing beer selected: beer_id ${updateData.beer_id}`);
                    }
                    // CASE 2: New beer (will get auto-generated beer_id)
                    else if (beerSelect.value === 'NEW_BEER' || brewerySelect.value === 'NEW_BREWERY') {
                        updateData.is_new_beer = true;
                        
                        // Get brewery name
                        if (brewerySelect.value === 'NEW_BREWERY') {
                            const newBreweryField = option.querySelector('.new-brewery-name');
                            updateData.brewery = newBreweryField?.value || '';
                        } else {
                            updateData.brewery = brewerySelect.value;
                        }
                        
                        // Get new beer details
                        const newBeerFields = option.querySelector('.new-beer-fields');
                        if (newBeerFields) {
                            updateData.beer_name = newBeerFields.querySelector('.new-beer-name')?.value || '';
                            updateData.style = newBeerFields.querySelector('.new-beer-style')?.value || '';
                            updateData.abv = parseFloat(newBeerFields.querySelector('.new-beer-abv')?.value) || 0;
                            updateData.vegan_status = newBeerFields.querySelector('.new-beer-vegan')?.value || 'unknown';
                            updateData.category = 'gluten_removed'; // Default
                        }
                        
                        console.log(`üÜï New beer will be created: ${updateData.brewery} - ${updateData.beer_name}`);
                    }
                    
                    // Add user details
                    updateData.email = document.getElementById(`user-email-${pubId}`)?.value || '';
                    updateData.name = document.getElementById(`user-name-${pubId}`)?.value || '';
                    updateData.notes = document.getElementById(`user-notes-${pubId}`)?.value || '';
                    
                    beerUpdates.push(updateData);
                });
                
                if (beerUpdates.length === 0) {
                    showSuccessToast('Please select at least one beer format to update.');
                    return;
                }
                
                // Submit updates
                showLoadingToast('Submitting for validation...');
                
                let successCount = 0;
                let newBeerCount = 0;
                let existingBeerCount = 0;
                
                for (const update of beerUpdates) {
                    try {
                        const response = await fetch('/api/submit_beer_update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(update)
                        });
                        
                        if (response.ok) {
                            const result = await response.json();
                            successCount++;
                            
                            if (result.will_create_new_beer) {
                                newBeerCount++;
                            } else {
                                existingBeerCount++;
                            }
                            
                            console.log(`‚úÖ Update submitted: pending_id ${result.pending_id}`);
                        } else {
                            const error = await response.json();
                            console.error('Update failed:', error);
                        }
                    } catch (error) {
                        console.error('Error submitting update:', error);
                    }
                }
                
                hideLoadingToast();
                
                if (successCount === beerUpdates.length) {
                    let message = `üéâ ${successCount} beer update(s) submitted!`;
                    
                    if (newBeerCount > 0 && existingBeerCount > 0) {
                        message += ` ${newBeerCount} new beers will be created, ${existingBeerCount} existing beers linked.`;
                    } else if (newBeerCount > 0) {
                        message += ` ${newBeerCount} new beer(s) will be created with auto-generated IDs.`;
                    } else {
                        message += ` ${existingBeerCount} existing beer(s) will be linked.`;
                    }
                    
                    message += ' We\'ll review and approve them soon!';
                    
                    showSuccessToast(message);
                    closeUpdateForm(pubId);
                } else {
                    showSuccessToast(`‚ö†Ô∏è ${successCount}/${beerUpdates.length} updates submitted. Some failed - please try again.`);
                }
                
            } catch (error) {
                console.error('Error submitting beer updates:', error);
                hideLoadingToast();
                showSuccessToast('Error submitting updates. Please try again.');
            }
        }
        
        // Enhanced brewery dropdown population
        function populateBreweryDropdown() {
            const brewerySelects = document.querySelectorAll('.brewery-select');
            
            brewerySelects.forEach(select => {
                if (select.children.length > 1) return; // Already populated
                
                select.innerHTML = '<option value="">Select brewery...</option>';
                
                currentBreweries.forEach(brewery => {
                    const option = document.createElement('option');
                    option.value = brewery;
                    option.textContent = brewery;
                    select.appendChild(option);
                });
                
                // Add "New brewery" option
                const newOption = document.createElement('option');
                newOption.value = 'NEW_BREWERY';
                newOption.textContent = 'üÜï Add new brewery (will auto-generate beer ID)';
                select.appendChild(newOption);
            });
        }
        
        // Enhanced beer dropdown population
        async function loadBeersByBrewery(breweryName, targetSelectId) {
            try {
                showLoadingToast('Loading beers...');
                
                const response = await fetch(`/api/brewery/${encodeURIComponent(breweryName)}/beers`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const beers = await response.json();
                
                const beerSelect = document.getElementById(targetSelectId);
                beerSelect.innerHTML = '<option value="">Select beer...</option>';
                
                beers.forEach(beer => {
                    const option = document.createElement('option');
                    option.value = beer.beer_id; // This is the existing beer_id
                    option.textContent = `${beer.name} (${beer.style}, ${beer.abv}%)`;
                    option.dataset.beerId = beer.beer_id;
                    option.dataset.brewery = breweryName;
                    option.dataset.name = beer.name;
                    option.dataset.style = beer.style;
                    option.dataset.abv = beer.abv;
                    option.dataset.vegan = beer.vegan_status;
                    beerSelect.appendChild(option);
                });
                
                // Add "New beer" option (will get auto-generated beer_id)
                const newOption = document.createElement('option');
                newOption.value = 'NEW_BEER';
                newOption.textContent = 'üÜï Add new beer (will auto-generate beer ID)';
                beerSelect.appendChild(newOption);
                
                beerSelect.disabled = false;
                hideLoadingToast();
                
            } catch (error) {
                console.error('Error loading beers:', error);
                hideLoadingToast();
                showSuccessToast('Error loading beers. Please try again.');
            }
        }

        // Enhanced new beer fields with clearer messaging
        function showNewBeerFields(container) {
            let newBeerFields = container.querySelector('.new-beer-fields');
            
            if (!newBeerFields) {
                newBeerFields = document.createElement('div');
                newBeerFields.className = 'new-beer-fields';
                newBeerFields.innerHTML = `
                    <div class="new-beer-form">
                        <h5>üÜï New Beer Details</h5>
                        <div class="auto-id-notice">
                            <small>üí° A new beer_id will be auto-generated when approved</small>
                        </div>
                        <div class="form-row">
                            <input type="text" class="new-beer-name" placeholder="Beer name *" required>
                            <input type="text" class="new-beer-style" placeholder="Style (IPA, Lager, etc.)">
                        </div>
                        <div class="form-row">
                            <input type="number" class="new-beer-abv" placeholder="ABV %" step="0.1" min="0" max="15">
                            <select class="new-beer-vegan">
                                <option value="unknown">Vegan status unknown</option>
                                <option value="vegan">Vegan friendly</option>
                                <option value="not_vegan">Not vegan</option>
                            </select>
                        </div>
                        <div class="category-selection">
                            <label>
                                <input type="radio" name="category-${Date.now()}" value="gluten_removed" checked>
                                ‚öóÔ∏è Gluten Removed (most common)
                            </label>
                            <label>
                                <input type="radio" name="category-${Date.now()}" value="no_gluten_ingredients">
                                üåæ No Gluten Ingredients (dedicated GF brewery)
                            </label>
                        </div>
                        <small>‚úÖ Will be added to beers table with auto-generated beer_id when approved</small>
                    </div>
                `;
                container.appendChild(newBeerFields);
            }
            
            newBeerFields.style.display = 'block';
        }
        
        // Enhanced validation status display
        function updateValidationStatus(container, isNewBeer) {
            const statusElement = container.querySelector('.validation-status');
            if (statusElement) {
                if (isNewBeer) {
                    statusElement.textContent = 'Will create new beer_id';
                    statusElement.className = 'validation-status new-beer';
                } else {
                    statusElement.textContent = 'Will link existing beer';
                    statusElement.className = 'validation-status existing-beer';
                }
            }
        }
        
        // Update change handlers to show status
        function setupBeerEventListener() {
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('beer-select')) {
                    const beerValue = e.target.value;
                    const formContainer = e.target.closest('.beer-option');
                    
                    if (beerValue === 'NEW_BEER') {
                        showNewBeerFields(formContainer);
                        updateValidationStatus(formContainer, true);
                    } else if (beerValue) {
                        hideNewBeerFields(formContainer);
                        updateValidationStatus(formContainer, false);
                    } else {
                        hideNewBeerFields(formContainer);
                        updateValidationStatus(formContainer, false);
                    }
                }
            });
        }
        
        function setupBreweryEventListener() {
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('brewery-select')) {
                    const breweryName = e.target.value;
                    const formContainer = e.target.closest('.beer-option');
                    const beerSelect = formContainer.querySelector('.beer-select');
                    
                    if (breweryName && breweryName !== 'NEW_BREWERY') {
                        loadBeersByBrewery(breweryName, beerSelect.id);
                        hideNewBeerFields(formContainer);
                        hideNewBreweryFields(formContainer);
                    } else if (breweryName === 'NEW_BREWERY') {
                        showNewBreweryFields(formContainer);
                        showNewBeerFields(formContainer);
                        beerSelect.disabled = true;
                        beerSelect.innerHTML = '<option value="">Will create new beer</option>';
                        updateValidationStatus(formContainer, true);
                    } else {
                        beerSelect.disabled = true;
                        beerSelect.innerHTML = '<option value="">Select beer...</option>';
                        hideNewBeerFields(formContainer);
                        hideNewBreweryFields(formContainer);
                    }
                }
            });
        }
        
        // Helper function to close update form
        function closeUpdateForm(pubId) {
            const form = document.getElementById(`form-${pubId}`);
            if (form) {
                form.style.display = 'none';
                
                // Reset form
                const checkboxes = form.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
                
                const selects = form.querySelectorAll('select');
                selects.forEach(select => {
                    select.selectedIndex = 0;
                    if (select.classList.contains('beer-select')) {
                        select.disabled = true;
                    }
                });
                
                // Hide all selection areas
                const selectionAreas = form.querySelectorAll('.beer-selection-area');
                selectionAreas.forEach(area => area.classList.remove('active'));
                
                // Clear user inputs
                const inputs = form.querySelectorAll('input[type="text"], input[type="email"], textarea');
                inputs.forEach(input => input.value = '');
            }
        }
        
        console.log('üç∫ Optimized beer update system loaded - auto beer_id generation enabled!');

        // ENHANCED SEARCH FUNCTION WITH POSTCODE DETECTION
        async function searchPubs() {
            const query = document.getElementById('searchInput').value.trim();
            const searchType = document.getElementById('searchType').value;
            const gfOnly = document.getElementById('gfOnly').checked;
            const results = document.getElementById('results');
            
            if (!query) {
                results.innerHTML = '<li class="no-results">Please enter a search term.</li>';
                return;
            }
            
            currentQuery = query;
            currentSearchType = searchType;
            currentGfOnly = gfOnly;
            currentPage = 1;
            
            showResultsSection();
            showLoadingToast('Searching...');
            results.innerHTML = '<li class="loading">Searching...</li>';
            
            // Check if query looks like a postcode
            const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
            
            try {
                let url;
                let searchResults;
                
                if (isPostcode && (searchType === 'postcode' || searchType === 'all')) {
                    // Handle postcode search - geocode then find nearby
                    console.log('Detected postcode search:', query);
                    showLoadingToast('Finding location...');
                    
                    // First geocode the postcode
                    const geocodeResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&countrycodes=gb&limit=1`);
                    const geocodeData = await geocodeResponse.json();
                    
                    if (geocodeData && geocodeData.length > 0) {
                        const lat = parseFloat(geocodeData[0].lat);
                        const lng = parseFloat(geocodeData[0].lon);
                        
                        showLoadingToast('Finding nearby pubs...');
                        
                        // Now search for nearby pubs
                        url = `/nearby?lat=${lat}&lng=${lng}&radius=5&gf_only=${gfOnly}`;
                        
                        // Auto-show map and update to show the postcode area
                        smartShowMap();
                        if (map) {
                            map.setView([lat, lng], 14);
                            
                            // Add a marker for the searched postcode
                            if (window.postcodeMarker) {
                                map.removeLayer(window.postcodeMarker);
                            }
                            window.postcodeMarker = L.marker([lat, lng], {
                                icon: L.divIcon({
                                    className: 'postcode-marker',
                                    html: `<div style="
                                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                        width: 30px;
                                        height: 30px;
                                        border-radius: 50%;
                                        border: 3px solid white;
                                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        color: white;
                                        font-weight: bold;
                                        font-size: 14px;
                                    ">üìç</div>`,
                                    iconSize: [36, 36],
                                    iconAnchor: [18, 18]
                                })
                            }).addTo(map);
                            
                            window.postcodeMarker.bindPopup(`<strong>${query}</strong><br>Searching nearby pubs...`).openPopup();
                        }
                    } else {
                        throw new Error('Postcode not found');
                    }
                } else {
                    // Regular text search
                    url = `/search?query=${encodeURIComponent(query)}&search_type=${searchType}&page=1` + (gfOnly ? '&gf_only=true' : '');
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const pubs = Array.isArray(data) ? data : data.pubs;
                
                hideLoadingToast();
                
                if (pubs.length === 0) {
                    if (isPostcode) {
                        results.innerHTML = `<li class="no-results">No pubs found within 5km of ${query}. Try expanding your search area.</li>`;
                        showSuccessToast(`No pubs found near ${query}`);
                    } else {
                        results.innerHTML = '<li class="no-results">No pubs found.</li>';
                        showSuccessToast('No pubs found for your search');
                    }
                    return;
                }
                
                displaySearchResults(data);
                addPubMarkersToMap(pubs);
                
                AppState.save();
                trackSearch(query, searchType, pubs.length);
                
                // Show success message for postcode searches
                if (isPostcode && pubs.length > 0) {
                    showSuccessToast(`‚úÖ Found ${pubs.length} pubs within 5km of ${query}`);
                } else {
                    showSuccessToast(`Found ${pubs.length} pubs matching "${query}"`);
                }
                
            } catch (error) {
                console.error('Error searching pubs:', error);
                hideLoadingToast();
                
                if (isPostcode) {
                    results.innerHTML = `<li class="no-results">Could not find location for "${query}". Please check the postcode and try again.</li>`;
                    showSuccessToast(`Could not find location for "${query}"`);
                } else {
                    results.innerHTML = '<li class="no-results">Error searching pubs. Please try again.</li>';
                    showSuccessToast('Error searching pubs. Please try again.');
                }
            }
        }

        // Initialize dropdowns specifically for report modal
        async function initializeReportModalDropdowns() {
            try {
                console.log('üîÑ Initializing report modal dropdowns...');
                
                // Load breweries for the report modal
                await loadBreweriesForReportModal();
                
                // Setup event listeners for report modal
                setupReportModalEventListeners();
                
                console.log('‚úÖ Report modal dropdowns initialized');
                
            } catch (error) {
                console.error('‚ùå Error initializing report modal dropdowns:', error);
            }
        }
        
        // Load breweries specifically for report modal
        async function loadBreweriesForReportModal() {
            try {
                const response = await fetch('/api/breweries');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const breweries = await response.json();
                
                // Find brewery input in report modal
                const breweryInput = document.getElementById('reportBrewery');
                if (!breweryInput) {
                    console.warn('‚ö†Ô∏è Brewery input not found in report modal');
                    return;
                }
                
                // Convert input to dropdown
                convertBreweryInputToDropdown(breweryInput, breweries);
                
                console.log(`üìö Loaded ${breweries.length} breweries for report modal`);
                
            } catch (error) {
                console.error('‚ùå Error loading breweries for report modal:', error);
                // Fallback: keep as text input
            }
        }
        
        // Convert brewery text input to dropdown
        function convertBreweryInputToDropdown(breweryInput, breweries) {
            // Create new select element
            const brewerySelect = document.createElement('select');
            brewerySelect.id = 'reportBrewery';
            brewerySelect.name = breweryInput.name;
            brewerySelect.className = 'brewery-select-report';
            brewerySelect.style.cssText = breweryInput.style.cssText;
            
            // Add default option
            brewerySelect.innerHTML = '<option value="">Select brewery...</option>';
            
            // Add brewery options
            breweries.forEach(brewery => {
                const option = document.createElement('option');
                option.value = brewery;
                option.textContent = brewery;
                brewerySelect.appendChild(option);
            });
            
            // Add "New brewery" option
            const newOption = document.createElement('option');
            newOption.value = 'NEW_BREWERY';
            newOption.textContent = 'üÜï Add new brewery';
            brewerySelect.appendChild(newOption);
            
            // Replace input with select
            breweryInput.parentNode.replaceChild(brewerySelect, breweryInput);
            
            console.log('‚úÖ Converted brewery input to dropdown');
        }
        
        // Setup event listeners for report modal
        function setupReportModalEventListeners() {
            // Brewery selection handler
            const brewerySelect = document.getElementById('reportBrewery');
            if (brewerySelect) {
                brewerySelect.addEventListener('change', function() {
                    const selectedBrewery = this.value;
                    handleReportBreweryChange(selectedBrewery);
                });
            }
            
            // Beer name input for auto-suggestions
            const beerNameInput = document.getElementById('reportBeerName');
            if (beerNameInput) {
                beerNameInput.addEventListener('input', function() {
                    const brewerySelect = document.getElementById('reportBrewery');
                    if (brewerySelect && brewerySelect.value && brewerySelect.value !== 'NEW_BREWERY') {
                        suggestBeersForBrewery(brewerySelect.value, this.value);
                    }
                });
            }
        }

        // REPLACE - Enhanced brewery selection handler
        async function handleReportBreweryChange(selectedBrewery) {
            const beerNameInput = document.getElementById('reportBeerName');
            const beerStyleInput = document.getElementById('reportBeerStyle');
            
            // Clear existing beer data
            clearBeerNameDropdown();
            clearBeerSuggestions();
            
            if (!selectedBrewery) {
                return;
            }
            
            if (selectedBrewery === 'NEW_BREWERY') {
                console.log('üÜï New brewery selected');
                return;
            }
            
            // Load beers for selected brewery and convert to dropdown
            try {
                showLoadingToast('Loading beers...');
                
                const response = await fetch(`/api/brewery/${encodeURIComponent(selectedBrewery)}/beers`);
                if (response.ok) {
                    const beers = await response.json();
                    console.log(`üìö Loaded ${beers.length} beers for ${selectedBrewery}`);
                    
                    // Convert beer name input to dropdown
                    convertBeerNameToDropdown(beers);
                    
                    hideLoadingToast();
                } else {
                    throw new Error('Failed to load beers');
                }
            } catch (error) {
                console.error('Error loading beers:', error);
                hideLoadingToast();
                showSuccessToast('Error loading beers for this brewery');
            }
        }
        
        // NEW - Convert beer name input to dropdown
        function convertBeerNameToDropdown(beers) {
            const beerNameInput = document.getElementById('reportBeerName');
            if (!beerNameInput) return;
            
            // Create new select element
            const beerNameSelect = document.createElement('select');
            beerNameSelect.id = 'reportBeerName';
            beerNameSelect.name = beerNameInput.name;
            beerNameSelect.className = 'beer-name-select-report';
            beerNameSelect.style.cssText = beerNameInput.style.cssText;
            
            // Add default option
            beerNameSelect.innerHTML = '<option value="">Select beer...</option>';
            
            // Add beer options
            beers.forEach(beer => {
                const option = document.createElement('option');
                option.value = beer.beer_id;
                option.textContent = beer.name; // CLEAN - no brackets!
                
                // Store beer data in option for later use
                option.dataset.beerName = beer.name;
                option.dataset.style = beer.style;
                option.dataset.abv = beer.abv;
                option.dataset.veganStatus = beer.vegan_status;
                option.dataset.glutenStatus = beer.gluten_status;
                
                beerNameSelect.appendChild(option);
            });
            
            // Add "New beer" option
            const newOption = document.createElement('option');
            newOption.value = 'NEW_BEER';
            newOption.textContent = 'üÜï Add new beer not listed';
            beerNameSelect.appendChild(newOption);
            
            // Replace input with select
            beerNameInput.parentNode.replaceChild(beerNameSelect, beerNameInput);
            
            // Add change event listener for auto-population
            beerNameSelect.addEventListener('change', function() {
                handleBeerNameSelection(this);
            });
            
            console.log(`‚úÖ Converted beer name to dropdown with ${beers.length} options`);
        }
        
        function handleBeerNameSelection(selectElement) {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const beerStyleInput = document.getElementById('reportBeerStyle');
            const beerStyleGroup = document.getElementById('beerStyleGroup');
            
            if (!selectedOption || !beerStyleInput) return;
            
            // Clear all previous classes
            beerStyleInput.classList.remove('beer-style-locked', 'beer-style-editable', 'beer-style-disabled');
            
            if (selectedOption.value === 'NEW_BEER') {
                // NEW BEER - Show style field and allow editing
                if (beerStyleGroup) beerStyleGroup.style.display = 'block';
                beerStyleInput.value = '';
                beerStyleInput.placeholder = 'Enter beer style (IPA, Lager, etc.)';
                beerStyleInput.disabled = false;
                beerStyleInput.readOnly = false;
                beerStyleInput.classList.add('beer-style-editable');
                
                // Add clean indicator (no "new beer" text)
                addCleanStyleIndicator('üÜï Enter style for new beer', 'new');
                
                console.log('üÜï New beer selected - style field editable');
                
            } else if (selectedOption.value && selectedOption.value !== '') {
                // EXISTING BEER - HIDE style field entirely, show beer info
                if (beerStyleGroup) beerStyleGroup.style.display = 'none';
                
                // KEEP the existing beer info display
                showBeerInfo(selectedOption);
                
                console.log('üîí Existing beer selected - style field hidden');
                
            } else {
                // NO SELECTION - Hide style field
                if (beerStyleGroup) beerStyleGroup.style.display = 'none';
                removeStyleIndicator();
                clearBeerInfo();
            }
        }

        // 2. ADD this NEW function:
        function showCleanBeerInfo(selectedOption) {
            const selectedBeerInfo = document.getElementById('selectedBeerInfo');
            const beerName = selectedOption.getAttribute('data-beer-name') || selectedOption.textContent.split(' (')[0];
            const style = selectedOption.getAttribute('data-style') || 'Unknown';
            const abv = selectedOption.getAttribute('data-abv') || 'Unknown';
            
            document.getElementById('selectedBeerName').textContent = beerName;
            document.getElementById('selectedBeerDetails').textContent = `${style} ‚Ä¢ ${abv}% ABV`;
            
            selectedBeerInfo.style.display = 'block';
        }
        
        // 3. ADD this NEW function:
        async function showCurrentPubBeers(pubData) {
            const currentPubBeers = document.getElementById('currentPubBeers');
            const pubBeersList = document.getElementById('pubBeersList');
            
            if (!pubData || !pubData.pub_id) {
                currentPubBeers.style.display = 'none';
                return;
            }
            
            try {
                // Fetch current beers for this pub
                const response = await fetch(`/api/pub/${pubData.pub_id}/current_beers`);
                if (response.ok) {
                    const beers = await response.json();
                    
                    if (beers.length > 0) {
                        pubBeersList.innerHTML = beers.map(beer => `
                            <div class="pub-beer-item">
                                ${beer.format_icon} ${beer.format}: ${beer.brewery} ${beer.name} (${beer.style})
                            </div>
                        `).join('');
                        
                        currentPubBeers.style.display = 'block';
                    } else {
                        currentPubBeers.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading current pub beers:', error);
                currentPubBeers.style.display = 'none';
            }
        }
        
        // REPLACE - Clean visual indicator function
        function addStyleIndicator(message, type) {
            // Remove existing indicator
            removeStyleIndicator();
            
            const beerStyleInput = document.getElementById('reportBeerStyle');
            if (!beerStyleInput) return;
            
            // Create indicator element with CSS classes
            const indicator = document.createElement('div');
            indicator.id = 'beer-style-indicator';
            indicator.className = `beer-style-indicator ${type}`;
            indicator.textContent = message;
            
            // Insert after beer style input
            beerStyleInput.parentNode.insertBefore(indicator, beerStyleInput.nextSibling);
        }
        
        // REPLACE - Clean beer info display
        function showBeerInfo(selectedOption) {
            const beerName = selectedOption.getAttribute('data-beer-name') || selectedOption.textContent.split(' (')[0];
            const abv = selectedOption.getAttribute('data-abv') || 'Unknown';
            const veganStatus = selectedOption.getAttribute('data-vegan') || 'Unknown';
            const glutenStatus = selectedOption.getAttribute('data-gluten') || 'Unknown';
            const style = selectedOption.getAttribute('data-style') || 'Unknown';
            
            // Find or create info div
            let infoDiv = document.getElementById('selected-beer-info');
            
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'selected-beer-info';
                infoDiv.className = 'selected-beer-info';
                
                // Insert after beer name select
                const beerNameSelect = document.getElementById('reportBeerName');
                beerNameSelect.parentNode.insertBefore(infoDiv, beerNameSelect.nextSibling);
            }
            
            // CLEAN beer info display - remove "STYLE LOCKED" badge
            infoDiv.innerHTML = `
                <div class="beer-info-header">
                    <strong>üìä Selected Beer Details</strong>
                </div>
                <div class="beer-info-grid">
                    <div class="beer-info-item">
                        <span class="beer-info-label">üç∫ Style:</span>
                        <span class="beer-info-value">${style}</span>
                    </div>
                    <div class="beer-info-item">
                        <span class="beer-info-label">üìä ABV:</span>
                        <span class="beer-info-value">${abv}%</span>
                    </div>
                    <div class="beer-info-item">
                        <span class="beer-info-label">üå± Vegan:</span>
                        <span class="beer-info-value">${veganStatus}</span>
                    </div>
                    <div class="beer-info-item">
                        <span class="beer-info-label">‚öóÔ∏è Gluten:</span>
                        <span class="beer-info-value">${glutenStatus.replace('_', ' ')}</span>
                    </div>
                </div>
            `;
            
            console.log(`üìä Showing clean info for: ${beerName}`);
        }

        // 4. ADD function to clear beer info
        function clearBeerInfo() {
            const infoDiv = document.getElementById('selected-beer-info');
            if (infoDiv) {
                infoDiv.remove();
            }
        }
        
        // 5. ADD the pub beer history feature
        async function showCurrentPubBeers(pubData) {
            const currentPubBeers = document.getElementById('currentPubBeers');
            const pubBeersList = document.getElementById('pubBeersList');
            
            if (!pubData || !pubData.pub_id) {
                if (currentPubBeers) currentPubBeers.style.display = 'none';
                return;
            }
            
            try {
                // Fetch current beers for this pub
                const response = await fetch(`/api/pub/${pubData.pub_id}/current_beers`);
                if (response.ok) {
                    const beers = await response.json();
                    
                    if (beers.length > 0) {
                        pubBeersList.innerHTML = beers.map(beer => `
                            <div class="pub-beer-item">
                                ${beer.format_icon} ${beer.format}: <strong>${beer.brewery} ${beer.name}</strong> (${beer.style})
                            </div>
                        `).join('');
                        
                        currentPubBeers.style.display = 'block';
                    } else {
                        currentPubBeers.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading current pub beers:', error);
                if (currentPubBeers) currentPubBeers.style.display = 'none';
            }
        }
        
        // REPLACE - Clean clear function
        function clearBeerNameDropdown() {
            const beerNameSelect = document.getElementById('reportBeerName');
            if (!beerNameSelect || beerNameSelect.tagName !== 'SELECT') return;
            
            // Create new input element
            const beerNameInput = document.createElement('input');
            beerNameInput.type = 'text';
            beerNameInput.id = 'reportBeerName';
            beerNameInput.name = beerNameSelect.name;
            beerNameInput.className = beerNameSelect.className.replace('beer-name-select-report', '');
            beerNameInput.placeholder = 'Beer name';
            
            // Replace select with input
            beerNameSelect.parentNode.replaceChild(beerNameInput, beerNameSelect);
            
            // Clear beer info
            const infoDiv = document.getElementById('selected-beer-info');
            if (infoDiv) {
                infoDiv.remove();
            }
            
            // Remove style indicator
            removeStyleIndicator();
            
            // Reset beer style to clean state
            const beerStyleInput = document.getElementById('reportBeerStyle');
            if (beerStyleInput) {
                beerStyleInput.value = '';
                beerStyleInput.placeholder = 'Beer style';
                beerStyleInput.disabled = false;
                beerStyleInput.readOnly = false;
                beerStyleInput.classList.remove('beer-style-locked', 'beer-style-editable', 'beer-style-disabled');
            }
            
            console.log('üßπ Cleared beer name dropdown and unlocked style');
        }

        // UNCHANGED - Simple remove function
        function removeStyleIndicator() {
            const existing = document.getElementById('beer-style-indicator');
            if (existing) {
                existing.remove();
            }
        }
        
            console.log('üé® Clean beer style system loaded (CSS classes, no inline styles)!');
        
        // Setup beer name auto-suggestions
        function setupBeerNameSuggestions(beers) {
            const beerNameInput = document.getElementById('reportBeerName');
            if (!beerNameInput) return;
            
            // Store beers data for suggestions
            beerNameInput.dataset.beers = JSON.stringify(beers);
            
            // Add placeholder text
            beerNameInput.placeholder = `Type beer name... (${beers.length} beers available)`;
            
            console.log('‚úÖ Beer name suggestions ready');
        }
        
        // Suggest beers as user types
        function suggestBeersForBrewery(brewery, searchTerm) {
            const beerNameInput = document.getElementById('reportBeerName');
            if (!beerNameInput || !beerNameInput.dataset.beers) return;
            
            try {
                const beers = JSON.parse(beerNameInput.dataset.beers);
                const matchingBeers = beers.filter(beer => 
                    beer.name.toLowerCase().includes(searchTerm.toLowerCase())
                ).slice(0, 5); // Limit to 5 suggestions
                
                if (matchingBeers.length > 0 && searchTerm.length > 1) {
                    showBeerSuggestions(matchingBeers, searchTerm);
                } else {
                    clearBeerSuggestions();
                }
            } catch (error) {
                console.error('Error parsing beer suggestions:', error);
            }
        }
        
        // Show beer suggestions dropdown
        function showBeerSuggestions(beers, searchTerm) {
            // Remove existing suggestions
            clearBeerSuggestions();
            
            const beerNameInput = document.getElementById('reportBeerName');
            const container = beerNameInput.parentNode;
            
            // Create suggestions dropdown
            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'beer-name-suggestions';
            suggestionsDiv.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 2px solid #e2e8f0;
                border-top: none;
                border-radius: 0 0 10px 10px;
                max-height: 150px;
                overflow-y: auto;
                z-index: 10001;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            // Add beer suggestions
            beers.forEach(beer => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'beer-suggestion-item';
                suggestionDiv.style.cssText = `
                    padding: 10px 12px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                    transition: background-color 0.2s ease;
                `;
                suggestionDiv.innerHTML = `
                    <strong>${beer.name}</strong><br>
                    <small>${beer.style} ‚Ä¢ ${beer.abv}% ‚Ä¢ ${beer.vegan_status}</small>
                `;
                
                // Click handler
                suggestionDiv.addEventListener('click', function() {
                    selectBeerSuggestion(beer);
                });
                
                // Hover effect
                suggestionDiv.addEventListener('mouseenter', function() {
                    this.style.background = 'rgba(102, 126, 234, 0.1)';
                });
                suggestionDiv.addEventListener('mouseleave', function() {
                    this.style.background = 'white';
                });
                
                suggestionsDiv.appendChild(suggestionDiv);
            });
            
            // Position container as relative
            container.style.position = 'relative';
            container.appendChild(suggestionsDiv);
        }
        
        // Select a beer suggestion
        function selectBeerSuggestion(beer) {
            // Fill in the form fields
            document.getElementById('reportBeerName').value = beer.name;
            
            const styleInput = document.getElementById('reportBeerStyle');
            if (styleInput) {
                styleInput.value = beer.style;
            }
            
            // Clear suggestions
            clearBeerSuggestions();
            
            console.log(`‚úÖ Selected beer: ${beer.brewery} ${beer.name}`);
        }
        
        // Clear beer suggestions
        function clearBeerSuggestions() {
            const existing = document.querySelector('.beer-name-suggestions');
            if (existing) {
                existing.remove();
            }
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('gfOnly').checked = false;
            document.getElementById('results').innerHTML = '';
            document.getElementById('suggestions').style.display = 'none';
            hideResultsSection();
            
            pubMarkers.forEach(marker => map.removeLayer(marker));
            pubMarkers = [];
            
            if (window.postcodeMarker) {
                map.removeLayer(window.postcodeMarker);
            }
            
            currentQuery = '';
            currentSearchType = 'all';
            currentGfOnly = false;
            currentPage = 1;
            AppState.save();
        }

        // UPDATE - Enhanced form submission to handle beer selection
        document.getElementById('reportForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            showLoadingToast('Submitting report...');
            
            // Get form data
            const brewerySelect = document.getElementById('reportBrewery');
            const beerNameElement = document.getElementById('reportBeerName');
            
            // Determine if beer name is a select or input
            const isDropdown = beerNameElement.tagName === 'SELECT';
            
            let beerData = {};
            
            if (isDropdown && beerNameElement.value && beerNameElement.value !== 'NEW_BEER') {
                // Selected existing beer
                const selectedOption = beerNameElement.options[beerNameElement.selectedIndex];
                beerData = {
                    beer_id: parseInt(beerNameElement.value),
                    beer_name: selectedOption.dataset.beerName,
                    style: selectedOption.dataset.style,
                    is_existing_beer: true
                };
            } else {
                // New beer or manual entry
                beerData = {
                    beer_name: isDropdown ? '' : beerNameElement.value,
                    style: document.getElementById('reportBeerStyle').value,
                    is_existing_beer: false
                };
            }
            
            const formData = {
                // Pub data
                existingPub: selectedPubData,
                pubName: selectedPubData ? selectedPubData.name : document.getElementById('reportPubName')?.value,
                address: selectedPubData ? selectedPubData.address : document.getElementById('reportAddress')?.value,
                postcode: selectedPubData ? selectedPubData.postcode : document.getElementById('reportPostcode')?.value,
                
                // Beer data
                format: document.getElementById('reportFormat').value,
                brewery: brewerySelect ? brewerySelect.value : '',
                ...beerData
            };
            
            // Validation
            if (!formData.format) {
                hideLoadingToast();
                showSuccessToast('Please select a beer format.');
                return;
            }
            
            if (!formData.brewery) {
                hideLoadingToast();
                showSuccessToast('Please select a brewery.');
                return;
            }
            
            if (!formData.beer_name) {
                hideLoadingToast();
                showSuccessToast('Please select or enter a beer name.');
                return;
            }
            
            try {
                // Submit data
                const response = await fetch('/api/submit_beer_update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pub_id: selectedPubData ? selectedPubData.pub_id : null,
                        beer_format: formData.format,
                        brewery: formData.brewery,
                        beer_name: formData.beer_name,
                        style: formData.style,
                        beer_id: formData.beer_id || null,
                        email: '',
                        name: 'Anonymous Report'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    hideLoadingToast();
                    
                    const message = formData.is_existing_beer 
                        ? 'üéâ Existing beer report submitted for validation!'
                        : 'üéâ New beer report submitted for validation!';
                    
                    showSuccessToast(message);
                    closeReportModal();
                } else {
                    throw new Error('Submission failed');
                }
                
            } catch (error) {
                hideLoadingToast();
                showSuccessToast('Error submitting report. Please try again.');
                console.error('Report submission error:', error);
            }
        });
        
        console.log('üç∫ Enhanced beer name dropdown with auto-style population loaded!');

        // Add pub search listener
        document.getElementById('reportPubSearch').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            searchPubsForReport(query);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestions = document.getElementById('pubSuggestions');
            const searchInput = document.getElementById('reportPubSearch');
            
            if (!suggestions.contains(e.target) && !searchInput.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const input = document.getElementById('searchInput');
            const suggestions = document.getElementById('suggestions');

            // Initialize Leaflet map
            map = L.map('map').setView([51.505, -0.09], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            loadDashboardStats();
            getUserLocation();
            await AppState.restore();

            // Event listeners for coordinate modal
            document.getElementById('confirmLocation').addEventListener('click', confirmLocation);
            document.getElementById('cancelModal').addEventListener('click', closeCoordinateModal);

            // Close modals when clicking outside
            document.getElementById('coordinateModal').addEventListener('click', (e) => {
                if (e.target.id === 'coordinateModal') {
                    closeCoordinateModal();
                }
            });

            document.getElementById('reportModal').addEventListener('click', (e) => {
                if (e.target.id === 'reportModal') {
                    closeReportModal();
                }
            });

            document.getElementById('aboutModal').addEventListener('click', (e) => {
                if (e.target.id === 'aboutModal') {
                    closeAboutModal();
                }
            });

            document.getElementById('gfInfoModal').addEventListener('click', (e) => {
                if (e.target.id === 'gfInfoModal') {
                    closeGFInfoModal();
                }
            });

            // ENHANCED AUTOCOMPLETE WITH POSTCODE DETECTION
            input.addEventListener('input', debounce(async () => {
                const query = input.value.trim();
                const searchType = document.getElementById('searchType').value;
                const gfOnly = document.getElementById('gfOnly').checked;
                
                if (query.length < 2) {
                    suggestions.style.display = 'none';
                    return;
                }

                // Check if it looks like a postcode
                const isPostcode = /^[A-Z]{1,2}[0-9R][0-9A-Z]?\s?[0-9][A-Z]{2}$/i.test(query.replace(/\s/g, ''));
                
                if (isPostcode) {
                    // Show postcode search option
                    suggestions.innerHTML = `
                        <div class="postcode-suggestion" style="padding: 15px; cursor: pointer; background: rgba(102, 126, 234, 0.1); border-radius: 10px; margin: 5px;">
                            <strong>üìç Search for pubs near "${query}"</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                Find pubs within 5km of this postcode
                            </div>
                        </div>
                    `;
                    suggestions.style.display = 'block';
                    
                    // Add click handler
                    suggestions.querySelector('.postcode-suggestion').addEventListener('click', () => {
                        searchPubs();
                        suggestions.style.display = 'none';
                    });
                    return;
                }

                // Regular autocomplete for non-postcodes
                try {
                    const url = `/autocomplete?q=${encodeURIComponent(query)}&search_type=${searchType}` + (gfOnly ? '&gf_only=true' : '');
                    const response = await fetch(url);
                    if (!response.ok) {
                        suggestions.style.display = 'none';
                        return;
                    }
                    const data = await response.json();

                    suggestions.innerHTML = '';
                    if (data.length === 0) {
                        suggestions.style.display = 'none';
                        return;
                    }

                    if (data.length >= 10) {
                        const showAllDiv = document.createElement('div');
                        showAllDiv.className = 'show-all-option';
                        showAllDiv.innerHTML = `<strong>üîç Show all ${data.length}+ results for "${query}"</strong>`;
                        showAllDiv.addEventListener('click', () => {
                            document.getElementById('searchInput').value = query;
                            searchPubs();
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(showAllDiv);
                    }

                    data.forEach(pub => {
                        const div = document.createElement('div');
                        div.textContent = `${pub.name}, ${pub.address} (${pub.postcode})`;
                        div.addEventListener('click', () => {
                            clearSearch();
                            searchSpecificPub(pub.pub_id);
                            suggestions.style.display = 'none';
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } catch (error) {
                    suggestions.style.display = 'none';
                }
            }, 300));

            // Hide suggestions on outside click
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            // Save state on form changes
            document.getElementById('searchType').addEventListener('change', () => AppState.save());
            document.getElementById('gfOnly').addEventListener('change', () => AppState.save());
        });
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

        <!-- Add this cookie consent banner to your index.html, just before the closing </body> tag -->
    
    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-consent" style="display: none;">
        <div class="cookie-content">
            <div class="cookie-text">
                <h4>üç™ We use cookies</h4>
                <p>We use essential cookies to make our site work. With your consent, we may also use analytics cookies to improve your experience.</p>
            </div>
            <div class="cookie-buttons">
                <button onclick="acceptAllCookies()" class="cookie-btn accept-all">Accept All</button>
                <button onclick="acceptEssentialOnly()" class="cookie-btn essential-only">Essential Only</button>
                <button onclick="showCookieSettings()" class="cookie-btn settings">Settings</button>
            </div>
        </div>
    </div>
    
    <!-- Cookie Settings Modal -->
    <div id="cookieSettings" class="cookie-modal" style="display: none;">
        <div class="modal-content cookie-modal-content">
            <div class="modal-header">
                <h2>üç™ Cookie Settings</h2>
                <button class="close-modal" onclick="closeCookieSettings()">&times;</button>
            </div>
            
            <div class="cookie-settings-content">
                <div class="cookie-category">
                    <div class="cookie-category-header">
                        <h3>Essential Cookies</h3>
                        <label class="cookie-toggle">
                            <input type="checkbox" checked disabled>
                            <span class="toggle-slider essential"></span>
                        </label>
                    </div>
                    <p>These cookies are necessary for the website to function and cannot be switched off. They are usually only set in response to actions made by you which amount to a request for services.</p>
                    <div class="cookie-details">
                        <strong>Examples:</strong> Session management, search preferences, location consent
                    </div>
                </div>
                
                <div class="cookie-category">
                    <div class="cookie-category-header">
                        <h3>Analytics Cookies</h3>
                        <label class="cookie-toggle">
                            <input type="checkbox" id="analyticsConsent">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p>These cookies help us understand how visitors interact with our website by collecting and reporting information anonymously. This helps us improve our service.</p>
                    <div class="cookie-details">
                        <strong>Provider:</strong> Google Analytics<br>
                        <strong>Purpose:</strong> Usage statistics, popular features, performance monitoring
                    </div>
                </div>
                
                <div class="cookie-info">
                    <h4>üìã Your Rights</h4>
                    <ul>
                        <li>You can change your preferences at any time</li>
                        <li>Withdrawing consent may limit website functionality</li>
                        <li>Essential cookies cannot be disabled</li>
                        <li>See our <a href="/cookies" target="_blank">Cookie Policy</a> for full details</li>
                    </ul>
                </div>
            </div>
            
            <div class="cookie-modal-buttons">
                <button onclick="savesCookiePreferences()" class="cookie-btn save-preferences">Save Preferences</button>
                <button onclick="acceptAllFromSettings()" class="cookie-btn accept-all">Accept All</button>
            </div>
        </div>
    </div>
    
    <!-- Floating Cookie Settings Button (appears after consent given) -->
    <div id="cookieSettingsFloat" class="cookie-settings-float" style="display: none;">
        <button onclick="showCookieSettings()" class="cookie-float-btn" title="Cookie Settings">
            üç™
        </button>
    </div>
</body>
</html>
